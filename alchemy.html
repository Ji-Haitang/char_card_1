<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¿®ä»™ç‚¼ä¸¹æ¨¡æ‹Ÿå™¨ - ç´§å‡‘æ°´å¢¨ç‰ˆ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@500;700&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --ink-black: #2b2b2b;
            --ink-light: #5a5a5a;
            --paper-bg: #f4f1e4;
            --paper-dark: #e6e2d3;
            --cinnabar: #8e1e20;
            --jade: #4d6e6e;
            --gold: #bfa36f;
            
            --base-spacing: 1%;
            --border-thick: 0.3rem;
            --border-thin: 0.15rem;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'ZCOOL XiaoWei', 'Noto Serif SC', serif;
            background-color: var(--paper-bg);
            background-image: 
                radial-gradient(var(--paper-dark) 15%, transparent 16%),
                radial-gradient(var(--paper-dark) 15%, transparent 16%);
            background-size: 1rem 1rem;
            background-position: 0 0, 0.5rem 0.5rem;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--ink-black);
            overflow-x: hidden;
        }

        .game-container {
            background: rgba(255, 255, 255, 0.65);
            border: var(--border-thick) double var(--ink-black);
            width: 90vw;
            max-width: 1216px;
            aspect-ratio: 1216 / 832;
            padding: 1%;
            position: relative;
            box-shadow: 1rem 1rem 0 rgba(43, 43, 43, 0.15);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .game-container::after { content: "â–"; position: absolute; top: 0.2rem; right: 0.2rem; color: var(--ink-light); opacity: 0.6; font-size: 0.8rem; }
        .game-container::before { content: "â–"; position: absolute; bottom: 0.2rem; left: 0.2rem; color: var(--ink-light); opacity: 0.6; font-size: 0.8rem; }

        /* ========== å¼€å§‹ç‚¼ä¸¹æŒ‰é’® - å“åº”å¼ä¼˜åŒ– ========== */
        .start-alchemy-btn {
            position: absolute;
            bottom: 15.5%;
            left: 50%;
            transform: translateX(-50%);
            width: 15%;
            aspect-ratio: 1/1;
            background: radial-gradient(circle, rgba(6, 116, 98, 0.95) 0%, rgba(6, 116, 98, 0.95) 70%);
            border: 2px solid var(--ink-black);
            border-radius: 50%;
            color: #fff;
            font-family: 'Ma Shan Zheng';
            font-size: clamp(0.7rem, 2vw, 2rem);  /* é™ä½æœ€å°å­—ä½“å¤§å° */
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 0 20px rgba(142, 30, 32, 0.5), 0.2rem 0.2rem 0.5rem rgba(0,0,0,0.3);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: btnPulse 2s infinite;
            white-space: nowrap;  /* é˜²æ­¢æ–‡å­—æ¢è¡Œ */
            overflow: hidden;     /* ç¡®ä¿ä¸ä¼šæº¢å‡º */
        }
        .start-alchemy-btn:hover {
            transform: translateX(-50%) scale(1.05);
            box-shadow: 0 0 30px rgba(142, 30, 32, 0.7), 0.3rem 0.3rem 0.6rem rgba(0,0,0,0.4);
        }
        .start-alchemy-btn.hidden {
            display: none;
        }
        @keyframes btnPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(142, 30, 32, 0.5), 0.2rem 0.2rem 0.5rem rgba(0,0,0,0.3); }
            50% { box-shadow: 0 0 30px rgba(142, 30, 32, 0.8), 0.2rem 0.2rem 0.5rem rgba(0,0,0,0.3); }
        }

        /* ========== æ¶ˆæ¯æç¤º ========== */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--paper-bg);
            border: 2px solid var(--ink-black);
            padding: clamp(1rem, 2vw, 1.5rem) clamp(1.5rem, 3vw, 2rem);
            font-family: 'Ma Shan Zheng';
            font-size: clamp(1rem, 2vw, 1.2rem);
            z-index: 10001;
            box-shadow: 0.5rem 0.5rem 1rem rgba(0,0,0,0.3);
            display: none;
            text-align: center;
            max-width: 80vw;
        }
        .toast.show {
            display: block;
            animation: toastFadeIn 0.3s;
        }
        .toast.success { border-color: var(--jade); color: var(--jade); }
        .toast.error { border-color: var(--cinnabar); color: var(--cinnabar); }
        @keyframes toastFadeIn {
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }

        /* ========== é¡¶éƒ¨äº‹ä»¶æ¨ªå¹… ========== */
        .event-banner {
            height: 10%;
            min-height: 0;
            margin-bottom: 1%;
            display: flex;
            flex-direction: column;
            gap: 2%;
            overflow: hidden;
        }

        .event-card {
            background: var(--paper-dark);
            border: 1px solid var(--ink-black);
            padding: 0.5% 1%;
            font-size: clamp(0.6rem, 1.2vw, 0.85rem);
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideIn 0.4s ease;
            border-left: 0.2rem solid var(--ink-black);
            min-height: 0;
        }
        .event-card.positive { border-left-color: var(--jade); }
        .event-card.negative { border-left-color: var(--cinnabar); }

        @keyframes slideIn { from { opacity: 0; transform: translateY(-0.5rem); } to { opacity: 1; transform: translateY(0); } }

        /* ========== æ ¸å¿ƒåŒºåŸŸï¼šä¸¹ç‚‰ + çºµå‘è¿›åº¦æ¡ + ç«ç„° ========== */
        .main-stage {
            position: relative;
            width: 100%;
            height: 55%;
            margin-bottom: 2%;
            display: flex;
            justify-content: center;
        }

        .furnace-container {
            position: relative;
            width: 60%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-end;
        }

        /* çºµå‘è¿›åº¦æ¡å®¹å™¨ */
        .vertical-gauge {
            position: absolute;
            top: 3%;
            bottom: 0;
            width: 10%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }
        
        .vertical-gauge.left { left: 5%; }
        .vertical-gauge.right { right: 5%; }

        .gauge-label {
            font-size: clamp(0.6rem, 1.2vw, 1rem);
            font-family: 'Ma Shan Zheng';
            margin-bottom: 2%;
            writing-mode: vertical-rl;
            letter-spacing: 0.1rem;
        }

        .gauge-value {
            font-size: clamp(0.7rem, 1.5vw, 1.1rem);
            font-family: 'Ma Shan Zheng';
            font-weight: bold;
            color: var(--ink-black);
            margin-bottom: 5%;
        }

        .gauge-track {
            width: 0.5rem;
            height: 75%;
            background: rgba(0,0,0,0.05);
            border: 1px solid var(--ink-black);
            position: relative;
            border-radius: 1rem;
            overflow: hidden;
        }

        .gauge-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            transition: height 0.5s ease;
        }

        .fill-quality { background: var(--jade); }
        .fill-completion { background: var(--ink-black); }

        /* ç«ç„°å®¹å™¨ */
        .furnace-fire-wrapper {
            position: absolute;
            bottom: 7%;
            left: 50%;
            transform: translateX(-50%);
            width: 25%;
            aspect-ratio: 1/1;
            z-index: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .furnace-fire-bg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,100,0,0.6) 0%, transparent 70%);
            filter: blur(8px);
            animation: pulse 2s infinite;
            transition: background 0.5s;
        }

        .temp-display {
            position: relative;
            z-index: 2;
            font-family: 'Ma Shan Zheng';
            font-size: clamp(1rem, 2.5vw, 2rem);
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            font-weight: bold;
        }

        .furnace-fire-bg.normal { background: radial-gradient(circle, rgba(255,160,50,0.6) 0%, transparent 70%); }
        .furnace-fire-bg.hot { background: radial-gradient(circle, rgba(255,60,0,0.8) 0%, transparent 70%); }
        .furnace-fire-bg.cold { background: radial-gradient(circle, rgba(100,200,200,0.5) 0%, transparent 70%); }
        .furnace-fire-bg.danger { background: radial-gradient(circle, rgba(220,0,0,0.9) 0%, transparent 70%); animation: shake 0.5s infinite; }

        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        @keyframes shake { 0%, 100% { transform: translate(0, 0) scale(1); } 25% { transform: translate(-2px, 2px) scale(1.1); } 75% { transform: translate(2px, -2px) scale(1.1); } }

        .furnace-image {
            position: relative;
            width: 90%;
            height: 100%;
            background: url('assets/image/static/ç‚¼ä¸¹ç‚‰.png') no-repeat center bottom; 
            background-size: contain;
            z-index: 2;
            pointer-events: none;
        }
        
        .furnace-image:empty::after {
            content: "ä¸¹ç‚‰"; display: flex; justify-content: center; align-items: center; width: 100%; height: 100%; opacity: 0.1; font-size: 2rem; font-family: 'Ma Shan Zheng';
        }

        /* ========== ä¿¡æ¯æ  ========== */
        .info-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 8%;
            margin-bottom: 2%;
            padding: 0.5% 0;
            border-top: 1px solid rgba(0,0,0,0.1);
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        .info-item { text-align: center; flex: 1; }
        
        .info-label { 
            font-size: clamp(0.5rem, 1vw, 0.7rem);
            color: var(--ink-light); 
        }
        .info-value { 
            font-family: 'Ma Shan Zheng'; 
            font-size: clamp(0.8rem, 1.6vw, 1.2rem);
            color: var(--ink-black); 
        }
        .info-value.danger-text { color: var(--cinnabar); }

        /* ========== æ§åˆ¶æŒ‰é’® ========== */
        .controls {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1%;
            height: 10%;
            margin-bottom: 2%;
        }

        .control-btn {
            background: #fff;
            border: var(--border-thin) solid var(--ink-black);
            color: var(--ink-black);
            padding: 0;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0.1rem 0.1rem 0 rgba(0,0,0,0.1);
            min-height: 0;
        }

        .control-btn:hover:not(:disabled) { transform: translate(-1px, -1px); box-shadow: 0.2rem 0.2rem 0 rgba(0,0,0,0.15); border-color: var(--cinnabar); color: var(--cinnabar); }
        .control-btn:active:not(:disabled) { transform: translate(2px, 2px); box-shadow: 0; }
        .control-btn:disabled { opacity: 0.5; border-color: #ccc; color: #999; cursor: not-allowed; box-shadow: none; }

        .btn-title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: clamp(0.7rem, 1.5vw, 1.1rem);
            line-height: 1;
        }

        /* ========== æ¶ˆæ¯ ========== */
        .message { 
            text-align: center; 
            padding: 1%; 
            margin: 0;
            height: 8%;
            font-size: clamp(0.6rem, 1.2vw, 0.8rem);
            border: 1px dashed var(--ink-black); 
            display: none; 
            background: rgba(255,255,255,0.5); 
        }
        .message.success { color: var(--jade); border-color: var(--jade); }
        .message.failure { color: var(--cinnabar); border-color: var(--cinnabar); }

        .tooltip { position: fixed; background: var(--paper-bg); border: 2px solid var(--ink-black); padding: 0.8rem; font-size: 0.8rem; z-index: 10000; opacity: 0; pointer-events: none; transition: opacity 0.2s; box-shadow: 0.4rem 0.4rem 0.8rem rgba(0,0,0,0.2); width: max-content; max-width: 80vw; }
        .tooltip.show { opacity: 1; }
        .tooltip-title { font-family: 'Ma Shan Zheng'; font-size: 1rem; color: var(--cinnabar); border-bottom: 1px solid rgba(0,0,0,0.2); margin-bottom: 0.4rem; }
        .tooltip-range { display: flex; justify-content: space-between; gap: 1rem; }
        .tooltip-value.positive { color: var(--jade); } .tooltip-value.negative { color: var(--cinnabar); }

        /* ========== é€šç”¨å¼¹çª— ========== */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(43, 43, 43, 0.7); backdrop-filter: blur(2px); display: none; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        
        /* å¼¹çª—å±‚çº§è®¾ç½® */
        #event-modal-overlay { z-index: 9998; }
        #herb-modal-overlay { z-index: 9999; }
        #shop-modal-overlay { z-index: 10000; }
        #inventory-modal-overlay { z-index: 10001; }
        
        .modal { 
            background: rgba(255, 255, 255, 0.65);
            border: var(--border-thick) double var(--ink-black);
            width: 90vw;
            max-width: 1216px;
            aspect-ratio: 1216 / 832;
            padding: 1%;
            position: relative;
            box-shadow: 1rem 1rem 0 rgba(43, 43, 43, 0.15);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .modal-title { 
            font-family: 'Ma Shan Zheng'; 
            font-size: clamp(1.5rem, 3vw, 2rem); 
            margin-bottom: 2%;
            color: var(--cinnabar);
            text-align: center;
        }
        
        .modal-content { 
            flex: 1;
            overflow-y: auto;
            margin: 2% 0;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 2%;
            margin-top: 2%;
        }
        
        .modal-btn { 
            background: #fff;
            border: var(--border-thin) solid var(--ink-black);
            padding: clamp(0.5rem, 1vw, 0.8rem) clamp(1.5rem, 3vw, 2rem);
            font-family: 'Ma Shan Zheng'; 
            font-size: clamp(1rem, 2vw, 1.2rem);
            cursor: pointer;
            box-shadow: 0.1rem 0.1rem 0 rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        .modal-btn:hover { 
            transform: translate(-1px, -1px);
            box-shadow: 0.2rem 0.2rem 0 rgba(0,0,0,0.15);
            background: var(--ink-black); 
            color: #fff; 
        }
        .modal-btn.primary { 
            background: var(--cinnabar); 
            color: #fff; 
            border-color: var(--cinnabar); 
        }
        .modal-btn.primary:hover { 
            background: var(--ink-black); 
            border-color: var(--ink-black);
        }

        /* ========== é¡¶éƒ¨æŒ‰é’®ï¼ˆå¼¹çª—å†…ï¼‰- ä½ç½®ä¼˜åŒ– ========== */
        .modal-top-btn {
            position: absolute;
            top: 2%;
            background: #fff;
            border: var(--border-thin) solid var(--ink-black);
            color: var(--ink-black);
            padding: clamp(0.4rem, 1vw, 0.6rem) clamp(0.8rem, 2vw, 1.2rem);
            font-family: 'Ma Shan Zheng';
            font-size: clamp(0.8rem, 1.5vw, 1rem);
            cursor: pointer;
            z-index: 10;
            box-shadow: 0.1rem 0.1rem 0 rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        .modal-top-btn:hover {
            transform: translate(-1px, -1px);
            box-shadow: 0.2rem 0.2rem 0 rgba(0,0,0,0.15);
        }
        
        /* å•†åŸæŒ‰é’®åœ¨å³ä¸Š */
        .modal-shop-btn {
            right: 2%;
        }
        .modal-shop-btn:hover {
            border-color: var(--gold);
            color: var(--gold);
        }
        
        /* èƒŒåŒ…æŒ‰é’®åœ¨å·¦ä¸Š */
        .modal-inventory-btn {
            left: 2%;
        }
        .modal-inventory-btn:hover {
            border-color: var(--jade);
            color: var(--jade);
        }

        /* ========== å•†åŸå¼¹çª—å†…å®¹ ========== */
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: clamp(0.5rem, 1.5vw, 0.8rem);
            margin: clamp(0.3rem, 0.8vw, 0.5rem) 0;
            border: 1px solid var(--ink-black);
            background: rgba(255,255,255,0.5);
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .shop-item-name { 
            font-family: 'Ma Shan Zheng'; 
            font-size: clamp(1rem, 2vw, 1.2rem); 
        }
        .shop-item-price { 
            color: var(--gold); 
            font-weight: bold; 
            margin: 0 clamp(0.5rem, 1vw, 1rem); 
            font-size: clamp(0.9rem, 1.8vw, 1.1rem);
        }
        .shop-item-btn { 
            padding: clamp(0.3rem, 0.8vw, 0.4rem) clamp(0.8rem, 1.5vw, 1rem); 
            background: var(--jade); 
            color: #fff; 
            border: none; 
            cursor: pointer; 
            font-family: 'Ma Shan Zheng';  /* ç»Ÿä¸€å­—ä½“é£æ ¼ */
            font-size: clamp(0.8rem, 1.5vw, 1rem);
        }
        .shop-item-btn:hover { background: var(--ink-black); }

        /* ========== æŠ•å…¥è¯æå¼¹çª—å†…å®¹ - å“åº”å¼ä¼˜åŒ– ========== */
        .herb-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: clamp(0.5rem, 1vw, 0.8rem);
            margin: clamp(0.5rem, 1vw, 1rem) 0;
        }
        
        @media (min-width: 768px) {
            .herb-selector {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .herb-item {
            border: 2px solid var(--ink-black);
            padding: clamp(0.4rem, 1vw, 0.8rem);
            background: rgba(255,255,255,0.5);
            text-align: center;
        }
        .herb-item-name { 
            font-family: 'Ma Shan Zheng'; 
            font-size: clamp(0.9rem, 1.8vw, 1.2rem); 
            margin-bottom: clamp(0.3rem, 0.8vw, 0.5rem); 
        }
        .herb-item-count { 
            color: var(--ink-light); 
            margin-bottom: clamp(0.3rem, 0.8vw, 0.5rem); 
            font-size: clamp(0.7rem, 1.4vw, 0.9rem);
        }
        .herb-item-controls { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: clamp(0.3rem, 0.8vw, 0.5rem); 
        }
        .herb-item-controls button { 
            width: clamp(1.5rem, 3vw, 2rem); 
            height: clamp(1.5rem, 3vw, 2rem); 
            border: 1px solid var(--ink-black); 
            background: #fff; 
            cursor: pointer; 
            font-size: clamp(1rem, 2vw, 1.3rem); 
        }
        .herb-item-controls button:hover { background: var(--paper-dark); }
        .herb-item-selected { 
            font-weight: bold; 
            font-size: clamp(1rem, 2vw, 1.3rem); 
            min-width: 1.5rem;
        }

        .total-herbs {
            font-family: 'Ma Shan Zheng';
            font-size: clamp(1rem, 2vw, 1.3rem);
            margin: clamp(0.8rem, 1.5vw, 1.2rem) 0;
            padding: clamp(0.6rem, 1.5vw, 1rem);
            background: var(--paper-dark);
            border: 2px solid var(--ink-black);
            text-align: center;
        }

        /* ========== èƒŒåŒ…å¼¹çª—å†…å®¹ ========== */
        .inventory-section {
            margin-bottom: 2%;
        }
        .inventory-title {
            font-family: 'Ma Shan Zheng';
            font-size: clamp(1.2rem, 2.5vw, 1.5rem);
            color: var(--cinnabar);
            border-bottom: 2px solid var(--ink-black);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        .inventory-item {
            background: rgba(255,255,255,0.5);
            border: 1px solid var(--ink-black);
            padding: clamp(0.5rem, 1vw, 0.8rem);
            text-align: center;
        }
        .inventory-item-name {
            font-family: 'Ma Shan Zheng';
            font-size: clamp(0.9rem, 1.8vw, 1.1rem);
            margin-bottom: 0.3rem;
        }
        .inventory-item-count {
            font-size: clamp(1rem, 2vw, 1.3rem);
            font-weight: bold;
            color: var(--jade);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        @media (min-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* ========== äº‹ä»¶å¼¹çª— ========== */
        .event-modal { 
            background: var(--paper-bg); 
            border-top: clamp(0.3rem, 0.5vw, 0.5rem) solid var(--ink-black); 
            border-bottom: clamp(0.3rem, 0.5vw, 0.5rem) solid var(--ink-black); 
            padding: clamp(1rem, 2vw, 1.5rem); 
            width: clamp(300px, 85vw, 400px); 
            text-align: center; 
            box-shadow: 0 1rem 2rem rgba(0,0,0,0.5); 
        }
        .event-icon { 
            font-size: clamp(2rem, 4vw, 2.5rem); 
            margin-bottom: clamp(0.3rem, 0.8vw, 0.5rem); 
        }
        .event-title { 
            font-family: 'Ma Shan Zheng'; 
            font-size: clamp(1.3rem, 3vw, 1.8rem); 
            margin-bottom: clamp(0.3rem, 0.8vw, 0.5rem); 
            color: var(--cinnabar); 
        }
        .event-effect { 
            background: rgba(0,0,0,0.05); 
            padding: clamp(0.5rem, 1.5vw, 0.8rem); 
            margin: clamp(0.5rem, 1vw, 1rem) 0; 
            border-left: 0.2rem solid var(--ink-black); 
            text-align: left; 
            font-size: clamp(0.8rem, 1.5vw, 0.9rem); 
        }
        .event-close-btn { 
            background: transparent; 
            border: 2px solid var(--ink-black); 
            padding: clamp(0.4rem, 1vw, 0.5rem) clamp(1rem, 2vw, 1.5rem); 
            font-family: 'Ma Shan Zheng'; 
            font-size: clamp(0.9rem, 1.8vw, 1.1rem);
            cursor: pointer; 
        }
        .event-close-btn:hover { background: var(--ink-black); color: #fff; }

    </style>
</head>
<body>
    <!-- Toast é€šçŸ¥ -->
    <div class="toast" id="toast"></div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>

    <!-- äº‹ä»¶å¼¹çª— -->
    <div class="modal-overlay" id="event-modal-overlay" onclick="closeEventModal()">
        <div class="event-modal" id="event-modal" onclick="event.stopPropagation()">
            <div class="event-icon" id="event-modal-icon"></div>
            <div class="event-title" id="event-modal-title"></div>
            <div class="event-description" id="event-modal-desc"></div>
            <div class="event-effect" id="event-modal-effect"></div>
            <button class="event-close-btn" onclick="closeEventModal()">é˜… æ¯•</button>
        </div>
    </div>

    <!-- å•†åŸå¼¹çª— -->
    <div class="modal-overlay" id="shop-modal-overlay" onclick="closeShopModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-title">è¯æå•†åŸ</div>
            <div style="margin-bottom: 1rem; font-size: clamp(1rem, 2vw, 1.2rem); text-align: center;">
                é‡‘é’±ï¼š<span style="color: #bfa36f;" id="money-display">5000</span>
            </div>
            <div class="modal-content" id="shop-content"></div>
            <div class="modal-buttons">
                <button class="modal-btn" onclick="closeShopModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- èƒŒåŒ…å¼¹çª— -->
    <div class="modal-overlay" id="inventory-modal-overlay" onclick="closeInventoryModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-title">èƒŒåŒ…</div>
            <div class="modal-content" id="inventory-content"></div>
            <div class="modal-buttons">
                <button class="modal-btn" onclick="closeInventoryModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- æŠ•å…¥è¯æå¼¹çª— -->
    <div class="modal-overlay" id="herb-modal-overlay">
        <div class="modal" onclick="event.stopPropagation()">
            <!-- é¡¶éƒ¨æŒ‰é’® - ä½ç½®ä¼˜åŒ– -->
            <button class="modal-top-btn modal-inventory-btn" onclick="openInventoryModal()">ğŸ’ èƒŒåŒ…</button>
            <button class="modal-top-btn modal-shop-btn" onclick="openShopModal()">ğŸ’° å•†åŸ</button>
            
            <div class="modal-title">æŠ•å…¥è¯æ</div>
            <div style="margin-bottom: 1%; color: var(--ink-light); font-size: clamp(0.9rem, 1.8vw, 1rem); text-align: center;">
                éœ€è¦æŠ•å…¥6-10ä¸ªè¯æ
            </div>
            <div class="modal-content">
                <div class="herb-selector" id="herb-selector"></div>
                <div class="total-herbs">
                    å·²é€‰æ‹©ï¼š<span id="total-selected-herbs">0</span> / 10
                    <br>åˆå§‹å“è´¨ï¼š<span id="initial-quality-preview">0</span>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="startAlchemyWithHerbs()">å¼€å§‹ç‚¼ä¸¹</button>
                <button class="modal-btn" onclick="closeHerbModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div class="game-container">
        <!-- é¡¶éƒ¨äº‹ä»¶æ¨ªå¹… -->
        <div class="event-banner" id="event-banner"></div>

        <!-- æ ¸å¿ƒåŒºåŸŸï¼šçºµå‘è¿›åº¦æ¡ + ä¸¹ç‚‰ + ç«ç„°æ•°å€¼ -->
        <div class="main-stage">
            <!-- å·¦ä¾§ï¼šå“è´¨ -->
            <div class="vertical-gauge left">
                <div class="gauge-label">å“è´¨</div>
                <div class="gauge-value" id="quality-display">0</div>
                <div class="gauge-track">
                    <div class="gauge-fill fill-quality" id="quality-bar"></div>
                </div>
            </div>

            <!-- ä¸­é—´ï¼šä¸¹ç‚‰ -->
            <div class="furnace-container">
                <!-- å¼€å§‹ç‚¼ä¸¹æŒ‰é’® -->
                <button class="start-alchemy-btn" id="start-alchemy-btn" onclick="openHerbModal()">å¼€å§‹</button>
                
                <!-- ç«ç„°å®¹å™¨ -->
                <div class="furnace-fire-wrapper">
                    <div class="furnace-fire-bg" id="furnace-fire-bg"></div>
                    <div class="temp-display" id="temp-value">50</div>
                </div>
                <!-- ä¸¹ç‚‰å›¾ç‰‡ -->
                <div class="furnace-image"></div>
            </div>

            <!-- å³ä¾§ï¼šå®Œæˆåº¦ -->
            <div class="vertical-gauge right">
                <div class="gauge-label">å®Œæˆ</div>
                <div class="gauge-value" id="completion-display">0</div>
                <div class="gauge-track">
                    <div class="gauge-fill fill-completion" id="completion-bar"></div>
                </div>
            </div>
        </div>
        
        <!-- æ•°æ®æ˜¾ç¤º -->
        <div class="info-display">
            <div class="info-item">
                <div class="info-label">å‰©ä½™æ“ä½œ</div>
                <div class="info-value" id="moves-left">15</div>
            </div>
            <div class="info-item">
                <div class="info-label">ç‚‰æ¸©å€ç‡</div>
                <div class="info-value" id="multiplier">0.8x</div>
            </div>
            <div class="info-item">
                <div class="info-label">ä¸¹ç‚‰çŠ¶æ€</div>
                <div class="info-value" id="status">æ­£å¸¸</div>
            </div>
        </div>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="controls" id="controls">
            <button class="control-btn" data-action="fiereFire">
                <span class="btn-title">çŒ›ç«</span>
            </button>
            <button class="control-btn" data-action="gentleFire">
                <span class="btn-title">æ–‡ç«</span>
            </button>
            <button class="control-btn" data-action="addHerb">
                <span class="btn-title">æŠ•è¯</span>
            </button>
            <button class="control-btn" data-action="condense">
                <span class="btn-title">å†·å‡</span>
            </button>
            <button class="control-btn" data-action="refine">
                <span class="btn-title">æ·¬ç‚¼</span>
            </button>
        </div>
        
        <div id="message" class="message"></div>
    </div>

    <script>
        // ========== æ—¥å¿—ç³»ç»Ÿ ==========
        function log(message) {
            console.log(`[ç‚¼ä¸¹æ¨¡æ‹Ÿå™¨] ${new Date().toLocaleTimeString()} - ${message}`);
        }

        // ========== Toast é€šçŸ¥å‡½æ•° ==========
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        // ========== è§’è‰²å±æ€§ ==========
        let playerStats = {
            rootBone: 0,      // æ ¹éª¨
            comprehension: 0, // æ‚Ÿæ€§
            nature: 0,        // å¿ƒæ€§
            charm: 0          // é­…åŠ›
        };

        let money = 5000;

        let herbs = {
            danshen: 0,   // ä¸¹å‚
            danggui: 0,   // å½“å½’
            moyao: 0,     // æ²¡è¯
            chenxiang: 0  // æ²‰é¦™
        };

        let pills = {
            daliwan: 0,      // å¤§åŠ›ä¸¸
            jingutie: 0,     // ç­‹éª¨è´´
            jinchuangyao: 0, // é‡‘ç–®è¯
            piliwan: 0       // éœ¹é›³ä¸¸
        };

        const herbNames = {
            danshen: 'ä¸¹å‚',
            danggui: 'å½“å½’',
            moyao: 'æ²¡è¯',
            chenxiang: 'æ²‰é¦™'
        };

        const pillNames = {
            daliwan: 'å¤§åŠ›ä¸¸',
            jingutie: 'ç­‹éª¨è´´',
            jinchuangyao: 'é‡‘ç–®è¯',
            piliwan: 'éœ¹é›³ä¸¸'
        };

        const statNames = {
            rootBone: 'æ ¹éª¨',
            comprehension: 'æ‚Ÿæ€§',
            nature: 'å¿ƒæ€§',
            charm: 'é­…åŠ›'
        };

        // è¯æä¸å±æ€§çš„å¯¹åº”å…³ç³»
        const herbToStat = {
            danshen: 'rootBone',      // ä¸¹å‚ â†’ æ ¹éª¨
            danggui: 'comprehension', // å½“å½’ â†’ æ‚Ÿæ€§
            moyao: 'nature',          // æ²¡è¯ â†’ å¿ƒæ€§
            chenxiang: 'charm'        // æ²‰é¦™ â†’ é­…åŠ›
        };

        let selectedHerbs = {
            danshen: 0,
            danggui: 0,
            moyao: 0,
            chenxiang: 0
        };

        // è®°å½•ç‚¼ä¸¹æ—¶æŠ•å…¥çš„è¯æï¼ˆç”¨äºè®¡ç®—å±æ€§ï¼‰
        let herbsUsedForAlchemy = {};

        let gameState = {
            temperature: 50, quality: 0, completion: 0, movesLeft: 15,
            gameOver: false, turnCount: 0, lastEventWasNegative: false,
            alchemyStarted: false
        };

        const actions = {
            fiereFire: { name: 'çŒ›ç«', desc: 'å¤§å¹…å‡æ¸©', effects: { temperature: [25, 35], quality: [-5, -2], completion: [0, 0] } },
            gentleFire: { name: 'æ–‡ç«', desc: 'å¾®è°ƒå¹³è¡¡', effects: { temperature: [5, 10], quality: [3, 6], completion: [4, 8] } },
            addHerb: { name: 'æŠ•è¯', desc: 'å¢åŠ å®Œæˆåº¦', effects: { temperature: [-15, -5], quality: [2, 4], completion: [8, 15] } },
            condense: { name: 'å†·å‡', desc: 'é™æ¸©å‡ä¸¹', effects: { temperature: [-30, -20], quality: [8, 12], completion: [0, 2] } },
            refine: { name: 'æ·¬ç‚¼', desc: 'æçº¯æ‚è´¨', effects: { temperature: [5, 10], quality: [5, 8], completion: [-10, -5] } }
        };

        let activeEvents = [];
        const eventLibrary = [
            { id: 'cold_snap', name: 'å¯’æ½®', type: 'negative', icon: 'â„ï¸', desc: 'å¯’æ°”è¢­æ¥ï¼Œç‚‰æ¸©éª¤é™', effectDesc: 'ç‚‰æ¸©-15ï¼Œä¸‹æ¬¡çŒ›ç«å‡åŠ', activeEffect: 'ä¸‹æ¬¡çŒ›ç«å‡åŠ', duration: 0, probability: 0.15, onTrigger: (s) => { s.temperature = Math.max(0, s.temperature - 15); return { nextFireHalved: true, duration: 1 }; } },
            { id: 'clog', name: 'æ·¤ç§¯', type: 'negative', icon: 'ğŸš«', desc: 'è¯æ¸£å µå¡æ°”å­”', effectDesc: 'ä¸‹æ¬¡å†·å‡å¤±æ•ˆ', activeEffect: 'ä¸‹æ¬¡å†·å‡å¤±æ•ˆ', duration: 1, probability: 0.12, onTrigger: () => ({ coolDisabled: true }) },
            { id: 'backlash', name: 'åå™¬', type: 'negative', icon: 'ğŸ”¥', desc: 'ç«æ°”æš´èµ°ä¾µèš€è¯æ€§', effectDesc: 'æ¯è½®å“è´¨-5', activeEffect: 'æ¯è½®å“è´¨-5', duration: 3, probability: 0.1, onTick: (s) => { s.quality = Math.max(0, s.quality - 5); } },
            { id: 'distraction', name: 'å¿ƒé­”', type: 'negative', icon: 'ğŸ˜µ', desc: 'å¿ƒç¥ä¸å®', effectDesc: 'ä¸‹æ¬¡æ³¢åŠ¨ç¿»å€', activeEffect: 'ä¸‹æ¬¡æ³¢åŠ¨x2', duration: 1, probability: 0.13, onTrigger: () => ({ varianceDoubled: true }) },
            { id: 'blessing', name: 'ç¥¥ç‘', type: 'positive', icon: 'âœ¨', desc: 'ç´«æ°”ä¸œæ¥', effectDesc: 'å“è´¨+15', activeEffect: 'å“è´¨+15', duration: 0, probability: 0.12, onTrigger: (s) => { s.quality = Math.min(100, s.quality + 15); } },
            { id: 'epiphany', name: 'é¡¿æ‚Ÿ', type: 'positive', icon: 'ğŸ’¡', desc: 'é¢†æ‚Ÿæ§ç«ç²¾é«“', effectDesc: 'ä¸‹æ¬¡ä¸è€—æ¬¡æ•°', activeEffect: 'ä¸‹æ¬¡ä¸è€—æ¬¡æ•°', duration: 1, probability: 0.1, onTrigger: () => ({ freeTurn: true }) },
            { id: 'wind_aid', name: 'é£åŠ©', type: 'positive', icon: 'ğŸŒªï¸', desc: 'é£åŠ©ç«åŠ¿', effectDesc: 'ä¸‹æ¬¡çŒ›ç«x2.5', activeEffect: 'ä¸‹æ¬¡çŒ›ç«x2.5', duration: 1, probability: 0.08, onTrigger: () => ({ fireBoost: 2.5 }) },
            { id: 'shield', name: 'æŠ¤ä¸»', type: 'positive', icon: 'ğŸ›¡ï¸', desc: 'å™¨çµæŠ¤ç›¾', effectDesc: 'æŠµæŒ¡ä¸€æ¬¡ç‚¸ç‚‰', activeEffect: 'æŠµæŒ¡ç‚¸ç‚‰', duration: 1, probability: 0.08, onTrigger: () => ({ explosionShield: true }) },
            { id: 'boiling', name: 'æ²¸è…¾', type: 'neutral', icon: 'â™¨ï¸', desc: 'çµæ°”æ´»è·ƒ', effectDesc: 'æ‰€æœ‰æ•ˆæœç¿»å€', activeEffect: 'æ•ˆæœx2', duration: 2, probability: 0.08, onTrigger: () => ({ allDoubled: true }) },
            { id: 'reverse', name: 'é˜´ç«', type: 'neutral', icon: 'ğŸ”„', desc: 'é˜´é˜³é¢ å€’å¯’æš‘é€†è½¬', effectDesc: 'ä¸‹æ¬¡æ“ä½œæ¸©åº¦å˜åŒ–åè½¬ï¼ˆå‡æ¸©å˜é™æ¸©ï¼Œé™æ¸©å˜å‡æ¸©ï¼‰', activeEffect: 'ä¸‹æ¬¡æ¸©åº¦åè½¬', duration: 1, probability: 0.06, onTrigger: () => ({ temperatureReversed: true }) },
            { id: 'lock_multiplier', name: 'å‡ä¸¹', type: 'neutral', icon: 'ğŸ’', desc: 'è¯æ¶²å‡å›ºç¬é—´ï¼Œæ—¶é—´æš‚åœ', effectDesc: 'æŒç»­2è½®ï¼Œç‚‰æ¸©å€ç‡é”å®šä¸º1.5x', activeEffect: 'å€ç‡é”å®š1.5x', duration: 2, probability: 0.08, onTrigger: () => ({ multiplierLocked: 1.5 }) }
        ];

        // ========== å•†åŸåŠŸèƒ½ ==========
        function openShopModal() {
            document.getElementById('money-display').textContent = money;
            const shopContent = document.getElementById('shop-content');
            shopContent.innerHTML = '';
            
            Object.keys(herbs).forEach(herbKey => {
                const herbName = herbNames[herbKey];
                const itemDiv = document.createElement('div');
                itemDiv.className = 'shop-item';
                itemDiv.innerHTML = `
                    <span class="shop-item-name">${herbName}</span>
                    <span style="color: var(--ink-light); font-size: clamp(0.8rem, 1.5vw, 0.9rem);">æ‹¥æœ‰ï¼š${herbs[herbKey]}</span>
                    <span class="shop-item-price">500é‡‘</span>
                    <button class="shop-item-btn" onclick="buyHerb('${herbKey}')">è´­ä¹°</button>
                `;
                shopContent.appendChild(itemDiv);
            });
            
            document.getElementById('shop-modal-overlay').classList.add('active');
        }

        function closeShopModal() {
            document.getElementById('shop-modal-overlay').classList.remove('active');
        }

        function buyHerb(herbKey) {
            if (money >= 500) {
                money -= 500;
                herbs[herbKey]++;
                log(`è´­ä¹°${herbNames[herbKey]}ï¼ŒèŠ±è´¹500é‡‘ï¼Œå½“å‰é‡‘é’±ï¼š${money}ï¼Œ${herbNames[herbKey]}åº“å­˜ï¼š${herbs[herbKey]}`);
                openShopModal(); // åˆ·æ–°å•†åŸæ˜¾ç¤º
                updateHerbDisplay(); // æ›´æ–°æŠ•å…¥è¯æç•Œé¢çš„æ˜¾ç¤º
                showToast(`è´­ä¹°æˆåŠŸï¼è·å¾—${herbNames[herbKey]} x1`, 'success');
            } else {
                showToast('é‡‘é’±ä¸è¶³ï¼', 'error');
            }
        }

        // ========== èƒŒåŒ…åŠŸèƒ½ ==========
        function openInventoryModal() {
            const inventoryContent = document.getElementById('inventory-content');
            inventoryContent.innerHTML = '';
            
            // æ˜¾ç¤ºå±æ€§
            let statsHtml = '<div class="inventory-section"><div class="inventory-title">è§’è‰²å±æ€§</div><div class="stats-grid">';
            Object.keys(playerStats).forEach(stat => {
                statsHtml += `<div class="inventory-item">
                    <div class="inventory-item-name">${statNames[stat]}</div>
                    <div class="inventory-item-count">${playerStats[stat]}</div>
                </div>`;
            });
            statsHtml += '</div></div>';
            
            // æ˜¾ç¤ºè¯æ
            let herbsHtml = '<div class="inventory-section"><div class="inventory-title">è¯æ</div><div class="inventory-grid">';
            Object.keys(herbs).forEach(herbKey => {
                herbsHtml += `<div class="inventory-item">
                    <div class="inventory-item-name">${herbNames[herbKey]}</div>
                    <div class="inventory-item-count">${herbs[herbKey]}</div>
                </div>`;
            });
            herbsHtml += '</div></div>';
            
            // æ˜¾ç¤ºä¸¹è¯
            let pillsHtml = '<div class="inventory-section"><div class="inventory-title">ä¸¹è¯</div><div class="inventory-grid">';
            Object.keys(pills).forEach(pillKey => {
                pillsHtml += `<div class="inventory-item">
                    <div class="inventory-item-name">${pillNames[pillKey]}</div>
                    <div class="inventory-item-count">${pills[pillKey]}</div>
                </div>`;
            });
            pillsHtml += '</div></div>';
            
            inventoryContent.innerHTML = statsHtml + herbsHtml + pillsHtml;
            document.getElementById('inventory-modal-overlay').classList.add('active');
        }

        function closeInventoryModal() {
            document.getElementById('inventory-modal-overlay').classList.remove('active');
        }

        // ========== æŠ•å…¥è¯æåŠŸèƒ½ ==========
        function openHerbModal() {
            Object.keys(selectedHerbs).forEach(key => selectedHerbs[key] = 0);
            renderHerbSelector();
            updateHerbTotal();
            document.getElementById('herb-modal-overlay').classList.add('active');
        }

        function renderHerbSelector() {
            const herbSelector = document.getElementById('herb-selector');
            herbSelector.innerHTML = '';
            
            Object.keys(herbs).forEach(herbKey => {
                const herbName = herbNames[herbKey];
                const itemDiv = document.createElement('div');
                itemDiv.className = 'herb-item';
                itemDiv.innerHTML = `
                    <div class="herb-item-name">${herbName}</div>
                    <div class="herb-item-count" id="herb-count-${herbKey}">æ‹¥æœ‰ï¼š${herbs[herbKey]}</div>
                    <div class="herb-item-controls">
                        <button onclick="changeHerbCount('${herbKey}', -1)">-</button>
                        <span class="herb-item-selected" id="selected-${herbKey}">${selectedHerbs[herbKey] || 0}</span>
                        <button onclick="changeHerbCount('${herbKey}', 1)">+</button>
                    </div>
                `;
                herbSelector.appendChild(itemDiv);
            });
        }

        function updateHerbDisplay() {
            // æ›´æ–°æŠ•å…¥è¯æç•Œé¢çš„åº“å­˜æ˜¾ç¤º
            if (document.getElementById('herb-modal-overlay').classList.contains('active')) {
                Object.keys(herbs).forEach(herbKey => {
                    const countElement = document.getElementById(`herb-count-${herbKey}`);
                    if (countElement) {
                        countElement.textContent = `æ‹¥æœ‰ï¼š${herbs[herbKey]}`;
                    }
                });
            }
        }

        function closeHerbModal() {
            document.getElementById('herb-modal-overlay').classList.remove('active');
        }

        function changeHerbCount(herbKey, delta) {
            const newValue = selectedHerbs[herbKey] + delta;
            const totalSelected = Object.values(selectedHerbs).reduce((a, b) => a + b, 0);
            
            if (newValue < 0) return;
            if (newValue > herbs[herbKey]) {
                showToast(`${herbNames[herbKey]}åº“å­˜ä¸è¶³ï¼`, 'error');
                return;
            }
            if (delta > 0 && totalSelected >= 10) {
                showToast('æœ€å¤šæŠ•å…¥10ä¸ªè¯æï¼', 'error');
                return;
            }
            
            selectedHerbs[herbKey] = newValue;
            document.getElementById(`selected-${herbKey}`).textContent = newValue;
            updateHerbTotal();
        }

        function updateHerbTotal() {
            const total = Object.values(selectedHerbs).reduce((a, b) => a + b, 0);
            document.getElementById('total-selected-herbs').textContent = total;
            
            const initialQuality = Math.max(0, (total - 6) * 5);
            document.getElementById('initial-quality-preview').textContent = initialQuality;
        }

        function startAlchemyWithHerbs() {
            const total = Object.values(selectedHerbs).reduce((a, b) => a + b, 0);
            
            if (total < 6) {
                showToast('è‡³å°‘éœ€è¦æŠ•å…¥6ä¸ªè¯æï¼', 'error');
                return;
            }
            
            // è®°å½•æŠ•å…¥çš„è¯æï¼ˆç”¨äºè®¡ç®—å±æ€§ï¼‰
            herbsUsedForAlchemy = {...selectedHerbs};
            log(`å¼€å§‹ç‚¼ä¸¹ï¼ŒæŠ•å…¥è¯æï¼š${JSON.stringify(herbsUsedForAlchemy)}`);
            
            // æ‰£é™¤è¯æ
            Object.keys(selectedHerbs).forEach(herbKey => {
                herbs[herbKey] -= selectedHerbs[herbKey];
                if (selectedHerbs[herbKey] > 0) {
                    log(`æ¶ˆè€—${herbNames[herbKey]} x${selectedHerbs[herbKey]}ï¼Œå‰©ä½™ï¼š${herbs[herbKey]}`);
                }
            });
            
            const initialQuality = Math.max(0, (total - 6) * 5);
            gameState.quality = initialQuality;
            gameState.alchemyStarted = true;
            
            closeHerbModal();
            document.getElementById('start-alchemy-btn').classList.add('hidden');
            updateDisplay();
            document.querySelectorAll('.control-btn').forEach(btn => btn.disabled = false);
        }

        // ========== å±æ€§æå‡åŠŸèƒ½ ==========
        function addRandomAttribute(points) {
            // è®¡ç®—æ€»æŠ•å…¥
            const totalHerbs = Object.values(herbsUsedForAlchemy).reduce((a, b) => a + b, 0);
            if (totalHerbs === 0) return;
            
            // è®¡ç®—æ¯ç§è¯æçš„æ¦‚ç‡æƒé‡
            const weights = [];
            const stats = [];
            
            Object.keys(herbsUsedForAlchemy).forEach(herbKey => {
                if (herbsUsedForAlchemy[herbKey] > 0) {
                    weights.push(herbsUsedForAlchemy[herbKey]);
                    stats.push(herbToStat[herbKey]);
                }
            });
            
            // éšæœºé€‰æ‹©å±æ€§
            const totalWeight = weights.reduce((a, b) => a + b, 0);
            let random = Math.random() * totalWeight;
            let selectedStat = null;
            
            for (let i = 0; i < weights.length; i++) {
                random -= weights[i];
                if (random <= 0) {
                    selectedStat = stats[i];
                    break;
                }
            }
            
            if (selectedStat) {
                playerStats[selectedStat] += points;
                log(`å±æ€§æå‡ï¼š${statNames[selectedStat]} +${points}ï¼Œå½“å‰å€¼ï¼š${playerStats[selectedStat]}`);
                showToast(`${statNames[selectedStat]} +${points}ï¼`, 'success');
            }
        }

        // Tooltip
        let tooltipTimeout, longPressTimer;
        function showTooltip(element, content, x, y) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = content; tooltip.classList.add('show');
            const rect = element.getBoundingClientRect();
            const tRect = tooltip.getBoundingClientRect();
            let left = x || rect.left + rect.width/2 - tRect.width/2;
            let top = y || rect.top - tRect.height - 10;
            if (left < 10) left = 10; if (left + tRect.width > window.innerWidth) left = window.innerWidth - tRect.width - 10;
            if (top < 10) top = rect.bottom + 10;
            tooltip.style.left = left + 'px'; tooltip.style.top = top + 'px';
        }
        function hideTooltip() { document.getElementById('tooltip').classList.remove('show'); }
        function formatRange(min, max) { return (min === max) ? String(min) : `${min>0?'+':''}${min}~${min>0?'+':''}${max}`; }
        function getValueClass(v) { return v > 0 ? 'positive' : (v < 0 ? 'negative' : 'neutral'); }

        function generateActionTooltip(actionType) {
            const action = actions[actionType];
            const m = calculateMultiplier();
            const e = action.effects;
            const qMin = Math.round(e.quality[0]*m), qMax = Math.round(e.quality[1]*m);
            const cMin = Math.round(e.completion[0]*m), cMax = Math.round(e.completion[1]*m);
            let html = `<div class="tooltip-title">${action.name}</div><div style="margin-bottom:5px;opacity:0.8">${action.desc}</div>`;
            html += `<div class="tooltip-range"><span>ç‚‰æ¸©</span><span class="${getValueClass(e.temperature[0])}">${formatRange(e.temperature[0], e.temperature[1])}</span></div>`;
            html += `<div class="tooltip-range"><span>å“è´¨</span><span class="${getValueClass(qMin)}">${formatRange(qMin, qMax)}</span></div>`;
            html += `<div class="tooltip-range"><span>å®Œæˆ</span><span class="${getValueClass(cMin)}">${formatRange(cMin, cMax)}</span></div>`;
            return html;
        }

        function initializeControls() {
            document.querySelectorAll('.control-btn').forEach(btn => {
                const action = btn.getAttribute('data-action');
                btn.addEventListener('mouseenter', function() { if(!btn.disabled) tooltipTimeout = setTimeout(() => showTooltip(this, generateActionTooltip(action)), 300); });
                btn.addEventListener('mouseleave', () => { clearTimeout(tooltipTimeout); hideTooltip(); });
                btn.addEventListener('touchstart', function(e) { if(!btn.disabled) longPressTimer = setTimeout(() => showTooltip(this, generateActionTooltip(action), e.touches[0].clientX, e.touches[0].clientY-80), 500); });
                btn.addEventListener('touchend', () => clearTimeout(longPressTimer));
                btn.addEventListener('click', () => { hideTooltip(); performAction(action); });
            });
        }

        function showEventModal(e) {
            document.getElementById('event-modal-icon').textContent = e.icon;
            document.getElementById('event-modal-title').textContent = e.name;
            document.getElementById('event-modal-desc').textContent = e.desc;
            document.getElementById('event-modal-effect').textContent = e.effectDesc;
            document.getElementById('event-modal-overlay').classList.add('active');
        }
        function closeEventModal() { document.getElementById('event-modal-overlay').classList.remove('active'); }

        function getRandom(min, max) { return Math.random() * (max - min) + min; }
        function calculateMultiplier() {
            const lock = activeEvents.find(e => e.multiplierLocked); if (lock) return lock.multiplierLocked;
            if (gameState.temperature <= 30) return 0.3 + (gameState.temperature/30)*0.2;
            if (gameState.temperature <= 70) return 0.5 + ((gameState.temperature-30)/40)*0.5;
            return 1.0 + ((gameState.temperature-70)/30)*0.8;
        }

        function triggerRandomEvent() {
            if (gameState.turnCount <= 2 || gameState.movesLeft <= 1 || Math.random() > 0.35) return;
            let pool = eventLibrary.filter(e => !(e.type==='negative' && gameState.lastEventWasNegative) && Math.random()<(e.probability/0.35));
            if (!pool.length) return;
            const evt = pool[Math.floor(Math.random()*pool.length)];
            gameState.lastEventWasNegative = (evt.type==='negative');
            const res = evt.onTrigger ? evt.onTrigger(gameState) : {};
            const active = { ...evt, ...res, remainingDuration: evt.duration };
            activeEvents.push(active);
            showEventModal(evt); displayEventCard(active);
        }

        function displayEventCard(e) {
            const div = document.createElement('div');
            div.className = `event-card ${e.type}`; div.setAttribute('data-id', e.id);
            div.innerHTML = `<span>${e.name}</span><span style="opacity:0.7;font-size:0.7em">${e.activeEffect}</span>`;
            document.getElementById('event-banner').appendChild(div);
            div.addEventListener('click', () => showEventModal(e));
            if(e.duration===0) setTimeout(() => div.remove(), 3000);
        }

        function updateEventDuration() {
            activeEvents = activeEvents.filter(e => {
                if(e.onTick) e.onTick(gameState);
                e.remainingDuration--;
                const card = document.querySelector(`.event-card[data-id="${e.id}"]`);
                if(e.remainingDuration < 0) { if(card) card.remove(); return false; }
                return true;
            });
        }

        function updateDisplay() {
            const m = calculateMultiplier();
            document.getElementById('temp-value').textContent = Math.round(gameState.temperature);
            document.getElementById('moves-left').textContent = gameState.movesLeft;
            document.getElementById('quality-display').textContent = Math.round(gameState.quality);
            document.getElementById('completion-display').textContent = Math.round(gameState.completion);
            
            const mulEl = document.getElementById('multiplier');
            mulEl.textContent = m.toFixed(1) + 'x';
            mulEl.className = 'info-value ' + (gameState.temperature > 85 ? 'danger-text' : '');

            document.getElementById('quality-bar').style.height = gameState.quality + '%';
            document.getElementById('completion-bar').style.height = gameState.completion + '%';
            
            const bg = document.getElementById('furnace-fire-bg');
            const status = document.getElementById('status');
            bg.className = 'furnace-fire-bg'; status.className = 'info-value';
            if(gameState.temperature > 90) { bg.classList.add('danger'); status.textContent = 'å°†ç‚¸'; status.classList.add('danger-text'); }
            else if(gameState.temperature > 70) { bg.classList.add('hot'); status.textContent = 'ç‚½çƒ­'; status.classList.add('danger-text'); }
            else if(gameState.temperature < 30) { bg.classList.add('cold'); status.textContent = 'å†·å¯‚'; }
            else { bg.classList.add('normal'); status.textContent = 'æ­£å¸¸'; }
        }

        function performAction(type) {
            if (!gameState.alchemyStarted) {
                showToast('è¯·å…ˆç‚¹å‡»"å¼€å§‹"æŒ‰é’®ï¼', 'error');
                return;
            }
            if (gameState.gameOver || gameState.movesLeft <= 0) return;
            gameState.turnCount++;
            const action = actions[type];
            const e = action.effects;
            const m = calculateMultiplier();
            
            let mod = { t: 1, q: 1, c: 1, v: 1, free: false };
            activeEvents.forEach(evt => {
                if(evt.allDoubled) { mod.t*=2; mod.q*=2; mod.c*=2; }
                if(evt.fireBoost && type==='fiereFire') mod.t *= evt.fireBoost;
                if(evt.nextFireHalved && type==='fiereFire') { mod.t *= 0.5; evt.remainingDuration = -1; }
                if(evt.coolDisabled && type==='condense') { mod.t = 0; evt.remainingDuration = -1; }
                if(evt.varianceDoubled) mod.v = 2;
                if(evt.freeTurn) { mod.free = true; evt.remainingDuration = -1; }
                if(evt.temperatureReversed) { mod.t *= -1; evt.remainingDuration = -1; }
            });

            let dt = getRandom(e.temperature[0], e.temperature[1]);
            let dq = getRandom(e.quality[0], e.quality[1]);
            let dc = getRandom(e.completion[0], e.completion[1]);

            if(mod.v > 1) { const center = (e.temperature[0]+e.temperature[1])/2; dt = center + (dt-center)*mod.v; }

            dt *= mod.t;
            dq = dq * m * mod.q;
            dc = dc * m * mod.c;

            if(gameState.temperature > 80) dq -= (gameState.temperature - 80) * 0.2;

            gameState.temperature = Math.max(0, gameState.temperature + dt);
            gameState.quality = Math.max(0, Math.min(100, gameState.quality + dq));
            gameState.completion = Math.max(0, Math.min(100, gameState.completion + dc));

            if(!mod.free) gameState.movesLeft--;
            updateEventDuration();

            const hasShield = activeEvents.some(e => e.explosionShield);
            if(gameState.temperature > 100) {
                if(hasShield) {
                    gameState.temperature = 99; activeEvents = activeEvents.filter(e => !e.explosionShield);
                    showToast('å™¨çµæŠ¤ä¸»ç”Ÿæ•ˆï¼', 'success');
                } else { gameOver(false, 'ç‚‰æ¸©è¿‡é«˜ï¼Œä¸¹ç‚‰ç‚¸è£‚ï¼'); return; }
            }

            updateDisplay();
            triggerRandomEvent();

            if(gameState.completion >= 100) {
                gameState.completion = 100; updateDisplay();
                const product = getProduct(gameState.quality);
                gameOver(true, `ç‚¼ä¸¹æˆåŠŸï¼è·å¾—ï¼š${product}`);
                return;
            }
            if(gameState.movesLeft === 0) gameOver(false, `æ¬¡æ•°è€—å°½ï¼Œç‚¼ä¸¹å¤±è´¥ï¼`);
        }

        function getProduct(q) {
            let productName = '';
            let points = 0;
            
            if(q >= 100) {
                productName = 'ã€ä¹è½¬é‡‘ä¸¹ã€‘(ä¼ è¯´)';
                points = 3;
            } else if(q >= 90) {
                productName = 'ã€æ˜“ç­‹ä¸¹ã€‘(å²è¯—)';
                points = 2;
            } else if(q >= 75) {
                productName = 'ã€åŸ¹å…ƒä¸¹ã€‘(ç¨€æœ‰)';
                points = 1;
            } else if(q >= 50) {
                const commonPills = ['daliwan', 'jingutie', 'jinchuangyao', 'piliwan'];
                const pillNames = {
                    daliwan: 'ã€å¤§åŠ›ä¸¸ã€‘(æ™®é€š)',
                    jingutie: 'ã€ç­‹éª¨è´´ã€‘(æ™®é€š)',
                    jinchuangyao: 'ã€é‡‘ç–®è¯ã€‘(æ™®é€š)',
                    piliwan: 'ã€éœ¹é›³ä¸¸ã€‘(æ™®é€š)'
                };
                const randomPill = commonPills[Math.floor(Math.random() * commonPills.length)];
                pills[randomPill]++;
                productName = pillNames[randomPill];
                log(`è·å¾—ä¸¹è¯ï¼š${productName.replace(/ã€|ã€‘|\(.*\)/g, '')}ï¼Œå½“å‰åº“å­˜ï¼š${pills[randomPill]}`);
            } else {
                productName = 'æ— äº§å‡º';
            }
            
            // æ ¹æ®å“è´¨æ·»åŠ å±æ€§
            if (points > 0) {
                addRandomAttribute(points);
            }
            
            log(`ç‚¼ä¸¹ç»“æœï¼šå“è´¨${q}ï¼Œ${productName}`);
            return productName;
        }

        function gameOver(success, msg) {
            gameState.gameOver = true;
            const el = document.getElementById('message');
            el.innerHTML = `<div>${msg}</div><div style="font-size:0.8em;margin-top:0.3em;opacity:0.8">å“è´¨:${Math.round(gameState.quality)}</div>`;
            el.className = 'message ' + (success ? 'success' : 'failure');
            el.style.display = 'block';
            document.querySelectorAll('.control-btn').forEach(btn => btn.disabled = true);
            
            setTimeout(() => {
                document.getElementById('start-alchemy-btn').classList.remove('hidden');
            }, 3000);
        }

        function resetGame() {
            gameState = { 
                temperature: 50, quality: 0, completion: 0, movesLeft: 15, 
                gameOver: false, turnCount: 0, lastEventWasNegative: false,
                alchemyStarted: false
            };
            activeEvents = [];
            document.getElementById('event-banner').innerHTML = '';
            document.getElementById('message').style.display = 'none';
            closeEventModal(); hideTooltip();
            document.querySelectorAll('.control-btn').forEach(btn => btn.disabled = true);
            document.getElementById('start-alchemy-btn').classList.remove('hidden');
            updateDisplay();
        }

        initializeControls();
        updateDisplay();
        document.querySelectorAll('.control-btn').forEach(btn => btn.disabled = true);
        document.addEventListener('click', (e) => { if(!e.target.closest('.control-btn') && !e.target.closest('.event-card')) hideTooltip(); });
    </script>
</body>
</html>
