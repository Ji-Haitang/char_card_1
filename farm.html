<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Mini Farm (4x3)</title>
  <link rel="icon" type="image/png" href="assets/image/icon/favicon.png" />
  <style>
    :root {
      /* Responsive tile size: scales between phones and desktop */
      --tile-size: clamp(44px, 12vw, 72px);
      --gap: 8px;
      --radius: 8px;
      --bg: #000000; /* 背景黑色 */
      --panel-bg: #0b0b0bcc;
      --text: #e6e6e6; /* 文字更亮以适配黑色背景 */
      --accent: rgba(0,0,0,0.7); /* 主按钮也用黑色半透明 */
      --danger: #d9534f;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", Arial, "Microsoft YaHei", sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-user-select: none; user-select: none;
    }
    header {
      position: fixed; top: 0; left: 0; right: 0;
      display: flex; align-items: center; justify-content: space-between;
      padding: calc(10px + env(safe-area-inset-top, 0px)) 14px 10px 14px; gap: 10px;
      background: linear-gradient(180deg, rgba(0,0,0,0.7), rgba(0,0,0,0.45) 60%, rgba(0,0,0,0));
      backdrop-filter: blur(4px);
      z-index: 10;
    }
    .money { font-weight: 700; color: #ffffff; }
    .money img { width: 18px; vertical-align: -3px; margin-right: 6px; }
    .header-actions { display: flex; gap: 8px; align-items: center; }
    /* removed week-badge styles */
    button {
      padding: 8px 12px; 
      border-radius: 6px; 
      border: 1px solid #ffffff; /* 改为白色边框 */
      background: #000000;
      color: #ffffff;
      cursor: pointer; 
      transition: transform .05s ease; 
      font-weight: 600;
    }
    button:active { transform: translateY(1px); }
    /* button.primary { background: rgba(0,0,0,0.7); color: #ffffff; border: 1px solid rgba(255,255,255,0.22); } */
    button.danger { background: var(--danger); color: white; border: 1px solid #ffffff; /* 添加白色边框 */ }
    button:hover {
      background: #1a1a1a; /* 悬停时稍微变亮 */
    }

    button.primary { 
      background: #000000; /* 改为纯黑色 */
      color: #ffffff; 
      border: 1px solid #ffffff; /* 改为白色边框 */
    }

    button.primary:hover {
      background: #1a1a1a;
    }
    button:disabled {
      background: #333333; /* 深灰色表示禁用 */
      color: #999999;
      cursor: not-allowed;
      opacity: 0.6;
    }
    main { 
      padding-top: calc(68px + env(safe-area-inset-top, 0px)); 
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    
    #grid {
      display: grid;
      grid-template-columns: repeat(12, var(--tile-size));
      grid-template-rows: repeat(9, var(--tile-size));
      gap: 0; /* no gaps between tiles */
      padding: 0;
      background: rgba(0,0,0,0.25);
      border-radius: var(--radius);
      width: max-content;
      position: relative; /* allow absolute-positioned trees */
    }
    #decorLayer {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 2;
    }
    .tile {
      position: relative;
      width: var(--tile-size); height: var(--tile-size);
      border-radius: 0; /* 取消单个格子的圆角 */
      overflow: visible; /* 允许3x3树跨格显示 */
      box-shadow: 0 2px 6px #0000001a inset, 0 1px 0 #ffffff59 inset;
      background: #6bbf6b;
      cursor: pointer;
      transition: transform 0.1s ease;
    }
    .tile.farm:hover {
      transform: scale(1.02);
    }
    .tile .ground { position: absolute; inset: 0; object-fit: cover; width: 100%; height: 100%; }
    .tile .crop { position: absolute; inset: 0; object-fit: contain; width: 100%; height: 100%; padding: 6px; }
    /* decorative overlay image on non-farm tiles */
    .decor { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; padding: 6px; pointer-events: none; }
    .tree3x3 { 
      position: absolute; 
      width: calc(var(--tile-size) * 3); 
      height: calc(var(--tile-size) * 3); 
      object-fit: contain; 
      pointer-events: none; 
      z-index: 2;
    }

    /* Shop overlay */
    #shopOverlay { 
      position: fixed; 
      inset: 0; 
      background: #00000066; 
      display: none; 
      align-items: center; 
      justify-content: center; 
      z-index: 20; 
      padding: 20px;
    }
    .shop { 
      width: min(720px, 100%); 
      max-height: 90vh;
      background: #fff; 
      border-radius: 10px; 
      box-shadow: 0 20px 60px #00000040; 
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .shop-header { 
      position: sticky; 
      top: 0; 
      background: rgba(0,0,0); 
      color: #ffffff;
      padding: 14px; 
      box-shadow: 0 1px 0 #0000000f;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    .shop-header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .shop .content { 
      padding: 12px; 
      display: grid; 
      gap: 12px;
      overflow-y: auto;
      flex: 1;
    }
    .shop .items { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .shop .card { 
      border: 1px solid #00000012; 
      border-radius: 8px; 
      padding: 10px; 
      text-align: center; 
      color: #000000; /* 添加黑色文字 */
    }
    .shop .card img { height: 64px; max-width: 100%; object-fit: contain; }
    .card-controls { 
      margin-top: 8px;
      display: flex;
      gap: 6px;
      justify-content: center;
    }
    .card-controls button {
      padding: 6px 10px;
      font-size: 14px;
    }

    /* Context popover */
    #popup { position: fixed; z-index: 1000; display: none; }
    .popover { min-width: 220px; max-width: min(86vw, 360px); background: #fff; border-radius: 10px; box-shadow: 0 10px 30px #00000033; border: 1px solid #00000012; overflow: hidden; }
    .popover header { padding: 10px 12px; font-weight: 700; background: #f7fafad9; border-bottom: 1px solid #0000000e; }
    .popover .body { padding: 10px; display: grid; gap: 10px; }
    .popover .choices { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .popover .choices button { display: flex; align-items: center; justify-content: center; gap: 6px; padding: 8px; flex-direction: column; }
    .popover .choices img { height: 28px; }
    .popover .actions { display: grid; grid-template-columns: 1fr; gap: 8px; }
    .popover .hint { font-size: 12px; color: #0f0f0f; text-align: center; margin-top: 4px; }
    .bar { background: #edf2f7; border-radius: 6px; height: 10px; overflow: hidden; }
    .bar > span { display:block; height: 100%; background: linear-gradient(90deg, #48bb78, #38b2ac); width: 0%; }
    .bar-row { display: grid; grid-template-columns: 72px 1fr auto; align-items: center; gap: 8px; }
    .bar-row small { 
      opacity: 1; /* 改为不透明 */
      color: #000000; /* 改为黑色 */
    }
    .muted {
      color: #000000; /* 改为黑色 */
    }

    /* 成熟高亮闪烁效果（使用 drop-shadow，围绕透明 PNG 边缘发光） */
    @keyframes glowPulseFilter {
      0% { filter: drop-shadow(0 0 0 rgba(255,215,0,0)) drop-shadow(0 0 0 rgba(255,255,200,0)); }
      50% { filter: drop-shadow(0 0 14px rgba(255,215,0,0.9)) drop-shadow(0 0 8px rgba(255,255,200,0.8)); }
      100% { filter: drop-shadow(0 0 0 rgba(255,215,0,0)) drop-shadow(0 0 0 rgba(255,255,200,0)); }
    }

    /* 新增：带灰度的高亮动画 */
    @keyframes glowPulseFilterGray {
      0% { filter: grayscale(1) brightness(0.85) drop-shadow(0 0 0 rgba(255,215,0,0)) drop-shadow(0 0 0 rgba(255,255,200,0)); }
      50% { filter: grayscale(1) brightness(0.85) drop-shadow(0 0 14px rgba(255,215,0,0.9)) drop-shadow(0 0 8px rgba(255,255,200,0.8)); }
      100% { filter: grayscale(1) brightness(0.85) drop-shadow(0 0 0 rgba(255,215,0,0)) drop-shadow(0 0 0 rgba(255,255,200,0)); }
    }

    .crop-glow {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none;
      animation: glowPulseFilter 1.2s infinite;
      z-index: 3;
    }

    /* 新增：灰度状态的高亮类 */
    .crop-glow.gray {
      animation: glowPulseFilterGray 1.2s infinite;
    }

    /* --- Responsive --- */
    @media (max-width: 640px) {
      header { flex-wrap: wrap; row-gap: 8px; }
      .money { width: 100%; }
      /* .header-actions { width: 100%; justify-content: space-between; } */
      button { padding: 12px 14px; font-size: 16px; }
      .header-actions { 
        width: 100%; 
        justify-content: space-between; 
        flex-wrap: wrap;
        gap: 6px;
      }
      .header-actions button {
        flex: 1;
        min-width: calc(33% - 4px);
        padding: 10px 8px;
        font-size: 14px;
      }
      /* Shop responsive improvements */
      #shopOverlay { padding: 0; }
      .shop { 
        width: 100%; 
        height: 100vh; 
        max-height: 100vh;
        border-radius: 0;
      }
      .shop-header {
        flex-wrap: wrap;
        gap: 10px;
      }
      .shop-header strong {
        width: 100%;
      }
      .shop-header-right {
        width: 100%;
        justify-content: space-between;
      }
      .shop-header-right .money {
        width: auto;
      }
      .shop .items { grid-template-columns: 1fr; }
      .card-controls {
        flex-wrap: wrap;
      }
      .card-controls button {
        flex: 1;
        min-width: calc(33% - 4px);
      }
      
      .popover .choices { grid-template-columns: repeat(2, 1fr); }
    }
    
    /* Small phones */
    @media (max-width: 380px) {
      .shop-header {
        padding: 12px;
      }
      .shop-header strong {
        font-size: 16px;
      }
      .shop-header-right button {
        padding: 8px 12px;
        font-size: 14px;
      }
      .money {
        font-size: 14px;
      }
      .money img {
        width: 16px;
      }
      .header-actions { 
        width: 100%; 
        justify-content: space-between; 
        flex-wrap: wrap;
        gap: 6px;
      }
      .header-actions button {
        flex: 1;
        min-width: calc(33% - 4px);
        padding: 10px 8px;
        font-size: 14px;
      }
    }
    /* 随机事件弹窗样式 */
    .event-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .event-popup {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      border: 2px solid #444;
      border-radius: 20px;
      padding: 40px;
      max-width: 480px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 
                  0 0 100px rgba(255, 255, 255, 0.1) inset;
      animation: popupBounce 0.5s ease;
    }

    @keyframes popupBounce {
      0% { transform: scale(0.8); opacity: 0; }
      60% { transform: scale(1.05); }
      100% { transform: scale(1); opacity: 1; }
    }

    .event-icon {
      font-size: 80px;
      margin-bottom: 20px;
      filter: drop-shadow(0 0 20px currentColor);
      animation: iconPulse 2s ease infinite;
    }

    @keyframes iconPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .event-title {
      color: #fff;
      font-size: 28px;
      margin: 0 0 15px;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    .event-desc {
      color: #ddd;
      font-size: 18px;
      line-height: 1.6;
      margin: 0 0 30px;
    }

    .event-confirm {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      border: none;
      padding: 12px 40px;
      font-size: 18px;
      border-radius: 30px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      transition: all 0.3s ease;
    }

    .event-confirm:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
    }

    .event-confirm:active {
      transform: translateY(0);
    }

    /* 不同事件类型的特殊样式 */
    .event-rain .event-icon { color: #64B5F6; }
    .event-rain .event-popup { 
      background: linear-gradient(135deg, #1565C0 0%, #0D47A1 100%);
      border-color: #42A5F5;
    }

    .event-locust .event-icon { color: #FF7043; }
    .event-locust .event-popup { 
      background: linear-gradient(135deg, #D84315 0%, #BF360C 100%);
      border-color: #FF5722;
    }
    .event-locust .event-confirm {
      background: linear-gradient(135deg, #FF5722 0%, #E64A19 100%);
    }

    .event-sunny .event-icon { color: #FFD54F; }
    .event-sunny .event-popup { 
      background: linear-gradient(135deg, #F9A825 0%, #F57F17 100%);
      border-color: #FFC107;
    }
    .event-sunny .event-confirm {
      background: linear-gradient(135deg, #FFC107 0%, #FFA000 100%);
    }

    .event-beast .event-icon { color: #E57373; }
    .event-beast .event-popup { 
      background: linear-gradient(135deg, #C62828 0%, #B71C1C 100%);
      border-color: #F44336;
    }
    .event-beast .event-confirm {
      background: linear-gradient(135deg, #F44336 0%, #D32F2F 100%);
    }

    /* 移动端适配 */
    @media (max-width: 640px) {
      .event-popup {
        padding: 30px 20px;
      }
      .event-icon {
        font-size: 60px;
      }
      .event-title {
        font-size: 24px;
      }
      .event-desc {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="money"><img src="assets/image/icon/money_icon.png" alt="money" /> <span id="money">500</span></div>
    <div class="header-actions">
      <button id="btnSkip" class="primary" aria-label="跳过这一周（前进一周）">跳过这一周</button>
      <button id="btnBatchDeworm" aria-label="统一除虫">统一除虫</button>
      <button id="btnBatchWater" aria-label="统一浇水">统一浇水</button>
      <button id="btnBatchFertilize" aria-label="统一施肥">统一施肥</button>
      <button id="btnShop">商店</button>
    </div>
  </header>
  <main>
    <section>
      <div id="grid" aria-label="4x3 农场网格" role="grid"></div>
    </section>
  </main>
  <!-- Event popup -->
  <div id="eventOverlay" class="event-overlay">
    <div class="event-popup">
      <div class="event-icon" id="eventIcon"></div>
      <h2 class="event-title" id="eventTitle"></h2>
      <p class="event-desc" id="eventDesc"></p>
      <button class="event-confirm" id="eventConfirm">确认</button>
    </div>
  </div>

  <!-- Shop overlay (同页内"跳转"到商店视图) -->
  <div id="shopOverlay">
    <div class="shop">
      <header class="shop-header">
        <strong>商店</strong>
        <div class="shop-header-right">
          <span class="money"><img src="assets/image/icon/money_icon.png" alt="money" /> <span id="shopMoney">0</span></span>
          <button id="btnCloseShop">返回农场</button>
        </div>
      </header>
      <div class="content">
        <div class="items" id="shopItems"></div>
      </div>
    </div>
  </div>

  <!-- Contextual popup -->
  <div id="popup"></div>


  <script>
    // --- Assets and crop config ---
    const CROPS = {
      wheat: {
        id: 'wheat', name: '小麦', maturityRequired: 6, basePrice: 75, baseSell: 360,
        images: [0,1,2,3,4,5,6].map(i => `assets/image/crops/wheat${i}.png`)
      },
      eggplant: {
        id: 'eggplant', name: '茄子', maturityRequired: 8, basePrice: 115, baseSell: 560,
        images: [0,1,2,3,4,5,6].map(i => `assets/image/crops/eggplant${i}.png`)
      },
      melon: {
        id: 'melon', name: '甜瓜', maturityRequired: 10, basePrice: 165, baseSell: 825,
        images: [0,1,2,3,4,5,6].map(i => `assets/image/crops/melon${i}.png`)
      },
      sugarcane: {
        id: 'sugarcane', name: '甘蔗', maturityRequired: 12, basePrice: 240, baseSell: 1200,
        images: [0,1,2,3,4,5,6].map(i => `assets/image/crops/sugarcane${i}.png`)
      }
    };
    
    // Embedded layout: edit this to change initial surrounding decor
    const EMBEDDED_LAYOUT = {
      scene: { rows: 9, cols: 12 },
      farm: { rows: 3, cols: 4 },
      decor: {
        trees: [
          { r: 2, c: 2 },
          { r: 2, c: 6 },
          { r: 3, c: 3 },
          { r: 3, c: 8 },
          { r: 4, c: 10 },
          { r: 5, c: 2 },
          { r: 5, c: 9 },
          { r: 7, c: 1 },
          { r: 7, c: 10 },
          { r: 8, c: 5 }
        ],
        singles: [
          { r: 0, c: 1, type: 'plant0' },
          { r: 0, c: 2, type: 'plant0' },
          { r: 0, c: 3, type: 'plant0' },
          { r: 0, c: 5, type: 'rock0' },
          { r: 0, c: 7, type: 'trunk0' },
          { r: 0, c: 9, type: 'rock0' },
          { r: 0, c: 10, type: 'plant0' },
          { r: 0, c: 11, type: 'plant0' },
          { r: 1, c: 2, type: 'rock0' },
          { r: 1, c: 3, type: 'plant0' },
          { r: 1, c: 4, type: 'plant0' },
          { r: 1, c: 5, type: 'rock0' },
          { r: 1, c: 10, type: 'plant0' },
          { r: 1, c: 11, type: 'trunk0' },
          { r: 2, c: 1, type: 'rock0' },
          { r: 2, c: 3, type: 'rock0' },
          { r: 2, c: 4, type: 'trunk0' },
          { r: 2, c: 7, type: 'rock0' },
          { r: 2, c: 8, type: 'plant0' },
          { r: 2, c: 9, type: 'plant0' },
          { r: 2, c: 11, type: 'trunk0' },
          { r: 3, c: 0, type: 'plant0' },
          { r: 3, c: 9, type: 'trunk0' },
          { r: 3, c: 11, type: 'rock0' },
          { r: 4, c: 0, type: 'rock0' },
          { r: 4, c: 3, type: 'plant0' },
          { r: 4, c: 10, type: 'plant0' },
          { r: 4, c: 11, type: 'rock0' },
          { r: 5, c: 0, type: 'trunk0' },
          { r: 5, c: 10, type: 'plant0' },
          { r: 5, c: 11, type: 'trunk0' },
          { r: 6, c: 0, type: 'rock0' },
          { r: 6, c: 2, type: 'plant0' },
          { r: 6, c: 4, type: 'plant0' },
          { r: 6, c: 5, type: 'rock0' },
          { r: 6, c: 6, type: 'rock0' },
          { r: 6, c: 8, type: 'rock0' },
          { r: 6, c: 10, type: 'trunk0' },
          { r: 6, c: 11, type: 'rock0' },
          { r: 7, c: 0, type: 'rock0' },
          { r: 7, c: 2, type: 'plant0' },
          { r: 7, c: 5, type: 'rock0' },
          { r: 7, c: 6, type: 'rock0' },
          { r: 7, c: 9, type: 'plant0' },
          { r: 8, c: 0, type: 'trunk0' },
          { r: 8, c: 2, type: 'trunk0' },
          { r: 8, c: 3, type: 'plant0' },
          { r: 8, c: 4, type: 'trunk0' },
          { r: 8, c: 8, type: 'rock0' },
          { r: 8, c: 9, type: 'rock0' }
        ]
      }
    };

    // --- Game state ---
    const state = {
      week: 1,
      money: 500,
      inventory: { wheat: 0, melon: 0, eggplant: 0, sugarcane: 0 },
      grid: [], // 3x4 farm plots
      selected: null, // {r,c}
      decor: { trees: [], singles: [] } // store surrounding random decorations
    };

    function createEmptyPlot() {
      return {
        planted: false,
        cropId: null,
        maturity: 0,
        health: 100,
        quality: 0,
        interactedThisWeek: false
      };
    }

    // --- DOM refs ---
    const elGrid = document.getElementById('grid');
    const elMoney = document.getElementById('money');
    const elWeek = null; // week badge removed
    const elShopOverlay = document.getElementById('shopOverlay');
    const elShopItems = document.getElementById('shopItems');
    const elShopMoney = document.getElementById('shopMoney');

    // --- Initialize grid (no random decor) ---
    async function initGrid() {
      // Build a 12x9 scene with a centered 4x3 farmable area.
      const sceneRows = 9, sceneCols = 12;
      const farmRows = 3, farmCols = 4;
      const farmTop = Math.floor((sceneRows - farmRows) / 2);
      const farmLeft = Math.floor((sceneCols - farmCols) / 2);

      // state.grid will be 3x4 to store farm plots
      state.grid = Array.from({ length: farmRows }, () => Array.from({ length: farmCols }, () => createEmptyPlot()));

      elGrid.innerHTML = '';
      state.decor = { trees: [], singles: [] };
      // Create a layer for large decorations to avoid interfering with tile indexing
      window.__decorLayerEl = document.createElement('div');
      __decorLayerEl.id = 'decorLayer';
      for (let r = 0; r < sceneRows; r++) {
        for (let c = 0; c < sceneCols; c++) {
          const tile = document.createElement('div');
          tile.className = 'tile';
          tile.dataset.sceneR = r; tile.dataset.sceneC = c;

          const isFarm = r >= farmTop && r < farmTop + farmRows && c >= farmLeft && c < farmLeft + farmCols;

          const ground = document.createElement('img');
          ground.className = 'ground';
          ground.src = isFarm ? 'assets/image/ground/grass_farm.png' : 'assets/image/ground/grass.png';
          tile.appendChild(ground);

          if (isFarm) {
            tile.classList.add('farm');
            const crop = document.createElement('img');
            crop.className = 'crop'; crop.style.display = 'none';
            tile.appendChild(crop);

            const farmR = r - farmTop;
            const farmC = c - farmLeft;
            tile.dataset.r = farmR; tile.dataset.c = farmC;
            tile.setAttribute('role', 'gridcell');
            tile.setAttribute('tabindex', '0');
            tile.addEventListener('click', onTileClick);
            tile.addEventListener('keydown', (ev) => { if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); onTileClick({ currentTarget: tile }); } });
          } else {
            // Non-farm tiles: decor will be applied from embedded layout below
          }

          elGrid.appendChild(tile);
        }
      }
      // Append overlay layer last so it visually sits above ground tiles but below popups
      elGrid.appendChild(__decorLayerEl);
      // Apply embedded layout and render
      applyLayoutData(EMBEDDED_LAYOUT);
      renderDecorFromState();
      renderAll();
      // Recalculate tree positions on viewport changes (resize/orientation)
      window.addEventListener('resize', recalcTreePositions);
      window.addEventListener('orientationchange', recalcTreePositions);
    }

    function onTileClick(e) {
      const tile = e.currentTarget;
      if (tile.dataset.r == null || tile.dataset.c == null) return; // ignore non-farm tiles
      const r = Number(tile.dataset.r), c = Number(tile.dataset.c);
      state.selected = { r, c };
      openTilePopup(tile, r, c);
    }

    // --- Rendering ---
    function renderAll() {
      elMoney.textContent = state.money;
      // week badge removed

      const sceneRows = 9, sceneCols = 12;
      const farmRows = 3, farmCols = 4;
      const farmTop = Math.floor((sceneRows - farmRows) / 2);
      const farmLeft = Math.floor((sceneCols - farmCols) / 2);
      for (let r = 0; r < farmRows; r++) {
        for (let c = 0; c < farmCols; c++) {
          renderTile(r, c, farmTop, farmLeft, sceneCols);
        }
      }
    }

    function stageIndexFor(plot) {
      if (!plot.planted) return 0;
      const cfg = CROPS[plot.cropId];
      const ratio = Math.min(1, plot.maturity / cfg.maturityRequired);
      return Math.min(6, Math.round(ratio * 6));
    }

    function renderTile(r, c, farmTop, farmLeft, sceneCols) {
      const plot = state.grid[r][c];
      // Query by farm coordinates to avoid index issues caused by overlay elements
      const tile = elGrid.querySelector(`.tile.farm[data-r="${r}"][data-c="${c}"]`);
      const cropImg = tile.querySelector('.crop');
      if (plot.planted) {
        const idx = stageIndexFor(plot);
        cropImg.src = CROPS[plot.cropId].images[idx];
        cropImg.style.display = '';
        // 保持灰度与高亮可共存：灰度直接应用于作物 img，发光使用额外的 overlay img
        cropImg.style.filter = plot.health < 50 ? 'grayscale(1) brightness(0.85)' : 'none';
        const cfg = CROPS[plot.cropId];
        const mature = plot.maturity >= cfg.maturityRequired;
        let glow = tile.querySelector('.crop-glow');
        if (mature) {
          if (!glow) {
            glow = document.createElement('img');
            glow.className = 'crop-glow';
            tile.appendChild(glow);
          }
          glow.src = cropImg.src;
          glow.style.display = '';
          // 修复：使用class切换而不是直接设置style.filter
          if (plot.health < 50) {
            glow.classList.add('gray');
          } else {
            glow.classList.remove('gray');
          }
        } else if (glow) {
          glow.style.display = 'none';
        }
      } else {
        cropImg.style.display = 'none';
        const glow = tile.querySelector('.crop-glow');
        if (glow) glow.style.display = 'none';
      }
    }

    // Prevent tree placement overlapping the farm bounding box
    function canPlaceTree3x3(r, c, sceneRows, sceneCols, farmTop, farmLeft, farmRows, farmCols) {
      // Anchor will be the bottom-center of the 3x3 area at (r,c)
      // The 3x3 spans rows r-2..r and cols c-1..c+1
      if (r - 2 < 0 || c - 1 < 0 || r >= sceneRows || c + 1 >= sceneCols) return false;
      const spanTop = r - 2;
      const spanBottom = r;
      const spanLeft = c - 1;
      const spanRight = c + 1;
      const farmBottom = farmTop + farmRows - 1;
      const farmRight = farmLeft + farmCols - 1;
      const overlap = !(spanRight < farmLeft || spanLeft > farmRight || spanBottom < farmTop || spanTop > farmBottom);
      return !overlap;
    }

    function placeTree3x3(r, c) {
      const img = document.createElement('img');
      img.className = 'tree3x3';
      img.src = Math.random() < 0.5 ? 'assets/image/static/tree0.png' : 'assets/image/static/tree1.png';
      // Save anchor for responsive repositioning
      img.dataset.r = String(r);
      img.dataset.c = String(c);
      positionTreeImage(img);
      // Append to decor overlay layer so it does not affect tile indexing
      if (window.__decorLayerEl) __decorLayerEl.appendChild(img); else elGrid.appendChild(img);
    }

    function positionTreeImage(img) {
      const r = Number(img.dataset.r);
      const c = Number(img.dataset.c);
      const refTile = elGrid.children[0];
      const tileSize = refTile ? refTile.getBoundingClientRect().width : parseFloat(getComputedStyle(elGrid).getPropertyValue('--tile-size')) || 64;
      const leftPx = (c - 1) * tileSize;
      const topPx = (r - 2) * tileSize;
      img.style.left = leftPx + 'px';
      img.style.top = topPx + 'px';
    }

    function recalcTreePositions() {
      const nodes = (window.__decorLayerEl || elGrid).querySelectorAll('.tree3x3');
      nodes.forEach(positionTreeImage);
    }

    function recordTree(r, c) {
      state.decor.trees.push({ r, c, type: 'tree3x3' });
    }
    function recordDecor(r, c, kind) {
      state.decor.singles.push({ r, c, type: kind });
    }

    // 添加事件弹窗相关的函数
    function showEventPopup(eventType, title, description) {
      const overlay = document.getElementById('eventOverlay');
      const icon = document.getElementById('eventIcon');
      const titleEl = document.getElementById('eventTitle');
      const descEl = document.getElementById('eventDesc');
      
      // 设置不同事件的图标和样式
      const eventConfig = {
        rain: { icon: '🌧️', class: 'event-rain' },
        locust: { icon: '🦗', class: 'event-locust' },
        sunny: { icon: '☀️', class: 'event-sunny' },
        beast: { icon: '🐺', class: 'event-beast' }
      };
      
      const config = eventConfig[eventType] || { icon: '📢', class: '' };
      
      // 移除之前的类名
      overlay.className = 'event-overlay ' + config.class;
      
      // 设置内容
      icon.textContent = config.icon;
      titleEl.textContent = title;
      descEl.innerHTML = description;
      
      // 显示弹窗
      overlay.style.display = 'flex';
    }

    // 绑定确认按钮
    document.getElementById('eventConfirm').addEventListener('click', () => {
      document.getElementById('eventOverlay').style.display = 'none';
    });
    // --- Weekly tick ---
    function skipWeek() {
      state.week++;
      
      // 随机事件系统
      const eventRoll = Math.random();
      let eventType = null;
      let extraMaturity = 1; // 默认成熟度增加1
      let extraHealthLoss = 0; // 额外健康损失
      let extraQuality = 0; // 额外品质增加
      
      if (eventRoll < 0.20) {
        // 20%概率：雨水充沛
        eventType = 'rain';
        extraMaturity = 2;
        showEventPopup('rain', '雨水充沛', '这一周雨水充沛，作物长势良好！<br>所有作物成熟度额外+1');
      } else if (eventRoll < 0.30) {
        // 10%概率：蝗虫过境
        eventType = 'locust';
        extraHealthLoss = 30;
        showEventPopup('locust', '蝗虫过境', '这一周蝗虫过境，作物遭到残害！<br>所有作物健康值额外-30');
      } else if (eventRoll < 0.40) {
        // 10%概率：风和日丽
        eventType = 'sunny';
        extraQuality = 20;
        showEventPopup('sunny', '风和日丽', '这一周风和日丽，作物丰收在望！<br>所有作物品质+20');
      } else if (eventRoll < 0.45) {
        // 5%概率：野兽出没
        eventType = 'beast';
        // 找出所有种植的作物
        const plantedPlots = [];
        for (let r = 0; r < 3; r++) {
          for (let c = 0; c < 4; c++) {
            if (state.grid[r][c].planted) {
              plantedPlots.push({r, c});
            }
          }
        }
        if (plantedPlots.length > 0) {
          const victim = plantedPlots[Math.floor(Math.random() * plantedPlots.length)];
          state.grid[victim.r][victim.c].health = 0;
          showEventPopup('beast', '野兽出没', `这一周有野兽出没，田里一片狼藉！<br>位置(${victim.r+1},${victim.c+1})的作物被摧毁`);
        }
      }
      
      // 处理每个地块
      const farmRows = 3, farmCols = 4;
      for (let r = 0; r < farmRows; r++) {
        for (let c = 0; c < farmCols; c++) {
          const plot = state.grid[r][c];
          plot.interactedThisWeek = false;
          if (!plot.planted) continue;
          
          // 应用事件效果
          plot.maturity += extraMaturity;
          
          // 健康度下降（基础10-20 + 额外损失）
          plot.health = Math.max(0, plot.health - (10 + Math.floor(Math.random() * 11)) - extraHealthLoss);
          
          // 品质增加（允许超过100）
          if (eventType === 'sunny') {
            plot.quality += extraQuality;
          }
          
          // 检查是否死亡
          if (plot.health <= 0) {
            Object.assign(plot, createEmptyPlot());
            continue;
          }
          
          // 检查是否过熟腐烂
          const cfg = CROPS[plot.cropId];
          if (plot.maturity > cfg.maturityRequired + 5) {
            Object.assign(plot, createEmptyPlot());
            continue;
          }
        }
      }
      
      renderAll();
    }

    // --- Actions ---
    function ensureSelectedPlot() {
      if (!state.selected) return null;
      const { r, c } = state.selected;
      return state.grid[r][c];
    }

    function withOneInteraction(fn) {
      const plot = ensureSelectedPlot();
      if (!plot || !plot.planted || plot.interactedThisWeek) return;
      fn(plot);
      plot.interactedThisWeek = true;
      renderAll();
      closePopup();
      // Reopen popup to show updated state
      const tile = elGrid.children[state.selected.r * 5 + state.selected.c];
      openTilePopup(tile, state.selected.r, state.selected.c);
    }

    function doWater() {
      withOneInteraction(plot => {
        plot.maturity += 1; // extra growth
      });
    }
    function doDeworm() {
      withOneInteraction(plot => {
        // 除虫恢复30-50健康（期望40）
        plot.health = Math.min(100, plot.health + 30 + Math.floor(Math.random() * 21));
      });
    }
    function doFertilize() {
      const cost = 5;
      if (state.money < cost) {
        alert(`施肥需要 $${cost}，金钱不足！`);
        return;
      }
      
      withOneInteraction(plot => {
        state.money -= cost;
        // 施肥增加10-30品质（可以超过100）
        plot.quality += 10 + Math.floor(Math.random() * 21);
        elMoney.textContent = state.money;
      });
    }

    function doHarvest() {
      const plot = ensureSelectedPlot();
      if (!plot || !plot.planted) return;
      const cfg = CROPS[plot.cropId];
      if (plot.maturity < cfg.maturityRequired) {
        alert('尚未成熟，不能收割');
        return;
      }
      if (plot.health < 50) {
        alert('作物健康度过低（<50），不能收割！请先除虫。');
        return;
      }
      // 售价公式：baseSell × (1 + min(quality,100)/100)
      const effectiveQuality = Math.min(100, plot.quality);
      const price = Math.round(cfg.baseSell * (1 + (effectiveQuality / 100)));
      state.money += price;
      Object.assign(plot, createEmptyPlot());
      renderAll();
      closePopup();
    }

    // --- Planting from inventory ---
    function tryPlant(seedId) {
      if (!state.selected) return;
      if (state.inventory[seedId] <= 0) return;
      const { r, c } = state.selected;
      const plot = state.grid[r][c];
      if (plot.planted) return;
      plot.planted = true;
      plot.cropId = seedId;
      plot.maturity = 0;
      plot.health = 100;
      plot.quality = 0;
      plot.interactedThisWeek = false;
      state.inventory[seedId] -= 1;
      renderAll();
      closePopup();
    }

    // --- Shop ---
    function openShop() {
      elShopMoney.textContent = state.money;
      elShopItems.innerHTML = '';
      Object.values(CROPS).forEach(cfg => {
        const card = document.createElement('div');
        card.className = 'card';
        const img = document.createElement('img'); img.src = cfg.images[6]; img.alt = cfg.name;
        const name = document.createElement('div'); name.textContent = cfg.name + '种子'; // 添加"种子"
        const price = document.createElement('div'); price.className = 'muted'; price.textContent = `价格：$${cfg.basePrice}/包`;
        const controls = document.createElement('div'); 
        controls.className = 'card-controls';
        
        const buy1 = document.createElement('button'); buy1.textContent = '买 1';
        const buy5 = document.createElement('button'); buy5.textContent = '买 5';
        const buy10 = document.createElement('button'); buy10.textContent = '买 10';
        
        [buy1, buy5, buy10].forEach((btn, idx) => {
          const qty = [1,5,10][idx];
          btn.addEventListener('click', () => {
            const cost = cfg.basePrice * qty;
            if (state.money < cost) { alert('金钱不足'); return; }
            state.money -= cost;
            state.inventory[cfg.id] += qty;
            elShopMoney.textContent = state.money;
            renderAll();
          });
        });
        controls.append(buy1, buy5, buy10);
        card.append(img, name, price, controls);
        elShopItems.appendChild(card);
      });
      elShopOverlay.style.display = 'flex';
    }

    function closeShop() { elShopOverlay.style.display = 'none'; }

    // --- Wire events ---
    document.getElementById('btnSkip').addEventListener('click', skipWeek);
    document.getElementById('btnShop').addEventListener('click', openShop);
    // document.getElementById('btnExport').addEventListener('click', exportLayout);
    document.getElementById('btnCloseShop').addEventListener('click', closeShop);
    // 添加批量操作按钮的事件监听器
    document.getElementById('btnBatchDeworm').addEventListener('click', batchDeworm);
    document.getElementById('btnBatchWater').addEventListener('click', batchWater);
    document.getElementById('btnBatchFertilize').addEventListener('click', batchFertilize);

    // --- Kickoff ---
    initGrid();
    renderAll();

    // ====== Export/Import helpers ======
    function exportLayout() {
      const data = {
        scene: { rows: 9, cols: 12 },
        farm: { rows: 3, cols: 4 },
        decor: state.decor
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const ts = new Date().toISOString().replace(/[:.]/g, '-');
      a.download = `layout-${ts}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // 添加新的批量操作函数：
    function batchDeworm() {
      let count = 0;
      for (let r = 0; r < 3; r++) {
        for (let c = 0; c < 4; c++) {
          const plot = state.grid[r][c];
          if (plot.planted && plot.health < 50 && !plot.interactedThisWeek) {
            plot.health = Math.min(100, plot.health + 50);
            plot.interactedThisWeek = true;
            count++;
          }
        }
      }
      renderAll();
      if (count > 0) {
        alert(`已对 ${count} 个作物执行除虫操作`);
      } else {
        alert('没有符合条件的作物需要除虫');
      }
    }

    function batchWater() {
      let count = 0;
      for (let r = 0; r < 3; r++) {
        for (let c = 0; c < 4; c++) {
          const plot = state.grid[r][c];
          if (plot.planted && !plot.interactedThisWeek) {
            plot.maturity += 1;
            plot.interactedThisWeek = true;
            count++;
          }
        }
      }
      renderAll();
      if (count > 0) {
        alert(`已对 ${count} 个作物执行浇水操作`);
      } else {
        alert('没有符合条件的作物需要浇水');
      }
    }

    function batchFertilize() {
      let count = 0;
      let eligiblePlots = [];
      
      for (let r = 0; r < 3; r++) {
        for (let c = 0; c < 4; c++) {
          const plot = state.grid[r][c];
          if (plot.planted && !plot.interactedThisWeek) {
            eligiblePlots.push(plot);
          }
        }
      }
      
      const cost = 5 * eligiblePlots.length;
      
      if (eligiblePlots.length === 0) {
        alert('没有符合条件的作物需要施肥');
        return;
      }
      
      if (state.money < cost) {
        alert(`统一施肥需要 $${cost}，金钱不足！`);
        return;
      }
      
      state.money -= cost;
      eligiblePlots.forEach(plot => {
        // 可以超过100
        plot.quality += 10 + Math.floor(Math.random() * 21);
        plot.interactedThisWeek = true;
        count++;
      });
      
      renderAll();
      alert(`已对 ${count} 个作物执行施肥操作，花费 $${cost}`);
    }

    function applyLayoutData(data) {
      if (!data || !data.decor) return;
      state.decor.trees = (data.decor.trees || []).map(t => ({ r: t.r, c: t.c, type: t.type || 'tree3x3' }));
      state.decor.singles = (data.decor.singles || []).map(s => ({ r: s.r, c: s.c, type: s.type }));
    }

    function renderDecorFromState() {
      if (window.__decorLayerEl) __decorLayerEl.innerHTML = '';
      // Singles
      state.decor.singles.forEach(({ r, c, type }) => {
        const tile = elGrid.querySelector(`.tile[data-scene-r="${r}"][data-scene-c="${c}"]`);
        if (!tile) return;
        const decor = document.createElement('img');
        decor.className = 'decor';
        decor.src = `assets/image/static/${type}.png`;
        tile.appendChild(decor);
      });
      // Trees 3x3
      state.decor.trees.forEach(({ r, c }) => placeTree3x3(r, c));
    }

    // ====== Popup helpers ======
    const popupRoot = document.getElementById('popup');

    function closePopup() {
      popupRoot.style.display = 'none';
      popupRoot.innerHTML = '';
      document.removeEventListener('keydown', escCloseHandler);
      document.removeEventListener('click', outsideClickHandler, true);
      window.removeEventListener('resize', handleViewportChange);
      window.removeEventListener('scroll', handleViewportChange, true);
    }

    function escCloseHandler(ev) { if (ev.key === 'Escape') closePopup(); }
    function outsideClickHandler(ev) {
      if (!popupRoot.contains(ev.target)) closePopup();
    }
    function handleViewportChange() { clampPopupToViewport(); recalcTreePositions(); }

    function openTilePopup(tile, r, c) {
      const plot = state.grid[r][c];
      const rect = tile.getBoundingClientRect();
      const x = rect.left + rect.width / 2;
      const y = rect.top + rect.height + 6; // below tile
      if (!plot.planted) {
        openSeedPopup({ x, y, r, c });
      } else {
        openActionPopup({ x, y, r, c });
      }
    }

    function openSeedPopup({ x, y, r, c }) {
      const content = document.createElement('div');
      content.className = 'popover';
      content.innerHTML = `
        <div class="body">
          <div class="choices">
            ${seedButtonHTML('wheat')}
            ${seedButtonHTML('melon')}
            ${seedButtonHTML('eggplant')}
            ${seedButtonHTML('sugarcane')}
          </div>
          <div class="hint">点击种子在此地块种植</div>
        </div>
      `;
      showPopupAt(content, x, y);
      bindSeedButtons();
    }

    function openActionPopup({ x, y, r, c }) {
      const plot = state.grid[r][c];
      const cfg = plot.planted ? CROPS[plot.cropId] : null;
      const canInteract = plot.planted && !plot.interactedThisWeek;
      const canHarvest = plot.planted && plot.maturity >= cfg.maturityRequired;
      
      let hint = '';
      if (plot.interactedThisWeek) {
        hint = '<div class="hint">本周已与该作物交互一次</div>';
      } else if (!canHarvest && plot.maturity < cfg.maturityRequired) {
        hint = '<div class="hint">作物尚未成熟</div>';
      }
      
      const content = document.createElement('div');
      content.className = 'popover';
      content.innerHTML = `
        <div class="body">
          ${progressBarsHTML(plot)}
          <div class="actions">
            <button id="pActWater" ${!canInteract ? 'disabled' : ''}>浇水（+1成熟）</button>
            <button id="pActDeworm" ${!canInteract ? 'disabled' : ''}>除虫（+30~50健康）</button>
            <button id="pActFertilize" ${!canInteract ? 'disabled' : ''}>施肥（+10~30品质，$5）</button>
            <button id="pActHarvest" class="primary" ${!canInteract || !canHarvest ? 'disabled' : ''}>收割</button>
          </div>
          ${hint}
        </div>
      `;
      showPopupAt(content, x, y);
      // document.getElementById('btnBatchDeworm').addEventListener('click', batchDeworm);
      // document.getElementById('btnBatchWater').addEventListener('click', batchWater);
      // document.getElementById('btnBatchFertilize').addEventListener('click', batchFertilize);
      document.getElementById('pActWater').addEventListener('click', () => { doWater(); });
      document.getElementById('pActDeworm').addEventListener('click', () => { doDeworm(); });
      document.getElementById('pActFertilize').addEventListener('click', () => { doFertilize(); });
      document.getElementById('pActHarvest').addEventListener('click', () => { doHarvest(); });
    }

    function seedButtonHTML(id) {
      const cfg = CROPS[id];
      const qty = state.inventory[id];
      const disabled = qty <= 0 ? 'disabled' : '';
      return `
        <button class="seed-btn" data-seed="${id}" ${disabled}>
          <img src="${cfg.images[6]}" alt="${cfg.name}" />
          <span>${cfg.name}</span>
          <small>×${qty}</small>
        </button>
      `;
    }

    function bindSeedButtons() {
      popupRoot.querySelectorAll('.seed-btn').forEach(btn => {
        btn.addEventListener('click', () => tryPlant(btn.dataset.seed));
      });
    }

    function progressBarsHTML(plot) {
      if (!plot || !plot.planted) {
        return `<div class="muted">暂无作物数据</div>`;
      }
      const cfg = CROPS[plot.cropId];
      const mRatio = Math.min(1, plot.maturity / cfg.maturityRequired);
      const hRatio = Math.min(1, plot.health / 100);
      const qRatio = Math.min(1, plot.quality / 100); // 进度条最多显示到100%
      
      // 添加过熟警告
      const overripeWarning = plot.maturity > cfg.maturityRequired ? 
        `<div class="hint" style="color: #d9534f;">警告：成熟度${plot.maturity}/${cfg.maturityRequired+5}，即将腐烂！</div>` : '';
      
      return `
        <div class="bar-row"><small>成熟度</small><div class="bar"><span style="width:${Math.round(mRatio*100)}%"></span></div><small>${plot.maturity}/${cfg.maturityRequired}</small></div>
        <div class="bar-row"><small>健康值</small><div class="bar"><span style="width:${Math.round(hRatio*100)}%"></span></div><small>${plot.health}</small></div>
        <div class="bar-row"><small>品质</small><div class="bar"><span style="width:${Math.round(qRatio*100)}%"></span></div><small>${plot.quality}</small></div>
        ${overripeWarning}
      `;
    }

    function showPopupAt(contentEl, x, y) {
      popupRoot.innerHTML = '';
      popupRoot.appendChild(contentEl);
      popupRoot.style.display = 'block';
      popupRoot.style.visibility = 'hidden';
      // initial position
      popupRoot.style.left = `${x}px`;
      popupRoot.style.top = `${y}px`;
      // measure
      requestAnimationFrame(() => {
        clampPopupToViewport(x, y);
        popupRoot.style.visibility = 'visible';
      });
      document.addEventListener('keydown', escCloseHandler);
      // Defer outside click binding to avoid closing immediately on the opening click
      setTimeout(() => {
        document.addEventListener('click', outsideClickHandler, true);
      }, 0);
      window.addEventListener('resize', handleViewportChange);
      window.addEventListener('scroll', handleViewportChange, true);
    }

    function clampPopupToViewport(x, y) {
      const pad = 8;
      const w = popupRoot.offsetWidth;
      const h = popupRoot.offsetHeight;
      let left = (x ?? parseFloat(popupRoot.style.left)) - w/2;
      let top = (y ?? parseFloat(popupRoot.style.top));
      // If going out of bottom, flip above
      if (top + h + pad > window.innerHeight) {
        top = top - h - 16;
      }
      // Clamp to viewport
      left = Math.max(pad, Math.min(window.innerWidth - w - pad, left));
      top = Math.max(pad, Math.min(window.innerHeight - h - pad, top));
      popupRoot.style.left = `${Math.round(left)}px`;
      popupRoot.style.top = `${Math.round(top)}px`;
      // Reposition trees as viewport/tile size may change
      recalcTreePositions();
    }
  </script>
</body>
</html>
