/**
 * special-event.js - 特殊事件管理
 * 
 * 文件概述：
 * 定义和管理特殊事件，在跳过一周或选择"特殊剧情"选项时检查条件并触发符合条件的事件。
 * 支持复杂的条件检查、变量修改、预设文本发送和事件链触发。
 * 
 * 主要功能：
 * 1. 定义特殊事件数据结构（支持事件链）
 * 2. 检查事件触发条件（支持嵌套变量路径）
 * 3. 应用事件效果（修改游戏变量，支持set/add/push操作）
 * 4. 发送预设的事件文本（SLG_MODE格式）
 * 5. 防止事件重复触发
 * 6. 支持通过currentSpecialEvent实现事件链
 * 
 * 对外暴露的主要函数：
 * - checkSpecialEvents(): 检查是否有符合条件的特殊事件（按优先级排序）
 * - triggerSpecialEvent(event, options): 触发指定的特殊事件
 * - getTriggeredEvents(): 获取已触发的事件ID列表
 * - resetEventTrigger(eventId): 重置指定事件的触发状态
 * 
 * 内部函数：
 * - getValueByPath(path): 根据路径获取变量值（支持嵌套如"npcFavorability.C"）
 * - setValueByPath(path, newValue): 根据路径设置变量值
 * - checkCondition(value, condition, path): 检查单个条件是否满足
 * - checkEventConditions(event): 检查事件的所有条件
 * - applyEventEffects(event): 应用事件效果
 * - markEventTriggered(eventId): 标记事件已触发
 * 
 * 事件数据结构说明：
 * - id: 唯一标识符（用于防重复和事件链）
 * - name: 事件名称（调试用）
 * - priority: 优先级（数字越大越优先）
 * - conditions: 触发条件对象（支持min/max/equals/in检查）
 * - effects: 效果对象（支持set/add/push操作）
 * - text: 预设文本（SLG_MODE格式）
 * 
 * 依赖关系：
 * - 依赖 game-state.js 中的状态变量
 * - 依赖 game-utils.js 中的渲染环境检测函数
 * - 依赖 game-events.js 中的parseLLMResponse函数
 */

// ==================== 特殊事件定义 ====================
/**
 * 事件数据结构说明：
 * {
 *   id: string,           // 唯一标识符，用于防止重复触发
 *   name: string,         // 事件名称（调试用）
 *   priority: number,     // 优先级，数字越大越优先检查
 *   conditions: {         // 触发条件，全部满足才触发
 *     variablePath: {     // 变量路径，支持嵌套如 "npcFavorability.C"
 *       min: number,      // 最小值（可选）
 *       max: number,      // 最大值（可选）
 *       equals: any,      // 精确匹配（可选）
 *       in: array         // 值在数组中（可选）
 *     }
 *   },
 *   effects: {            // 触发后的变量修改
 *     variablePath: value | { add: number } | { set: value }
 *   },
 *   text: string          // 要发送的预设文本（SLG_MODE格式）
 * }
 */

const specialEvents = [
    {
        id: "Apprenticeship_Storyline_1",
        name: "拜师苓雪妃1",
        priority: 100,
        conditions: {
            currentWeek: { min: 4 }  // 第4周（第一个月末）
        },
        effects: {
            GameMode: { set: 1 },
            inputEnable: { set: 0 },
            mapLocation: { set: '天山派外堡' },  
            companionNPC: { push: '苓雪妃' }
        }, 
        text: `<SLG_MODE>

<MAIN_TEXT>
新的一周，某日，官道上，阳光有些刺眼。你骑在马上，感觉屁股都快颠成八瓣了——这该死的劣马，跑起来跟抽风似的，四条腿各干各的，仿佛它们之间有什么深仇大恨。同行的是四个和你一样刚入门不久的外门弟子，大家都穿着劲装便服，腰间挎着长剑，看上去倒是有几分江湖中人的样子。|none|沙漠|none|none

你左侧那个叫阿福的少年小声问道：「师兄，咱们和车队约好碰头的地方就是前面的驿站吗？」他遥指远处那座破败的驿站。你点头回应，这次下山，你们领命去接应采买粮食的车队，照理说只是再寻常不过的日常，但是不知为何，从刚才开始你心中一阵忐忑不安——就像小时候偷吃了供桌上的贡品，总觉得下一秒就要遭报应。但你什么也没说，只是下意识地握紧了剑柄。|none|沙漠|none|none

很快你们策马抵达了驿站。破败的土墙，坍塌的门楼，周围是枯黄的戈壁草滩，风吹过，卷起细碎的沙砾，打在脸上生疼。周围太安静了，官道上连个人影都没有，驿站里也没有半点动静。按理说，车队应该早就到了才对。你发现驿站门前的官道上有车辙印，看深浅应该不出半日，但是车队却不见踪迹……你心跳突然加速：「不对，这里有问题——」|none|废墟|none|none

砰！一声闷响，阿福突然从马上栽了下去，胸口插着一支箭羽还在颤动的重箭。你的喊声还没出口，破空声已经从四面八方响起，密集的箭雨如蝗群般破空而来。你本能地侧身，一支箭矢擦着你的肩膀飞过，带起一片布料。身后传来惨叫——你回头一看，一名师兄连人带马轰然倒地，三支箭同时命中了他，肩膀、大腿、还有一支直接钉在了马背上。|none|沙漠|none|none

「该死！」你猛地拨转马头，「快跑！往回——」话还没说完，官道两侧的沙丘后涌出一队全副武装的骑兵。黑色的战甲，猩红的披风，手持弯刀和强弓——是西夏擒生军！至少有三十骑！为首那个军官脸上带着狰狞的笑容，用生硬的汉语喊道：「天山派的崽子们！今天一个都别想跑！」你的脑子瞬间转了起来：车队恐怕已经全灭，敌军早就埋伏好了——情报泄露了！这是个陷阱！「跑！」你嘶吼道，「分散跑！回门派求援！」|none|沙漠|none|none

追兵的马蹄声在身后响起，如同滚雷。你拼命地挥动缰绳，恨不得自己也长出四条腿。余光瞥见身后的擒生军熟练地在马上张弓搭箭，破空声再次响起！你下意识地俯身，一支箭矢擦着头顶飞过，射断了几根头发。心脏在胸腔里狂跳，喉咙发干，冷汗顺着脊背往下流。你左后方的师弟惨叫一声，被一箭射中后背，从马上翻滚下去。现在只剩你和另一个叫狗娃的少年了。|none|沙漠|none|none

「不要回头！」你嘶吼，「跑！告诉门派！擒生军摸清了咱们的运粮路线！」你们疯狂地策马狂奔，身后的追兵越来越近，你能听到他们的喊声，能听到弓弦拉动的声音。距离外堡还有二十多里，你不知道自己能不能跑回去，但你必须跑——至少要有一个人活着回去，把消息传回去！狗娃的马突然一个趔趄，差点摔倒。你看了一眼，他的马腿上插着一支箭。「师兄！我马受伤了！」狗娃的声音里带着哭腔。|none|沙漠|none|none

你咬了咬牙，还没来得及说什么，却听到身后又是一声闷响——狗娃从马上栽了下去，后脑插着一支箭羽。他的马惊叫着冲出几步，又轰然倒地。你咬紧牙关，拼命地抽打马鞭，劣马吃痛，发出凄厉的嘶鸣，四蹄翻飞。泪水模糊了你的视线，你用袖子胡乱抹了一把，一起下山的师兄弟全死了，就剩你一个人了。「该死！该死！该死！」你一边跑一边骂，不知道是在骂敌人，还是在骂自己的无能。|none|沙漠|none|none

奇怪的是，身后的箭雨突然停了。你愣了一下，下意识地回头看——那队擒生军依然紧追不舍，但确实没有继续放箭了，他们保持着大约七十步的距离，不紧不慢地跟着你。你心中疑惑：「为什么不射？难道箭用完了？不对，他们刚才射了那么多箭，绝对还有存货。那为什么……」前方的地形你很熟悉——再有十里，就是通往门派的峡谷入口了！只要冲进峡谷，穿过那条狭窄的通道，就能抵达天山派的外堡！希望就在眼前！|none|山谷|none|none

你的心跳得更快了，劣马似乎也感觉到了，拼尽最后的力气狂奔。风在耳边呼啸，你能看到远处那道熟悉的山崖轮廓——那里就是回家的路！你心中突然闪过一个念头：「可是……为什么追兵还不射箭？」一个念头在脑海里炸开——他们在跟踪你！他们想让你活着回去，想让你把他们带到天山派的隐藏入口！你的心一下子凉透了。西夏擒生军一直在找天山派的所在，可峡谷入口藏得极隐蔽，外人根本找不到。而你现在就像一只慌不择路的兔子，正要把狼群引向自己的窝。外堡里还有几千难民——老人、孩子、妇女——都是这些年天山派救下的无辜百姓，如果西夏人找到入口，如果他们把这个消息带回擒生军大营……你不敢想下去。|none|山谷|none|none
</MAIN_TEXT>

<SUMMARY>
你与四名外门师兄弟奉命前往驿站接应运粮车队，途中心生不祥预感。抵达后发现驿站空无一人，车队不知所踪。突然遭到西夏擒生军伏击，阿福、狗娃等师兄弟相继中箭身亡，仅你一人拼死逃脱。追兵却突然停止射箭，保持距离跟踪。你恍然大悟——敌人是想利用你找到天山派隐蔽的峡谷入口，外堡内还有数千无辜难民，你陷入两难绝境。
</SUMMARY>

<SIDE_NOTE>
{
    "随机事件": {
        "事件类型": "选项事件",
        "事件描述": "西夏擒生军紧追不舍，你意识到他们想利用你找到天山派入口。继续逃往峡谷将暴露门派位置，停下则必死无疑。",
        "选项一": {
            "描述": "特殊剧情: 继续",
            "奖励": "",
            "成功率": "100%"
        }
    },
    "时间": "10:30",
    "用户": {
        "位置变动": "山道"
    },
    "当前NPC": {}
}
</SIDE_NOTE>

</SLG_MODE>`
    },
    {
        id: "Apprenticeship_Storyline_2",
        name: "拜师苓雪妃2",
        priority: 99,
        conditions: {
            currentSpecialEvent: { equals: 'Apprenticeship_Storyline_1' } 
        },
        effects: {},  // 无属性变化
        text: `<SLG_MODE>

<MAIN_TEXT>
你强迫自己深呼吸，故意放慢了马速，劣马正好也跑得气喘吁吁，一听你收紧缰绳，立刻慢了下来。身后的马蹄声也慢了下来。你心一沉——果然！他们在跟踪你！「该死的杂碎……」你低声骂道，手心里全是冷汗。你深吸一口气，心脏狂跳。「对不起了……爹娘……」前方出现了一个岔路口——左边通往峡谷，右边是一片人迹罕至的山林，里面到处是野兽和毒虫，连猎户都不愿意进去，据外堡的说书先生讲，这林子深处还住着厉鬼，进去的人都会失踪。你猛地一拉缰绳，劣马嘶鸣着转向右侧，冲进了茂密的林子。|none|山道|none|none

「嗯？那小子朝右边了！」身后传来擒生军的喊声，「追！别让他跑了！」你咬着牙，拼命往林子深处钻。树枝刮破了衣服，划伤了脸颊，你根本顾不上。劣马在树林里跑得跌跌撞撞，几次差点摔倒。十里、十一里、十二里……你不知道自己跑了多久，只知道天色渐暗，林子里的光线越来越暗。劣马的呼吸声像风箱一样，四条腿在打颤。「再坚持一下……再坚持一下……」你轻轻拍了拍劣马的脖子，给它鼓劲，又像是喃喃自语。|none|树林|none|none

突然——咔嚓！劣马的前蹄踩到一根横在地上的树根，整匹马一头栽了下去！你被甩出去，在地上翻滚了好几圈，背部撞在一棵树上，疼得眼前发黑。劣马躺在地上抽搐着，发出凄厉的嘶鸣。身后的马蹄声越来越近。你浑身都在疼，肋骨可能断了几根，左手臂也动不了了，嘴里全是血腥味。但你还是踉踉跄跄地站起来。你的手摸向腰间的剑柄——那是入门时发的制式长剑，你连剑法都没学全，平时最多就是劈劈柴，偶尔还差点劈到自己的脚。|none|树林|none|none

铮——出鞘声在寂静的林子里格外清脆。你右手握剑，摆出尚未熟练的起手式——虽然姿势肯定歪七扭八，虽然双腿在打颤，虽然你知道自己根本不是那些精锐骑兵的对手。但你不能给天山派丢脸。「来吧……杂碎们……」你握紧了剑。擒生军的骑兵们策马围拢上来，为首的军官冷笑着举起弯刀：「给我抓活的，到时候把他手指挨个掰断，不信他不招天山派的贼窟在哪。」你咬紧牙关，右手握剑，尽管知道自己根本不是对手，但至少——至少要站着死。|none|树林|none|none

「呵，还挺有骨气——」仿佛是幻听，不知哪里传来女声，随即一道黑影如鬼魅般从林间闪过。咔嚓！为首的军官脑袋被拧到背后，他瞪大眼睛，一声呻吟都来不及发出就直挺挺从马上栽了下去。「什么——！」其他擒生军还没反应过来，黑影又往复闪过。随着一声声闷响，又有几个倒霉蛋被拧断了脖子落马坠地。你甚至看不清那影子是怎么动的——只能看到残影掠过，然后就有人倒地。「鬼！是鬼！」「快跑——！」剩下的擒生军吓破了胆，调转马头就要逃。|none|树林|none|none

但为时已晚——黑影在林间穿梭，每一次闪现都带走一条人命，轻功之快，简直不像人类能做到的。不到盏茶工夫，三十多个擒生军精锐，全军覆没。林子里重新陷入寂静。你的心脏狂跳，冷汗顺着脊背往下流。你突然想起外堡的传闻——这片林子深处住着厉鬼……你心中发毛：「该不会……真的是鬼吧？」你喃喃自语，下意识地后退，剑尖对准四周。|none|树林|none|none

风吹过树梢，发出诡异的呜呜声。夕阳的余晖把树影拉得很长，像一只只张牙舞爪的怪物。你的手在发抖，但还是死死握着剑——哪怕是鬼，你也要拼一把！又退了两步。突然——你的后背撞在了什么柔软温热的东西上。不对！是人！有人站在你身后！「啊——！」你惊叫一声，本能地转身，手中长剑横扫而出！铮——剑刃在空中划出一道寒光，却在距离对方咽喉三寸的地方突然停住了。|苓雪妃|树林|特殊CG1|none

对方只是轻描淡写地伸出两根手指，就夹住了你全力挥出的剑刃——就像夹一根筷子那么轻松。你这才看清面前的人。那是一个女子，准确说，是一个美得让人屏息的女子——哪怕她脸上写满了疲惫和冷漠，浑身上下散发着生人勿近的冰冷气息。乌黑的长发略显凌乱，白衫黑裙外罩着黑色貂裘披风，赤红色的眼眸冷冷地打量着你。最引人注目的是她头顶那对黑色的下垂兔耳——在夕阳余晖下微微晃动。|苓雪妃|树林|特殊CG1|none

「你……」你的声音在发颤，「你是……」「妾身正要问你，」女子松开夹着剑刃的手指，语气冰冷，「擅闯禁林，所为何事？」她的眼神越来越冷，像是在看一只不知死活的虫子：「这林子已经荒废多年，妾身也在此清净多时。你是头一个闯进来的。」你这才意识到——刚才杀光那些擒生军的，就是眼前这个女子！而且，她明显不欢迎你。|苓雪妃|树林|严肃|none
</MAIN_TEXT>

<SUMMARY>
你意识到擒生军在跟踪你想找到天山派入口，于是冒险冲入传闻有厉鬼的禁林。逃亡途中劣马摔倒，你身负重伤被敌军包围。危急时刻，一道黑影从林间闪出，瞬间全歼三十余名擒生军。你惊恐中发现救你的是一名美貌女子——黑发红眸，头顶垂着一对黑色兔耳。她语气冰冷地质问你为何擅闯禁林，显然对你的到来并不欢迎。
</SUMMARY>

<SIDE_NOTE>
{
    "随机事件": {
        "事件类型": "选项事件",
        "事件描述": "神秘的兔耳女子救了你，但她对你的闯入显然十分不满。你身负重伤，必须设法解释自己的来意并取得她的信任。",
        "选项一": {
            "描述": "特殊剧情: 继续",
            "奖励": "",
            "成功率": "100%"
        }
    },
    "时间": "15:30",
    "用户": {
        "位置变动": "树林"
    },
    "当前NPC": {
        "苓雪妃": {
            "好感变化": "不变",
            "位置变动": "树林"
        }
    }
}
</SIDE_NOTE>

</SLG_MODE>`
    },
    {
        id: "Apprenticeship_Storyline_3",
        name: "拜师苓雪妃3",
        priority: 98,
        conditions: {
            currentSpecialEvent: { equals: 'Apprenticeship_Storyline_2' } 
        },
        effects: {},  // 无属性变化
        text: `<SLG_MODE>

<MAIN_TEXT>
「我、我不是故意闯进来的！」你连忙解释，声音因为紧张而有些结巴，「我是天山派外门弟子！今天奉命去接应门派采买粮食的车队，结果遭到西夏擒生军埋伏——」你一口气把事情的来龙去脉说了出来：同伴全部阵亡，自己被追杀，意识到敌人想利用自己找到天山派入口，所以故意把他们引到这片林子里来。「为了不让他们找到外堡，我只能往这边跑……」你咽了口唾沫，「我真的不知道这里是前辈您隐居的地方……对不起！」|苓雪妃|树林|平静|none

女子面无表情地听完，赤红色的眼眸在你身上扫了一遍，最后落在你那件破破烂烂、沾满血污的天山派制式劲装上。「天山派……」她喃喃自语，语气中带着一丝复杂的情绪，「呵。」她突然冷笑一声：「为了保护门派，宁可把追兵引向未知的险地，把自己置于死地？」「是。」你点点头。「愚蠢。」她淡淡地吐出两个字，「以一己之命，能换来什么？现在的天山派，多你一个不多，少你一个不少。」她的话像刀子一样扎在你心上，但你没有反驳——因为你知道她说的是实话。|苓雪妃|树林|不满|none

她的目光最后定格在你那还死死握着剑柄的手上——虽然剑尖在发抖，但你始终没有松开。「身体挺直。」她突然道。「啊？」「让妾身看看你的站姿。」你愣了一下，忍着疼痛站直了身体，摆出才学了一个月的起手式。虽然浑身都在痛，虽然姿势肯定歪七扭八，但你还是努力做到最好。女子盯着你看了一会儿，突然走了过来。|苓雪妃|树林|平静|none

「重心偏了。」她用脚尖踢了踢你的左脚，力道不重，但你差点摔倒，「握剑的手腕太僵硬。剑意散乱。」「我……」「闭嘴。」她绕着你转了一圈，就像在打量一件次品，「根骨平庸，资质低劣。内力薄弱，剑法稀烂。」每一句话都像刀子一样扎在你心上。「这就是天山派现在的弟子水平？」她冷笑，「难怪……」她没说完，但语气里的轻蔑和失望让你脸上发烧。你心里腹诽：「这前辈武功虽高，但是嘴巴也太毒了，但凡她嘴下留情一点，我也不至于想找个地缝钻进去。」嘴上却一句话不敢说。|苓雪妃|树林|特殊CG2|none

「不过……」她突然停下脚步，站在你面前，「面对必死之局，没有跪地求饶，也没有临阵脱逃。宁可把敌人引入险地，也不出卖门派。」她的眼神依然冷淡，「算是有几分气节。」你愣住了。这是……夸奖？|苓雪妃|树林|特殊CG2|none

「妾身实在看不下去现在天山派弟子的水平了。」她沉吟片刻，黑色兔耳微微一动，「罢了，妾身便收你为徒，亲自调教一番。」什么？！你的脑子嗡的一声。收徒？眼前这个冷艳绝伦、武功绝世的女子，要收你为徒？这……这是天上掉馅饼吗？不对！|苓雪妃|树林|平静|none

「晚辈……晚辈不能。」你咬着牙说。「嗯？」女子回过头，眼神危险，「你在拒绝妾身？」「不是……」你额头冒汗，「是晚辈已经拜入天山派，虽为外门弟子，但也是正式入门。按江湖规矩，不能另行拜师，否则便是背叛师门……」「江湖规矩？」她冷笑，「天山派的规矩，需要你一个外门弟子来教我？」「我不是……我是说……」|苓雪妃|树林|不满|none

「还是说，」她眯起眼睛，「你觉得妾身配不上做你的师父？」「不敢不敢！」你连忙摇头，「前辈武功盖世，晚辈高攀不起！只是……只是真的不能违背师门规矩……」女子盯着你，一言不发。林子里安静得可怕。你的心脏狂跳，冷汗顺着脊背往下流。但你还是咬着牙，没有改口。你心想：「行吧，今天大概是要交代在这了。」|苓雪妃|树林|严肃|none
</MAIN_TEXT>

<SUMMARY>
你向神秘女子解释了遭擒生军伏击、引敌入林的经过。女子虽嘲讽你愚蠢，但也认可你宁死不出卖门派的气节。她检视你的站姿和根骨后，毒舌点评你资质平庸、剑法稀烂，却出人意料地提出要收你为徒。你因已拜入天山派，按江湖规矩不能另投师门，只得硬着头皮拒绝。女子眼神转冷，质问你是否看不起她，气氛一时剑拔弩张。
</SUMMARY>

<SIDE_NOTE>
{
    "随机事件": {
        "事件类型": "选项事件",
        "事件描述": "神秘女子提出收你为徒，你以江湖规矩为由婉拒，她显然对此十分不满。气氛僵持，你不知她下一步会如何。",
        "选项一": {
            "描述": "特殊剧情: 继续",
            "奖励": "",
            "成功率": "100%"
        }
    },
    "时间": "16:00",
    "用户": {
        "位置变动": "树林"
    },
    "当前NPC": {
        "苓雪妃": {
            "好感变化": "不变",
            "位置变动": "树林"
        }
    }
}
</SIDE_NOTE>

</SLG_MODE>`
    },
    {
        id: "Apprenticeship_Storyline_4",
        name: "拜师苓雪妃4",
        priority: 97,
        conditions: {
            currentSpecialEvent: { equals: 'Apprenticeship_Storyline_3' } 
        },
        effects: {},  // 无属性变化
        text: `<SLG_MODE>

<MAIN_TEXT>
半晌——「呵。」她突然轻笑了一声，伸手按在腰间的剑柄上。完了。你的心一沉。自己刚才拒绝她，惹她不快了，现在她要杀人灭口了。你握紧手中的剑，虽然知道自己根本不是她的对手——别说打赢，能在她手下撑过一招都难——但你还是摆出了防守的姿势。至少……至少要死得有尊严一点。|苓雪妃|树林|严肃|none

「你怕吗？」她的声音飘过来。「怕。」你老实回答，声音在发抖，「但……但该守的规矩还是要守。该说的话还是要说。」「哦？」她挑了挑眉，「知道妾身要杀你？」「晚辈……晚辈猜测是这样。」你咽了口唾沫，努力让自己的声音不要抖得太厉害，「不过前辈高义，救晚辈性命，晚辈感激不尽。若是因为晚辈言语冒犯，惹前辈不快……那晚辈认了。」|苓雪妃|树林|平静|none

女子嘴角扬起一个极淡的弧度。那笑容稍纵即逝，但你确实看到了。她把手中的剑横着递到你面前。「拿着。」你愣了一下，伸手接过那柄剑。剑身修长，通体漆黑，剑锋却泛着淡淡的寒光，一看便不是凡铁。最重要的是——剑柄上，刻着天山派的标记——一朵雪莲，环绕宝剑！|苓雪妃|树林|微笑|none

「这、这是……」你瞪大眼睛。「天山派徽记。」她淡淡道，「看到了？」「您……您也是天山派的？！」「苓雪妃，天山派第七代弟子。」苓雪妃的兔耳抖动，「算起来，是你的长辈。」苓雪妃？！你的脑子又嗡了一声。这个名字你儿时便在外堡的说书先生口中屡屡听闻，传说中天山派不世出的剑圣，侍剑长老，曾持一把快剑，只身一人荡平拜火教群魔，剿灭邪教分舵十数所！|苓雪妃|树林|平静|none

难怪……难怪她的武功这么可怕！你心中暗道：「等等，这位就是传说中的苓雪妃？说书先生说她身高八尺，虎背熊腰，一顿饭要生吞五个鞑子……这也差太多了吧！」「既然同为天山弟子，方才所说拜师之事，便不算违背规矩了吧？」她看了你一眼，眼神中带着些微的促狭。「不算……」你连忙摇头，「只是晚辈何德何能……」|苓雪妃|树林|得意|none

「妾身不管你有没有德，有没有能。」她打断你，「你不明白的事，做不到的事，妾身会全部教给你。」她的语气又突然变得冷硬起来：「当然，你也可以拒绝。反正妾身也不缺徒弟。」「不不不！」你连忙跪下，「弟子愿意！弟子愿意拜师！」你心想：开玩笑，天山派第一高手要收你为徒，这种好事上哪找去？！|苓雪妃|树林|特殊CG3|none

「起来吧。」她挥了挥手，「为师不喜欢这些虚礼。你只需记住——为师的要求很高。若是偷懒懈怠，为师绝不容情。」「弟子明白！」「很好。」她点点头，然后皱起眉头看着你，「现在，带为师回天山派。你这副半死不活的样子，还需要尽快医治。」「是！」你连忙站起来，忍着疼痛准备带路。|苓雪妃|树林|特殊CG3|none

「等等。」她突然伸手按在你的肩膀上。一股温热的内力注入你的体内，疼痛顿时减轻了大半。「应付一下，免得你走到半路就死了，还烦扰我收尸。」她淡淡道，「真正的治疗回去再说。」「弟子拜谢恩师！」你心中一暖，感激之情脱口而出。「肉麻死了，恶心……」她的语气依然冷淡甚至带着嫌弃，但嘴角又扬起那个不易察觉的弧度，「先熬过为师的调教再说，愚钝的弟子。」你小心翼翼地偷看了她一眼——果然，嘴上说着嫌弃，兔耳却又微微抖了一下。|苓雪妃|树林|害羞|none
</MAIN_TEXT>

<SUMMARY>
你以为苓雪妃要杀你灭口，但她却递来一柄刻有天山派徽记的宝剑，亮明自己正是传说中的天山派剑圣——第七代弟子苓雪妃。既是同门长辈，拜师便不违规矩，你当即跪地认师。苓雪妃警告你修炼要求极高，不容懈怠，随后以内力为你暂时疗伤，准备带你返回天山派。
</SUMMARY>

<SIDE_NOTE>
{
    "随机事件": {
        "事件类型": "选项事件",
        "事件描述": "你正式拜苓雪妃为师，成为天山派剑圣的唯一弟子。她为你以内力暂时疗伤，准备带你返回天山派进行正式治疗。",
        "选项一": {
            "描述": "特殊剧情: 继续",
            "奖励": "",
            "成功率": "100%"
        }
    },
    "时间": "17:00",
    "用户": {
        "位置变动": "树林"
    },
    "当前NPC": {
        "苓雪妃": {
            "好感变化": "不变",
            "位置变动": "树林"
        }
    }
}
</SIDE_NOTE>

</SLG_MODE>`
    },
    {
        id: "Apprenticeship_Storyline_5",
        name: "拜师苓雪妃5",
        priority: 96,
        conditions: {
            currentSpecialEvent: { equals: 'Apprenticeship_Storyline_4' } 
        },
        effects: {},  // 无属性变化
        text: `<SLG_MODE>

<MAIN_TEXT>
夜幕降临时，你终于带着苓雪妃来到了天山派的山门。「是{{user}}！快去叫人！」当值守门的弟子认出了你，「他受伤了——等等，他身边那个人是谁？」所有人的目光都落在苓雪妃身上。她依然是那副冷漠的表情，貂裘在夜风中摆动，赤红色的眼眸扫过众人，一言不发。守卫弟子咽了口唾沫:「这位姑娘，请问你是——」|苓雪妃|山门|平静|none

苓雪妃面无表情，用手肘顶了一下你。你会意，连忙替她向众人解释：「她……她是门派的人！是本门第七代的前辈！」你心中暗道：「虽然我也很想说她是我在林子里捡的女鬼……但我怕挨打。」「可是我从没见过——」话音未落，山门另一侧突然传来急促的脚步声。破阵子高大的身影从黑暗中冲出，身后跟着洞庭君、玄天青几位长老。|苓雪妃|山门|平静|none

「听说{{user}}受伤回来了，怎么——」破阵子的话卡在喉咙里。他看到了苓雪妃。气氛凝固了。破阵子瞪大眼睛，洞庭君愣在原地，就连一向沉稳的玄天青都惊得下意识扶了扶眼镜。「雪、雪妃？」破阵子的声音有些发颤，「你……你回来了？」「嗯。」苓雪妃面无表情地点点头，「回来了。」|苓雪妃|山门|平静|none

玄天青深吸一口气：「师妹，你这几年……」「不必担心。」苓雪妃当即打断寒暄，「妾身活得好好的。」「雪妃……」洞庭君强装镇定，眼眶却红了，「你终于肯回来了……」「只是顺路。」苓雪妃淡淡道，「这个弟子把追兵引到了妾身隐居的地方，妾身只好送他回来。」|苓雪妃|山门|平静|none

你站在一旁，看着几位长老的反应，心里突然有些不是滋味。你心想：「原来……她一个人在那片林子里，已经住了很久了吗？」「追兵？」破阵子皱眉，「什么追兵？」你连忙上前，把今天发生的事情一五一十地说了出来：伏击、同伴阵亡、情报泄露、擒生军……|none|山门|none|none

「这……」玄天青沉吟道，「此事蹊跷，还需从长计议。你先去处理伤口，详细情况明日再说。」「是。」「雪妃，」破阵子的语气软了下来，「你的住处我让人去准备，长老厢房一直给你留着——」「不必了。」苓雪妃的声音冷得像冰，「妾身住普通的女弟子房便可，不必费心。」|苓雪妃|山门|严肃|none

「可是——」「就这样。」她没有再给任何人说话的机会，径直朝女弟子居住的方向走去。你愣了一下，连忙跟上去：「师父！等等我！」「师父？！」三位长老面面相觑。你回头，看到他们脸上写满了震惊——还有某种难以言喻的……如释重负？|none|山门|none|none

「这倒是……」玄天青若有所思，「也许是个转机。」洞庭君冰蓝色的眼眸里闪过光亮：「至少……她愿意回来了。」「去吧。」破阵子挥挥手，声音有些沙哑，「照顾好你师父。」你点点头，快步追上苓雪妃。|none|山门|none|none
</MAIN_TEXT>

<SUMMARY>
夜幕降临，你带苓雪妃回到天山派山门。破阵子、洞庭君、玄天青等长老闻讯赶来，惊见失踪多年的苓雪妃归来，激动万分。苓雪妃冷淡回应，称只是顺路送你回来。你向长老们汇报了遭伏击、情报泄露的情况。苓雪妃拒绝住长老厢房，执意住普通女弟子房。你追上她时喊出「师父」，长老们震惊之余又流露出如释重负之色，似乎她的回归与收徒是某种转机。
</SUMMARY>

<SIDE_NOTE>
{
    "随机事件": {
        "事件类型": "选项事件",
        "事件描述": "你带苓雪妃回到天山派，长老们对她的归来既惊喜又感慨。苓雪妃收你为徒一事已被长老们知晓，似乎暗藏某种深意。",
        "选项一": {
            "描述": "特殊剧情: 继续",
            "奖励": "",
            "成功率": "100%"
        }
    },
    "时间": "19:30",
    "用户": {
        "位置变动": "山门"
    },
    "当前NPC": {
        "苓雪妃": {
            "好感变化": "不变",
            "位置变动": "山门"
        }
    }
}
</SIDE_NOTE>

</SLG_MODE>`
    },
    {
        id: "Apprenticeship_Storyline_6",
        name: "拜师苓雪妃6",
        priority: 95,
        conditions: {
            currentSpecialEvent: { equals: 'Apprenticeship_Storyline_5' } 
        },
        effects: {
            GameMode: { set: 0 },
            inputEnable: { set: 1 },
            mapLocation: { set: '天山派' },  
            companionNPC: { set: [] },
            userLocation: { set: 'nvdizi' },
            "npcFavorability.O": { add: 20 },
            "npcVisibility.O": { set: true }
        },  // 无属性变化
        text: `<SLG_MODE>

<MAIN_TEXT>
女弟子房是一排依山而建的木屋，最里面有几间偏僻的单间，平时很少有人住——因为在山坳背阴处，冬天起夜冻死个人。苓雪妃偏偏选了最里面、最偏僻的那一间。「师父，这里……」你看着眼前这间破落的小屋，欲言又止。屋子不大，只有一张木床、一张桌子、一把椅子，墙角有些漏风。「够了。」苓雪妃淡淡道，「为师不需要太多。」你想说什么，却又不知道该说什么。你心中暗想：「她明明是长老，为什么要住这种地方……」

「去打盆水来。」她坐到椅子上，「为师要给你处理伤口。」「是！」你跑出去打水，回来时发现屋里多了一盏油灯——不知道是谁悄悄送来的，可能是某个路过的师姐。昏黄的灯光摇曳，照亮苓雪妃疲惫的侧脸。你心想：「原来……也有人在偷偷关心她啊。」

她示意你趴到床上，开始帮你处理伤口。她的动作很轻，但药粉洒上去还是疼得你龇牙咧嘴。「忍着。」她淡淡道，「这点疼都忍不了？」「弟子忍得住！」「哼，嘴硬。」苓雪妃开始替你包扎伤口，突然开口：「为师有几条规矩，你要记住。」「是！请师父示下！」

「第一，」她居高临下，赤红色的眼眸直视着你，「为师是带罪之身，不再是长老。你也不许以内门弟子自居。在外人面前，你依然是外门弟子。明白吗？」你本欲替她抱不平，但看着她坚决的眼神，只能点头：「弟子……明白。」

「第二，」她继续道，「不要在外人面前提及师徒关系。行事低调，不可张扬。若有人问起，你就说……」她顿了顿。「就说你在林子里捡了个农妇回来。」「……农妇？？？师父，这也太——」「有意见？」「没有没有！弟子没有意见！」你心中腹诽：「谁信啊！哪个农妇长这么好看！哪个农妇能徒手拧断擒生军的脖子！」

「很好。第三，」她的语气稍微缓和了一点，「你根基尚浅，每日的早课和操练不可懈怠，习武切忌冒进，等到时机成熟，为师自会倾囊相授。」「弟子谨记！」「另外，」罕见的，苓雪妃竟有一丝犹豫，「不要试图打听为师的过去。不要试图劝慰为师。」
</MAIN_TEXT>

<SUMMARY>
苓雪妃选了女弟子房中最偏僻破落的单间居住，拒绝长老待遇。她为你处理伤口时，立下三条规矩：一、她是带罪之身，你不得以内门弟子自居；二、不可对外提及师徒关系，若有人问便称她是你捡回来的农妇；三、修行不可冒进，时机成熟她自会倾囊相授。最后她犹豫着补充——不要打听她的过去，也不要试图劝慰她。
</SUMMARY>

<SIDE_NOTE>
{
    "时间": "20:30",
    "用户": {
        "位置变动": "女弟子房"
    },
    "当前NPC": {
        "苓雪妃": {
            "好感变化": "上升",
            "位置变动": "女弟子房"
        }
    }
}
</SIDE_NOTE>

</SLG_MODE>`
    },

    {
        id: "Jisi_Letter_1",
        name: "故人遗书·姬姒1",
        priority: 80,
        conditions: {
            currentWeek: { min: 1 },
            "npcFavorability.E": { min: 50 }
        },
        effects: {
            GameMode: { set: 1 },
            inputEnable: { set: 0 },
            mapLocation: { set: '博斯坦村' },
            companionNPC: { push: '姬姒' }
        },
        text: `<SLG_MODE>

<MAIN_TEXT>
新的一周的某个傍晚，你路过藏经阁时，看到姬姒独自坐在门口的石阶上，手里攥着一封信，怔怔出神。夕阳的余晖洒在她身上，那双平日里总是笑眯眯的琥珀色眼眸此刻却蒙着一层薄雾，银白色的狐耳耷拉着，蓬松的狐尾也安静地垂在身后。你从未见过她这副模样——这位没心没肺的大师姐，竟然也有如此失魂落魄的时候。|姬姒|武侠门派|悲伤|none

「大师姐？」你轻声唤道。她回过神来，下意识地把信藏到身后，动作慌张得像是被抓到了什么小秘密：「啊……是你。没、没什么事。」你看着她那副欲盖弥彰的样子，心中有些好奇，也有些担忧。犹豫了一下，你还是在她身旁坐下。她沉默了一会儿，最终还是把信递给你：「你……你看看吧。」|姬姒|武侠门派|为难|none

你接过信展开——信纸已经有些泛黄，边角磨损，显然被人读过很多遍。信上的字迹工整娟秀，写道：「姬姒前辈台鉴：吾乃周怀远之后人，家祖嘱托，后人若有机会务必寻访前辈，将祖上遗物奉还。祖上生前常常提起前辈，说前辈是此生知己，永志难忘……」你的目光停在「永志难忘」四个字上，心中莫名涌起一股说不清道不明的滋味。|姬姒|武侠门派|悲伤|none

「周怀远……」你念出这个名字，尽量让自己的语气听起来平静，「这是谁？」姬姒沉默良久，声音轻得像一声叹息：「是……吾的一个故人。」她的狐耳微微颤抖，「那是很久很久以前的事了……」她抬头望向远方，琥珀色的眼眸里倒映着晚霞，却带着某种你看不懂的哀伤，「怀远……是吾在这天山派认识的第一个人。」|姬姒|武侠门派|悲伤|none

第一个人。你咀嚼着这几个字，心里像是被什么东西轻轻扎了一下。「怀远走的时候说会再回来，结果这一去……就是一百多年。」她的声音越来越轻，「吾一直以为……一直以为，山川远隔，道路断绝，怀远早就死在途中了。没想到……竟然真的到了中原，还成了家，有了后人……」她低下头，银白色的长发垂落，遮住了表情。你看到她的肩膀在微微颤抖。|姬姒|武侠门派|悲伤|none

你心中五味杂陈。原来大师姐心里一直藏着这样一个人——一个让她等了一百多年的人。那个叫周怀远的……究竟是什么样的人，能让她念念不忘至今？你张了张嘴，想说些什么安慰的话，却发现喉咙像是被什么堵住了。「大师姐，」你斟酌着开口，「你打算去赴约吗？」「当然要去。」她抬起头，眼眶微红，却挤出一个笑容，「都是百年前的事了，有什么好伤感的。能见到故人的后人，也是一桩缘分。」|姬姒|武侠门派|微笑|none

她站起身，拍了拍衣服，然后转过头看着你。那双琥珀色的眼眸里带着少见的不安和期待：「赴约的日子……就是明天了。你……你愿意陪吾去吗？」你愣了一下。「吾……吾一个人去，怕控制不住情绪，丢了长辈的脸面。」她的声音带着少见的不安，狐尾不自在地晃了晃，「你跟着吾，若吾……若吾哭出来，你替吾圆场……」她说到最后，声音几乎细不可闻。|姬姒|武侠门派|害羞|none

你看着她那副强装坚强的模样，心中那股酸涩的滋味更浓了。但你还是点了点头：「我陪你去。」「好！」她的狐耳瞬间竖了起来，狐尾也恢复了摇摆，「那……那咱们明天一早出发！博斯坦村有一段路呢！」她说着说着，声音又低了下去，「吾……吾得好好准备一下。见故人后代嘛，总不能太失礼……」你看着她那副紧张的样子，心中暗叹：「她……真的很在意那个人啊。」|姬姒|武侠门派|害羞|none
</MAIN_TEXT>

<SUMMARY>
新的一周某天，你发现姬姒独自坐在藏经阁门口，神情悲伤地攥着一封信。信是百年前故人周怀远的后代写来的，要归还祖上遗物。姬姒提到周怀远是她"此生认识的第一个人"，等了一百多年却再未相见。她请求你陪同赴约，担心自己情绪失控。你答应了，心中却泛起说不清的酸涩。
</SUMMARY>

<SIDE_NOTE>
{
    "随机事件": {
        "事件类型": "选项事件",
        "事件描述": "姬姒收到百年前故人后代的来信，邀她在博斯坦村见面。她神情复杂，请你陪同赴约。那个让她等了一百多年的人，究竟是谁？",
        "选项一": {
            "描述": "特殊剧情: 继续",
            "奖励": "",
            "成功率": "100%"
        }
    },
    "时间": "18:00",
    "用户": {
        "位置变动": "武侠门派"
    },
    "当前NPC": {
        "姬姒": {
            "好感变化": "不变",
            "位置变动": "武侠门派"
        }
    }
}
</SIDE_NOTE>

</SLG_MODE>`
    },
    {
        id: "Jisi_Letter_2",
        name: "故人遗书·姬姒2",
        priority: 79,
        conditions: {
            currentSpecialEvent: { equals: 'Jisi_Letter_1' }
        },
        effects: {},
        text: `<SLG_MODE>

<MAIN_TEXT>
第二天一早，你们踏上了前往博斯坦村的路。姬姒今天特意换了一身干净整洁的衣服，银白色的长发梳得一丝不苟，狐耳上还别了一朵小小的雪莲花。她一路上都有些心不在焉，时不时摸摸怀里的信，又时不时出神地哼着曲调。你跟在她身后，看着她那副魂不守舍的样子，心里堵得慌。「大师姐，」你忍不住开口，「你哼的那首曲子是什么？」|姬姒|山道|为难|none

「哦，这个啊，」她回过头，脸上带着怀念的神色，「是怀远教吾的。中原的童谣。」她的声音轻轻的，像是在回忆很久以前的事，「怀远说这是家乡的曲子，说等有一天带吾去中原，就带吾一起回乡看看……」她没有说下去，只是继续轻声哼唱——原来她连这个人教的曲子都记得这么清楚。|姬姒|山道|悲伤|none

「大师姐，」你斟酌着措辞，「您和周怀远……究竟是什么关系？」姬姒的脚步顿了一下。沉默了好一会儿，她才开口：「怀远……是吾认识的第一个朋友。」她的声音有些飘忽，「那时候吾刚被张公收留，不会武功，不懂人情世故，懵懵懂懂。其他人都看轻吾，只有怀远……」她突然停住了，狐耳微微发红。「只有怀远什么？」你追问。|姬姒|山道|害羞|none

「只有怀远主动靠近吾，」她小声说，「教吾练剑，教吾写字……」她的声音越来越轻，「怀远总是叫吾'小狐狸'，说吾的耳朵很可爱，说吾的尾巴毛茸茸的很好摸……」你听着这些亲昵的称呼，心里像是打翻了醋坛子。小狐狸？摸尾巴？这……这分明是情侣之间才会有的举动吧？|姬姒|山道|害羞|none

「怀远还说，等打完仗，就带吾去中原」姬姒继续说着，完全没注意到你越来越难看的脸色，「说中原有很多好吃的，吾一定会喜欢……」她的声音带上了几分甜蜜的怀念，狐尾也不自觉地摇了起来。你看着她那副沉浸在回忆中的模样，心里酸得几乎要溢出来。「后来呢？」你的声音有些僵硬。「后来怀远要回中原，去长安搬救兵。」她的声音低了下来，「临走前，吾把随身的玉佩送给怀远，让怀远……让怀远记得回来。」|姬姒|山道|悲伤|none

玉佩？定情信物？你的心沉了下去。原来如此……原来大师姐心里一直有一个人，一个她等了一百多年的人。你努力让自己的表情保持平静，但攥紧的拳头出卖了你的心情。「怀远说一定会回来的。」姬姒的声音越来越轻，「说等带着援军回来，就……」她突然停住了，没有说下去。「就什么？」你追问，声音里带着一丝自己都没察觉的急切。姬姒摇了摇头：「没什么了。都是些陈年旧事。」|姬姒|山道|悲伤|none

你沉默地跟在她身后，脑海里不断回荡着她刚才的话——"小狐狸"、"毛茸茸的尾巴"、"一起去中原"、"玉佩"……每一句都像是在告诉你，她的心里早就住着一个人了。你深吸一口气，努力压下心中翻涌的情绪。「大师姐，」你开口，声音尽量平静，「那个周怀远……一定是个很好的人吧。」「嗯。」她点点头，琥珀色的眼眸里满是柔情。|姬姒|山道|微笑|none

午后，你们抵达博斯坦村。这是一个依湖而建的宁静渔村，湖水碧蓝如镜，芦苇随风摇曳。望月茶楼就在湖边，是一座二层小楼，生意不温不火。姬姒在茶楼门口站了很久，狐耳紧张地抖动着。你看着她那副患得患失的样子，不知道该说什么，只能沉默地陪在她身边。她深吸一口气，推开了门。|姬姒|酒肆|紧张|none
</MAIN_TEXT>

<SUMMARY>
前往博斯坦村的路上，姬姒哼着周怀远教她的童谣，向你讲述往事——周怀远是唯一主动接近她的人，教她说话写字，叫她"小狐狸"，还说尾巴毛茸茸很好摸。她送了玉佩给周怀远作为信物，约定再见。你听着这些亲昵的往事，心中泛起强烈的酸涩，却只能沉默地陪在她身边。抵达茶楼时，姬姒紧张得狐耳直抖。
</SUMMARY>

<SIDE_NOTE>
{
    "随机事件": {
        "事件类型": "选项事件",
        "事件描述": "姬姒讲述与周怀远的往事——亲昵的称呼、定情的玉佩、未完成的约定。你心中泛酸，却只能沉默陪伴。",
        "选项一": {
            "描述": "特殊剧情: 继续",
            "奖励": "",
            "成功率": "100%"
        }
    },
    "时间": "14:00",
    "用户": {
        "位置变动": "酒肆"
    },
    "当前NPC": {
        "姬姒": {
            "好感变化": "不变",
            "位置变动": "酒肆"
        }
    }
}
</SIDE_NOTE>

</SLG_MODE>`
    },
    {
        id: "Jisi_Letter_3",
        name: "故人遗书·姬姒3",
        priority: 78,
        conditions: {
            currentSpecialEvent: { equals: 'Jisi_Letter_2' }
        },
        effects: {},
        text: `<SLG_MODE>

<MAIN_TEXT>
茶楼里人不多，三三两两的茶客在闲聊。你们选了一个靠窗的位置坐下，点了一壶茶，开始等待。姬姒坐立不安，一会儿喝茶，一会儿看窗外，一会儿又整理头发。你从没见过她这么紧张的样子——平日里那个没心没肺、嬉皮笑脸的大师姐，此刻却像个即将见到心上人的小姑娘。你心中愈发酸涩，却只能沉默地陪着她。|姬姒|酒肆|紧张|none

就在这时，茶楼的门被推开了。一个年轻女子走了进来，二十出头的年纪，穿着素净的青衣，容貌清秀，气质温婉。她的目光在茶楼里扫了一圈，最后落在姬姒那对银白色的狐耳上，眼睛瞬间亮了起来。「请问……您是姬姒前辈吗？」她快步走过来，声音微微颤抖，「晚辈周清婉，特来拜见前辈！」姬姒站起身，目光落在她脸上，怔怔出神。|姬姒|酒肆|惊讶|none

「你……」姬姒的声音有些发颤，「你长得……好像……」「家父也这么说过，」周清婉笑了笑，眼眶却微微泛红，「他说晚辈的眉眼像极了祖上年轻时候。」她从怀里取出一个布包，双手捧着递给姬姒，「这是祖上留下的遗物，家父再三嘱咐，一定要亲手交给您。」姬姒颤抖着双手接过布包，小心翼翼地打开——里面是一枚玉佩和一封泛黄的书信。|姬姒|酒肆|惊讶|none

「这枚玉佩……」姬姒的声音哽住了。你凑过去看——那是一枚雕成雪莲形状的白玉佩，做工精致，通体温润，显然被人贴身佩戴了很多年。「曾祖母说，这是您送给她的。」周清婉轻声道。「曾祖母一直戴在身上，从未取下。临终前，她让家父转交给您，说……说是物归原主。」|姬姒|酒肆|悲伤|none

姬姒捧着玉佩，银白色的狐耳剧烈地颤抖着，眼眶已经红了。她似乎完全没注意到你的震惊，只是喃喃自语：「怀远……师姐……」曾祖母？！师姐？！你的大脑飞速运转——所以周怀远不是姬姒的恋人，而是她的师姐？！|姬姒|酒肆|悲伤|none

「还有这封信，」周清婉继续说，「是曾祖母临终前亲笔所写。她说……只有姬姒前辈才能启封。」姬姒展开信纸，你看到那字迹起初尚算工整，越往后越颤抖潦草，显然是弥留之际强撑病体所书。|姬姒|酒肆|悲伤|none

</MAIN_TEXT>

<SUMMARY>
周清婉带来祖上周怀远的遗物——姬姒当年所赠的玉佩和一封绝笔信。信中周怀远自称"愚姐"，唤姬姒"吾妹"。你这才恍然大悟：周怀远是女性，是姬姒的师姐，两人是姐妹之情而非恋人。
</SUMMARY>

<SIDE_NOTE>
{
    "随机事件": {
        "事件类型": "选项事件",
        "事件描述": "真相大白——周怀远是女性，是姬姒的师姐。姬姒启封周怀远的信，开始阅读",
        "选项一": {
            "描述": "特殊剧情: 继续",
            "奖励": "",
            "成功率": "100%"
        }
    },
    "时间": "15:00",
    "用户": {
        "位置变动": "酒肆"
    },
    "当前NPC": {
        "姬姒": {
            "好感变化": "上升",
            "位置变动": "酒肆"
        }
    }
}
</SIDE_NOTE>

</SLG_MODE>`
    },
    {
        id: "Jisi_Letter_4",
        name: "故人遗书·姬姒4",
        priority: 77,
        conditions: {
            currentSpecialEvent: { equals: 'Jisi_Letter_3' }
        },
        effects: {},
        text: `<SLG_MODE>

<MAIN_TEXT>
「姬姒吾妹，见信如晤：愚姐此生最大的遗憾，便是未能再回天山看你一眼。当年一别，本想等到朝廷派兵收复河西，再与你重逢。谁料世事无常，愚姐这一走，竟是永诀。」|姬姒|酒肆|特殊CG1|none

「那年愚姐一路东行，历尽艰辛抵达长安，才发现大唐天子早已自顾不暇。流寇肆虐，宗室蒙尘，朝廷上下惶惶不可终日，谁还顾得上万里之外的河西故土？愚姐跪在宫门外三日三夜，连一个答复都未曾等到。」|姬姒|酒肆|特殊CG1|none

「此后便是乱世。愚姐走遍大半天下，凡有兵马处皆去求援。淮南、河东、河北、蜀中……那些节度使一个个拥兵自重，听到河西二字便推三阻四，谁愿分兵万里去打通陇右？有的敷衍搪塞，有的闭门不见，有的甚至暗中嗤笑——'遥遥数千里外的边陲荒漠，与我何干？'」|姬姒|酒肆|特殊CG2|none

「愚姐四处奔走二十余年，磨破了多少双鞋底，看尽了多少冷眼，最终却是一事无成。到后来，胡尘隔绝，山高水远，愚姐就是想回到天山，也是办不到了。」|姬姒|酒肆|特殊CG2|none

「每每想起天山派的诸位，想起你，愚姐便愧疚难当。当年信誓旦旦说要带援军回来，如今看来不过是痴人说梦。愚姐有负师门重托，有负张公所嘱，更有负你殷殷期盼的目光。这些年你独自守在天山，可曾怨过愚姐？」|姬姒|酒肆|特殊CG2|none

「愚姐如今已是将死之人，怕是再也走不动了。天下寂寥事，与君阔别时，愚姐常常梦见天山的雪，梦见你笑着朝我跑来，醒来却只有空荡荡的屋梁和窗外的月光。」|姬姒|酒肆|特殊CG3|none

信写到这里，字迹已经歪歪扭扭，几乎难以辨认。最后几行像是用尽了全身力气：「随信附上愚姐的发簪，是当年离开天山时戴着的那一支。愚姐斗胆，求你一件事——若有机会，将这发簪埋在天山派后山，随便哪个角落都好。愚姐这辈子走了太远太远的路，累了，想回家了。」|姬姒|酒肆|特殊CG3|none

「吾妹，莫要为愚姐伤心太久，替愚姐好好活着，替愚姐看看这世间的春花秋月。若来生有缘，愚姐定不再走那么远，就在天山陪着你，哪儿也不去了。」|姬姒|酒肆|特殊CG3|none

信末歪歪扭扭写着：「愚姐怀远绝笔。」落款处有几滴干涸的水渍——是泪痕，还是墨迹，已分不清了。|姬姒|酒肆|特殊CG3|none
</MAIN_TEXT>

<SUMMARY>
周怀远的绝笔信道尽了她一生的遗憾与愧疚。当年她东行求援，最终却蹉跎一生，信中她自责愧对师门，更有负姬姒，此生最大的憾事便是不能再见姬姒一面。信末她请求姬姒将随信的发簪埋在天山派后山，让她魂归故里。
</SUMMARY>

<SIDE_NOTE>
{
    "随机事件": {
        "事件类型": "选项事件",
        "事件描述": "周怀远的绝笔信道尽了她一生的遗憾与愧疚。当年她东行求援，最终却蹉跎一生，信中她自责愧对师门，更有负姬姒，此生最大的憾事便是不能再见姬姒一面。信末她请求姬姒将随信的发簪埋在天山派后山，让她魂归故里。",
        "选项一": {
            "描述": "特殊剧情: 继续",
            "奖励": "",
            "成功率": "100%"
        }
    },
    "时间": "17:30",
    "用户": {
        "位置变动": "酒肆"
    },
    "当前NPC": {
        "姬姒": {
            "好感变化": "上升",
            "位置变动": "酒肆"
        }
    }
}
</SIDE_NOTE>

</SLG_MODE>`
    },
    {
        id: "Jisi_Letter_5",
        name: "故人遗书·姬姒5",
        priority: 76,
        conditions: {
            currentSpecialEvent: { equals: 'Jisi_Letter_4' }
        },
        effects: {
            GameMode: { set: 0 },
            inputEnable: { set: 1 },
            mapLocation: { set: '天山派' },
            companionNPC: { set: [] },
            userLocation: { set: 'houshan' }
        },
        text: `<SLG_MODE>

<MAIN_TEXT>
第二日清晨，你和姬姒在村口与周清婉道别。「前辈，」周清婉深深鞠了一躬，「祖上的心愿总算了结了。今后若有机会，晚辈一定来天山派拜访。」「好。」姬姒点点头，琥珀色的眼眸里带着几分释然，「路上小心，若有难处，随时来找吾。」周清婉眼眶微红，最后看了姬姒一眼，转身上了马车，渐渐消失在晨雾中。

回程的路上，姬姒一直沉默不语。她的手紧紧攥着怀里的发簪和玉佩，狐耳时不时抖动一下，似乎在思考什么。你没有打扰她，只是默默地陪在身边。午后时分，你们终于回到了天山派。姬姒没有回女弟子房，而是径直朝后山走去。

后山有一片僻静的山坡，长满了野花，能俯瞰整个天山派。姬姒在山坡上停下脚步，环顾四周，最后选了一棵松树下的位置。「就这里吧。」她轻声说，「师姐生前最喜欢登高望远……这里能看到整个门派，她一定会喜欢的。」你点点头，默默地帮她挖土。姬姒蹲在一旁，把玉佩和发簪并排放在手心里，怔怔地看了很久。

「师姐，」她轻声说，声音有些沙哑，「吾把你带回来了。」她从怀里取出一方素帕，小心翼翼地把玉佩和发簪用素帕包好，放入土坑中。「这是吾当年亲手绣的……绣得很丑，师姐却说好看……」她的声音越来越低，狐耳耷拉下来，银白色的狐尾紧紧缠住自己。你默默地帮她把土填上，堆成一个小小的坟包。

姬姒在坟前跪下，郑重地磕了三个头。「师姐，」她的声音带着哭腔，「你走了一百二十三年……终于回家了。」泪水顺着她的脸颊滑落，滴在新翻的泥土上。「吾没能等到你回来……但吾会替你看着天山派……」她的肩膀微微颤抖，却没有放声哭出来。你蹲在她身旁，轻轻拍着她的后背，什么也没说。

过了许久，姬姒终于止住了泪水。她用袖子胡乱擦了擦脸，深吸一口气，站起身来。「好了，」她的声音还有些沙哑，但语气已经平静了许多，「师姐的事……总算了结了。」她转过头，琥珀色的眼眸看着你，眼眶还红着，却挤出一个笑容，「谢谢你……陪吾做完这些。」「大师姐，你不用谢我。」你认真地说，「这是我应该做的。」

「对了，」姬姒突然歪着头，「吾有件事想问你。」「什么事？」「昨天在茶楼……」她的嘴角扬起一个小小的弧度，「你是不是以为怀远是吾的……嗯？」你的脸瞬间涨红：「我、我没有——」「骗人，」她凑近你，「你一路上酸溜溜的，吾又不是瞎子。承认吧，你吃醋了。」

「我……」你张口结舌，不知道该怎么解释。姬姒看着你窘迫的样子，忍不住咯咯笑了起来，那笑声清脆悦耳，驱散了悲伤的氛围。「好了好了，不逗你了。」她拍了拍你的肩膀，狐尾也跟着欢快地摇了起来，「其实吾很高兴。」「高兴？」「高兴你会吃醋啊，」她的声音轻了下来，耳尖微微泛红，「说明……你在乎吾嘛。」

你愣在原地，心跳不自觉地加快。姬姒别过头去，假装看向远处的山峰，但你还是看到她的耳朵红得厉害。「师姐走了一百多年……吾一个人等了一百多年……」她的声音飘忽，「有时候吾会想，是不是吾这辈子就只能一个人了……」她顿了顿，狐耳抖了抖，「但是现在，虽然师姐不在了，」她望向山下的门派，语气释然，「但吾还有天山派，还有萧白瑚那个小丫头，还有雨烛……」她偷偷瞥了你一眼，「还有你。」

「走！」她一把拉住你的手，往山下跑去，「吾饿了！咱们去吃顿好的！吾请客！」「大师姐，您慢点——」「慢什么慢！」她回过头，狐耳欢快地抖动，「吾要吃烤羊腿、红烧肉、炖鸡汤、糖醋鱼……对了，还有糖炒栗子！」你被她拽得踉踉跄跄，却忍不住笑了起来——

傍晚，你和姬姒坐在伙房的角落里，面前摆满了各种菜肴。姬姒吃得眉开眼笑，腮帮子鼓鼓的，狐尾摇得像个拨浪鼓。你看着她那副没心没肺的样子，心中涌起一股暖意。「大师姐，」你忍不住开口，「我有件事想跟您说。」「嗯？」她嘴里塞满了肉，含糊不清地应道，「什么事？」

「周怀远师姐……」你认真地看着她，「她说过要带你去中原，看桃花，吃家乡的点心。」姬姒的动作顿了一下，琥珀色的眼眸里闪过一丝怀念。「她没能完成的约定，」你深吸一口气，「以后……以后由我来完成。」姬姒怔住了，筷子停在半空中，呆呆地看着你。「等天下太平了，」你说，「我陪你去中原，去周师姐的家乡看看。」

「你……」姬姒的声音有些发颤，狐耳剧烈地抖动着，「你说真的？」「真的。」你点点头，「我说到做到。」姬姒低下头，银白色的长发垂落，遮住了表情。你看到她的肩膀在微微颤抖。「你……你这张嘴，什么时候变得这么油了……」她的声音闷闷的，带着哭腔，「净说些……不知所谓的话……」她抬起头，眼眶红红的，却笑得比任何时候都灿烂。

「好……」她用力点头，泪水和笑容交织在一起，「那吾就……就等着你带吾去……」她的声音越来越小，脸颊也越来越红。突然，她猛地站起身，绕过桌子来到你面前。还没等你反应过来，她已经踮起脚尖，在你脸颊上飞快地印下一个吻——那触感温软，带着淡淡的肉香。「这是……这是定金！」

话音未落，她转身就跑，银白色的狐尾在身后乱晃，差点撞翻了旁边的凳子。「大师姐！你的菜还没吃完——」「不、不吃了！吾突然想起还有事！」她的声音从门外传来，带着颤抖，「明、明天见！」你呆呆地坐在原地，手摸着被亲过的脸颊。伙房里只剩下你一个人，和满桌的菜。安慕从厨房探头进来，看了看空荡荡的座位，又看了看你傻笑的表情，一脸莫名其妙：「……发生什么事了？」
</MAIN_TEXT>

<SUMMARY>
你和姬姒送别周清婉后返回天山派，在后山为周怀远立了衣冠冢，埋下发簪、玉佩和姬姒当年亲手绣的素帕。姬姒在坟前磕头告别，终于了结百年心事。之后她恢复精神，打趣你一路吃醋的样子，坦言"高兴你在乎我"。她感慨虽然故人已去，但还有天山派、萧白瑚、雨烛和你作为新的家人，决定振作起来。你承诺会替周怀远完成带她去中原的约定，姬姒感动落泪，在你脸上飞快地亲了一下说是"定金"，然后羞得落荒而逃。
</SUMMARY>

<SIDE_NOTE>
{
    "时间": "18:00",
    "用户": {
        "位置变动": "天山派"
    },
    "当前NPC": {
        "姬姒": {
            "好感变化": "大幅上升",
            "位置变动": "女弟子房"
        }
    }
}
</SIDE_NOTE>

</SLG_MODE>`
    },
  
    {
        id: "QTJ_Festival_1",
        name: "九天玄女诞辰1-损友之约",
        priority: 70,
        conditions: {
            currentWeek: { min: 1 },
            "npcFavorability.C": { min: 30 }
        },
        effects: {
            GameMode: { set: 1 },
            inputEnable: { set: 0 },
            mapLocation: { set: '天山派外堡' },
            companionNPC: { push: '钱塘君' }
        },
        text: `<SLG_MODE>

<MAIN_TEXT>
新的一周，某天傍晚时分，你刚从演武场练完功回来，浑身臭汗，正琢磨着去伙房顺点吃的垫垫肚子。还没走出几步，一个熟悉的身影就从墙角窜了出来，银白色的龙尾差点甩到你脸上。「嘿！」钱塘君叉着腰，赤红色的竖瞳里闪着狡黠的光，「你小子躲哪去了？本龙找你半天！」|钱塘君|演武场|兴奋|none

「我能躲哪？」你没好气地拨开她凑过来的脑袋，「练功啊，不像某条懒龙，天天翘课。」「嘁，那叫劳逸结合，懂不懂？」钱塘君完全不以为耻，反而得意地晃了晃额侧的赤红龙角，「行了行了，别废话——后天是九天玄女的诞辰，外堡要办庙会，你知道吧？」你当然知道。每年这个时候，外堡都会热闹好几天，社戏、杂耍、各种小吃摊子，是难民们一年里难得的欢乐时光。往年你们都会结伴下山鬼混，吃完这摊吃那摊，顺便在人群里捉弄几个倒霉蛋。|钱塘君|演武场|得意|none

「知道啊，怎么？」你警觉地后退一步。每次钱塘君用这种语气说话，准没好事。果然，她一把勾住你的脖子，压低声音：「本龙提前跟姐姐请好假了，后天咱俩一起下山看社戏去！戏班子今年演的是《九天玄女授天书》，据说请了伊州来的名角，可精彩了！」你心想：「又来了，每年都是这套，拉着我去外堡鬼混，出了事就把我推出去顶锅……」|钱塘君|演武场|兴奋|none

嘴上却说：「行啊，什么时辰？」「酉时一刻，山门口见！谁迟到谁是狗！」钱塘君拍了拍你的肩膀，语气突然正经起来，「对了，今年的社戏真的很特别，你一定要来。」「特别？怎么个特别法？」「哇哈哈哈，到时候你就知道了！」她笑得一脸神秘，龙尾得意地晃来晃去，然后一溜烟跑了。|钱塘君|演武场|大笑|none

你看着她的背影，总觉得哪里不对劲。这家伙平时约你出去玩，从来都是直接拖着就走，哪用得着提前两天通知？而且刚才那句「很特别」，她的眼神好像闪过一丝……紧张？算了，想不明白。你摇摇头，转身去伙房找吃的。你心想：「管她呢，反正后天去了就知道。指不定又是她憋的什么坏主意，到时候见机行事就是。」|none|演武场|none|none

两天后，酉时一刻。夕阳把天边染成橘红色，你早早地站在山门口。晚风带着山间的凉意，吹得人精神一振。等了一刻钟，钱塘君没来。等了两刻钟，还是没来。「这臭龙……」你骂骂咧咧，「说好谁迟到谁是狗，结果自己先当狗了。」|none|山门|none|none

已经等了小半个时辰，你实在等不下去了，决定先去女弟子房找她。结果刚走到门口，就被一个路过的外门女弟子拦住了。「师兄找谁？」「钱塘君，她在不在？」「钱塘师姐啊，」那女弟子眨眨眼，「她午后就下山了，说是去外堡有急事，让我碰见你的话转告一声——让你自己先过去，她在外堡等你。」|none|女弟子房|none|none

你愣住了。什么情况？约好一起走，结果她自己先跑了？你心里涌起一股无名火，但更多的是困惑。钱塘君这家伙虽然没正形，但从小到大，唯独不会在玩的事上放你鸽子。今天这是怎么了？「算了……」你叹了口气，「去外堡找她问清楚。」夕阳已经西沉，天边只剩最后一抹余晖。你一个人走出山门，沿着峡谷的小道往外堡走去。|none|山道|none|none
</MAIN_TEXT>

<SUMMARY>
新的一周，九天玄女诞辰前两天，钱塘君约你一起去外堡看社戏，神神秘秘地说今年的戏「很特别」。当天酉时三刻你按时到山门等她，却等来一个外门女弟子的转告——钱塘君已经先行下山了，让你自己去外堡找她。你满腹狐疑，独自踏上了前往外堡的路。
</SUMMARY>

<SIDE_NOTE>
{
    "随机事件": {
        "事件类型": "选项事件",
        "事件描述": "钱塘君失约，独自先行下山。你决定前往外堡一探究竟。",
        "选项一": {
            "描述": "特殊剧情: 继续",
            "奖励": "",
            "成功率": "100%"
        }
    },
    "时间": "18:30",
    "用户": {
        "位置变动": "山道"
    },
    "当前NPC": {
        "钱塘君": {
            "好感变化": "不变",
            "位置变动": "none"
        }
    }
}
</SIDE_NOTE>

</SLG_MODE>`
    },

    // ==================== 第二段：庙会盛景 ====================
    {
        id: "QTJ_Festival_2",
        name: "九天玄女诞辰2-庙会盛景",
        priority: 69,
        conditions: {
            currentSpecialEvent: { equals: 'QTJ_Festival_1' }
        },
        effects: {},
        text: `<SLG_MODE>

<MAIN_TEXT>
穿过峡谷，外堡的景象让你一愣。暮色四合，但小盆地里却灯火通明，宛如白昼。数不清的灯笼挂满了集市两旁，红的、黄的、五颜六色的，把整条街照得亮堂堂。人声鼎沸，比往年任何一届庙会都热闹。孩子们举着糖人跑来跑去，老人们三五成群地往戏台方向走，空气里弥漫着羊肉串和胡饼的香味，还有爆竹燃烧后的硝烟气息。|none|市集|none|none

你挤进人群，四处张望着寻找钱塘君那显眼的银白龙尾。但外堡今天实在太挤了，到处都是人头攒动，你转了半天也没找到她的影子。「这臭龙到底躲哪去了……」你心里嘀咕，一边躲避着乱窜的熊孩子，一边往戏台的方向走。远处传来锣鼓声，社戏快开场了。|none|市集|none|none

戏台搭在外堡最大的广场上，用粗木和彩布搭成，周围插满了火把，映得台上亮如白昼。台下已经里三层外三层围满了人，男女老少都伸长脖子等着开戏。你好不容易挤到一个能看见台子的位置，耳边传来两个大婶的闲聊。「哎，听说没？今年演玄女娘娘的角儿换了！」「换了？不是请的伊州名角吗？」「名角路上病了，临时换人！」「换谁了？」「不知道啊，听说是天山派的弟子，派里的长老临时点的名……」|none|市集|none|none

你心里咯噔一下。一种不祥的预感涌上心头。你想起钱塘君那句「今年很特别」，想起她神秘兮兮的笑容，想起她提前下山的反常举动……不会吧？|none|市集|none|none
</MAIN_TEXT>

<SUMMARY>
你抵达外堡，发现庙会热闹非凡，灯火通明如同白昼。可是四处也找不着钱塘君，你只得一人来到社戏的戏台前。开演前，你听说原定演出的名角因病缺席，今年将由天山派弟子顶替出演。
</SUMMARY>

<SIDE_NOTE>
{
    "随机事件": {
        "事件类型": "选项事件",
        "事件描述": "社戏即将开演，可是四处寻不着钱塘君，你心中隐隐有预感...",
        "选项一": {
            "描述": "特殊剧情: 继续",
            "奖励": "",
            "成功率": "100%"
        }
    },
    "时间": "19:00",
    "用户": {
        "位置变动": "市集"
    },
    "当前NPC": {
        "钱塘君": {
            "好感变化": "不变",
            "位置变动": "市集"
        }
    }
}
</SIDE_NOTE>

</SLG_MODE>`
    },
    // ==================== 第三段：粉墨登场 ====================
    {
        id: "QTJ_Festival_3",
        name: "九天玄女诞辰3-庙会盛景",
        priority: 68,
        conditions: {
            currentSpecialEvent: { equals: 'QTJ_Festival_2' }
        },
        effects: {},
        text: `<SLG_MODE>

<MAIN_TEXT>
锣鼓声骤然响起，人群安静下来。一个老者走上戏台，扯着嗓子喊道：「各位乡亲父老！今年玄女娘娘诞辰社戏，因名角抱恙，由我天山派弟子代为登台，还望海涵！下面有请——九天玄女娘娘！」|none|市集|none|none

帷幕缓缓拉开。火把的光芒映照在台上，一道身影从幕后走出——你的眼睛瞬间瞪大了。那是一个身着华丽戏服的女子，头戴凤冠，身披霞帔，脸上画着精致的妆容，手持一柄玉如意，端的是雍容华贵、仙气飘飘。但你认得那对赤红色的龙角，认得那条银白色的龙尾——哪怕被霞帔遮了大半，依然能看见尾尖不安地晃动着。是钱塘君。|钱塘君|市集|特殊CG1|none

你的脑子嗡的一声。那个平日里大大咧咧、没心没肺、动不动就威胁要将你一斧劈成两半的损友，此刻正站在戏台上，一本正经地扮演着玄女元君。你使劲揉了揉眼睛，确定自己没看错。你心想：「想不到……原来是这个'特别'……」|钱塘君|市集|特殊CG1|none

台上的钱塘君似乎完全变了个人。她的步伐稳重，身姿挺拔，眼神中透着一股不怒自威的气势。她开口唱道，声音婉转动听，竟然出乎意料地好听。你其实知道她会唱戏——小时候在外堡混日子的时候，她偶尔会哼几句，但你从没认真听过，只当是她随口唱着玩。没想到正经唱起来，居然是这个水平。|钱塘君|市集|特殊CG1|none

周围的观众也被震住了。先是一片寂静，然后爆发出雷鸣般的叫好声。「好！」「唱得好啊！」「九天玄女娘娘显灵了！」火把的光芒映在她的凤冠上，流光溢彩。你站在人群中，看着台上那个熟悉又陌生的身影，心里翻涌着说不清的情绪。你心想：「这家伙……原来还藏着这一手。」|钱塘君|市集|特殊CG1|none
</MAIN_TEXT>

<SUMMARY>
登台扮演九天玄女的竟然是钱塘君。平日大大咧咧的她此刻身着华服、妆容精致，举手投足间端庄大气，唱腔婉转动人。你其实知道她小时候学过唱戏，但没想到她真敢上台，而且唱得这么好。
</SUMMARY>

<SIDE_NOTE>
{
    "随机事件": {
        "事件类型": "选项事件",
        "事件描述": "钱塘君正在台上扮演九天玄女，表演惊艳全场。你决定看完这出戏再找她问清楚。",
        "选项一": {
            "描述": "特殊剧情: 继续",
            "奖励": "",
            "成功率": "100%"
        }
    },
    "时间": "19:30",
    "用户": {
        "位置变动": "市集"
    },
    "当前NPC": {
        "钱塘君": {
            "好感变化": "不变",
            "位置变动": "市集"
        }
    }
}
</SIDE_NOTE>

</SLG_MODE>`
    },
    // ==================== 第四段：台前幕后（修订版） ====================
    {
        id: "QTJ_Festival_4",
        name: "九天玄女诞辰4-台前幕后",
        priority: 67,
        conditions: {
            currentSpecialEvent: { equals: 'QTJ_Festival_3' }
        },
        effects: {},
        text: `<SLG_MODE>

<MAIN_TEXT>
社戏演了整整一个时辰。钱塘君从头演到尾，把九天玄女授黄帝天书、助轩辕大败蚩尤的故事演绎得荡气回肠。台下的观众看得如痴如醉，不少老人热泪盈眶。你也看得入神，好几次忘了眨眼。夜风吹过，火把的光芒摇曳，她站在台上，霞帔翻飞，当真有几分神女下凡的味道。|钱塘君|市集|平静|none

锣鼓声停，大戏落幕。钱塘君站在台上向观众行礼谢幕，台下掌声雷动。有人往台上扔花，有人大喊「九天娘娘保佑」。你趁着人群散去的混乱，悄悄绕到了戏台后面。|none|庭院|none|none

后台是一间临时搭建的布棚，里面堆满了戏服道具。你掀开帘子钻进去，正好看见钱塘君坐在铜镜前，凤冠还没来得及摘，正端着一碗凉茶咕嘟咕嘟往嘴里灌，喝得满嘴茶渍也顾不上擦。听到动静，她从镜子里看到你，赤红色的竖瞳里闪过一丝……得意？|钱塘君|庭院|得意|none

「哟！」她放下茶碗，转过身来，双手叉腰，下巴高高扬起，那副嘚瑟劲儿简直要溢出来，「怎么样怎么样？本龙方才的表演，是不是惊为天人？是不是叹为观止？是不是——」「是是是，」你没好气地打断她，「是不是该把嘴边的茶渍擦一擦？九天玄女娘娘？」|钱塘君|庭院|大笑|none

钱塘君愣了一下，伸手往嘴边一抹，果然沾了一手茶渍。她瞪了你一眼，龙尾气得甩了两下，但很快又恢复了那副得意洋洋的表情：「哇哈哈哈，小节小节！本龙今天可是社戏头牌！头牌懂不懂？全场观众都为本龙喝彩！你看见没有？那些老太太都哭了！感动哭的！」「我看见了，」你靠在门框上，抱着胳膊，「我还看见你方才谢幕的时候，腿在抖。」|钱塘君|庭院|得意|none

钱塘君的笑容僵了一瞬。「胡说！本龙哪有——」「你每次紧张的时候，龙尾都会往左边甩，」你慢悠悠地说，「方才你谢幕的时候，龙尾往左边甩了七下，我数着呢。」她张了张嘴，想反驳什么，却又说不出来。龙尾果然又心虚地往左边甩了一下。|钱塘君|庭院|害羞|none

「……你什么时候变得这么讨厌了？」她嘟囔着，转回身去继续摘头上的凤冠，「亏本龙还想给你一个惊喜。」「惊是挺惊的，」你走近几步，在她旁边的木箱上坐下，「我是真没想到你会上台。你不是说再也不唱了吗？」|钱塘君|庭院|为难|none

钱塘君的动作顿了顿。她沉默了片刻，银白色的长发从凤冠下散落，在油灯的光芒中泛着柔和的光泽。「……你还记得？」「废话。」你说，「小时候在外堡，你哼那几段戏词的时候，我就在旁边听着呢。虽然那时候你五音不全跑调跑得离谱——」|钱塘君|庭院|惊讶|none

她愣住了，转过头来看你，赤红色的眼眸里有一抹你看不懂的情绪。「你……一直都记得？」「当然记得。」你耸耸肩，「咱俩从小一起长大，你的事我哪有不知道的。戏班子的王班主教你唱戏，每天天不亮就开始吊嗓子。后来你进了天山派，说什么'练武才是正道'，就再没唱过了。」|钱塘君|庭院|平静|none

你没有提起她为什么要去戏班子帮忙。你知道那段日子——她还没被洞庭君认回去，在难民堆里混日子，吃不饱穿不暖，去戏班子跑腿能混口饭吃。你也知道她那一半党项血统给她带来了多少白眼和欺负。但这些事，你从来不会主动提起。她不说，你就不问。这是你们之间多年的默契。|钱塘君|庭院|平静|none

「今天怎么突然又唱了？」你问，「洞庭长老逼你的？」「才不是逼！」钱塘君瞪了你一眼，但语气软了下来，「是……是名角病了，姐姐说外堡的乡亲们盼了一年，不能让他们失望。派里只有我学过这出戏，而且……」她顿了顿，龙尾不安地晃了晃，「而且姐姐说，我唱得比那个名角还好。」|钱塘君|庭院|害羞|none

「那你姐姐说得对，」你看着她，认真地说，「你今天确实唱得很好。不是恭维你——是真的好。台上的你，和平时完全不一样。」钱塘君的手指停在发间，龙角悄悄泛起淡淡的红晕。「……你今天是不是吃错药了？」她的声音有些发颤，「怎么净说这种肉麻话？」「我说实话而已。」|钱塘君|庭院|害羞|none

沉默了片刻。布棚里只有外面传来的喧嚣声，和油灯燃烧的轻微噼啪声。然后钱塘君突然「噗嗤」一声笑了出来，伸手在你脑袋上拍了一下：「行了行了，本龙知道本龙厉害！不用你夸！」她站起来，抓起一旁的外袍披在身上，恢复了平日里那副没心没肺的样子，「走走走！本龙唱了一个时辰，饿死了！外面庙会还热闹着呢，你请客！」|钱塘君|庭院|大笑|none

「凭什么我请客？」「凭你迟到！」「我迟到？明明是你——」「少废话！」她一把拽住你的手腕往外拖，力气大得惊人，「头牌出行，跟班买单，天经地义！」|钱塘君|庭院|得意|none
</MAIN_TEXT>

<SUMMARY>
社戏结束后，你潜入后台找到钱塘君。她非但不害羞，反而得意洋洋地炫耀自己是「社戏头牌」，还被你吐槽嘴边有茶渍、谢幕时腿在抖。你点破她紧张时龙尾会往左甩的习惯，她一时语塞。作为青梅竹马，你其实一直记得她小时候学戏的事，但从不主动提起那段艰难岁月。你真诚地夸她「今天唱得很好」，她龙角泛红，嘴上说你肉麻，却很快恢复常态，拉着你去逛庙会。
</SUMMARY>

<SIDE_NOTE>
{
    "随机事件": {
        "事件类型": "选项事件",
        "事件描述": "你和钱塘君之间的默契让这次对话温馨而自然。现在她拉着你准备去逛夜市。",
        "选项一": {
            "描述": "特殊剧情: 继续",
            "奖励": "",
            "成功率": "100%"
        }
    },
    "时间": "21:30",
    "用户": {
        "位置变动": "市集"
    },
    "当前NPC": {
        "钱塘君": {
            "好感变化": "上升",
            "位置变动": "市集"
        }
    }
}
</SIDE_NOTE>

</SLG_MODE>`
    },
    {
        id: "QTJ_Festival_5",
        name: "九天玄女诞辰5-庙会同游",
        priority: 66,
        conditions: {
            currentSpecialEvent: { equals: 'QTJ_Festival_4' }
        },
        effects: {},
        text: `<SLG_MODE>

<MAIN_TEXT>
夜市比白天更热闹。灯笼的光芒把整条街照得亮堂堂，到处是叫卖声、笑闹声、锅碗瓢盆的碰撞声。钱塘君换下了戏服，但那张脸实在太过出众——银白的长发在灯火下泛着柔光，赤红的龙角在人群中格外显眼——走到哪都有人回头看。你被她拖着从街头吃到街尾，糖葫芦、羊肉串、胡饼、酥油茶、炸丸子……她的战斗力简直惊人，你怀疑她的胃里是不是另有乾坤。|钱塘君|市集|兴奋|none

「呼——」她满足地拍拍肚子，打了个响亮的饱嗝，「舒坦！」「你到底是龙还是猪？」你看着自己瘪下去的钱袋，欲哭无泪，「我这个月的月钱全交代在你肚子里了。」「嘿嘿，约头牌名角出来同游，哪有不花钱的？」她拍拍你的肩膀，一脸「深表同情但毫不心软」的表情，「再说，谁让你是我跟班呢？愿赌服输！」「我什么时候跟你赌了？」「你迟到了啊。」「明明是你先跑——」|钱塘君|市集|得意|none

你简直哭笑不得。这家伙的脸皮，怕是比城墙还厚。你们边吃边逛，路过一个捞金鱼的摊子，钱塘君的眼睛亮了：「哇！金鱼！本龙要捞！」她蹲下来抓起纸网就往盆里伸——啪！纸网一碰水就破了。「什么破玩意！」她瞪着手里的木柄，龙尾气得炸毛，「骗人！」然后——啪！啪！啪！连破三个。|钱塘君|市集|生气|none

你实在看不下去了，从她手里拿过纸网，蹲下来，深吸一口气，将纸网斜斜地插入水中，借着水的浮力托起一条小金鱼，然后迅速而平稳地捞出水面——成功了。「卧槽！」钱塘君瞪大眼睛，「你怎么做到的！」「小时候在外堡学的，你忘了？」你把小金鱼放进摊主递来的袋子里，「那时候你只顾着吊嗓子，我闲着没事就在摊子边上看人家捞。」你把装着金鱼的袋子递给她：「给你。」「啊？」「反正我也养不活，给你吧。就当是今天看戏的谢礼。」|钱塘君|市集|惊讶|none

钱塘君接过袋子，盯着里面游来游去的小红鱼，半晌没说话。灯笼的光芒映在她脸上，她的表情有些奇怪。「……哼，」她把脸别过去，龙尾却悄悄翘了起来，「算你有点良心。」|钱塘君|市集|害羞|none

你们继续往前走。路过一个卖首饰的摊子，她的脚步慢了下来，眼睛盯着一对银质的耳坠——做工精致，坠着小小的铃铛，晃动时会发出清脆的声响。你正想说点什么，身后突然传来几个年轻人的议论声——「哎，你们看那边那个姑娘，是不是刚才戏台上演九天玄女的？」「好像是！你看那龙角！」「哇，真人比台上还好看！」「她旁边那个男的是谁？」「不知道，看着挺般配的。」「是吧是吧，郎才女貌的，该不会是一对吧？」|none|市集|none|none

你的脚步顿了一下。余光瞥向钱塘君，想看看她什么反应——结果她居然一脸淡定，甚至还转过头来，挑了挑眉，用一种「你听见了吧」的眼神看着你。「怎么？」她嘴角勾起一个促狭的笑，龙尾得意地晃了晃，「被人说和本龙般配，很丢脸吗？」|钱塘君|市集|得意|none

「没有，我——」「还是说，」她凑近一步，赤红色的竖瞳闪闪发光，鼻尖几乎要碰到你的脸，「你觉得自己配不上本龙？」「……」你一时语塞。这家伙，什么时候学会反将一军了？「哇哈哈哈！」看到你吃瘪的表情，钱塘君笑得前仰后合，龙尾甩得欢快，「开玩笑的啦！你那个表情也太好笑了！放松放松，咱俩是兄弟，兄弟懂不懂？别人爱怎么说怎么说，关咱们什么事？」|钱塘君|市集|大笑|none

她说得轻松，好像完全不在意。但你注意到，她的龙角——那两只赤红色的小角——尖端悄悄泛起了一层淡淡的红晕。「对了，」她像是想起什么，突然岔开话题，指着那个首饰摊子，「你说那个耳坠好不好看？」她说得漫不经心，但龙尾却不自觉地朝那边晃了晃。|钱塘君|市集|平静|none

你看了她一眼，什么也没说，走到摊子前，掏出仅剩的几个铜板。「老板，这对耳坠我要了。」「哎？」钱塘君愣住了，「你、你干嘛——」「给你的。」你把耳坠递过去，「刚才不是说好看吗？」「本龙就是随口说说，又不是真想要！」她的声音突然拔高了几度。「哦，那我退了？」「……别。」她飞快地把耳坠抢过去攥在手里，龙角已经红透了，「既然买都买了，就当是跟班孝敬本龙的，本龙勉为其难收下就是。」|钱塘君|市集|害羞|none
</MAIN_TEXT>

<SUMMARY>
你和钱塘君逛夜市，从街头吃到街尾，还玩了捞金鱼——她连破好几个纸网都捞不上来，你一次成功，把金鱼送给了她。路人议论你们「郎才女貌」，她非但不害羞，反而大大咧咧地反问你「觉得配不上本龙？」，用损友方式化解暧昧。你买了她偷偷喜欢的耳坠送她，她嘴硬说「不想要」，龙角却红透了。
</SUMMARY>

<SIDE_NOTE>
{
    "随机事件": {
        "事件类型": "选项事件",
        "事件描述": "你和钱塘君一同逛夜市，吃了很多东西，一起捞了金鱼，还买了她喜欢的耳坠。",
        "选项一": {
            "描述": "特殊剧情: 继续",
            "奖励": "",
            "成功率": "100%"
        }
    },
    "时间": "22:30",
    "用户": {
        "位置变动": "市集"
    },
    "当前NPC": {
        "钱塘君": {
            "好感变化": "大幅上升",
            "位置变动": "市集"
        }
    }
}
</SIDE_NOTE>

</SLG_MODE>`
    },
    {
        id: "QTJ_Festival_6",
        name: "九天玄女诞辰6-庙会同游",
        priority: 65,
        conditions: {
            currentSpecialEvent: { equals: 'QTJ_Festival_5' }
        },
        effects: {
            GameMode: { set: 0 },
            inputEnable: { set: 1 },
            mapLocation: { set: '天山派' },
            companionNPC: { set: [] },
            userLocation: { set: 'shanmen' },
            "playerTalents.魅力": { add: 1 }     
        },
        text: `<SLG_MODE>

<MAIN_TEXT>
夜深了，庙会的人群渐渐散去。你们并肩走在回山的路上，月光洒在峡谷的小道上，银白色的光芒和她的头发融为一体。钱塘君一手拎着装金鱼的袋子，一手攥着那对耳坠，心情看起来很好，嘴里还哼着刚才戏台上的曲调。

「喂。」她突然开口，声音轻了下来。「嗯？」「今天……」她顿了顿，龙尾不安地晃了晃，「今天还挺好玩的。」「是吗？」你故意问，「比你一个人在台上当头牌还好玩？」「那当然！」她瞪了你一眼，但眼角带着笑意，「唱戏多累啊，嗓子都冒烟了。还不如跟你这个冤大头出来逛街，白吃白喝白拿。」「……所以我今天就是个移动钱袋？」「不然呢？」她笑得没心没肺，「兄弟不就是用来坑的吗？」

走到山门口时，月亮已经升到了中天。钱塘君停下脚步，转身看着你。月光洒在她银白色的头发上，给她镀上了一层光晕，仿佛真的是天上的仙女一般出尘绝伦。那双赤红色的竖瞳里，映着月光，也映着你。「喂，{{user}}。」她的声音突然轻了下去，和平时的张扬判若两人。「怎么了？」「明年的庙会……」她抿了抿嘴唇，龙尾不安地晃动着，「明年你还来吗？」

你看着她。月光下的她，没有了白天的嘻嘻哈哈，没有了戏台上的雍容华贵，只是一个有些紧张、有些期待的少女。「当然来。」你说。「……真的？」「嗯。不过下次你要是还上台，」你故意停顿了一下，「记得提前告诉我。」「干嘛？」「我好准备鲜花啊。」你说，「给头牌献花，不是天经地义的吗？」

钱塘君愣住了。月光下，她的龙角红得发亮，连耳根都染上了绯色。她张了张嘴，似乎想说什么，但话到嘴边又咽了回去。龙尾不安地晃了两下，然后突然停住。「……你等着。」她的声音闷闷的，别过头去不看你，转身朝山门里面走去「明年要是敢拿几朵破野花来糊弄本龙，本龙一斧头劈死你。」「知道了知道了，最大最漂亮的那种。」你笑着说。

「哼。」她应了一声，脚步又快了许多。银白色的龙尾在月光下向左边来回摇摆，仿佛走的再快一些，就能掩藏少女心事。又走远了十几步，钱塘君头也不回地丢下一句：「谢谢你，今天...还挺开心的。」声音轻得几乎被夜风吹散。然后她快步跑开了，银白的身影很快消失在夜色里。
</MAIN_TEXT>

<SUMMARY>
回山路上，钱塘君和你回顾今天的庙会，她难得认真地邀请你，问你「明年还来吗」，你说要带花给头牌献花。她害羞跑开。
</SUMMARY>

<SIDE_NOTE>
{
    "时间": "23:30",
    "用户": {
        "位置变动": "天山派"
    },
    "当前NPC": {
        "钱塘君": {
            "好感变化": "大幅上升",
            "位置变动": "女弟子房"
        }
    }
}
</SIDE_NOTE>

</SLG_MODE>`
    },

    // ==================== 第一回合：甜蜜与苦涩 ====================
    {
        id: "Yuzhu_HamiOasis_Dilemma_1",
        name: "雨烛·哈密绿洲1",
        priority: 60,
        conditions: {
            currentWeek: { min: 1 },
            "npcFavorability.H": { min: 55 }
        },
        effects: {
            GameMode: { set: 1 },
            inputEnable: { set: 0 },
            mapLocation: { set: '哈密绿洲' },
            companionNPC: { push: '雨烛' }
        },
        text: `<SLG_MODE>

<MAIN_TEXT>
新的一周的某个清晨，哈密绿洲的瓜果市集在晨光中苏醒，空气里弥漫着瓜果的甜香，混杂着驴粪和汗水的气息——后者让你忍不住皱了皱鼻子。你和雨烛奉命来此采购瓜果，补充门派储备。说是"奉命"，其实是破阵子长老随口一提，雨烛便眼睛亮得像发现了宝藏，拽着你的袖子摇了三十七下，直到你答应带她下山。|雨烛|市集|兴奋|none

「哥哥快看！那个瓜好大！」雨烛像只欢快的小鸟，在摊位间蹦来蹦去，金色的长发在阳光下跳跃，腰后的青色羽翼不自觉地微微扇动。她难得出远门，对什么都好奇得不行——刚才她盯着一个卖糖人的老头看了半炷香，差点把人家看出冷汗。|雨烛|市集|兴奋|none

「雨儿，」你无奈地喊她，「我们是来买瓜的，不是来——」话音未落，雨烛已经不知从哪儿摸来一块切好的哈密瓜，整个脑袋埋进去，腮帮子鼓得像只贪吃的仓鼠。她抬起头，嘴角全是瓜汁，碧蓝色的眼眸里满是惊喜：「好甜！好甜好甜！哥哥你也尝尝！」|雨烛|市集|大笑|none

你心想：「这丫头……钱还没给呢。」但看着她那副满足的表情，你还是默默从荷包里掏出铜板，递给一旁笑得合不拢嘴的瓜农。瓜农是个黝黑的老汉，满脸皱纹笑得堆成沟壑：「小姑娘好福气，这是今年头茬的蜜瓜，甜着呢！」|雨烛|市集|微笑|none

雨烛边走边吃，突然停下来，歪着头看向你。她把手里的瓜递过来，瓜肉上还留着她的牙印：「哥哥，你吃这边，雨儿咬过的地方最甜。」你愣了一下，不知该感动于她的分享精神，还是该吐槽她的卫生观念。你心想：「算了，反正都是同门师兄妹，吃就吃吧？」|雨烛|市集|微笑|none

你正要下嘴，集市后头突然传来一阵骚动。「抓住他！小贼！」「别让他跑了！」人群像被石块砸进的水面，向四周散开。你拉住雨烛，警惕地看向骚乱的方向——只见一个瘦骨嶙峋的少年被几个壮汉按倒在地，手里死死攥着一个钱袋。|none|市集|none|none

「偷老子的钱！」一个老汉冲上前，抄起扁担就要往少年身上招呼。正是刚才卖瓜给你们的那个王大爷，此刻脸上的笑容荡然无存，取而代之的是可怖的怒容：「打断他的手！让他知道偷东西的下场！」|none|市集|none|none

少年被按在地上，面朝黄土，瘦得皮包骨头的后背在阳光下显得格外刺眼。他没有挣扎，也没有求饶，只是把钱袋攥得更紧，仿佛那是他的命。扁担高高举起——|none|市集|none|none

「住手！」雨烛的声音从你身旁响起。你转头，发现她已经冲出去三步，羽翼微微展开，连羽索不知何时已经握在手中，泛着银光。她的脸上没了刚才的笑容，碧蓝色的眼眸里满是焦急：「不能打人！会打死人的！」|雨烛|市集|紧张|none

你一把拉住她的手腕：「等等，先看清楚情况。」你心想：「这丫头心肠软是好事，但江湖上的事哪有那么简单……贸然出手，搞不好反而帮倒忙。」雨烛急得眼眶泛红，羽翼抖个不停：「可是他会被打死的！」「我知道，」你压低声音，「但咱们是天山派的人，不能随便插手地方上的事……先问清楚再说。」|雨烛|市集|为难|none

扁担悬在半空。王大爷喘着粗气，瞪着地上的少年：「问什么问！人赃并获，还有什么好问的！」围观的人群越聚越多，有叫好的，有冷眼旁观的，有交头接耳议论的——但没人上前阻止。你心想：「每个人都有自己的立场，每个人都有自己的难处。而我们……」你看了一眼雨烛。她咬着嘴唇，眼眶通红，却被你死死拽住，动弹不得。羽翼在她身后剧烈颤抖，像极了一只想要飞却被困住的小鸟。|雨烛|市集|悲伤|none
</MAIN_TEXT>

<SUMMARY>
你与雨烛奉命前往哈密绿洲采购瓜果。雨烛第一次吃到哈密瓜，开心得像只小仓鼠。然而好景不长，一个瘦骨嶙峋的少年偷了瓜农王大爷的钱袋被当场抓住，王大爷暴怒之下要打断他的手。雨烛想冲上去阻止，你拉住她，提醒她先看清情况再说。围观人群冷漠旁观，雨烛急得羽翼颤抖，陷入两难。
</SUMMARY>

<SIDE_NOTE>
{
    "随机事件": {
        "事件类型": "选项事件",
        "事件描述": "少年偷钱被抓，即将被打。雨烛想出手阻止，你拉住她。围观群众冷漠旁观，扁担高悬——你们该如何抉择？",
        "选项一": {
            "描述": "特殊剧情: 继续",
            "奖励": "",
            "成功率": "100%"
        }
    },
    "时间": "09:30",
    "用户": {
        "位置变动": "市集"
    },
    "当前NPC": {
        "雨烛": {
            "好感变化": "不变",
            "位置变动": "市集"
        }
    }
}
</SIDE_NOTE>

</SLG_MODE>`
    },

    // ==================== 第二回合：没有对错的困局 ====================
    {
        id: "Yuzhu_HamiOasis_Dilemma_2",
        name: "雨烛·哈密绿洲2",
        priority: 59,
        conditions: {
            currentSpecialEvent: { equals: 'Yuzhu_HamiOasis_Dilemma_1' }
        },
        effects: {},
        text: `<SLG_MODE>

<MAIN_TEXT>
「慢着。」你走上前一步，「这位老丈，打人可以，但能不能先让晚辈问几句？」王大爷狐疑地看着你，扁担依然举着：「你谁啊？」「路过的江湖人。」你拱了拱手，「只是想弄清楚，这钱袋里有多少银子，值得打断一个人的手？」|none|市集|none|none

「三两七钱！」王大爷吼道，青筋暴起，「老子种了一辈子瓜，今年收成好不容易卖了个好价钱！这钱是给我老爹买药的！他瘫在床上三年了，就等着这钱活命！」他的声音在发颤，眼眶突然红了：「我老爹七十八了……再不治，就熬不过今年冬天……」|none|市集|none|none

人群中响起一阵叹息。雨烛的羽翼停止了颤抖，她愣愣地看着王大爷，脸上的表情从愤怒变成了困惑。你心想：「果然没那么简单。」你蹲下身，看向被按在地上的少年：「你呢？偷钱做什么？」|none|市集|none|none

少年抬起头，你这才看清他的脸——不过十三四岁，脸颊凹陷，嘴唇干裂，眼窝深深凹进去，却有一双倔强的眼睛。他没有看你，而是死死盯着手里的钱袋，声音沙哑得像砂纸：「我妹妹……高烧三天了……再不买药，她就死了……」|none|市集|none|none

「少他妈编故事！」王大爷啐了一口，「哪个贼不会找借口！」「我没骗人！」少年突然挣扎起来，被壮汉们按得更紧，「我叫阿牛！我爹娘被擒生军杀了！就剩我和妹妹两个人！她才八岁！她什么都没做错！她只是……只是生病了……」他的声音越来越小，最后变成了呜咽。|none|市集|none|none

人群安静了。王大爷的扁担依然举着，但动作僵住了。雨烛站在你身旁，碧蓝色的眼眸里满是迷茫。她张了张嘴，想说什么，却发现自己什么都说不出来。你心想：「偷东西的是坏人，被偷的是好人——这是最简单的道理。可现在，坏人有坏人的苦衷，好人也有好人的难处……」|雨烛|市集|为难|none

「他在骗人！」人群里有人喊道，「这种话谁不会说！」「就是！打他！」「别打了，看他怪可怜的……」「可怜什么！可怜老王头啊！他爹躺床上等着救命呢！」声音此起彼伏，嗡嗡嗡地吵成一片，谁也说服不了谁。|none|市集|none|none

阿牛突然从人群的缝隙中抬起头，死死盯着王大爷，额头在地上磕出了血：「求求你……我什么都可以给你……我可以给你当牛做马……我可以给你干一辈子活……求你让我把药买回去……我妹妹快死了……」他的额头磕在地上，一下，又一下，砰砰作响。血从额角流下来，滴在干燥的泥土上，很快被吸干，只留下一个个暗红色的印记。|none|市集|none|none

王大爷的手在发抖。他老泪纵横，浑浊的眼睛里满是痛苦：「我爹……我爹也快死了啊……凭什么……凭什么我要让给你……」他的声音变成了哭腔：「我种了一辈子瓜……我从没害过人……凭什么是我……」扁担从他手里滑落，砸在地上，扬起一片尘土。|none|市集|none|none
</MAIN_TEXT>

<SUMMARY>
你上前询问事情原委，发现偷钱少年阿牛是被擒生军杀害双亲的孤儿，偷钱是为了给高烧三天、命悬一线的八岁妹妹买药。而瓜农王大爷的钱同样是给瘫痪三年、熬不过冬天的七十八岁老父买药的救命钱。两个"受害者"，都有不得已的苦衷。
</SUMMARY>

<SIDE_NOTE>
{
    "随机事件": {
        "事件类型": "选项事件",
        "事件描述": "两个都需要救命钱的人，是非对错并非那么直白易判",
        "选项一": {
            "描述": "特殊剧情: 继续",
            "奖励": "",
            "成功率": "100%"
        }
    },
    "时间": "10:15",
    "用户": {
        "位置变动": "市集"
    },
    "当前NPC": {
        "雨烛": {
            "好感变化": "不变",
            "位置变动": "市集"
        }
    }
}
</SIDE_NOTE>

</SLG_MODE>`
    },

    {
        id: "Yuzhu_HamiOasis_Dilemma_3",
        name: "雨烛·哈密绿洲3",
        priority: 58,
        conditions: {
            currentSpecialEvent: { equals: 'Yuzhu_HamiOasis_Dilemma_2' }
        },
        effects: {},
        text: `<SLG_MODE>

<MAIN_TEXT>
雨烛的身体在发抖。你看着她——她的脸色煞白，嘴唇微微颤动，碧蓝色的眼眸里满是恐惧和迷茫。她简单的世界正在崩塌。在她的认知里，偷东西是错的，帮助别人是对的，好人应该得到好报，坏人应该受到惩罚。可现在——谁是好人？谁是坏人？谁对？谁错？|雨烛|市集|害怕|none

「让开让开！」一阵喧哗从人群边缘传来，七八个地痞流氓模样的人挤了进来，为首的是个满脸横肉的大汉，手里拎着一把砍刀：「听说有人闹事？哟，王老头，你这是怎么了？」他的目光扫过地上的阿牛，又扫过王大爷，最后落在摊位上堆成小山的哈密瓜上，眼睛亮了起来：「这样吧，我帮你教训这小贼，你把这堆瓜给我，两清。怎么样？」|none|市集|none|none

王大爷的脸色更白了：「这……这是我一年的收成……」「那你想怎么着？」横肉大汉把砍刀往地上一戳，「报官？官老爷会管你一个卖瓜的？还是你想自己动手？行啊，打死人你赔得起吗？」他的目光扫向周围的人群，阴恻恻地笑了：「我李三在这片地头上说话还是算数的。给个面子，大家都好过。不给面子……」他没说完，但砍刀在阳光下闪着寒光。|none|市集|none|none

你心想：「该死，趁火打劫的来了。」你摸了摸腰间的剑柄，悄悄数了数对方的人数——七个，都带着家伙。你和雨烛加起来两个人，打起来应该能赢，但这是在哈密绿洲的地盘上，天山派不好公开和地头蛇起冲突，而且对方背后说不定还有党项人撑腰。你正盘算着对策，雨烛突然开口了。|雨烛|市集|严肃|none

「我来付。」她的声音很轻，但在嘈杂的人群中异常清晰。所有人都转头看向她——这个金发碧眼、背后生着羽翼的少女，正在解下腰间的蓝色素带。「雨儿这里有些钱，」她低着头，声音有些发颤，「应该……应该够给阿牛的妹妹买药……」|雨烛|市集|为难|none

你愣住了。你知道那是她攒了两年的零花钱，本来想买一条漂亮的发带，但一直舍不得花。她曾经指着集市上的发带跟你说：「等雨儿攒够钱，就买那条最漂亮的，系在头发上，小姑妈一定会夸雨儿好看的！」|雨烛|市集|悲伤|none
</MAIN_TEXT>

<SUMMARY>
面对两难抉择，雨烛的善恶观彻底崩塌。更糟的是，趁火打劫的地痞李三带人出现，想敲诈王大爷的瓜果。雨烛做出决定——用自己攒了两年的钱来解决这一切。
</SUMMARY>

<SIDE_NOTE>
{
    "随机事件": {
        "事件类型": "选项事件",
        "事件描述": "面对一群趁火打劫的地痞，雨烛决定付出自己的积蓄来解决这一切——但这真的能解决问题吗？",
        "选项一": {
            "描述": "特殊剧情: 继续",
            "奖励": "",
            "成功率": "100%"
        }
    },
    "时间": "10:30",
    "用户": {
        "位置变动": "市集"
    },
    "当前NPC": {
        "雨烛": {
            "好感变化": "不变",
            "位置变动": "市集"
        }
    }
}
</SIDE_NOTE>

</SLG_MODE>`
    },

    {
        id: "Yuzhu_HamiOasis_Dilemma_4",
        name: "雨烛·哈密绿洲4",
        priority: 57,
        conditions: {
            currentSpecialEvent: { equals: 'Yuzhu_HamiOasis_Dilemma_3' }
        },
        effects: {},
        text: `<SLG_MODE>

<MAIN_TEXT>
雨烛的素带里面是她所有的积蓄——三两银子，零零散散的铜板，还有几块碎银。她把钱递给你：「哥哥，帮雨儿去给阿牛的妹妹买药，好不好？」然后，她摘下耳边的银铃铛——那是姬姒送她的生日礼物，她一直当宝贝似的戴着。然后，她把手腕上那串长老们凑钱送的银镯子也褪了下来。|雨烛|市集|悲伤|none

「小姑娘，你这是……」王大爷愣住了。雨烛没有看他，只是把那些东西一件一件放到他手里：「够了吗？」她的声音有些发颤，碧蓝色的眼眸里蒙着一层水雾，「雨儿没有更多了……这些加起来……应该值三两银子吧……您拿去给您爹爹买药……」王大爷收下首饰，依旧满脸愤懑，但好歹还是放了阿牛。|雨烛|市集|悲伤|none

李三那伙地痞看到这架势，知道没有油水可捞，骂骂咧咧地散了。你和雨烛一起带着阿牛去附近的药铺抓了药。雨烛把药递给阿牛：「快回去吧，你妹妹等着呢。」阿牛抬头看了你们一眼——那双倔强的眼睛里，有感激，有愧疚，还有一种你看不懂的复杂情绪。你以为他会说声谢谢，或者磕个头，或者至少点个头。但他什么都没说。他抢过药袋，转身就跑，头也不回，消失在人群里。跑出几步后，你隐约听到他嘟囔了一句什么——|none|市集|none|none

「多管闲事。」|none|市集|none|none

你愣在原地，不知道该作何反应。你心想：「行善不求回报，听起来很伟大，但说到底——就像往井里扔石头，听个响，连水花都看不见。」等你们回到瓜摊，发现王大爷也走了。地上只剩下那条素带——大概是掉在地上被踩脏了，王大爷嫌脏没要。雨烛蹲在那里，把素带捡起来，用袖子擦了擦上面的泥土。|雨烛|市集|悲伤|none

「走吧。」你轻声说，「该回去了。」雨烛点点头，站起来，跟在你身后。她没有像来时那样蹦蹦跳跳，没有叽叽喳喳地说话，连羽翼都耷拉着，像只淋了雨的小鸟。你们走出集市，走上回程的路，走过七泉灌渠，走过瓜田稻田，走过一片绿洲。她始终没有开口。|雨烛|绿洲|悲伤|none

太阳西斜，把你们的影子拉得很长。雨烛突然停下脚步。「哥哥。」她的声音很轻，像是怕惊扰了什么。「嗯？」「雨儿……是不是做错了？」她抬起头，碧蓝色的眼眸里满是迷茫和无助，「雨儿想帮所有人……可是……好像谁都没帮到。王大爷还是很生气，阿牛也没有感谢雨儿……雨儿把所有东西都给出去了，可是好像……什么都没有变好。」|雨烛|山道|悲伤|none

你不知道该怎么回答。你心想：「她说的是实话。王大爷虽然拿了东西，但临走时嘟囔着'晦气'，连句谢谢都没说。阿牛更是直接骂了句'多管闲事'。雨烛付出了一切，却什么都没换来。」|雨烛|山道|悲伤|none

「哥哥，」雨烛的声音越来越小，「什么是对的？什么是错的？」她低下头，盯着自己的脚尖，「偷东西是不对的……可是不偷的话，阿牛的妹妹会死……被偷的人也很可怜……可是偷东西的人也很可怜……」她的声音开始颤抖，「雨儿……不明白了……」|雨烛|山道|悲伤|none
</MAIN_TEXT>

<SUMMARY>
雨烛用自己所有的积蓄和珍爱的饰品解决了眼前的困局——给阿牛买药，赔偿王大爷损失。但结果出乎意料：阿牛拿到药后骂了句"多管闲事"便跑了，王大爷嘟囔着"晦气"也走了。雨烛付出一切，却无人感激。回程路上，她终于崩溃。
</SUMMARY>

<SIDE_NOTE>
{
    "随机事件": {
        "事件类型": "选项事件",
        "事件描述": "玉烛付出了善意，但是结果却并不如人意，她陷入了深深的困惑",
        "选项一": {
            "描述": "特殊剧情: 继续",
            "奖励": "",
            "成功率": "100%"
        }
    },
    "时间": "16:00",
    "用户": {
        "位置变动": "山道"
    },
    "当前NPC": {
        "雨烛": {
            "好感变化": "不变",
            "位置变动": "山道"
        }
    }
}
</SIDE_NOTE>

</SLG_MODE>`
    },

    {
        id: "Yuzhu_HamiOasis_Dilemma_5",
        name: "雨烛·哈密绿洲5",
        priority: 56,
        conditions: {
            currentSpecialEvent: { equals: 'Yuzhu_HamiOasis_Dilemma_4' }
        },
        effects: {
            GameMode: { set: 0 },
            inputEnable: { set: 1 },
            mapLocation: { set: '天山派' },
            companionNPC: { set: [] },
            userLocation: { set: 'shanmen' },
            "playerTalents.心性": { add: 1 }
        },
        text: `<SLG_MODE>

<MAIN_TEXT>
她蹲下来，抱住膝盖，把脸埋进臂弯里。羽翼无力地垂落，在夕阳下泛着暗淡的光泽。你站在她身旁，不知道该说什么。片刻后，她闷闷的声音从臂弯里传出来：「哥哥……雨儿跟你说个秘密，好不好？」「好。」

「其实……雨儿也是被捡回来的。」她没有抬头，声音像是从很远的地方飘来，「叔父说，雨儿是在被马匪洗劫的村子里找到的。全村人都死了……只有雨儿一个人活下来。」她顿了顿，「如果……如果当时没有长老路过，没有天山派……雨儿可能也会变成阿牛那样。」你愣住了。你从没听她提起过这些。她在天山派总是笑嘻嘻的，像只快乐的小鸟，像所有人的开心果——你从没想过，这只小鸟曾经也是一只被暴风雨淋湿的雏鸟，在废墟中等待着死亡或者救赎。

「雨儿和阿牛，其实是一样的人。」她的声音更轻了，轻得像一声叹息，「只是雨儿运气好……被捡回了天山派……」她终于抬起头，碧蓝色的眼眸里蓄满了泪水，却倔强地不让它们落下来：「可是雨儿帮了他……他为什么不高兴呢？雨儿做错了什么吗？」

「雨儿，」你开口了，却发现自己不知道该说什么。你沉默了一会儿，伸出手，轻轻摸了摸她的头发。她愣了一下，然后像只受伤的小兽，扑进你怀里，紧紧抱住你，把脸埋在你胸口。羽翼在你身后合拢，像是要把你们两个人包裹起来。你感觉到胸口一片温热——那是她的眼泪。

「雨儿好累……」她的声音闷闷的，带着哭腔，「什么都不明白了……哥哥，你能抱抱雨儿吗？」

你没有说话，只是把她抱紧了一点。夕阳把你们的影子拉得很长很长，像两个人紧紧依偎在一起。远处的天山雪峰在晚霞中泛着金红色的光芒，像是神明铺就的天路。风从雪山那边吹来，带着一丝凉意，也带着远方的气息。你们就这样抱了很久。等雨烛终于从你怀里抬起头时，眼睛已经红肿得像两颗核桃。她用袖子胡乱擦了把脸，吸了吸鼻子，努力挤出一个笑容：「谢谢哥哥……雨儿好多了。」她顿了顿，又补了一句：「虽然还是什么都不明白……但是……有哥哥在，雨儿就不怕了。」

她伸了个懒腰，羽翼也跟着舒展开，在夕阳下泛着青色的光泽。她转过头，歪着脑袋看着你：「哥哥，我们回家吧？雨儿想吃安慕做的糖醋排骨了……而且，雨儿要攒钱买新的发带——比之前看中那条更漂亮的！」她的眼睛又亮了起来，虽然还红着眼眶，但那股劲头又回来了。

你心想：「这丫头……恢复得还挺快。」你拍了拍身上的尘土，跟在她身后往山上走。她走在前面，蹦蹦跳跳的，金色长发在夕阳下跳跃。走了几步，她突然回过头：「哥哥，下次还带雨儿下山好不好？雨儿还想吃哈密瓜——那个真的好甜好甜的！」

你没有回答，只是笑着摇了摇头。你心想：「这丫头，真是没心没肺——不，不对。」你看着她的背影，看着她那对青色的羽翼在夕阳下微微颤动，想起她说的话：雨儿和阿牛是一样的人。是啊，都是被命运抛弃的孤儿，都是在废墟中活下来的幸存者。区别只在于，她选择相信善良，而他选择相信愤怒。「至于行善有没有意义……」你抬头看了一眼远处的天山雪峰。「大概，做了才知道吧。」
</MAIN_TEXT>

<SUMMARY>
雨烛向你坦露了自己被捡回来的孤儿身世，哭着问你"行善真的有意义吗"。你抱着她，陪她度过了这段艰难的时刻。最后她擦干眼泪，说只要有你在就不怕了，又开始念叨着想吃糖醋排骨和攒钱买新发带。你意识到她的善良本质。
</SUMMARY>

<SIDE_NOTE>
{
    "时间": "17:30",
    "用户": {
        "位置变动": "天山派"
    },
    "当前NPC": {
        "雨烛": {
            "好感变化": "大幅上升",
            "位置变动": "山门"
        }
    }
}
</SIDE_NOTE>

</SLG_MODE>`
    },

    // ==================== 示例事件：钱塘君好感触发 ====================
    {
        id: "event_qiantangjun_invitation",
        name: "钱塘君邀请下山",
        priority: 20,
        conditions: {
            currentWeek: { min: 999 },           // 至少第5周
            "npcFavorability.C": { min: 100 }   // 钱塘君好感度≥100
        },
        effects: {
            "playerStats.声望": { add: 3 }     // 声望+3
        },
        text: `<SLG_MODE>
<MAIN_TEXT>
清晨，你刚准备出门，就被一个熟悉的身影堵在了门口。

「嘿！」钱塘君笑嘻嘻地站在你面前，手里拎着一个包袱，「我跟姐姐请了假，今天我们下山去玩！」

「下山？」你有些意外，「这……合适吗？」

「有什么不合适的！」钱塘君不由分说地拉起你的手往外走，「我都安排好了！山下的集市今天有庙会，可热闹了！再说了，整天闷在山上练功，不闷出病来才怪！」

你无奈地被她拖着走，心想这个从小一起长大的损友，还是一如既往地我行我素……

不过话说回来，偶尔放松一下，似乎也不错？
</MAIN_TEXT>

<SUMMARY>
钱塘君邀请{{user}}下山逛庙会，不由分说地拖着{{user}}出发。这是两人自{{user}}入门以来首次一起外出。
</SUMMARY>

<SIDE_NOTE>
{
    "用户": {
        "位置变动": "山门"
    },
    "当前NPC": {
        "钱塘君": {
            "好感变化": "上升",
            "位置变动": "山门"
        }
    }
}
</SIDE_NOTE>
</SLG_MODE>`
    },

    // ==================== 测试事件集 ====================
    // 以下事件用于调试，覆盖各种条件和效果类型

//     // 【测试1】条件: equals字符串 + 效果: set字符串
//     {
//         id: "test_string_equals_set",
//         name: "[测试] 字符串条件与设置",
//         priority: 100,  // 高优先级，方便测试
//         conditions: {
//             mapLocation: { equals: '天山派' },  // 条件: 地点等于"天山派"
//             currentWeek: { min: 2 }              // 条件: 至少第2周
//         },
//         effects: {
//             mapLocation: { set: '天山派后山' },  // 效果: 地点变为"天山派后山"
//             userLocation: '后山'                  // 效果: 直接赋值字符串
//         },
//         text: `<SLG_MODE>
// <MAIN_TEXT>
// 【测试事件】字符串条件与设置测试

// 这是一个测试事件，用于验证：
// - 条件: mapLocation equals "天山派" ✓
// - 效果: mapLocation 设置为 "天山派后山"
// - 效果: userLocation 直接赋值为 "后山"
// </MAIN_TEXT>
// <SUMMARY>测试事件触发成功。</SUMMARY>
// </SLG_MODE>`
//     },

//     // 【测试2】条件: max + 效果: add数值
//     {
//         id: "test_max_condition_add",
//         name: "[测试] 最大值条件与加法效果",
//         priority: 99,
//         conditions: {
//             currentWeek: { min: 2, max: 10 },    // 条件: 周数在2-10之间
//             playerMood: { max: 80 }               // 条件: 体力不超过80
//         },
//         effects: {
//             playerMood: { add: 10 },              // 效果: 体力+10
//             "playerStats.金钱": { add: 100 }      // 效果: 金钱+100
//         },
//         text: `<SLG_MODE>
// <MAIN_TEXT>
// 【测试事件】最大值条件与加法效果测试

// 这是一个测试事件，用于验证：
// - 条件: currentWeek 在 2-10 之间 ✓
// - 条件: playerMood ≤ 80 ✓
// - 效果: playerMood +10
// - 效果: playerStats.金钱 +100
// </MAIN_TEXT>
// <SUMMARY>测试事件触发成功。</SUMMARY>
// </SLG_MODE>`
//     },

//     // 【测试3】条件: in数组 + 效果: multiply乘法
//     {
//         id: "test_in_condition_multiply",
//         name: "[测试] in条件与乘法效果",
//         priority: 98,
//         conditions: {
//             currentWeek: { in: [3, 6, 9, 12] },  // 条件: 周数在指定数组中
//             difficulty: { in: ['easy', 'normal'] } // 条件: 难度在指定数组中
//         },
//         effects: {
//             "playerStats.武学": { multiply: 1.5 }  // 效果: 武学×1.5
//         },
//         text: `<SLG_MODE>
// <MAIN_TEXT>
// 【测试事件】in条件与乘法效果测试

// 这是一个测试事件，用于验证：
// - 条件: currentWeek 在 [3, 6, 9, 12] 中 ✓
// - 条件: difficulty 在 ["easy", "normal"] 中 ✓
// - 效果: playerStats.武学 ×1.5
// </MAIN_TEXT>
// <SUMMARY>测试事件触发成功。</SUMMARY>
// </SLG_MODE>`
//     },

//     // 【测试4】条件: notEquals + 效果: push数组
//     {
//         id: "test_notequals_push",
//         name: "[测试] notEquals条件与数组push",
//         priority: 97,
//         conditions: {
//             currentWeek: { min: 2 },
//             GameMode: { notEquals: 1 }            // 条件: 游戏模式不等于1
//         },
//         effects: {
//             companionNPC: { push: '钱塘君' }      // 效果: 向随行NPC数组添加"钱塘君"
//         },
//         text: `<SLG_MODE>
// <MAIN_TEXT>
// 【测试事件】notEquals条件与数组push测试

// 这是一个测试事件，用于验证：
// - 条件: GameMode ≠ 1 ✓
// - 效果: companionNPC.push("钱塘君")
// </MAIN_TEXT>
// <SUMMARY>测试事件触发成功。</SUMMARY>
// </SLG_MODE>`
//     },

//     // 【测试5】效果: remove数组元素
//     {
//         id: "test_remove_from_array",
//         name: "[测试] 数组remove操作",
//         priority: 96,
//         conditions: {
//             currentWeek: { min: 3 }
//             // 注意：需要确保companionNPC数组中已有"钱塘君"才能测试remove
//         },
//         effects: {
//             companionNPC: { remove: '钱塘君' }    // 效果: 从随行NPC数组移除"钱塘君"
//         },
//         text: `<SLG_MODE>
// <MAIN_TEXT>
// 【测试事件】数组remove操作测试

// 这是一个测试事件，用于验证：
// - 效果: companionNPC.remove("钱塘君")
// </MAIN_TEXT>
// <SUMMARY>测试事件触发成功。</SUMMARY>
// </SLG_MODE>`
//     },

//     // 【测试6】效果: concat合并数组
//     {
//         id: "test_concat_array",
//         name: "[测试] 数组concat操作",
//         priority: 95,
//         conditions: {
//             currentWeek: { equals: 5 }
//         },
//         effects: {
//             companionNPC: { concat: ['洞庭君', '破阵子'] }  // 效果: 合并多个NPC到数组
//         },
//         text: `<SLG_MODE>
// <MAIN_TEXT>
// 【测试事件】数组concat操作测试

// 这是一个测试事件，用于验证：
// - 效果: companionNPC.concat(["洞庭君", "破阵子"])
// </MAIN_TEXT>
// <SUMMARY>测试事件触发成功。</SUMMARY>
// </SLG_MODE>`
//     },

//     // 【测试7】多层嵌套路径 + 多种效果组合
//     {
//         id: "test_nested_path_combo",
//         name: "[测试] 嵌套路径与组合效果",
//         priority: 94,
//         conditions: {
//             "npcFavorability.A": { min: 10 },     // 破阵子好感≥10
//             "npcFavorability.B": { min: 10 },     // 洞庭君好感≥10
//             "playerStats.武学": { min: 30 }       // 武学≥30
//         },
//         effects: {
//             "npcFavorability.A": { add: 5 },      // 破阵子好感+5
//             "npcFavorability.B": { add: 5 },      // 洞庭君好感+5
//             "playerTalents.悟性": { add: 2 },     // 悟性+2
//             "playerStats.声望": { add: 10 },      // 声望+10
//             "combatStats.攻击力": { add: 5 }      // 攻击力+5
//         },
//         text: `<SLG_MODE>
// <MAIN_TEXT>
// 【测试事件】嵌套路径与组合效果测试

// 这是一个测试事件，用于验证多个嵌套路径的读取和设置：
// - 条件: npcFavorability.A ≥ 10 ✓
// - 条件: npcFavorability.B ≥ 10 ✓
// - 条件: playerStats.武学 ≥ 30 ✓
// - 效果: npcFavorability.A +5
// - 效果: npcFavorability.B +5
// - 效果: playerTalents.悟性 +2
// - 效果: playerStats.声望 +10
// - 效果: combatStats.攻击力 +5
// </MAIN_TEXT>
// <SUMMARY>测试事件触发成功。</SUMMARY>
// </SLG_MODE>`
//     },

//     // 【测试8】设置顶层变量
//     {
//         id: "test_set_top_level_vars",
//         name: "[测试] 设置顶层变量",
//         priority: 93,
//         conditions: {
//             currentWeek: { equals: 6 }
//         },
//         effects: {
//             GameMode: { set: 1 },                 // 设置游戏模式为1
//             randomEvent: { set: 0 },              // 重置随机事件标记
//             battleEvent: { set: 0 },              // 重置战斗事件标记
//             actionPoints: { set: 3 },             // 设置行动点为3
//             enamor: { set: 0 }                    // 重置魅惑值
//         },
//         text: `<SLG_MODE>
// <MAIN_TEXT>
// 【测试事件】设置顶层变量测试

// 这是一个测试事件，用于验证顶层变量的设置：
// - 效果: GameMode = 1
// - 效果: randomEvent = 0
// - 效果: battleEvent = 0
// - 效果: actionPoints = 3
// - 效果: enamor = 0
// </MAIN_TEXT>
// <SUMMARY>测试事件触发成功。</SUMMARY>
// </SLG_MODE>`
//     },

//     // 【测试9】无效果事件（仅发送文本）
//     {
//         id: "test_text_only",
//         name: "[测试] 仅文本无效果",
//         priority: 92,
//         conditions: {
//             currentWeek: { equals: 7 }
//         },
//         effects: {},  // 无任何效果
//         text: `<SLG_MODE>
// <MAIN_TEXT>
// 【测试事件】仅文本无效果测试

// 这是一个测试事件，用于验证：
// - 事件可以没有任何效果
// - 仅发送预设文本
// </MAIN_TEXT>
// <SUMMARY>测试事件触发成功，无属性变化。</SUMMARY>
// </SLG_MODE>`
//     },

//     // 【测试10】背包道具操作
//     {
//         id: "test_inventory_operation",
//         name: "[测试] 背包道具操作",
//         priority: 91,
//         conditions: {
//             currentWeek: { equals: 8 }
//         },
//         effects: {
//             "inventory.大力丸": { add: 3 },       // 大力丸+3
//             "inventory.金疮药": { add: 5 },       // 金疮药+5
//             "inventory.丹参": { set: 10 }         // 丹参设为10
//         },
//         text: `<SLG_MODE>
// <MAIN_TEXT>
// 【测试事件】背包道具操作测试

// 这是一个测试事件，用于验证背包操作：
// - 效果: inventory.大力丸 +3
// - 效果: inventory.金疮药 +5
// - 效果: inventory.丹参 = 10
// </MAIN_TEXT>
// <SUMMARY>测试事件触发成功。</SUMMARY>
// </SLG_MODE>`
//     }

    // ==================== 在此添加更多事件 ====================
    // 复制上面的模板，修改 id、conditions、effects 和 text
];

// ==================== 工具函数 ====================

/**
 * 根据路径获取变量值
 * 支持嵌套路径，如 "npcFavorability.C" 或 "playerStats.声望"
 * @param {string} path - 变量路径
 * @returns {any} 变量值
 */
function getValueByPath(path) {
    const parts = path.split('.');
    
    // 定义可访问的全局变量映射
    // 注意：这些变量需要在运行时可访问
    const globalVars = {
        currentWeek: typeof currentWeek !== 'undefined' ? currentWeek : undefined,
        playerMood: typeof playerMood !== 'undefined' ? playerMood : undefined,
        actionPoints: typeof actionPoints !== 'undefined' ? actionPoints : undefined,
        GameMode: typeof GameMode !== 'undefined' ? GameMode : undefined,
        difficulty: typeof difficulty !== 'undefined' ? difficulty : undefined,
        enamor: typeof enamor !== 'undefined' ? enamor : undefined,
        newWeek: typeof newWeek !== 'undefined' ? newWeek : undefined,
        randomEvent: typeof randomEvent !== 'undefined' ? randomEvent : undefined,
        battleEvent: typeof battleEvent !== 'undefined' ? battleEvent : undefined,
        mapLocation: typeof mapLocation !== 'undefined' ? mapLocation : undefined,
        userLocation: typeof userLocation !== 'undefined' ? userLocation : undefined,
        seasonStatus: typeof seasonStatus !== 'undefined' ? seasonStatus : undefined,
        dayNightStatus: typeof dayNightStatus !== 'undefined' ? dayNightStatus : undefined,
        companionNPC: typeof companionNPC !== 'undefined' ? companionNPC : undefined,
        npcFavorability: typeof npcFavorability !== 'undefined' ? npcFavorability : undefined,
        playerTalents: typeof playerTalents !== 'undefined' ? playerTalents : undefined,
        playerStats: typeof playerStats !== 'undefined' ? playerStats : undefined,
        combatStats: typeof combatStats !== 'undefined' ? combatStats : undefined,
        martialArts: typeof martialArts !== 'undefined' ? martialArts : undefined,
        inventory: typeof inventory !== 'undefined' ? inventory : undefined,
        equipment: typeof equipment !== 'undefined' ? equipment : undefined,
        npcVisibility: typeof npcVisibility !== 'undefined' ? npcVisibility : undefined,
        npcGiftGiven: typeof npcGiftGiven !== 'undefined' ? npcGiftGiven : undefined,
        npcSparred: typeof npcSparred !== 'undefined' ? npcSparred : undefined,
        triggeredEvents: typeof triggeredEvents !== 'undefined' ? triggeredEvents : undefined,
        currentSpecialEvent: typeof currentSpecialEvent !== 'undefined' ? currentSpecialEvent : undefined,
        inputEnable: typeof inputEnable !== 'undefined' ? inputEnable : undefined
    };
    
    let value = globalVars[parts[0]];
    
    // 逐层访问嵌套属性
    for (let i = 1; i < parts.length && value !== undefined; i++) {
        value = value[parts[i]];
    }
    
    return value;
}

/**
 * 根据路径设置变量值
 * @param {string} path - 变量路径
 * @param {any} newValue - 新值
 */
function setValueByPath(path, newValue) {
    const parts = path.split('.');
    const oldValue = getValueByPath(path);
    
    console.log(`[SpecialEvent] 设置变量: ${path}`);
    console.log(`[SpecialEvent]   旧值: ${JSON.stringify(oldValue)}`);
    console.log(`[SpecialEvent]   新值: ${JSON.stringify(newValue)}`);
    
    if (parts.length === 1) {
        // 顶层变量，需要特殊处理（使用 eval 或 window 对象在某些环境可能不可靠，这里用 switch）
        switch (parts[0]) {
            case 'currentWeek': currentWeek = newValue; console.log(`[SpecialEvent]   ✓ 已设置顶层变量 currentWeek`); break;
            case 'playerMood': playerMood = newValue; console.log(`[SpecialEvent]   ✓ 已设置顶层变量 playerMood`); break;
            case 'actionPoints': actionPoints = newValue; console.log(`[SpecialEvent]   ✓ 已设置顶层变量 actionPoints`); break;
            case 'GameMode': GameMode = newValue; console.log(`[SpecialEvent]   ✓ 已设置顶层变量 GameMode`); break;
            case 'difficulty': difficulty = newValue; console.log(`[SpecialEvent]   ✓ 已设置顶层变量 difficulty`); break;
            case 'enamor': enamor = newValue; console.log(`[SpecialEvent]   ✓ 已设置顶层变量 enamor`); break;
            case 'newWeek': newWeek = newValue; console.log(`[SpecialEvent]   ✓ 已设置顶层变量 newWeek`); break;
            case 'randomEvent': randomEvent = newValue; console.log(`[SpecialEvent]   ✓ 已设置顶层变量 randomEvent`); break;
            case 'battleEvent': battleEvent = newValue; console.log(`[SpecialEvent]   ✓ 已设置顶层变量 battleEvent`); break;
            case 'mapLocation': mapLocation = newValue; console.log(`[SpecialEvent]   ✓ 已设置顶层变量 mapLocation`); break;
            case 'userLocation': userLocation = newValue; console.log(`[SpecialEvent]   ✓ 已设置顶层变量 userLocation`); break;
            case 'seasonStatus': seasonStatus = newValue; console.log(`[SpecialEvent]   ✓ 已设置顶层变量 seasonStatus`); break;
            case 'dayNightStatus': dayNightStatus = newValue; console.log(`[SpecialEvent]   ✓ 已设置顶层变量 dayNightStatus`); break;
            case 'companionNPC': companionNPC = newValue; console.log(`[SpecialEvent]   ✓ 已设置顶层变量 companionNPC`); break;
            case 'inputEnable': inputEnable = newValue; console.log(`[SpecialEvent]   ✓ 已设置顶层变量 inputEnable`); if (typeof updateFreeActionInputState === 'function') { updateFreeActionInputState(); } break;
            default:
                console.warn(`[SpecialEvent]   ✗ 无法设置顶层变量: ${parts[0]}（未在支持列表中）`);
        }
    } else {
        // 嵌套变量
        const globalVars = {
            npcFavorability: typeof npcFavorability !== 'undefined' ? npcFavorability : null,
            npcVisibility: typeof npcVisibility !== 'undefined' ? npcVisibility : null,
            playerTalents: typeof playerTalents !== 'undefined' ? playerTalents : null,
            playerStats: typeof playerStats !== 'undefined' ? playerStats : null,
            combatStats: typeof combatStats !== 'undefined' ? combatStats : null,
            martialArts: typeof martialArts !== 'undefined' ? martialArts : null,
            inventory: typeof inventory !== 'undefined' ? inventory : null,
            equipment: typeof equipment !== 'undefined' ? equipment : null
        };
        
        let obj = globalVars[parts[0]];
        if (!obj) {
            console.warn(`[SpecialEvent]   ✗ 未找到对象: ${parts[0]}`);
            return;
        }
        
        // 遍历到倒数第二层
        for (let i = 1; i < parts.length - 1; i++) {
            obj = obj[parts[i]];
            if (obj === undefined) {
                console.warn(`[SpecialEvent]   ✗ 路径不存在: ${path}`);
                return;
            }
        }
        
        // 设置最后一层的值
        obj[parts[parts.length - 1]] = newValue;
        console.log(`[SpecialEvent]   ✓ 已设置嵌套变量 ${path}`);
    }
}

/**
 * 检查单个条件是否满足
 * @param {any} value - 当前值
 * @param {object} condition - 条件对象
 * @param {string} path - 变量路径（用于日志）
 * @returns {boolean} 是否满足条件
 */
function checkCondition(value, condition, path = '') {
    const logPrefix = `[SpecialEvent] 条件检查 [${path}]:`;
    
    if (value === undefined) {
        console.log(`${logPrefix} 值为undefined，条件不满足`);
        return false;
    }
    
    // 检查 min 条件
    if (condition.min !== undefined) {
        const result = value >= condition.min;
        console.log(`${logPrefix} ${value} >= ${condition.min} (min) → ${result ? '✓' : '✗'}`);
        if (!result) return false;
    }
    
    // 检查 max 条件
    if (condition.max !== undefined) {
        const result = value <= condition.max;
        console.log(`${logPrefix} ${value} <= ${condition.max} (max) → ${result ? '✓' : '✗'}`);
        if (!result) return false;
    }
    
    // 检查 equals 条件
    if (condition.equals !== undefined) {
        const result = value === condition.equals;
        console.log(`${logPrefix} ${JSON.stringify(value)} === ${JSON.stringify(condition.equals)} (equals) → ${result ? '✓' : '✗'}`);
        if (!result) return false;
    }
    
    // 检查 in 条件
    if (condition.in !== undefined) {
        const result = condition.in.includes(value);
        console.log(`${logPrefix} ${JSON.stringify(value)} in ${JSON.stringify(condition.in)} → ${result ? '✓' : '✗'}`);
        if (!result) return false;
    }
    
    // 检查 notEquals 条件
    if (condition.notEquals !== undefined) {
        const result = value !== condition.notEquals;
        console.log(`${logPrefix} ${JSON.stringify(value)} !== ${JSON.stringify(condition.notEquals)} (notEquals) → ${result ? '✓' : '✗'}`);
        if (!result) return false;
    }
    
    return true;
}

/**
 * 检查事件的所有条件是否满足
 * @param {object} event - 事件对象
 * @returns {boolean} 是否满足所有条件
 */
function checkEventConditions(event) {
    console.log(`\n[SpecialEvent] ========== 检查事件: ${event.name} (${event.id}) ==========`);
    
    // 检查是否已触发过
    if (triggeredEvents && triggeredEvents.includes(event.id)) {
        console.log(`[SpecialEvent] → 事件已触发过，跳过`);
        return false;
    }
    
    console.log(`[SpecialEvent] 事件条件数量: ${Object.keys(event.conditions).length}`);
    
    // 检查所有条件
    let allConditionsMet = true;
    for (const [path, condition] of Object.entries(event.conditions)) {
        const value = getValueByPath(path);
        console.log(`[SpecialEvent] 读取变量 ${path} = ${JSON.stringify(value)}`);
        if (!checkCondition(value, condition, path)) {
            console.log(`[SpecialEvent] → 条件不满足，事件不触发`);
            allConditionsMet = false;
            break;
        }
    }
    
    if (allConditionsMet) {
        console.log(`[SpecialEvent] → 所有条件满足！事件将被触发`);
    }
    
    return allConditionsMet;
}

/**
 * 应用事件效果（修改游戏变量）
 * 支持的操作类型：
 * - { add: number } - 加法操作（数值类型）
 * - { set: any } - 直接设置为指定值（任意类型：数值、字符串、数组等）
 * - { multiply: number } - 乘法操作（数值类型）
 * - { push: any } - 向数组末尾添加元素
 * - { remove: any } - 从数组中移除元素
 * - { concat: array } - 将数组与另一个数组合并
 * - 直接赋值 - 非对象值直接赋值
 *
 * @param {object} event - 事件对象
 */
function applyEventEffects(event) {
    console.log(`\n[SpecialEvent] ========== 应用事件效果: ${event.name} ==========`);
    
    if (!event.effects || Object.keys(event.effects).length === 0) {
        console.log(`[SpecialEvent] 该事件无效果需要应用`);
        return;
    }
    
    console.log(`[SpecialEvent] 效果数量: ${Object.keys(event.effects).length}`);
    
    for (const [path, effect] of Object.entries(event.effects)) {
        const currentValue = getValueByPath(path);
        let newValue;
        let skipSet = false;  // 标记是否跳过设置（用于 push/remove 等就地修改操作）
        let operationType = '';
        
        console.log(`\n[SpecialEvent] 处理效果: ${path}`);
        console.log(`[SpecialEvent]   当前值: ${JSON.stringify(currentValue)} (类型: ${Array.isArray(currentValue) ? 'array' : typeof currentValue})`);
        console.log(`[SpecialEvent]   效果定义: ${JSON.stringify(effect)}`);
        
        if (typeof effect === 'object' && effect !== null) {
            if (effect.add !== undefined) {
                // 加法操作（数值）
                operationType = 'add';
                newValue = (currentValue || 0) + effect.add;
                console.log(`[SpecialEvent]   操作类型: add（加法）`);
                console.log(`[SpecialEvent]   计算: ${currentValue || 0} + ${effect.add} = ${newValue}`);
            } else if (effect.set !== undefined) {
                // 直接设置（支持任意类型：字符串、数值、数组、对象等）
                operationType = 'set';
                newValue = effect.set;
                console.log(`[SpecialEvent]   操作类型: set（直接设置）`);
                console.log(`[SpecialEvent]   将设置为: ${JSON.stringify(newValue)}`);
            } else if (effect.multiply !== undefined) {
                // 乘法操作（数值）
                operationType = 'multiply';
                newValue = (currentValue || 0) * effect.multiply;
                console.log(`[SpecialEvent]   操作类型: multiply（乘法）`);
                console.log(`[SpecialEvent]   计算: ${currentValue || 0} × ${effect.multiply} = ${newValue}`);
            } else if (effect.push !== undefined) {
                // 向数组末尾添加元素
                operationType = 'push';
                console.log(`[SpecialEvent]   操作类型: push（数组添加）`);
                if (Array.isArray(currentValue)) {
                    console.log(`[SpecialEvent]   添加元素: ${JSON.stringify(effect.push)}`);
                    console.log(`[SpecialEvent]   数组操作前: ${JSON.stringify(currentValue)}`);
                    currentValue.push(effect.push);
                    console.log(`[SpecialEvent]   数组操作后: ${JSON.stringify(currentValue)}`);
                    console.log(`[SpecialEvent]   ✓ push 操作成功`);
                    skipSet = true;
                } else {
                    console.warn(`[SpecialEvent]   ✗ push 操作失败: ${path} 不是数组类型`);
                }
            } else if (effect.remove !== undefined) {
                // 从数组中移除元素
                operationType = 'remove';
                console.log(`[SpecialEvent]   操作类型: remove（数组移除）`);
                if (Array.isArray(currentValue)) {
                    console.log(`[SpecialEvent]   要移除的元素: ${JSON.stringify(effect.remove)}`);
                    console.log(`[SpecialEvent]   数组操作前: ${JSON.stringify(currentValue)}`);
                    const index = currentValue.indexOf(effect.remove);
                    if (index > -1) {
                        currentValue.splice(index, 1);
                        console.log(`[SpecialEvent]   数组操作后: ${JSON.stringify(currentValue)}`);
                        console.log(`[SpecialEvent]   ✓ remove 操作成功`);
                    } else {
                        console.log(`[SpecialEvent]   ⚠ 未找到要移除的元素`);
                    }
                    skipSet = true;
                } else {
                    console.warn(`[SpecialEvent]   ✗ remove 操作失败: ${path} 不是数组类型`);
                }
            } else if (effect.concat !== undefined) {
                // 将数组与另一个数组合并
                operationType = 'concat';
                console.log(`[SpecialEvent]   操作类型: concat（数组合并）`);
                if (Array.isArray(currentValue) && Array.isArray(effect.concat)) {
                    console.log(`[SpecialEvent]   要合并的数组: ${JSON.stringify(effect.concat)}`);
                    newValue = currentValue.concat(effect.concat);
                    console.log(`[SpecialEvent]   合并后: ${JSON.stringify(newValue)}`);
                } else {
                    console.warn(`[SpecialEvent]   ✗ concat 操作失败: 需要两个数组`);
                }
            } else {
                console.log(`[SpecialEvent]   ⚠ 未知的对象效果类型: ${JSON.stringify(effect)}`);
            }
        } else {
            // 直接赋值（非对象值）
            operationType = 'direct';
            newValue = effect;
            console.log(`[SpecialEvent]   操作类型: 直接赋值`);
            console.log(`[SpecialEvent]   将设置为: ${JSON.stringify(newValue)}`);
        }
        
        if (!skipSet && newValue !== undefined) {
            setValueByPath(path, newValue);
            console.log(`[SpecialEvent]   ✓ 效果已应用`);
        }
    }
    
    console.log(`\n[SpecialEvent] ========== 效果应用完成 ==========\n`);
    
    // 检查数值范围
    if (typeof checkAllValueRanges === 'function') {
        checkAllValueRanges();
    }
}

/**
 * 标记事件为已触发
 * @param {string} eventId - 事件ID
 */
function markEventTriggered(eventId) {
    if (!triggeredEvents) {
        triggeredEvents = [];
    }
    if (!triggeredEvents.includes(eventId)) {
        triggeredEvents.push(eventId);
        console.log(`[SpecialEvent] 事件已标记为触发: ${eventId}`);
    }
}

// ==================== 主要对外函数 ====================

/**
 * 检查是否有符合条件的特殊事件
 * 按优先级排序，返回第一个符合条件的事件
 * @returns {object|null} 符合条件的事件对象，或null
 */
function checkSpecialEvents() {
    // 按优先级降序排序
    const sortedEvents = [...specialEvents].sort((a, b) => (b.priority || 0) - (a.priority || 0));
    
    for (const event of sortedEvents) {
        if (checkEventConditions(event)) {
            console.log(`[SpecialEvent] 找到符合条件的事件: ${event.name} (${event.id})`);
            return event;
        }
    }
    
    return null;
}

/**
 * 触发特殊事件
 * 应用效果、标记已触发、发送预设文本
 * 与 handleMessageOutput 保持一致：更新 lastUserMessage、调用 /setvar、但不改变 newWeek
 * @param {object} event - 事件对象
 * @param {object} options - 可选参数
 * @param {boolean} options.fromSkipWeek - 是否由跳过一周按钮触发
 * @returns {Promise<boolean>} 是否成功触发
 */
async function triggerSpecialEvent(event, options = {}) {
    if (!event) {
        console.warn('[SpecialEvent] 事件对象为空');
        return false;
    }
    
    console.log(`[SpecialEvent] 开始触发事件: ${event.name} (${event.id})`);
    
    try {
        // 1. 构造用户消息：年月周、地点、特殊剧情名称
        const weekNum = typeof currentWeek !== 'undefined' ? currentWeek : 1;
        const year = Math.floor((weekNum - 1) / 48) + 1;
        const remainingWeeks = (weekNum - 1) % 48;
        const month = Math.floor(remainingWeeks / 4) + 1;
        const week = remainingWeeks % 4 + 1;
        const location = typeof mapLocation !== 'undefined' ? mapLocation : '未知地点';
        
        // 根据是否由跳过一周触发，构建不同的消息前缀
        let userMessage;
        if (options.fromSkipWeek) {
            userMessage = `时间过了一周，在${year}年${month}月${week}周，{{user}}在${location}触发特殊剧情——${event.name}`;
        } else {
            userMessage = `${year}年${month}月${week}周，{{user}}在${location}触发特殊剧情——${event.name}`;
        }
        
        // 2. 更新 lastUserMessage（与 handleMessageOutput 保持一致）
        if (typeof lastUserMessage !== 'undefined') {
            lastUserMessage = userMessage;
            console.log(`[SpecialEvent] 已更新 lastUserMessage = "${userMessage}"`);
        }
        
        // 3. 调用 /setvar 保存到酒馆变量（与 handleMessageOutput 保持一致）
        if (typeof isInRenderEnvironment === 'function' && isInRenderEnvironment()) {
            const renderFunc = typeof getRenderFunction === 'function' ? getRenderFunction() : null;
            if (renderFunc) {
                console.log('[SpecialEvent] user消息存入变量lastMessage_jxz');
                await renderFunc(`/setvar key=lastMessage_jxz ${userMessage}`);
            }
        }
        
        // 注意：特殊剧情不改变 newWeek，保持现状（与 handleMessageOutput 的区别）
        console.log('[SpecialEvent] newWeek 保持现状，不做修改');
        
        // 4. 应用事件效果
        applyEventEffects(event);
        
        // 5. 设置当前特殊事件ID
        if (typeof currentSpecialEvent !== 'undefined') {
            currentSpecialEvent = event.id;
            console.log(`[SpecialEvent] 已设置 currentSpecialEvent = "${event.id}"`);
        }
        
        // 6. 标记事件为已触发
        markEventTriggered(event.id);
        
        // 7. 保存游戏数据
        if (typeof saveGameData === 'function') {
            await saveGameData();
            console.log('[SpecialEvent] 游戏数据已保存');
        }
        
        // 8. 发送预设文本（先注入用户输入，再发送AI回复）
        if (event.text && typeof isInRenderEnvironment === 'function' && isInRenderEnvironment()) {
            const renderFunc = typeof getRenderFunction === 'function' ? getRenderFunction() : null;
            if (renderFunc) {
                // 使用Promise方式延迟，保持在同一个async上下文中
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 确保变量完全同步到SillyTavern
                if (typeof saveGameData === 'function') {
                    await saveGameData();
                }
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // 先注入用户输入（与 handleMessageOutput 保持一致）
                await renderFunc(`/inject id=10 position=chat depth=0 scan=true role=user ${userMessage}`);
                console.log(`[SpecialEvent] 用户输入已注入: ${userMessage}`);
                
                // 再发送AI的预设回复
                const safeText = event.text
                    .replace(/\|/g, '\\|')   // 先转义管道符
                    .replace(/`/g, '\\`');   // 再转义反引号
                await renderFunc(`/sendas name={{char}} at={{lastMessageId}}+1 ${safeText}`);
                console.log(`[SpecialEvent] 事件文本已发送: ${event.name}`);
                return true;
            }
        }
        
        // 非渲染环境，用弹窗显示
        if (typeof showModal === 'function' && !(typeof isInRenderEnvironment === 'function' && isInRenderEnvironment())) {
            showModal(`【特殊事件】${event.name}<br><br>（非酒馆环境，事件文本无法发送）`);
        }
        
        return true;
    } catch (error) {
        console.error('[SpecialEvent] 触发事件失败:', error);
        return false;
    }
}

/**
 * 获取所有已触发的事件ID列表
 * @returns {array} 已触发事件ID数组
 */
function getTriggeredEvents() {
    return triggeredEvents || [];
}

/**
 * 重置特定事件的触发状态（用于调试）
 * @param {string} eventId - 事件ID
 */
function resetEventTrigger(eventId) {
    if (triggeredEvents) {
        const index = triggeredEvents.indexOf(eventId);
        if (index > -1) {
            triggeredEvents.splice(index, 1);
            console.log(`[SpecialEvent] 事件触发状态已重置: ${eventId}`);
        }
    }
}

// 暴露到全局（供其他模块调用）
window.checkSpecialEvents = checkSpecialEvents;
window.triggerSpecialEvent = triggerSpecialEvent;
window.getTriggeredEvents = getTriggeredEvents;
window.resetEventTrigger = resetEventTrigger;