<!-- /**
 * index.html 内联函数说明
 * 
 * 这些函数保留在HTML中是为了支持onclick等内联事件调用。
 * 它们主要是对其他模块函数的封装或直接实现。
 * 
 * 主要函数：
 * 
 * - showPlayerStats(): 显示角色属性界面
 *   作用：切换到属性面板场景，显示玩家的各项数值
 * 
 * - showRelationships(): 显示人际关系界面
 *   作用：切换到关系面板场景，显示与各NPC的好感度
 * 
 * - skipWeek(): 跳过当前周
 *   作用：推进游戏时间一周，重置行动点
 * 
 * - performAction(action, location): 执行地点行动
 *   作用：处理玩家在各地点的行动选择，计算结果
 * 
 * - refreshNpcLocations(): 刷新NPC位置
 *   作用：重新随机分配所有NPC的位置
 * 
 * - backToMap(): 返回地图
 *   作用：从其他场景返回主地图界面
 * 
 * - closeModal(): 关闭弹窗
 *   作用：关闭当前显示的模态弹窗
 * 
 * - sendInteraction(): 发送NPC互动
 *   作用：处理玩家输入的NPC互动内容
 * 
 * - addAttack(): 增加攻击力
 *   作用：消耗属性点增加10点攻击力
 * 
 * - addHP(): 增加生命值
 *   作用：消耗属性点增加25点生命值
 * 
 * - npcAction(npcId, action): NPC动作处理
 *   作用：处理对NPC的切磋或互动操作
 * 
 * - goToLocation(locationId): 前往地点
 *   作用：从地图点击前往具体场景
 * 
 * - sendFreeAction(): 发送自由行动
 *   作用：处理玩家输入的自由行动内容
 * 
 * - startBattle(): 发起战斗
 *   作用：开始战斗事件的战斗
 * 
 * - fleeBattle(): 放弃战斗
 *   作用：放弃战斗事件，避开战斗
 */ -->

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>类脑群侠传</title>
    
    <!-- 从GitHub加载CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@829f5eb/module/game-styles.css">
</head>
<body>
    <div class="container">
        <div class="viewport-wrapper">
            <div class="viewport" id="main-viewport">
                <!-- 悬浮提示框 -->
                <div class="tooltip" id="tooltip"></div>

                <!-- NPC信息弹窗 -->
                <div class="npc-info-popup" id="npc-info-popup"></div>

                <!-- 地点信息弹窗 - 新增 -->
                <div class="location-info-popup" id="location-info-popup"></div>
                <!-- <button class="slg-return-btn" id="slg-return-btn" onclick="returnFromSLG()">返回天山派</button> -->
                <!-- 地图场景 -->
                <div id="map-scene" class="scene active">
                    <div class="status-display">
                        <div class="date-display" id="date-display">第1年第1月第1周</div>
                        <div class="mood-display" id="mood-display">体力: 100</div>
                        <div class="action-points-display" id="action-points-display">行动点: 3</div>
                    </div>
                    <button class="refresh-npc-btn" onclick="refreshNpcLocations()">刷新NPC位置</button>
                    <div class="location" id="yanwuchang"></div>
                    <div class="location" id="cangjingge"></div>
                    <div class="location" id="huofang"></div>
                    <div class="location" id="houshan"></div>
                    <div class="location" id="yishiting"></div>
                    <div class="location" id="tiejiangpu"></div>
                    <div class="location" id="nandizi"></div>
                    <div class="location" id="nvdizi"></div>
                    <div class="location" id="shanmen"></div>
                    <div class="location" id="gongtian"></div>
                    <div class="location" id="danfang"></div>
                    <div class="ink-decoration ink1"></div>
                    <div class="ink-decoration ink2"></div>
                    <!-- 建筑轮廓与热区（SVG覆盖层） -->
                    <svg id="map-hit-areas" viewBox="0 0 1000 1000" preserveAspectRatio="xMidYMid slice" style="position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;"></svg>
                </div>

                <!-- 后续场景保持不变 -->
                <!-- 角色属性场景 -->
                <div id="player-stats-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="stats-container">
                        <div class="stats-group">
                            <h3>天赋属性</h3>
                            <div class="stat-item">
                                <span class="stat-name">根骨</span>
                                <div class="stat-bar">
                                    <div class="stat-fill" id="talent-gengu" style="width: 75%"></div>
                                </div>
                                <span class="stat-value" id="talent-gengu-value">75</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">悟性</span>
                                <div class="stat-bar">
                                    <div class="stat-fill" id="talent-wuxing" style="width: 82%"></div>
                                </div>
                                <span class="stat-value" id="talent-wuxing-value">82</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">心性</span>
                                <div class="stat-bar">
                                    <div class="stat-fill" id="talent-xinxing" style="width: 68%"></div>
                                </div>
                                <span class="stat-value" id="talent-xinxing-value">68</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">魅力</span>
                                <div class="stat-bar">
                                    <div class="stat-fill" id="talent-meili" style="width: 70%"></div>
                                </div>
                                <span class="stat-value" id="talent-meili-value">70</span>
                            </div>
                        </div>
                        
                        <div class="bottom-stats-row">
                            <div class="stats-group">
                                <h3>人物数值</h3>
                                <div class="simple-stat-item">
                                    <span class="simple-stat-name">武学</span>
                                    <span class="simple-stat-value" id="stat-wuxue-value">50</span>
                                </div>
                                <div class="simple-stat-item">
                                    <span class="simple-stat-name">学识</span>
                                    <span class="simple-stat-value" id="stat-xueshi-value">35</span>
                                </div>
                                <div class="simple-stat-item">
                                    <span class="simple-stat-name">声望</span>
                                    <span class="simple-stat-value" id="stat-shengwang-value">20</span>
                                </div>
                                <div class="simple-stat-item">
                                    <span class="simple-stat-name">金钱</span>
                                    <span class="simple-stat-value" id="stat-jinqian-value">100</span>
                                </div>
                            </div>
                            
                            <div class="stats-group">
                                <h3>战斗数值</h3>
                                <div class="simple-stat-item">
                                    <span class="simple-stat-name">攻击力</span>
                                    <div class="point-control">
                                        <span class="simple-stat-value" id="combat-attack-value">20</span>
                                        <button class="add-point-btn" id="add-attack-btn" onclick="addAttack()">+</button>
                                    </div>
                                </div>
                                <div class="simple-stat-item">
                                    <span class="simple-stat-name">生命值</span>
                                    <div class="point-control">
                                        <span class="simple-stat-value" id="combat-hp-value">50</span>
                                        <button class="add-point-btn" id="add-hp-btn" onclick="addHP()">+</button>
                                    </div>
                                </div>
                                <div class="simple-stat-item">
                                    <span class="simple-stat-name">剩余点数</span>
                                    <span class="simple-stat-value" id="remaining-points-value">0</span>
                                </div>
                                <div class="skill-list">
                                    <div class="simple-stat-name" style="margin-bottom: 10px;">已学武功</div>
                                    <div id="learned-skills"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 人际关系场景 -->
                <div id="relationships-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="relationships-container">
                        <div class="relationship-grid" id="relationship-grid">
                            <!-- 动态生成 -->
                        </div>
                    </div>
                </div>

                <!-- 各个场景 -->
                <div id="yanwuchang-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="scene-title">演武场</div>
                    <div class="npc-container" id="yanwuchang-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('练武', 'yanwuchang')">练武</button>
                    </div>
                </div>

                <div id="cangjingge-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="scene-title">藏经阁</div>
                    <div class="npc-container" id="cangjingge-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('学习', 'cangjingge')">学习</button>
                    </div>
                </div>

                <div id="huofang-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="scene-title">伙房</div>
                    <div class="npc-container" id="huofang-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('打杂', 'huofang')">打杂</button>
                        <button class="scene-btn" onclick="showTrading('food')">交易</button>
                    </div>
                </div>

                <div id="houshan-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="scene-title">后山</div>
                    <div class="npc-container" id="houshan-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('秘密赌场', 'houshan')">秘密赌场</button>
                        <button class="scene-btn" onclick="performAction('探索', 'houshan')">探索</button>
                    </div>
                </div>

                <div id="yishiting-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="scene-title">议事厅</div>
                    <div class="npc-container" id="yishiting-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('汇报', 'yishiting')">汇报</button>
                    </div>
                </div>

                <div id="tiejiangpu-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="scene-title">铁匠铺</div>
                    <div class="npc-container" id="tiejiangpu-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('打铁', 'tiejiangpu')">打铁</button>
                        <button class="scene-btn" onclick="showTrading('equipment')">交易</button>
                    </div>
                </div>

                <div id="nandizi-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="scene-title">男弟子房</div>
                    <div class="npc-container" id="nandizi-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('休息', 'nandizi')">休息</button>
                    </div>
                </div>

                <div id="nvdizi-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="scene-title">女弟子房</div>
                    <div class="npc-container" id="nvdizi-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('拜访', 'nvdizi')">拜访</button>
                    </div>
                </div>

                <div id="shanmen-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="scene-title">山门</div>
                    <div class="npc-container" id="shanmen-npcs"></div>
                    <div class="scene-actions">
                        <!-- 修改这里：从disabled改为onclick -->
                        <button class="scene-btn" onclick="showWorldMap()">下山</button>
                    </div>
                </div>

                <div id="gongtian-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="scene-title">公田</div>
                    <div class="npc-container" id="gongtian-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('耕种', 'gongtian')">耕种</button>
                    </div>
                </div>

                <div id="danfang-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="scene-title">丹房</div>
                    <div class="npc-container" id="danfang-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('炼丹', 'danfang')">炼丹</button>
                    </div>
                </div>

                <!-- 弹窗 -->
                <div id="modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-text" id="modal-text">新的一周开始了</div>
                        <div class="modal-buttons" id="modal-buttons">
                            <button class="modal-btn" onclick="closeModal()">确定</button>
                        </div>
                    </div>
                </div>

                <!-- 21点游戏iframe弹窗 - 新增 -->
                <div id="blackjack-modal" class="blackjack-modal">
                    <div class="blackjack-container">
                        <iframe id="blackjack-iframe" class="blackjack-iframe"></iframe>
                    </div>
                </div>

                <!-- 战斗iframe弹窗 -->
                <div id="battle-modal" class="battle-modal">
                    <div class="battle-container">
                        <iframe id="battle-iframe" class="battle-iframe"></iframe>
                    </div>
                </div>

                <!-- 农场游戏iframe弹窗 -->
                <div id="farm-modal" class="farm-modal">
                    <div class="farm-container">
                        <iframe id="farm-iframe" class="farm-iframe"></iframe>
                    </div>
                </div>

                <!-- 炼丹游戏iframe弹窗 -->
                <div id="alchemy-modal" class="farm-modal">
                    <div class="farm-container">
                        <iframe id="alchemy-iframe" class="farm-iframe"></iframe>
                    </div>
                </div>

                <!-- 世界地图iframe弹窗 - 添加在其他modal后面 -->
                <div id="worldmap-modal" class="modal worldmap-modal" style="display: none; position: absolute; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7);">
                    <div class="worldmap-container" style="width: 100%; height: 100%; margin: 0; position: relative;">
                        <iframe id="worldmap-iframe" class="worldmap-iframe" style="width: 100%; height: 100%; border: none; border-radius: 10px;"></iframe>
                    </div>
                </div>
            </div>
        </div>
         
        <!-- 中间控制按钮 -->
        <div class="control-buttons">
            <!-- 属性查看下拉菜单 -->
            <div class="dropdown-wrapper">
                <button class="control-btn dropdown-toggle" onclick="toggleDropdown('attribute-dropdown')">
                    属性查看 ▲
                </button>
                <div id="attribute-dropdown" class="dropdown-menu">
                    <button class="dropdown-item" onclick="showPlayerStats()">角色属性</button>
                    <button class="dropdown-item" onclick="showRelationships()">人际关系</button>
                    <button class="dropdown-item" onclick="showInventory()">查看背包</button>
                    <button class="dropdown-item" onclick="showEquipment()">查看装备</button>
                </div>
            </div>
            
            <!-- 系统设置下拉菜单 -->
            <div class="dropdown-wrapper">
                <button class="control-btn dropdown-toggle" onclick="toggleDropdown('system-dropdown')">
                    系统设置 ▲
                </button>
                <div id="system-dropdown" class="dropdown-menu">
                    <button class="dropdown-item" onclick="saveGame()">存档</button>
                    <button class="dropdown-item" onclick="loadGame()">读档</button>
                    <button class="dropdown-item" onclick="showDifficultySettings()">难度设置</button>
                    <button class="dropdown-item" id="toggle-cg-btn" onclick="toggleCgContent()">CG内容（关）</button>
                    <button class="dropdown-item" onclick="showCheatMode()">金手指</button>
                    <button class="dropdown-item" onclick="openPlayGuide()">玩法说明</button>
                </div>
            </div>
            
            <!-- 新增：历史信息下拉菜单 -->
            <div class="dropdown-wrapper">
                <button class="control-btn dropdown-toggle" onclick="toggleDropdown('history-dropdown')">
                    信息设置 ▲
                </button>
                <div id="history-dropdown" class="dropdown-menu">
                    <button class="dropdown-item" onclick="showLastUserInput()">上轮输入</button>
                    <button class="dropdown-item" onclick="showHistorySummary()">历史记录</button>
                    <button class="dropdown-item" id="toggle-compress-summary-btn" onclick="toggleCompressSummary()">强力总结（关）</button>
                    <button class="dropdown-item" onclick="showFontSettings()">正文字体</button>               
                </div>
            </div>
            
            <button class="control-btn" id="skip-week-btn" onclick="skipWeek()">跳过这一周</button>
            <button class="control-btn" id="slg-return-btn" onclick="returnFromSLG()" style="display: none;">返回天山派</button>
        </div>

        <!-- 自由行动输入框 -->
        <div class="free-action-container">
            <textarea
                class="free-action-input"
                id="free-action-input"
                placeholder="输入自由行动内容"
                rows="1"
            ></textarea>
            <button class="free-action-send-btn" id="free-action-send-btn" onclick="sendFreeAction()">发送</button>
        </div>

        <!-- 难度设置弹窗 -->
        <div id="difficulty-modal" class="modal viewport-overlay">
            <div class="modal-content">
                <h3>难度设置</h3>
                <p>选择游戏难度，将影响行动成功率的计算：</p>
                    <label class="difficulty-option">
                        <input type="radio" name="difficulty" value="easy" id="diff-easy">
                        <span class="option-content">
                            <strong>简单模式</strong>
                            <small>体力加成 +20，更容易获得成功<br>好感度变化：上升+2/+4，下降-1/-2</small>
                        </span>
                    </label>
                    <label class="difficulty-option">
                        <input type="radio" name="difficulty" value="normal" id="diff-normal" checked>
                        <span class="option-content">
                            <strong>普通模式</strong>
                            <small>体力加成 +10，平衡的游戏体验<br>好感度变化：大幅±2，普通±1</small>
                        </span>
                    </label>
                    <label class="difficulty-option">
                        <input type="radio" name="difficulty" value="hard" id="diff-hard">
                        <span class="option-content">
                            <strong>困难模式</strong>
                            <small>无体力加成，更具挑战性<br>好感度变化：上升+1/+2，下降-2/-4</small>
                        </span>
                    </label>
                <div class="modal-buttons">
                    <button class="modal-btn" onclick="saveDifficulty()">确认</button>
                    <button class="modal-btn cancel" onclick="closeDifficultyModal()">取消</button>
                </div>
            </div>
        </div>

        <!-- 金手指弹窗 -->
        <div id="cheat-modal" class="modal viewport-overlay">
            <div class="modal-content cheat-content">
                <h3>金手指 - 数值修改</h3>
                <div class="cheat-sections">
                    <!-- 天赋属性 -->
                    <div class="cheat-section">
                        <h4>天赋属性</h4>
                        <div class="cheat-grid">
                            <div class="cheat-item">
                                <label>根骨</label>
                                <input type="number" id="cheat-gengu" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>悟性</label>
                                <input type="number" id="cheat-wuxing" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>心性</label>
                                <input type="number" id="cheat-xinxing" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>魅力</label>
                                <input type="number" id="cheat-meili" min="0" max="100">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 人物数值 -->
                    <div class="cheat-section">
                        <h4>人物数值</h4>
                        <div class="cheat-grid">
                            <div class="cheat-item">
                                <label>武学</label>
                                <input type="number" id="cheat-wuxue" min="0" max="300">
                            </div>
                            <div class="cheat-item">
                                <label>学识</label>
                                <input type="number" id="cheat-xueshi" min="0" max="300">
                            </div>
                            <div class="cheat-item">
                                <label>声望</label>
                                <input type="number" id="cheat-shengwang" min="0" max="300">
                            </div>
                            <div class="cheat-item">
                                <label>金钱</label>
                                <input type="number" id="cheat-jinqian" min="0" max="999999">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 战斗数值 -->
                    <div class="cheat-section">
                        <h4>战斗数值</h4>
                        <div class="cheat-grid">
                            <div class="cheat-item">
                                <label>攻击力</label>
                                <input type="number" id="cheat-attack" min="10" max="300">
                            </div>
                            <div class="cheat-item">
                                <label>生命值</label>
                                <input type="number" id="cheat-hp" min="25" max="600">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 其他数值 -->
                    <div class="cheat-section">
                        <h4>其他数值</h4>
                        <div class="cheat-grid">
                            <div class="cheat-item">
                                <label>体力</label>
                                <input type="number" id="cheat-mood" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>行动点</label>
                                <input type="number" id="cheat-actionpoints" min="0" max="3">
                            </div>
                            <div class="cheat-item">
                                <label>当前周数</label>
                                <input type="number" id="cheat-week" min="1" max="9999">
                            </div>
                        </div>
                    </div>
                    
                    <!-- NPC好感度 -->
                    <div class="cheat-section">
                        <h4>NPC好感度</h4>
                        <div class="cheat-grid npc-grid">
                            <div class="cheat-item">
                                <label>破阵子</label>
                                <input type="number" id="cheat-npc-A" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>洞庭君</label>
                                <input type="number" id="cheat-npc-B" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>钱塘君</label>
                                <input type="number" id="cheat-npc-C" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>萧白瑚</label>
                                <input type="number" id="cheat-npc-D" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>姬姒</label>
                                <input type="number" id="cheat-npc-E" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>施延年</label>
                                <input type="number" id="cheat-npc-F" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>呼延显</label>
                                <input type="number" id="cheat-npc-G" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>雨烛</label>
                                <input type="number" id="cheat-npc-H" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>安慕</label>
                                <input type="number" id="cheat-npc-I" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>唐沐梨</label>
                                <input type="number" id="cheat-npc-J" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>洛潜幽</label>
                                <input type="number" id="cheat-npc-K" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>神秘杂役</label>
                                <input type="number" id="cheat-npc-L" min="0" max="100">
                            </div>
                            <!-- 占位角色Z - 已注释
                            <div class="cheat-item">
                                <label>新角色Z</label>
                                <input type="number" id="cheat-npc-Z" min="0" max="100">
                            </div>
                            -->
                            <div class="cheat-item">
                                <label>玄天青</label>
                                <input type="number" id="cheat-npc-M" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>鹿椿若</label>
                                <input type="number" id="cheat-npc-N" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>苓雪妃</label>
                                <input type="number" id="cheat-npc-O" min="0" max="100">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button class="modal-btn" onclick="saveCheatValues()">保存</button>
                    <button class="modal-btn cancel" onclick="closeCheatModal()">取消</button>
                </div>
            </div>
        </div>

        <!-- 汗青集弹窗 -->
        <div id="history-summary-modal" class="modal viewport-overlay">
            <div class="modal-content" style="max-width: 90%; display: flex; flex-direction: column;">
                <h3>汗青集</h3>
                <div id="history-summary-content" style="
                    flex: 1;
                    overflow-y: auto;
                    padding: 20px;
                    background: #f5f5f5;
                    border-radius: 8px;
                    margin: 20px 0;
                    white-space: pre-wrap;
                    line-height: 1.8;
                ">
                    载入中...
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeHistorySummaryModal()">关闭</button>
                </div>
            </div>
        </div>

        <!-- 背包弹窗 -->
        <div id="inventory-modal" class="modal viewport-overlay">
            <div class="modal-content inventory-content">
                <h3>背包</h3>
                <div class="inventory-grid" id="inventory-grid">
                    <!-- 动态生成 -->
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeInventoryModal()">关闭</button>
                </div>
            </div>
        </div>

        <!-- 装备弹窗 -->
        <div id="equipment-modal" class="modal viewport-overlay">
            <div class="modal-content equipment-content">
                <h3>装备栏</h3>
                <div class="equipment-slots">
                    <div class="equipment-slot">
                        <div class="slot-label">武器</div>
                        <div class="slot-item" id="weapon-slot">
                            <div class="empty-slot">空</div>
                        </div>
                    </div>
                    <div class="equipment-slot">
                        <div class="slot-label">防具</div>
                        <div class="slot-item" id="armor-slot">
                            <div class="empty-slot">空</div>
                        </div>
                    </div>
                    <div class="equipment-slot">
                        <div class="slot-label">饰品1</div>
                        <div class="slot-item" id="accessory1-slot">
                            <div class="empty-slot">空</div>
                        </div>
                    </div>
                    <div class="equipment-slot">
                        <div class="slot-label">饰品2</div>
                        <div class="slot-item" id="accessory2-slot">
                            <div class="empty-slot">空</div>
                        </div>
                    </div>
                </div>
                <div class="equipment-stats">
                    <h4>当前装备效果</h4>
                    <div id="equipment-effect">
                        <!-- 动态显示装备效果 -->
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeEquipmentModal()">关闭</button>
                </div>
            </div>
        </div>

        <!-- 道具详情弹窗 -->
        <div id="item-detail-modal" class="modal">
            <div class="modal-content item-detail-content">
                <h3 id="item-name"></h3>
                <div class="item-description" id="item-description"></div>
                <div class="item-info" id="item-info"></div>
                <div class="modal-buttons" id="item-actions">
                    <!-- 动态生成操作按钮 -->
                </div>
            </div>
        </div>

        <!-- 交易弹窗 -->
        <div id="trading-modal" class="modal viewport-overlay">
            <div class="modal-content trading-content">
                <div class="trading-container">
                    <!-- 左侧：用户物品 -->
                    <div class="trading-section user-items">
                        <h4 class="user-money-header">当前金钱: <span id="trading-money-value">0</span></h4>
                        <div class="trading-list" id="user-items-list">
                            <!-- 动态生成 -->
                        </div>
                    </div>
                    
                    <!-- 分隔线 -->
                    <div class="trading-divider"></div>
                    
                    <!-- 右侧：商店物品 -->
                    <div class="trading-section shop-items">
                        <h4 id="shop-title">商店物品</h4>
                        <div class="trading-list" id="shop-items-list">
                            <!-- 动态生成 -->
                        </div>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeTrading()">关闭</button>
                </div>
            </div>
        </div>

        <!-- 商品详情弹窗 -->
        <div id="shop-detail-modal" class="modal">
            <div class="modal-content shop-detail-content">
                <h3 id="shop-item-name"></h3>
                <div class="shop-item-description" id="shop-item-description"></div>
                <div class="shop-item-info" id="shop-item-info"></div>
                <div class="shop-item-price-info">
                    <div class="price-label">价格：</div>
                    <div class="price-value" id="shop-item-price"></div>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn" id="shop-buy-btn" onclick="buyItemFromDetail()">购买</button>
                    <button class="modal-btn cancel" onclick="closeShopDetailModal()">关闭</button>
                </div>
            </div>
        </div>

        <!-- 故事区域 -->
        <div class="story-area">
            <div class="story-content-wrapper">
                <!-- 页面指示器 -->
                <div class="page-indicator" id="page-indicator"></div>
                
                <!-- 翻页箭头 -->
                <button class="story-nav-btn prev" id="story-prev-btn" onclick="prevPage()">◀</button>
                <button class="story-nav-btn next" id="story-next-btn" onclick="nextPage()">▶</button>
                
                <!-- 故事文本 -->
                <div class="story-text" id="story-text">
                    江湖路远，故事未始...
                </div>
                
                <!-- 展开/收起按钮 -->
                <button class="story-expand-btn" id="story-expand-btn" onclick="toggleStoryExpand()">▼ 展开全文</button>
            </div>
            
            <!-- 随机事件容器 -->
            <div class="random-event-container" id="random-event-container">
                <div class="event-title">随机事件</div>
                <div class="event-description" id="event-description"></div>
                <div class="event-options" id="event-options"></div>
            </div>
            <!-- 战斗事件容器 -->
            <div class="battle-event-container" id="battle-event-container">
                <div class="battle-event-title">战斗事件</div>
                <div class="battle-event-description" id="battle-event-description"></div>
                <div class="battle-enemy-info">
                    <div class="enemy-info-item">
                        <span class="enemy-info-label">敌人：</span>
                        <span id="enemy-name-display"></span>
                    </div>
                    <div class="enemy-info-item">
                        <span class="enemy-info-label">攻击力：</span>
                        <span id="enemy-attack-display"></span>
                    </div>
                    <div class="enemy-info-item">
                        <span class="enemy-info-label">生命力：</span>
                        <span id="enemy-health-display"></span>
                    </div>
                </div>
                <div class="battle-reward">
                    <div class="battle-reward-text" id="battle-reward-text"></div>
                </div>
                <div class="battle-actions">
                    <button class="battle-action-btn fight" onclick="startBattle()">发起战斗</button>
                    <button class="battle-action-btn flee" onclick="fleeBattle()">放弃战斗</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载外部库 -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
    <!-- 从GitHub加载游戏模块 -->
    <script src="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@829f5eb/module/game-config.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@829f5eb/module/game-utils.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@829f5eb/module/game-state.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@829f5eb/module/game-ui.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@829f5eb/module/game-helpers.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@829f5eb/module/game-events.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@829f5eb/module/special-event.js"></script>
     
    <script>
    document.addEventListener('DOMContentLoaded', function() {  
        // 记录原始渲染环境状态
        window._originalRenderer = {
            hasSTscript: typeof window.STscript === 'function',
            hasTriggerSlash: typeof window.triggerSlash === 'function'
        };
        
        // 兼容层
        window.triggerSlash = window.triggerSlash || window.STscript;
        window.STscript = window.STscript || window.triggerSlash;

        window.updateTemplateVariables = function(vars) {
            if (!vars) return;
            
            /* 1. 如果初始化尚未结束，先把 vars 缓存起来 —— 只保留最后一次 */
            if (!window.__initDone) {
                window.__pendingTemplateVars = vars;
                return;
            }
            let hasUpdate = false;

            // 新增：处理SLG_MODE内容（包括脏标签的情况）
            let slgModeContent = null;

            // 方法1：标准化属性名查找
            for (const key in vars) {
                // 移除所有空格、下划线，并转为大写
                const normalizedKey = key.replace(/[\s_]/g, '').toUpperCase();
                if (normalizedKey === 'SLGMODE') {
                    slgModeContent = vars[key];
                    break;
                }
            }
                
            // 如果找到了SLG_MODE内容（无论标签写法如何）
            if (slgModeContent !== null && slgModeContent !== undefined) {
                // 提取正文：从第一个汉字、# 或 * 开始到第一个<为止
                // 扩展的Unicode范围支持更多中文字符（包括繁体）
                const mainTextMatch = slgModeContent.match(/[#*\u4e00-\u9fff\u3400-\u4dbf...][^<]*/);
                if (mainTextMatch) {
                    const startIndex = slgModeContent.indexOf(mainTextMatch[0]);
                    const endIndex = slgModeContent.indexOf('<', startIndex);
                    const mainText = endIndex > -1 
                        ? slgModeContent.substring(startIndex, endIndex) 
                        : slgModeContent.substring(startIndex);
                    
                    console.log(`成功捕捉到正文（通过汉字/#/*特征）`);
                    console.log(`${startIndex}`);
                    console.log(`${endIndex}`);   
                    localState.currentStoryText = mainText.trim();
                    console.log(`${localState.currentStoryText}`);
                    updateStoryText(localState.currentStoryText);
                }

                // 新增：提取SUMMARY内容
                // const summaryMatch = slgModeContent.match(/<SUMMARY>([\s\S]*?)<\/SUMMARY>/);
                if (!localState.summarySmallUpdateApplied) {   
                    const summaryRegex = /<[\s_]*[Ss][Uu][Mm][Mm][Aa][Rr][Yy][\s_]*>([\s\S]*?)<[\s_]*\/[\s_]*[Ss][Uu][Mm][Mm][Aa][Rr][Yy][\s_]*>/;
                    const summaryMatch = slgModeContent.match(summaryRegex);
                    if (summaryMatch && summaryMatch[1]) {
                        const summaryContent = summaryMatch[1].trim();
                        console.log('成功捕捉到SUMMARY内容：', summaryContent);

                        const year = Math.floor((currentWeek - 1) / 48) + 1;
                        const remainingWeeks = (currentWeek - 1) % 48;
                        const month = Math.floor(remainingWeeks / 4) + 1;
                        const week = remainingWeeks % 4 + 1;

                        const timestamp = `[第${year}年第${month}月第${week}周]`;
                        
                        // 构建本次要添加的完整内容（用于去重检查）
                        const contentToAdd = `${timestamp}\n${summaryContent}`;
                        
                        // 检查是否已存在相同内容（防止重新渲染时重复累加）
                        const alreadyExists = summary_Small && summary_Small.includes(summaryContent);
                        const alreadyExistsInWeek = summary_Week && summary_Week.includes(summaryContent);
                        const alreadyExistsInBackup = summary_Backup && summary_Backup.includes(summaryContent);
                        
                        if (alreadyExists || alreadyExistsInWeek || alreadyExistsInBackup) {
                            console.log('SUMMARY内容已存在，跳过重复添加');
                        } else {
                            if (newWeek === 1) {
                                if (summary_Week) {
                                    summary_Week += `\n\n${summaryContent}`;
                                } else {
                                    summary_Week = `${summaryContent}`;
                                }
                                if (summary_Small) {
                                    summary_Backup = summary_Backup
                                        ? `${summary_Backup}\n\n${summary_Small}`
                                        : `${summary_Small}`;
                                }
                                summary_Small = "";
                            } else {
                                if (summary_Small) {
                                    summary_Small += `\n\n${timestamp}\n${summaryContent}`;
                                } else {
                                    summary_Small = `${timestamp}\n${summaryContent}`;
                                }
                            }
                            console.log('SUMMARY已根据newWeek规则更新');
                        }

                        localState.summarySmallUpdateApplied = true;
                    } else {
                        // 如果没有找到SUMMARY标签，尝试更鲁棒的方法
                        // 从第一个{符号往前找汉字，再回溯到>符号
                        const jsonStartIndex = slgModeContent.indexOf('{');
                        if (jsonStartIndex > -1) {
                            // 从{往前搜索，找到可能的SUMMARY结束位置
                            let searchStart = jsonStartIndex - 1;
                            while (searchStart >= 0) {
                                const char = slgModeContent[searchStart];
                                // 检查是否是汉字或其他有意义的字符
                                if (/[\u4e00-\u9fff\u3400-\u4dbf\w]/.test(char)) {
                                    // 找到了有意义的字符，现在向前找>符号
                                    let summaryStartSearch = searchStart;
                                    while (summaryStartSearch >= 0 && slgModeContent[summaryStartSearch] !== '>') {
                                        summaryStartSearch--;
                                    }
                                    
                                    if (summaryStartSearch >= 0) {
                                        // 找到了>符号，提取这段内容
                                        const potentialSummary = slgModeContent.substring(summaryStartSearch + 1, searchStart + 1).trim();
                                        
                                        // 检查是否包含SUMMARY相关内容
                                        if (potentialSummary.length > 0 && !potentialSummary.includes('<MAIN_TEXT>')) {
                                            console.log('通过鲁棒方法捕捉到可能的SUMMARY内容：', potentialSummary);
                                            
                                            // 检查是否已存在相同内容（防止重新渲染时重复累加）
                                            const alreadyExists = summary_Small && summary_Small.includes(potentialSummary);
                                            const alreadyExistsInWeek = summary_Week && summary_Week.includes(potentialSummary);
                                            const alreadyExistsInBackup = summary_Backup && summary_Backup.includes(potentialSummary);
                                            
                                            if (alreadyExists || alreadyExistsInWeek || alreadyExistsInBackup) {
                                                console.log('SUMMARY内容已存在（鲁棒方法），跳过重复添加');
                                            } else {
                                                const year = Math.floor((currentWeek - 1) / 48) + 1;
                                                const remainingWeeks = (currentWeek - 1) % 48;
                                                const month = Math.floor(remainingWeeks / 4) + 1;
                                                const week = remainingWeeks % 4 + 1;

                                                const timestamp = `[第${year}年第${month}月第${week}周]`;

                                                if (newWeek === 1) {
                                                    if (summary_Week) {
                                                        summary_Week += `\n\n${timestamp}\n${potentialSummary}`;
                                                    } else {
                                                        summary_Week = `${timestamp}\n${potentialSummary}`;
                                                    }
                                                    if (summary_Small) {
                                                        summary_Backup = summary_Backup
                                                            ? `${summary_Backup}\n\n${summary_Small}`
                                                            : `${summary_Small}`;
                                                    }
                                                    summary_Small = "";
                                                } else {
                                                    if (summary_Small) {
                                                        summary_Small += `\n\n${timestamp}\n${potentialSummary}`;
                                                    } else {
                                                        summary_Small = `${timestamp}\n${potentialSummary}`;
                                                    }
                                                }
                                                console.log('SUMMARY已根据newWeek规则更新（鲁棒方法）');
                                            }

                                            localState.summarySmallUpdateApplied = true;
                                        }
                                    }
                                    break;
                                }
                                searchStart--;
                            }
                        }
                    }
                }
                
                // 提取JSON：从第一个{开始到下一个<为止（如果没有<则到结尾）
                const jsonStartIndex = slgModeContent.indexOf('{');
                if (jsonStartIndex > -1 && !localState.turnUpdateApplied) {
                    const jsonEndIndex = slgModeContent.indexOf('<', jsonStartIndex);
                    const jsonText = jsonEndIndex > -1 
                        ? slgModeContent.substring(jsonStartIndex, jsonEndIndex)
                        : slgModeContent.substring(jsonStartIndex);
                    
                    try {
                        console.log(`成功捕捉到JSON（通过{特征）`);
                        let llmResponse = jsonText.trim();
                        console.log(`提取的JSON文本：${llmResponse}`);
                        
                        if (typeof llmResponse === 'string') {
                            llmResponse = JSON.parse(llmResponse);
                        }
                        parseLLMResponse(llmResponse, localState.currentStoryText);
                        hasUpdate = true;
                    } catch (error) {
                        console.error('解析SIDE_NOTE失败:', error);
                    }
                }
            }

            // if (vars.MAIN_TEXT !== undefined) {
            //     console.log(`成功捕捉到正文`);
            //     localState.currentStoryText = vars.MAIN_TEXT;
            //     updateStoryText(localState.currentStoryText);
            //     //hasUpdate = true;
            // }
            
            // console.log(`vars.SIDE_NOTE为：${vars.SIDE_NOTE}`);
            // console.log(`localState.turnUpdateApplied为：${localState.turnUpdateApplied}`);
            // if (vars.SIDE_NOTE !== undefined && !localState.turnUpdateApplied) {
            //     try {
            //         console.log(`成功捕捉到JSON`);
            //         let llmResponse = vars.SIDE_NOTE;
            //         if (typeof llmResponse === 'string') {
            //             llmResponse = JSON.parse(llmResponse);
            //         }
            //         parseLLMResponse(llmResponse, localState.currentStoryText);
            //         hasUpdate = true;
            //     } catch (error) {
            //         console.error('解析SIDE_NOTE失败:', error);
            //     }
            // }
            
            if (hasUpdate) {
                localState.turnUpdateApplied = true;
            }
        };
        
        // 模板变量
        // const mainText = `$1`;
        // const llmResponse = $2;
        
        // ========== 保留在HTML中的函数（用于onclick调用） ==========
        
        // 修改 showPlayerStats 函数
        function showPlayerStats() {
            // 只有当前场景不是角色属性或人际关系时才记录
            const activeScene = document.querySelector('.scene.active');
            if (activeScene && 
                activeScene.id !== 'player-stats-scene' && 
                activeScene.id !== 'relationships-scene') {
                previousScene = activeScene.id.replace('-scene', '');
                wasInSLGMode = GameMode === 1;
            }
            
            // 清除SLG相关元素
            const viewport = document.getElementById('main-viewport');
            const existingLayers = viewport.querySelectorAll('.slg-layer-container, .slg-layer');
            existingLayers.forEach(layer => layer.remove());
            const existingMask = viewport.querySelector('.slg-interaction-mask');
            if (existingMask) existingMask.remove();
            
            // 先切换场景
            switchScene('player-stats');
            updateStatsDisplay();
            
            // 如果是SLG模式，移除该场景的slg-mode类
            if (GameMode === 1) {
                const statsScene = document.getElementById('player-stats-scene');
                statsScene.classList.remove('slg-mode');
            }
        }

        // 从开局页接收 SLGMODE 并触发渲染，测试开局界面，不对的话就取消这部分
        try {
            const cached = sessionStorage.getItem('__templateVarsFromStart');
            if (cached) {
                const vars = JSON.parse(cached);
                sessionStorage.removeItem('__templateVarsFromStart');
                if (typeof window.updateTemplateVariables === 'function') {
                    window.updateTemplateVariables(vars);
                }
            }
            // 兜底：若跨域导致 sessionStorage 为空，尝试 window.name
            if (!cached && window.name) {
                try {
                    const parsed = JSON.parse(window.name);
                    if (parsed && typeof parsed === 'object' && parsed.SLGMODE && typeof window.updateTemplateVariables === 'function') {
                        window.updateTemplateVariables(parsed);
                    }
                } catch (e) {}
            }
        } catch (e) { console.warn('读取开场白失败', e); }

        // 修改 showRelationships 函数
        function showRelationships() {
            // 只有当前场景不是角色属性或人际关系时才记录
            const activeScene = document.querySelector('.scene.active');
            if (activeScene && 
                activeScene.id !== 'player-stats-scene' && 
                activeScene.id !== 'relationships-scene') {
                previousScene = activeScene.id.replace('-scene', '');
                wasInSLGMode = GameMode === 1;
            }
            
            // 清除SLG相关元素
            const viewport = document.getElementById('main-viewport');
            const existingLayers = viewport.querySelectorAll('.slg-layer-container, .slg-layer');
            existingLayers.forEach(layer => layer.remove());
            const existingMask = viewport.querySelector('.slg-interaction-mask');
            if (existingMask) existingMask.remove();
            
            // 先切换场景
            switchScene('relationships');
            updateRelationshipsDisplay();
            
            // 如果是SLG模式，移除该场景的slg-mode类
            if (GameMode === 1) {
                const relScene = document.getElementById('relationships-scene');
                relScene.classList.remove('slg-mode');
            }
        }

        // 切换NPC可见性
        function toggleNpcVisibility(npcId) {
            const checkbox = document.getElementById(`visibility-${npcId}`);
            npcVisibility[npcId] = checkbox.checked;
            
            // 如果NPC被设置为不显示，立即将其位置设为none
            if (!npcVisibility[npcId]) {
                currentNpcLocations[npcId] = 'none';
                
                // 更新对应的位置变量
                switch(npcId) {
                    case 'A': npcLocationA = 'none'; break;
                    case 'B': npcLocationB = 'none'; break;
                    case 'C': npcLocationC = 'none'; break;
                    case 'D': npcLocationD = 'none'; break;
                    case 'E': npcLocationE = 'none'; break;
                    case 'F': npcLocationF = 'none'; break;
                    case 'G': npcLocationG = 'none'; break;
                    case 'H': npcLocationH = 'none'; break;
                    case 'I': npcLocationI = 'none'; break;
                    case 'J': npcLocationJ = 'none'; break;
                    case 'K': npcLocationK = 'none'; break;
                    case 'L': npcLocationL = 'none'; break;
                    case 'Z': npcLocationZ = 'none'; break;
                }
                
                // 如果当前场景有该NPC，更新显示
                const activeScene = document.querySelector('.scene.active');
                if (activeScene && activeScene.id !== 'map-scene') {
                    const locationName = activeScene.id.replace('-scene', '');
                    displayNpcs(locationName);
                }
            }
            
            // 保存游戏数据
            // saveGameData();
        }

        // 送礼函数
        async function giveGift(npcId) {
            const npc = npcs[npcId];
            const currentFavorability = npcFavorability[npcId];
            
            // 再次检查条件
            if (npcGiftGiven[npcId]) {
                showModal('本周已经给该NPC送过礼物了！');
                return;
            }
            
            if (currentFavorability > 40) {
                showModal(`${npc.name}的好感度已经超过40，无需再送礼！`);
                return;
            }
            
            if (playerStats.金钱 < 500) {
                showModal('金钱不足500，无法送礼！');
                return;
            }
            
            // 执行送礼
            playerStats.金钱 -= 500;
            npcFavorability[npcId] = Math.min(100, npcFavorability[npcId] + 5);
            npcGiftGiven[npcId] = true;
            
            checkAllValueRanges();
            updateStatsDisplay();
            updateRelationshipsDisplay();
            
            // 发送消息
            const message = `你花费500金钱给${npc.name}送了一份礼物<br>` +
                        `${npc.name}的好感度提升至${npcFavorability[npcId]}`;
            
            await showModal(message);
        }

        // 修改 skipWeek 函数，在跳过周时重置送礼状态
        async function skipWeek() {
            showConfirmModal(
                '确认跳过',
                '确定要跳过这一周吗？',
                async () => {
                    currentWeek++;
                    actionPoints = 3;
                    userLocation = "tianshanpai";
                    
                    // 更新季节
                    const newSeason = calculateSeason(currentWeek);
                    if (newSeason !== seasonStatus) {
                        seasonStatus = newSeason;
                        console.log(`季节更新为：${seasonStatus}`);
                    }
                    
                    // 更新场景背景
                    updateSceneBackgrounds();
                    
                    // 重置所有NPC的送礼状态
                    Object.keys(npcGiftGiven).forEach(npcId => {
                        npcGiftGiven[npcId] = false;
                    });
                    
                    // 重置所有NPC的切磋状态
                    Object.keys(npcSparred).forEach(npcId => {
                        npcSparred[npcId] = false;
                    });
                    
                    // 重置炼丹状态
                    alchemyDone = false;
                    
                    checkAllValueRanges();
                    updateAllDisplays();
                    refreshNpcLocations();
                    
                    // 检查特殊事件
                    const specialEvent = typeof checkSpecialEvents === 'function' ? checkSpecialEvents() : null;
                    const year = Math.floor((currentWeek - 1) / 48) + 1;
                    const remainingWeeks = (currentWeek - 1) % 48;
                    const month = Math.floor(remainingWeeks / 4) + 1;
                    const week = remainingWeeks % 4 + 1;
                    
                    if (specialEvent) {
                        console.log(`[skipWeek] 触发特殊事件: ${specialEvent.name}`);
                        // 触发特殊事件（会应用效果、标记已触发、发送预设文本）
                        // 传递 fromSkipWeek: true 标识是由跳过一周按钮触发的
                        await triggerSpecialEvent(specialEvent, { fromSkipWeek: true });
                    } else {
                        // 无特殊事件，发送普通的新周消息
                        await handleMessageOutput('行动选择:新的一周开始了<br>当前第' + year + '年第' + month + '月第' + week + '周');
                    }
                }
            );
        }

        // 执行互动
        async function performAction(action, location) {
            // 新增：如果是SLG模式，不执行任何操作
            if (GameMode === 1) {
                return;
            }
            if (action === '秘密赌场') {
                if (actionPoints < 1) {
                    showModal('行动点不足，无法进行此操作！');
                    return;
                }
                
                let actionPointConsumed = true;
                const mindChance = playerTalents.心性 / 2;
                if (Math.random() * 100 < mindChance) {
                    actionPointConsumed = false;
                } else {
                    actionPoints--;
                }
                checkAllValueRanges();
                updateAllDisplays();
                
                showBlackjackGame();
                
                if (!actionPointConsumed) {
                    window.pendingMindMessage = true;
                }
                return;
            }

            if (action === '耕种') {
                // if (actionPoints < 1) {
                //     showModal('行动点不足，无法进行此操作！');
                //     return;
                // }
                
                // let actionPointConsumed = true;
                // const mindChance = playerTalents.心性 / 2;
                // if (Math.random() * 100 < mindChance) {
                //     actionPointConsumed = false;
                // } else {
                //     actionPoints--;
                // }
                // checkAllValueRanges();
                // updateAllDisplays();
                
                showFarmGame();
                
                // if (!actionPointConsumed) {
                //     window.pendingMindMessage = true;
                // }
                return;
            }
            
            if (action === '炼丹') {
                showAlchemyGame();
                return;
            }

            if (actionPoints < 1) {
                showModal('行动点不足，无法进行此操作！');
                return;
            }

            let actionPointConsumed = true;
            let mindMessageShown = false;
            const mindChance = playerTalents.心性 / 2;
            if (Math.random() * 100 < mindChance) {
                actionPointConsumed = false;
                mindMessageShown = true;
            } else {
                actionPoints--;
            }
            
            const config = actionConfigs[action];
            const talentBonus = playerTalents[config.talentBonus] / 2;
            
            // 根据难度调整成功率计算
            let moodBonus = 10; // 默认普通难度
            
            switch(difficulty) {
                case 'easy':
                    moodBonus = 20;
                    break;
                case 'normal':
                    moodBonus = 10;
                    break;
                case 'hard':
                    moodBonus = 0;
                    break;
            }
            
            const randomRoll = Math.random() * 100;
            const finalValue = (randomRoll + talentBonus) * (playerMood + moodBonus) / 100;

            let successLevel, successText, moodCost;
            let statChange = {};
            
            if (finalValue >= 80) {
                successLevel = '大成功';
                successText = '成果斐然！';
                moodCost = 0;
                if (action === '休息') {
                    const oldMood = playerMood;
                    playerMood = Math.min(100, playerMood + 90);  // 限制最多到100
                    statChange.体力 = '+' + (playerMood - oldMood);  // 显示实际增加值
                } else if (config.affects === '金钱') {
                    statChange[config.affects] = 1000;
                } else if (config.affects === '声望') {
                    statChange[config.affects] = 5;
                } else {
                    statChange[config.affects] = 5;
                }
            } else if (finalValue >= 60) {
                successLevel = '成功';
                successText = '收获颇丰。';
                moodCost = 5;
                if (action === '休息') {
                    const oldMood = playerMood;
                    playerMood = Math.min(100, playerMood + 60);  // 限制最多到100
                    statChange.体力 = '+' + (playerMood - oldMood);  // 显示实际增加值
                } else if (config.affects === '金钱') {
                    statChange[config.affects] = 500;
                } else if (config.affects === '声望') {
                    statChange[config.affects] = 3;
                } else {
                    statChange[config.affects] = 3;
                }
            } else if (finalValue >= 40) {
                successLevel = '一般';
                successText = '平平无奇。';
                moodCost = 10;
                if (action === '休息') {
                    const oldMood = playerMood;
                    playerMood = Math.min(100, playerMood + 45);  // 限制最多到100
                    statChange.体力 = '+' + (playerMood - oldMood);  // 显示实际增加值
                } else if (config.affects === '金钱') {
                    statChange[config.affects] = 100;
                } else if (config.affects === '声望') {
                    statChange[config.affects] = 1;
                } else {
                    statChange[config.affects] = 1;
                }
            } else if (finalValue >= 20) {
                successLevel = '失败';
                successText = '事与愿违...';
                moodCost = 15;
                if (action === '休息') {
                    const oldMood = playerMood;
                    playerMood = Math.min(100, playerMood + 30);  // 限制最多到100
                    statChange.体力 = '+' + (playerMood - oldMood);  // 显示实际增加值
                } else if (config.affects === '金钱') {
                    statChange[config.affects] = -500;
                } else if (config.affects === '声望') {
                    statChange[config.affects] = -2;
                } else {
                    statChange[config.affects] = 0;
                }
            } else {
                successLevel = '大失败';
                successText = '惨不忍睹！';
                moodCost = 20;
                if (action === '休息') {
                    const oldMood = playerMood;
                    playerMood = Math.min(100, playerMood + 30);  // 限制最多到100
                    statChange.体力 = '+' + (playerMood - oldMood);  // 显示实际增加值
                } else if (config.affects === '金钱') {
                    statChange[config.affects] = -1000;
                } else if (config.affects === '声望') {
                    statChange[config.affects] = -5;
                } else {
                    statChange[config.affects] = 0;
                }
            }

            if (config.affects !== '体力') {
                playerStats[config.affects] = Math.max(0, playerStats[config.affects] + statChange[config.affects]);
                if (action !== '休息') {
                    playerMood = Math.max(0, playerMood - moodCost);
                }
            }

            checkAllValueRanges();

            const npcsPresent = getNpcsAtLocation(location).map(npc => npc.name).join('、') || '无';

            let changeText = '';
            Object.entries(statChange).forEach(([key, value]) => {
                changeText += `<br>${key}: ${value > 0 ? '+' : ''}${value}`;
            });
            if (action !== '休息') {
                changeText += `<br>体力: -${moodCost}`;
            }
            
            if (actionPointConsumed) {
                changeText += '<br>行动点: -1';
            } else {
                changeText += '<br>行动点: -0（心性判定成功）';
            }

            // 检查并更新季节（以防某些行动改变了周数）
            const newSeason = calculateSeason(currentWeek);
            if (newSeason !== seasonStatus) {
                seasonStatus = newSeason;
                updateSceneBackgrounds();
            }

            let locationInfo = '';
            if (userLocation === userLocation_old) {
                locationInfo = `地点：${locationNames[location]}<br>`;
            } else {
                const oldLocationName = locationNames[userLocation_old] || userLocation_old;
                const newLocationName = locationNames[userLocation] || locationNames[location];
                locationInfo = `地点：从${oldLocationName}来到${newLocationName}<br>`;
            }

            let resultMessage = `时间：第${Math.floor((currentWeek - 1) / 48) + 1}年第${Math.floor(((currentWeek - 1) % 48) / 4) + 1}月第${((currentWeek - 1) % 4) + 1}周<br>` +
                `季节：${seasonNameMap[seasonStatus] || '冬天'}<br>` +
                locationInfo +  // 使用新的地点信息
                `{{user}}行动选择：${action}<br>` +
                `在场NPC：${npcsPresent}<br>` +
                `选择结果：${successLevel} - ${successText}<br><br>` +
                `属性变化：${changeText}`;

            updateAllDisplays();
            refreshNpcLocations();
            
            await handleMessageOutput(resultMessage);
        }

        // 刷新NPC位置
        function refreshNpcLocations() {
            // 获取用户当前位置（排除特殊场景）
            const currentLocation = userLocation === 'tianshanpai' || 
                                userLocation === 'player-stats' || 
                                userLocation === 'relationships' ? null : userLocation;
            
            // 保存当前位置的NPC
            const npcsAtCurrentLocation = [];
            if (currentLocation) {
                Object.keys(currentNpcLocations).forEach(npcId => {
                    if (currentNpcLocations[npcId] === currentLocation) {
                        npcsAtCurrentLocation.push(npcId);
                    }
                });
            }
            
            const locationCount = {
                yanwuchang: 0,
                cangjingge: 0,
                huofang: 0,
                houshan: 0,
                yishiting: 0,
                tiejiangpu: 0,
                nandizi: 0,
                nvdizi: 0,
                shanmen: 0,
                gongtian: 0,
                danfang: 0
            };
            
            // 如果有当前位置，先统计该位置的NPC数量
            if (currentLocation && locationCount.hasOwnProperty(currentLocation)) {
                locationCount[currentLocation] = npcsAtCurrentLocation.length;
            }

            // 只对不在当前位置的NPC进行重新分配
            const npcsToShuffle = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'Z'].filter(
                npcId => !npcsAtCurrentLocation.includes(npcId)
            );
            const npcOrder = npcsToShuffle.sort(() => Math.random() - 0.5);

            npcOrder.forEach(npcId => {
                // 新增：检查NPC是否被设置为不显示
                if (!npcVisibility[npcId]) {
                    currentNpcLocations[npcId] = 'none';
                    return;
                }
                
                let assigned = false;
                let attempts = 0;
                const maxAttempts = 20;

                while (!assigned && attempts < maxAttempts) {
                    const location = getRandomLocation(npcId);
                    
                    // 跳过用户当前位置
                    if (currentLocation && location === currentLocation) {
                        attempts++;
                        continue;
                    }
                    
                    if (location === 'none') {
                        currentNpcLocations[npcId] = location;
                        assigned = true;
                    } else if (locationCount[location] < 2) {
                        currentNpcLocations[npcId] = location;
                        locationCount[location]++;
                        assigned = true;
                    }
                    
                    attempts++;
                }

                if (!assigned) {
                    currentNpcLocations[npcId] = 'none';
                }
            });

            // 更新各个NPC的位置变量
            npcLocationA = currentNpcLocations.A;
            npcLocationB = currentNpcLocations.B;
            npcLocationC = currentNpcLocations.C;
            npcLocationD = currentNpcLocations.D;
            npcLocationE = currentNpcLocations.E;
            npcLocationF = currentNpcLocations.F;
            npcLocationG = currentNpcLocations.G;
            npcLocationH = currentNpcLocations.H;
            npcLocationI = currentNpcLocations.I;
            npcLocationJ = currentNpcLocations.J;
            npcLocationK = currentNpcLocations.K;
            npcLocationL = currentNpcLocations.L;
            npcLocationZ = currentNpcLocations.Z;
            
            const activeScene = document.querySelector('.scene.active');
            if (activeScene && activeScene.id !== 'map-scene') {
                const locationName = activeScene.id.replace('-scene', '');
                displayNpcs(locationName);
            }

            // 更新地图地点标签上的👤人数
            if (typeof updateLocationHeadcountLabels === 'function') {
                updateLocationHeadcountLabels();
            }
        }

        // 修改 backToMap 函数
        function backToMap() {
            // 移除返回按钮的偏移类
            const backBtns = document.querySelectorAll('.back-btn.slg-mode-offset');
            backBtns.forEach(btn => btn.classList.remove('slg-mode-offset'));
            
            // 获取当前场景
            const activeScene = document.querySelector('.scene.active');
            const currentSceneId = activeScene ? activeScene.id : '';
            
            // 如果是从角色属性或人际关系界面返回，且之前在SLG模式
            if ((currentSceneId === 'player-stats-scene' || currentSceneId === 'relationships-scene') 
                && wasInSLGMode && GameMode === 1) {
                
                // 直接返回到之前的SLG场景
                switchScene(previousScene);
                
                // 如果不是地图场景，添加slg-mode类
                if (previousScene !== 'map') {
                    const targetScene = document.getElementById(previousScene + '-scene');
                    if (targetScene) {
                        targetScene.classList.add('slg-mode');
                    }
                }
                
                // 恢复SLG显示
                updateStoryDisplay();
                
                // 重置状态
                wasInSLGMode = false;
            } else {
                // 普通模式：返回地图
                const scenes = document.querySelectorAll('.scene');
                scenes.forEach(scene => {
                    scene.classList.remove('active');
                });

                document.getElementById('map-scene').classList.add('active');
                userLocation = 'tianshanpai';

                // 取消地图高亮与弹窗
                try {
                    const svg = document.getElementById('map-hit-areas');
                    if (svg) {
                        svg.querySelectorAll('polygon.active').forEach(n => n.classList.remove('active'));
                    }
                    const locPopup = document.getElementById('location-info-popup');
                    if (locPopup) locPopup.classList.remove('show');
                } catch (e) {}
            }
        }

        // 关闭弹窗
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // 发送互动内容
        async function sendInteraction() {
            const interactionContent = document.getElementById('interaction-input').value.trim();
            
            if (!interactionContent) {
                alert('请输入互动内容！');
                return;
            }
            
            const activeScene = document.querySelector('.scene.active');
            const location = activeScene.id.replace('-scene', '');
            
            const npc = npcs[currentInteractionNpc];
            const npcsPresent = getNpcsAtLocation(location).map(npc => npc.name).join('、') || '无';
            
            let locationInfo = '';
            if (userLocation === userLocation_old) {
                locationInfo = `地点：${locationNames[location]}<br>`;
            } else {
                const oldLocationName = locationNames[userLocation_old] || userLocation_old;
                const newLocationName = locationNames[userLocation] || locationNames[location];
                locationInfo = `地点：从${oldLocationName}来到${newLocationName}<br>`;
            }

            const resultMessage = `时间：第${Math.floor((currentWeek - 1) / 48) + 1}年第${Math.floor(((currentWeek - 1) % 48) / 4) + 1}月第${((currentWeek - 1) % 4) + 1}周<br>` +
                `季节：${seasonNameMap[seasonStatus] || '冬天'}<br>` +
                locationInfo +  // 使用新的地点信息
                `{{user}}行动选择：NPC互动<br>` +
                `&nbsp;&nbsp;&nbsp;&nbsp;互动对象：${npc.name}<br>` +
                `&nbsp;&nbsp;&nbsp;&nbsp;互动内容：<span class="interaction-content">${interactionContent}</span><br>`;
            
            closeModal();
            
            currentInteractionNpc = null;
            currentInteractionLocation = null;
            
            await handleMessageOutput(resultMessage);
        }

        // 增加攻击力
        function addAttack() {
            const remainingPoints = calculateRemainingPoints();
            if (remainingPoints > 0) {
                showConfirmModal(
                    '确认加点',
                    '消耗1点分配点数，增加10点攻击力？',
                    () => {
                        combatStats.攻击力 += 10;
                        checkAllValueRanges();
                        updateStatsDisplay();
                        setTimeout(() => {
                            showModal(`攻击力提升至 ${combatStats.攻击力}`);
                        }, 100);
                    }
                );
            }
        }

        // 增加生命值
        function addHP() {
            const remainingPoints = calculateRemainingPoints();
            if (remainingPoints > 0) {
                showConfirmModal(
                    '确认加点',
                    '消耗1点分配点数，增加25点生命值？',
                    () => {
                        combatStats.生命值 += 25;
                        checkAllValueRanges();
                        updateStatsDisplay();
                        setTimeout(() => {
                            showModal(`生命值提升至 ${combatStats.生命值}`);
                        }, 100);
                    }
                );
            }
        }

        // NPC动作
        function npcAction(npcId, action) {
            const popup = document.getElementById('npc-info-popup');
            popup.classList.remove('show');
            document.removeEventListener('click', closeNpcInfo);
            
            if (action === '互动') {
                const activeScene = document.querySelector('.scene.active');
                const location = activeScene.id.replace('-scene', '');
                showInteractionInput(npcId, location);
            } else if (action === '切磋') {
                // 检查是否本周已经切磋过
                if (npcSparred[npcId]) {
                    showModal('本周已经和该NPC切磋过了！');
                    return;
                }
                
                const npc = npcs[npcId];
                currentBattleType = 'npc';
                currentBattleNpcName = npc.name;
                currentBattleNpcId = npcId;  // 新增：记录NPC ID
                
                const battleData = {
                    player: {
                        name: '你',
                        attack: combatStats.攻击力,
                        health: combatStats.生命值
                    },
                    enemy: {
                        name: npc.name,
                        maxHealth: '中',
                        basicDamage: '中'
                    }
                };
                
                showBattleGame(battleData);
            }
        }

        // 前往地点
        function goToLocation(locationId) {
            // 新增：如果是SLG模式，不允许切换场景
            if (GameMode === 1) {
                return;
            }
            
            const popup = document.getElementById('location-info-popup');
            popup.classList.remove('show');
            document.removeEventListener('click', closeLocationInfo);
            
            userLocation = locationId;
            switchScene(locationId);
        }

        // 发送自由行动
        async function sendFreeAction() {
            const inputElement = document.getElementById('free-action-input');
            const actionContent = inputElement.value.trim();

            const year = Math.floor((currentWeek - 1) / 48) + 1;
            const remainingWeeks = (currentWeek - 1) % 48;
            const month = Math.floor(remainingWeeks / 4) + 1;
            const week = remainingWeeks % 4 + 1;
            
            if (!actionContent) {
                alert('请输入自由行动内容！');
                return;
            }
            let resultMessage = '';
            // GameMode为1时的特殊处理
            if (GameMode === 1) {
                // 根据mapLocation的危险度进行事件判定
                const dangerLevel = locationDangerLevels[mapLocation] || '低';
                const eventChance = dangerEventChance[dangerLevel];
                
                const eventRoll = Math.random() * 100;
                
                // 先判断战斗事件（优先级更高）
                if (eventRoll < eventChance.battle) {
                    battleEvent = 1;
                    randomEvent = 0;
                    console.log(`在${mapLocation}触发战斗事件！危险度：${dangerLevel}`);
                } else if (eventRoll < (eventChance.battle + eventChance.random)) {
                    // 战斗事件没触发时，再判断随机事件
                    randomEvent = 1;
                    battleEvent = 0;
                    console.log(`在${mapLocation}触发随机事件！危险度：${dangerLevel}`);
                } else {
                    randomEvent = 0;
                    battleEvent = 0;
                }
                
                // 生成随行NPC名字列表
                let companionNames = '无';
                if (companionNPC && companionNPC.length > 0) {
                    companionNames = companionNPC.join('、');
                }
                
                // 构建事件信息
                let eventInfo = '';
                if (randomEvent === 1) {
                    eventInfo += '<br>特殊事件：遭遇随机事件';
                }
                if (battleEvent === 1) {
                    eventInfo += '<br>特殊事件：遭遇战斗';
                }
                
                resultMessage = `时间：第${year}年第${month}月第${week}周<br>` +
                    `季节：${seasonNameMap[seasonStatus] || '冬天'}<br>` +
                    `地点：${mapLocation}<br>` +
                    `{{user}}自由行动："${actionContent}"<br>` +
                    `随行NPC：${companionNames}` +
                    eventInfo;
            } else {
                // 原有的GameMode为0的逻辑
                const activeScene = document.querySelector('.scene.active');
                let currentLocation = '';
                
                const npcsPresent = getNpcsAtLocation(userLocation).map(npc => npc.name).join('、') || '无';
                
                let locationInfo = '';
                if (activeScene.id === 'map-scene') {
                    // 地图场景特殊处理
                    if (userLocation === userLocation_old) {
                        locationInfo = `地点：天山派<br>`;
                    } else {
                        const oldLocationName = locationNames[userLocation_old] || userLocation_old;
                        locationInfo = `地点：从${oldLocationName}来到天山派<br>`;
                    }
                } else {
                    const sceneName = activeScene.id.replace('-scene', '');
                    const currentLocationName = locationNames[sceneName] || sceneName;
                    
                    if (userLocation === userLocation_old) {
                        locationInfo = `地点：${currentLocationName}<br>`;
                    } else {
                        const oldLocationName = locationNames[userLocation_old] || userLocation_old;
                        locationInfo = `地点：从${oldLocationName}来到${currentLocationName}<br>`;
                    }
                }

                resultMessage = `时间：第${year}年第${month}月第${week}周<br>` +
                    `季节：${seasonNameMap[seasonStatus] || '冬天'}<br>` +
                    locationInfo +
                    `{{user}}自由行动："${actionContent}"<br>` +
                    `在场NPC：${npcsPresent}`;
            }
            inputElement.value = '';
            inputElement.style.height = 'auto';
            
            await handleMessageOutput(resultMessage);
        }
        // 发起战斗
        function startBattle() {
            if (!currentBattleEvent || !currentBattleEvent.敌方信息) return;
            
            const enemyInfo = currentBattleEvent.敌方信息;
            currentBattleType = 'event';
            
            const battleData = {
                player: {
                    name: '你',
                    attack: combatStats.攻击力,
                    health: combatStats.生命值
                },
                enemy: {
                    name: enemyInfo.名称,
                    maxHealth: enemyInfo.属性?.生命力 || '中',
                    basicDamage: enemyInfo.属性?.攻击力 || '中'
                }
            };
            
            showBattleGame(battleData);
        }

        // 放弃战斗
        async function fleeBattle() {
            if (!currentBattleEvent) return;
            
            const resultMessage = currentBattleEvent.事件描述 + '<br><br>你选择避开了战斗';
            
            hideBattleEvent();
            
            await handleMessageOutput(resultMessage);
        }
        
        // ========== 初始化 ==========
        // window.onload = async function() {
        //     //await loadOrInitGameData();
        //     checkAllValueRanges();
        //     updateAllDisplays();
        //     setupLocationEvents();
        //     setupMessageListeners();
            
        //     if (isInRenderEnvironment()) {
        //         const refreshBtn = document.querySelector('.refresh-npc-btn');
        //         if (refreshBtn) {
        //             refreshBtn.style.display = 'none';
        //         }
        //     }
            
        //     if (userLocation === 'tianshanpai') {
        //         document.getElementById('map-scene').classList.add('active');
        //     } else {
        //         switchScene(userLocation);
        //     }
            
        //     // parseLLMResponse(llmResponse, mainText);
        // };
        
        // 自由行动输入框事件
        document.getElementById('free-action-input').addEventListener('input', function() {
            this.style.height = 'auto';
            const scrollHeight = this.scrollHeight;
            this.style.height = Math.min(scrollHeight, 120) + 'px';
        });
        
        document.getElementById('free-action-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendFreeAction();
            }
        });
        
        // 弹窗背景点击事件
        document.getElementById('blackjack-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                const iframe = document.getElementById('blackjack-iframe');
                try {
                    iframe.contentWindow.postMessage({ type: 'close-game' }, '*');
                } catch(e) {
                    this.style.display = 'none';
                    iframe.src = '';
                }
            }
        });
        
        document.getElementById('battle-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                if (confirm('确定要退出战斗吗？')) {
                    this.style.display = 'none';
                    document.getElementById('battle-iframe').src = '';
                    
                    if (currentBattleType === 'event') {
                        hideBattleEvent();
                    }
                    
                    currentBattleType = null;
                    currentBattleReward = null;
                }
            }
        });

        document.getElementById('farm-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                if (confirm('确定要退出农场吗？')) {
                    this.style.display = 'none';
                    document.getElementById('farm-iframe').src = '';
                }
            }
        });

        document.getElementById('alchemy-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                if (confirm('确定要退出炼丹吗？')) {
                    this.style.display = 'none';
                    document.getElementById('alchemy-iframe').src = '';
                }
            }
        });

        // 翻页相关函数（调用game-ui.js中的实际实现）
        function goToPage(pageNum) {
            if (typeof doGoToPage === 'function') {
                doGoToPage(pageNum);
            }
        }

        function prevPage() {
            if (typeof doPrevPage === 'function') {
                doPrevPage();
            }
        }

        function nextPage() {
            if (typeof doNextPage === 'function') {
                doNextPage();
            }
        }

        function toggleStoryExpand() {
            if (typeof doToggleStoryExpand === 'function') {
                doToggleStoryExpand();
            }
        }

        // 从SLG模式返回
        async function returnFromSLG() {
            const message = '你结束了山下的游历，回到了天山派';
            
            // 重置游戏模式
            GameMode = 0;
            slgModeData = [];

            // 重置下山相关的变量
            randomEvent = 0;
            battleEvent = 0;
            companionNPC = [];
            mapLocation = '天山派';
            
            // 清除SLG图层
            const viewport = document.getElementById('main-viewport');
            const existingLayers = viewport.querySelectorAll('.slg-layer');
            existingLayers.forEach(layer => layer.remove());
            const existingMask = viewport.querySelector('.slg-interaction-mask');
            if (existingMask) existingMask.remove();
            
            // 移除场景的SLG模式标记
            const scenes = document.querySelectorAll('.scene');
            scenes.forEach(scene => {
                scene.classList.remove('slg-mode');
            });
            
            // 设置userLocation为天山派地图
            userLocation = 'tianshanpai';
            
            // 切换到地图场景
            switchScene('map');
            document.getElementById('map-scene').classList.add('active');
            
            // 更新按钮显示
            updateSLGReturnButton();
            
            // 刷新NPC位置
            refreshNpcLocations();
            
            // 保存游戏数据
            // await saveGameData();
            
            // // 根据环境处理消息输出
            // if (isInRenderEnvironment()) {
            //     const renderFunc = getRenderFunction();
            //     try {
            //         await renderFunc(`/send at={{lastMessageId}}+1 ${message}`);
            //         await renderFunc('/trigger');
            //         console.log('SLG return message sent:', message);
            //     } catch (error) {
            //         console.error('Error sending message:', error);
            //         showModal(message);
            //     }
            // } else {
            //     showModal(message);
            // }
            await handleMessageOutput(message);
        }

        // 下拉菜单控制
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const allDropdowns = document.querySelectorAll('.dropdown-menu');
            const button = dropdown.previousElementSibling;
            
            // 关闭其他下拉菜单
            allDropdowns.forEach(d => {
                if (d.id !== dropdownId) {
                    d.classList.remove('show');
                    d.previousElementSibling.classList.remove('active');
                }
            });
            
            // 切换当前下拉菜单
            dropdown.classList.toggle('show');
            button.classList.toggle('active');
        }

        // 点击外部关闭下拉菜单
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.dropdown-wrapper')) {
                document.querySelectorAll('.dropdown-menu').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
                document.querySelectorAll('.dropdown-toggle').forEach(button => {
                    button.classList.remove('active');
                });
            }
        });

        // 存档功能
        async function saveGame() {
            // 计算时间信息
            const year = Math.floor((currentWeek - 1) / 48) + 1;
            const remainingWeeks = (currentWeek - 1) % 48;
            const month = Math.floor(remainingWeeks / 4) + 1;
            const week = remainingWeeks % 4 + 1;
            
            // 获取当前地点名称（SLG模式用 mapLocation，否则用 userLocation）
            const locationKey = (GameMode === 1 ? mapLocation : userLocation);
            const locationName = locationNames[locationKey] || locationKey || '未知地点';
            
            // 构建存档名称
            const saveName = `第${year}年第${month}月第${week}周_所在地${locationName}`;
            
            // 调用SillyTavern的checkpoint命令
            if (isInRenderEnvironment()) {
                const renderFunc = getRenderFunction();
                try {
                    await renderFunc(`/checkpoint-create mesId={{LastMessageID}} ${saveName}`);
                    showModal('存档成功！<br>存档名称：' + saveName);
                } catch (error) {
                    console.error('存档失败:', error);
                    showModal('存档失败，请重试');
                }
            } else {
                showModal('当前环境不支持存档功能');
            }
            
            // 关闭下拉菜单
            toggleDropdown('system-dropdown');
        }

        // 读档功能
        async function loadGame() {
            if (isInRenderEnvironment()) {
                const renderFunc = getRenderFunction();
                try {
                    await renderFunc('/chat-manager');
                } catch (error) {
                    console.error('打开聊天管理器失败:', error);
                    showModal('无法打开聊天管理器');
                }
            } else {
                showModal('当前环境不支持读档功能');
            }
            
            // 关闭下拉菜单
            toggleDropdown('system-dropdown');
        }

        /* 打开难度设置 */
        function showDifficultySettings() {
            closeAllSpecialModals();
            const modal = document.getElementById('difficulty-modal');
            document.getElementById(`diff-${difficulty||'normal'}`).checked = true;
            
            // 先显示modal
            modal.style.display = 'block';
            
            // 延迟一帧后调整位置，确保DOM更新完成
            requestAnimationFrame(() => {
                fitModalToViewport(modal);
                bindModalAutoFit(modal);
            });
            
            toggleDropdown('system-dropdown');
        }

        // 保存难度设置
        async function saveDifficulty() {
            const selectedDifficulty = document.querySelector('input[name="difficulty"]:checked').value;
            difficulty = selectedDifficulty;
            
            // 保存到SillyTavern变量
            // await saveGameData();
            
            // 显示确认信息
            const difficultyNames = {
                'easy': '简单',
                'normal': '普通',
                'hard': '困难'
            };
            showModal(`难度已设置为：${difficultyNames[selectedDifficulty]}`);
            
            // 关闭弹窗
            closeDifficultyModal();
        }

        /* 关闭难度设置 */
        function closeDifficultyModal(){
            const modal=document.getElementById('difficulty-modal');
            modal.style.display='none';
            modal._unbindFit && modal._unbindFit();
        }

        // 显示金手指
        function showCheatMode() {
            closeAllSpecialModals();
            // 填充当前数值
            document.getElementById('cheat-gengu').value = playerTalents.根骨;
            document.getElementById('cheat-wuxing').value = playerTalents.悟性;
            document.getElementById('cheat-xinxing').value = playerTalents.心性;
            document.getElementById('cheat-meili').value = playerTalents.魅力;
            
            document.getElementById('cheat-wuxue').value = playerStats.武学;
            document.getElementById('cheat-xueshi').value = playerStats.学识;
            document.getElementById('cheat-shengwang').value = playerStats.声望;
            document.getElementById('cheat-jinqian').value = playerStats.金钱;
            
            document.getElementById('cheat-attack').value = combatStats.攻击力;
            document.getElementById('cheat-hp').value = combatStats.生命值;
            
            document.getElementById('cheat-mood').value = playerMood;
            document.getElementById('cheat-actionpoints').value = actionPoints;
            document.getElementById('cheat-week').value = currentWeek;
            
            // 填充NPC好感度
            document.getElementById('cheat-npc-A').value = npcFavorability.A;
            document.getElementById('cheat-npc-B').value = npcFavorability.B;
            document.getElementById('cheat-npc-C').value = npcFavorability.C;
            document.getElementById('cheat-npc-D').value = npcFavorability.D;
            document.getElementById('cheat-npc-E').value = npcFavorability.E;
            document.getElementById('cheat-npc-F').value = npcFavorability.F;
            document.getElementById('cheat-npc-G').value = npcFavorability.G;
            document.getElementById('cheat-npc-H').value = npcFavorability.H;
            document.getElementById('cheat-npc-I').value = npcFavorability.I;
            document.getElementById('cheat-npc-J').value = npcFavorability.J;
            document.getElementById('cheat-npc-K').value = npcFavorability.K;
            document.getElementById('cheat-npc-L').value = npcFavorability.L;
            // document.getElementById('cheat-npc-Z').value = npcFavorability.Z;  // 占位角色Z - 已注释
            document.getElementById('cheat-npc-M').value = npcFavorability.M;
            document.getElementById('cheat-npc-N').value = npcFavorability.N;
            document.getElementById('cheat-npc-O').value = npcFavorability.O;
            
            const modal = document.getElementById('cheat-modal');
            modal.style.display = 'block';
            
            // 延迟一帧后调整位置
            requestAnimationFrame(() => {
                fitModalToViewport(modal);
                bindModalAutoFit(modal);
            });
            
            toggleDropdown('system-dropdown');
        }

        // 保存金手指数值
        async function saveCheatValues() {
            // 更新天赋属性
            playerTalents.根骨 = parseInt(document.getElementById('cheat-gengu').value);
            playerTalents.悟性 = parseInt(document.getElementById('cheat-wuxing').value);
            playerTalents.心性 = parseInt(document.getElementById('cheat-xinxing').value);
            playerTalents.魅力 = parseInt(document.getElementById('cheat-meili').value);
            
            // 更新人物数值
            playerStats.武学 = parseInt(document.getElementById('cheat-wuxue').value);
            playerStats.学识 = parseInt(document.getElementById('cheat-xueshi').value);
            playerStats.声望 = parseInt(document.getElementById('cheat-shengwang').value);
            playerStats.金钱 = parseInt(document.getElementById('cheat-jinqian').value);
            
            // 更新战斗数值
            combatStats.攻击力 = parseInt(document.getElementById('cheat-attack').value);
            combatStats.生命值 = parseInt(document.getElementById('cheat-hp').value);
            
            // 更新其他数值
            playerMood = parseInt(document.getElementById('cheat-mood').value);
            actionPoints = parseInt(document.getElementById('cheat-actionpoints').value);
            currentWeek = parseInt(document.getElementById('cheat-week').value);
            
            // 更新NPC好感度
            npcFavorability.A = parseInt(document.getElementById('cheat-npc-A').value);
            npcFavorability.B = parseInt(document.getElementById('cheat-npc-B').value);
            npcFavorability.C = parseInt(document.getElementById('cheat-npc-C').value);
            npcFavorability.D = parseInt(document.getElementById('cheat-npc-D').value);
            npcFavorability.E = parseInt(document.getElementById('cheat-npc-E').value);
            npcFavorability.F = parseInt(document.getElementById('cheat-npc-F').value);
            npcFavorability.G = parseInt(document.getElementById('cheat-npc-G').value);
            npcFavorability.H = parseInt(document.getElementById('cheat-npc-H').value);
            npcFavorability.I = parseInt(document.getElementById('cheat-npc-I').value);
            npcFavorability.J = parseInt(document.getElementById('cheat-npc-J').value);
            npcFavorability.K = parseInt(document.getElementById('cheat-npc-K').value);
            npcFavorability.L = parseInt(document.getElementById('cheat-npc-L').value);
            // npcFavorability.Z = parseInt(document.getElementById('cheat-npc-Z').value);  // 占位角色Z - 已注释
            npcFavorability.M = parseInt(document.getElementById('cheat-npc-M').value);
            npcFavorability.N = parseInt(document.getElementById('cheat-npc-N').value);
            npcFavorability.O = parseInt(document.getElementById('cheat-npc-O').value);
            // 检查数值范围
            checkAllValueRanges();
            
            // 更新所有显示
            updateAllDisplays();
            
            // 如果在关系界面，更新关系显示
            const activeScene = document.querySelector('.scene.active');
            if (activeScene && activeScene.id === 'relationships-scene') {
                updateRelationshipsDisplay();
            }
            
            // 保存到SillyTavern
            // await saveGameData();
            
            // 显示确认信息
            showModal('数值已修改并保存！');
            
            // 关闭弹窗
            closeCheatModal();
        }

        // 关闭金手指弹窗
        function closeCheatModal(){
            const modal=document.getElementById('cheat-modal');
            modal.style.display='none';
            modal._unbindFit && modal._unbindFit();
        }

        // 显示背包
        function showInventory() {
            closeAllSpecialModals();
            const grid = document.getElementById('inventory-grid');
            grid.innerHTML = '';
            
            for (const [itemName, quantity] of Object.entries(inventory)) {
                if (quantity > 0) {
                    const itemData = item_list[itemName];
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'inventory-item';
                    itemDiv.onclick = () => showItemDetail(itemName);
                    
                    let icon = '📦';
                    if (itemData) {
                        if (itemData.装备类型 === '武器') icon = '⚔️';
                        else if (itemData.装备类型 === '防具') icon = '🛡️';
                        else if (itemData.装备类型 === '饰品') icon = '💎';
                        else if (itemData.可使用) icon = '🍖';
                    }
                    
                    itemDiv.innerHTML = `
                        <div class="item-icon">${icon}</div>
                        <div class="item-name">${itemName}</div>
                        <div class="item-quantity">×${quantity}</div>
                    `;
                    
                    grid.appendChild(itemDiv);
                }
            }
            
            if (grid.children.length === 0) {
                grid.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">背包空空如也</div>';
            }
            
            const modal = document.getElementById('inventory-modal');
            modal.style.display = 'block';
            
            // 延迟一帧后调整位置
            requestAnimationFrame(() => {
                fitModalToViewport(modal);
                bindModalAutoFit(modal);
            });
            
            toggleDropdown('attribute-dropdown');
        }

        // 显示装备
        function showEquipment() {
            closeAllSpecialModals();
            updateEquipmentSlot('weapon-slot', equipment.武器);
            updateEquipmentSlot('armor-slot', equipment.防具);
            updateEquipmentSlot('accessory1-slot', equipment.饰品1);
            updateEquipmentSlot('accessory2-slot', equipment.饰品2);
            
            // 显示当前装备效果
            const effectDiv = document.getElementById('equipment-effect');
            effectDiv.innerHTML = '';
            
            let hasEffect = false;
            for (const [slot, itemName] of Object.entries(equipment)) {
                if (itemName && item_list[itemName]) {
                    const item = item_list[itemName];
                    effectDiv.innerHTML += `<div class="stat-effect">${itemName}: ${item.装备属性} +${item.装备数值}</div>`;
                    hasEffect = true;
                }
            }
            
            if (!hasEffect) {
                effectDiv.innerHTML = '<div style="color: #999;">暂无装备效果</div>';
            }
            
            const modal = document.getElementById('equipment-modal');
            modal.style.display = 'block';
            
            // 延迟一帧后调整位置
            requestAnimationFrame(() => {
                fitModalToViewport(modal);
                bindModalAutoFit(modal);
            });
            
            toggleDropdown('attribute-dropdown');
        }

        // 关闭弹窗函数
        function closeInventoryModal() {
            const modal = document.getElementById('inventory-modal');
            modal.style.display = 'none';
            modal._unbindFit && modal._unbindFit();
        }

        function closeEquipmentModal() {
            const modal = document.getElementById('equipment-modal');
            modal.style.display = 'none';
            modal._unbindFit && modal._unbindFit();
        }

        // 当前交易类型
        let currentTradingType = 'food';

        // 显示交易界面
        function showTrading(type) {
            closeAllSpecialModals();
            currentTradingType = type;
            
            // 设置商店区域标题
            document.getElementById('shop-title').textContent = type === 'food' ? '伙房食物' : '铁匠铺装备';
            
            // 显示当前金钱
            document.getElementById('trading-money-value').textContent = playerStats.金钱;
            
            // 生成用户可卖物品列表
            const userList = document.getElementById('user-items-list');
            userList.innerHTML = '';
            
            let hasTradeableItems = false;
            for (const [itemName, quantity] of Object.entries(inventory)) {
                if (quantity > 0 && item_list[itemName] && item_list[itemName].可交易) {
                    hasTradeableItems = true;
                    const item = item_list[itemName];
                    
                    const itemRow = document.createElement('div');
                    itemRow.className = 'trading-item-row';
                    
                    itemRow.innerHTML = `
                        <div class="trading-item-info">
                            <div class="trading-item-name">${itemName} × ${quantity}</div>
                            <div class="trading-item-price">售价: ${item.卖出价格}金</div>
                        </div>
                        <button class="trading-btn sell-btn" onclick="sellItem('${itemName}')">卖出</button>
                    `;
                    
                    userList.appendChild(itemRow);
                }
            }
            
            if (!hasTradeableItems) {
                userList.innerHTML = '<div class="trading-empty">没有可交易的物品</div>';
            }
            
            // 生成商店物品列表
            const shopList = document.getElementById('shop-items-list');
            shopList.innerHTML = '';

            let shopItems = [];

            if (type === 'food') {
                // 伙房出售食物
                shopItems = ['胡饼', '桂花糕', '烤羊腿'];
            } else {
                // 铁匠铺出售装备
                shopItems = ['制式铁剑', '精钢长剑', '普通弟子服', '铁环软锁甲'];
            }

            shopItems.forEach(itemName => {
                const item = item_list[itemName];
                if (item && item.可交易) {
                    const itemRow = document.createElement('div');
                    itemRow.className = 'trading-item-row shop-item-row';
                    
                    // 只保留详情按钮，移除购买按钮
                    itemRow.innerHTML = `
                        <div class="trading-item-info">
                            <div class="trading-item-name">${itemName}</div>
                            <div class="trading-item-price">价格: ${item.买入价格}金</div>
                        </div>
                        <button class="trading-btn detail-btn" onclick="showShopItemDetail('${itemName}')">详情</button>
                    `;
                    
                    shopList.appendChild(itemRow);
                }
            });
            
            const modal = document.getElementById('trading-modal');
            modal.style.display = 'block';
            
            // 延迟一帧后调整位置
            requestAnimationFrame(() => {
                fitModalToViewport(modal);
                bindModalAutoFit(modal);
            });
        }

        // 购买物品
        async function buyItem(itemName) {
            const item = item_list[itemName];
            if (!item || playerStats.金钱 < item.买入价格) return;
            
            playerStats.金钱 -= item.买入价格;
            inventory[itemName] = (inventory[itemName] || 0) + 1;
            
            checkAllValueRanges();
            updateAllDisplays();
            // await saveGameData();
            
            // 不显示弹窗，直接刷新交易界面
            showTrading(currentTradingType);
        }

        // 卖出物品（只保留这一个）
        async function sellItem(itemName) {
            const item = item_list[itemName];
            if (!item || !inventory[itemName] || inventory[itemName] <= 0) return;
            
            // 检查是否是已装备的物品
            const isEquipped = Object.values(equipment).includes(itemName);
            if (isEquipped && inventory[itemName] === 1) {
                showModal('该物品已装备，请先卸下装备再卖出！');
                return;
            }
            
            playerStats.金钱 += item.卖出价格;
            inventory[itemName]--;
            if (inventory[itemName] <= 0) {
                delete inventory[itemName];
            }
            
            checkAllValueRanges();
            updateAllDisplays();
            // await saveGameData();
            
            // 不显示弹窗，直接刷新交易界面
            showTrading(currentTradingType);
        }

        // 关闭交易弹窗
        function closeTrading() {
            const modal = document.getElementById('trading-modal');
            modal.style.display = 'none';
            modal._unbindFit && modal._unbindFit();
        }

        // 当前查看的商品
        let currentShopItem = null;

        // 显示商品详情
        function showShopItemDetail(itemName) {
            const item = item_list[itemName];
            if (!item) return;
            
            currentShopItem = itemName;
            
            document.getElementById('shop-item-name').textContent = itemName;
            document.getElementById('shop-item-description').textContent = item.描述;
            document.getElementById('shop-item-price').textContent = item.买入价格 + ' 金';
            
            let infoHTML = '';
            if (item.可装备) {
                infoHTML += `<div class="shop-item-stat"><span class="shop-item-stat-label">装备类型：</span>${item.装备类型}</div>`;
                infoHTML += `<div class="shop-item-stat"><span class="shop-item-stat-label">装备属性：</span>${item.装备属性} +${item.装备数值}</div>`;
            }
            if (item.可使用) {
                infoHTML += `<div class="shop-item-stat"><span class="shop-item-stat-label">使用效果：</span>${getItemEffectText(item)}</div>`;
            }
            document.getElementById('shop-item-info').innerHTML = infoHTML;
            
            // 更新购买按钮状态
            const buyBtn = document.getElementById('shop-buy-btn');
            const canAfford = playerStats.金钱 >= item.买入价格;
            buyBtn.disabled = !canAfford;
            buyBtn.textContent = canAfford ? '购买' : '金钱不足';
            
            const modal = document.getElementById('shop-detail-modal');
            modal.style.display = 'block';
            
            // 将商品详情弹窗定位在交易弹窗的中心
            const tradingModal = document.getElementById('trading-modal');
            const tradingRect = tradingModal.getBoundingClientRect();
            const detailContent = modal.querySelector('.modal-content');
            
            // 设置商品详情弹窗的位置
            detailContent.style.position = 'fixed';
            detailContent.style.left = tradingRect.left + tradingRect.width / 2 + 'px';
            detailContent.style.top = tradingRect.top + tradingRect.height / 2 + 'px';
            detailContent.style.transform = 'translate(-50%, -50%)';
            
            // 确保弹窗不超出交易弹窗的范围
            requestAnimationFrame(() => {
                const detailRect = detailContent.getBoundingClientRect();
                
                // 检查是否超出边界并调整
                if (detailRect.left < tradingRect.left + 20) {
                    detailContent.style.left = (tradingRect.left + 20 + detailRect.width / 2) + 'px';
                }
                if (detailRect.right > tradingRect.right - 20) {
                    detailContent.style.left = (tradingRect.right - 20 - detailRect.width / 2) + 'px';
                }
                if (detailRect.top < tradingRect.top + 20) {
                    detailContent.style.top = (tradingRect.top + 20 + detailRect.height / 2) + 'px';
                }
                if (detailRect.bottom > tradingRect.bottom - 20) {
                    detailContent.style.top = (tradingRect.bottom - 20 - detailRect.height / 2) + 'px';
                }
            });
        }

        // 从详情弹窗购买
        async function buyItemFromDetail() {
            if (!currentShopItem) return;
            
            const item = item_list[currentShopItem];
            if (!item || playerStats.金钱 < item.买入价格) return;
            
            playerStats.金钱 -= item.买入价格;
            inventory[currentShopItem] = (inventory[currentShopItem] || 0) + 1;
            
            checkAllValueRanges();
            updateAllDisplays();
            // await saveGameData();
            
            showModal(`购买了${currentShopItem}！<br>花费: ${item.买入价格}金`);
            
            closeShopDetailModal();
            showTrading(currentTradingType);
        }

        // 关闭商品详情弹窗
        function closeShopDetailModal() {
            document.getElementById('shop-detail-modal').style.display = 'none';
            currentShopItem = null;
        }

        function showLastUserInput() {
            // 关闭下拉菜单
            toggleDropdown('history-dropdown');
            
            // 关闭其他弹窗
            closeAllSpecialModals();
            
            // 创建专门的弹窗（不使用普通的modal）
            const modal = document.createElement('div');
            modal.className = 'modal viewport-overlay';
            modal.id = 'last-input-modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <h3 style="margin-bottom: 20px;">上轮输入内容</h3>
                    <div id="last-input-display" style="
                        background: #f5f5f5;
                        padding: 15px;
                        border-radius: 8px;
                        margin-bottom: 20px;
                        font-size: 14px;
                        line-height: 1.6;
                        max-height: 300px;
                        overflow-y: auto;
                        text-align: left;
                        white-space: pre-wrap;
                        word-break: break-word;
                    ">${lastUserMessage || '暂无历史输入记录'}</div>
                    <textarea id="last-input-edit" style="
                        display: none;
                        width: 100%;
                        min-height: 150px;
                        max-height: 300px;
                        padding: 15px;
                        border-radius: 8px;
                        border: 1px solid #ddd;
                        font-size: 14px;
                        line-height: 1.6;
                        resize: vertical;
                        font-family: inherit;
                        margin-bottom: 20px;
                    ">${lastUserMessage || ''}</textarea>
                    <div class="modal-buttons">
                        <button class="modal-btn" id="edit-input-btn" onclick="toggleEditMode()">编辑</button>
                        <button class="modal-btn" id="save-input-btn" style="display:none;" onclick="saveEditedInput()">保存</button>
                        <button class="modal-btn" id="cancel-edit-btn" style="display:none;" onclick="cancelEdit()">取消编辑</button>
                        <button class="modal-btn cancel" onclick="closeLastInputModal()">关闭</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            // 延迟一帧后调整位置
            requestAnimationFrame(() => {
                fitModalToViewport(modal);
                bindModalAutoFit(modal);
            });
        }

        // 显示汗青集（聊天总结记录）
        async function showHistorySummary() {
            // 关闭下拉菜单
            toggleDropdown('history-dropdown');
            // 关闭其他弹窗
            closeAllSpecialModals();

            const modal = document.getElementById('history-summary-modal');

            // 关键：把汗青集弹窗搬到 body，避免受 #main-viewport 的裁剪/层级影响
            if (modal.parentElement !== document.body) {
                document.body.appendChild(modal);
            }

            // 显示弹窗并填充内容
            modal.style.display = 'block';
            const contentDiv = document.getElementById('history-summary-content');
            const combinedSummary = [(compressSummary ? summary_Week : summary_Backup), summary_Small]
                .filter(s => s && s.trim())
                .join('\n\n');
            contentDiv.textContent = combinedSummary || '暂无聊天总结记录';

            // 一帧后适配尺寸并绑定自动适配
            requestAnimationFrame(() => {
                fitModalToViewport(modal);
                bindModalAutoFit(modal);
            });
        }

        // 关闭汗青集弹窗
        function closeHistorySummaryModal() {
            const modal = document.getElementById('history-summary-modal');
            modal.style.display = 'none';
            modal._unbindFit && modal._unbindFit();
        }

        // 切换编辑模式
        function toggleEditMode() {
            const displayDiv = document.getElementById('last-input-display');
            const editArea = document.getElementById('last-input-edit');
            const editBtn = document.getElementById('edit-input-btn');
            const saveBtn = document.getElementById('save-input-btn');
            const cancelBtn = document.getElementById('cancel-edit-btn');
            
            displayDiv.style.display = 'none';
            editArea.style.display = 'block';
            editBtn.style.display = 'none';
            saveBtn.style.display = 'inline-block';
            cancelBtn.style.display = 'inline-block';
            
            // 自动聚焦并选中文本
            editArea.focus();
            editArea.select();
        }

        // 保存编辑的输入
        async function saveEditedInput() {
            const editArea = document.getElementById('last-input-edit');
            const newMessage = editArea.value.trim();
            
            if (newMessage) {
                // 更新本地变量
                lastUserMessage = newMessage;
                // gameData.lastUserMessage = newMessage;

                // 新增：检查是否是新的一周的消息（新版：年/月/周）
                const newWeekPattern = /^行动选择:新的一周开始了<br>当前第(\d+)年第(\d+)月第(\d+)周$/;
                const match = newMessage.match(newWeekPattern);

                if (match) {
                    newWeek = 1;
                    console.log('检测到新的一周开始，newWeek设置为1');
                } else {
                    newWeek = 0;
                    console.log('非新周消息，newWeek设置为0');
                }
                
                // 保存到SillyTavern变量
                const renderFunc = getRenderFunction();
                if (renderFunc) {
                    await renderFunc(`/setvar key=lastMessage_jxz ${newMessage}`);
                    await renderFunc(`/inject id=10 position=chat depth=0 scan=true role=user ${newMessage}`);
                    await saveLastUserMessage();
                    await saveNewWeek();
                }
                
                showModal('上轮输入内容已更新！');
            }
            
            closeLastInputModal();
        }

        // 取消编辑
        function cancelEdit() {
            const displayDiv = document.getElementById('last-input-display');
            const editArea = document.getElementById('last-input-edit');
            const editBtn = document.getElementById('edit-input-btn');
            const saveBtn = document.getElementById('save-input-btn');
            const cancelBtn = document.getElementById('cancel-edit-btn');
            
            displayDiv.style.display = 'block';
            editArea.style.display = 'none';
            editBtn.style.display = 'inline-block';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            
            // 恢复原始值
            editArea.value = lastUserMessage || '';
        }

        // 关闭上轮输入弹窗
        function closeLastInputModal() {
            const modal = document.getElementById('last-input-modal');
            if (modal) {
                modal.style.display = 'none';
                modal._unbindFit && modal._unbindFit();
                modal.remove();
            }
        }

        // 显示世界地图
        function showWorldMap() {
            const modal = document.getElementById('worldmap-modal');
            const iframe = document.getElementById('worldmap-iframe');
            
            // 准备传递给世界地图的数据
            const params = new URLSearchParams({
                reputation: playerStats.声望,
                mapLocation: mapLocation,
                randomEvent: randomEvent,
                battleEvent: battleEvent,
                companionNPC: JSON.stringify(companionNPC),
                // 传递所有NPC的好感度
                npcFavorability: JSON.stringify(npcFavorability)
            });
            
            // 构建世界地图URL（根据你的实际部署情况调整）
            const gameUrl = `https://Ji-Haitang.github.io/char_card_1/world_map.html?${params.toString()}`;
            // 本地测试时使用：
            // const gameUrl = `world_map.html?${params.toString()}`;
            
            iframe.src = gameUrl;
            modal.style.display = 'block';
        }

        // 添加世界地图弹窗的背景点击关闭事件
        document.getElementById('worldmap-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                if (confirm('确定要关闭世界地图吗？')) {
                    this.style.display = 'none';
                    document.getElementById('worldmap-iframe').src = '';
                }
            }
        });

        // 根据当前开关刷新按钮文案
        // function updateCgToggleLabel() {
        //     const btn = document.getElementById('toggle-cg-btn');
        //     if (btn) btn.textContent = `CG内容（${cgContentEnabled ? '开' : '关'}）`;
        // }
        function updateCgToggleLabel() {
            const btn = document.getElementById('toggle-cg-btn');
            const enabled = (typeof cgContentEnabled !== 'undefined') ? cgContentEnabled : false;
            if (btn) btn.textContent = `CG内容（${enabled ? '开' : '关'}）`;
        }

        // 切换CG内容开关（仅切开关，不改 slgCGOptions）
        async function toggleCgContent() {
            cgContentEnabled = !cgContentEnabled;

            // 立即刷新当前页面展示（关闭时隐藏CG层，开启时显示）
            if (GameMode === 1) {
                updateStoryDisplay();
            }

            // 保存到存档（可选）
            // try { await saveGameData(); } catch (e) {}

            // 更新按钮文案并收起菜单
            updateCgToggleLabel();
            toggleDropdown('system-dropdown');
        }

        // 切换强力总结开关 + 刷新按钮
        function updateCompressSummaryLabel() {
            const btn = document.getElementById('toggle-compress-summary-btn');
            if (btn) btn.textContent = `强力总结（${compressSummary ? '开' : '关'}）`;
        }

        // 切换强力总结开关
        async function toggleCompressSummary() {
            compressSummary = !compressSummary;
            updateCompressSummaryLabel();
        }

        // 打开玩法说明
        function openPlayGuide() {
            window.open('https://rentry.org/how2playJXZ', '_blank');
            toggleDropdown('system-dropdown');
        }

        // 字体设置弹窗
        function showFontSettings(){
            // 关闭下拉
            toggleDropdown('history-dropdown');
            // 若弹窗不存在，按需创建
            let modal = document.getElementById('font-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'font-modal';
                modal.className = 'modal viewport-overlay';
                modal.style.display = 'none';
                modal.innerHTML = '<div class="modal-content" style="max-width: 520px;">\
                    <h3>正文字体大小</h3>\
                    <p>拖动滑动条设置正文字体大小（1~5档）。</p>\
                    <div class="font-range-row" style="display:flex;align-items:center;gap:12px;margin: 12px 0;">\
                        <span>小</span>\
                        <input id="font-range" type="range" min="1" max="5" step="1" value="2" style="flex:1;">\
                        <span>大</span>\
                    </div>\
                    <div class="modal-buttons">\
                        <button class="modal-btn cancel" onclick="closeFontModal()">关闭</button>\
                    </div>\
                </div>';
                document.body.appendChild(modal);
                // 注入灰色主题样式（仅一次）
                if (!document.getElementById('font-range-style')) {
                    const style = document.createElement('style');
                    style.id = 'font-range-style';
                    style.textContent = '\n#font-modal input[type="range"]{ -webkit-appearance: none; width:100%; background: transparent; }\n#font-modal input[type="range"]:focus{ outline: none; }\n#font-modal input[type="range"]::-webkit-slider-runnable-track{ height: 6px; background: #6b6b6b; border-radius: 4px; }\n#font-modal input[type="range"]::-webkit-slider-thumb{ -webkit-appearance: none; width: 16px; height:16px; border-radius:50%; background:#bfbfbf; border:1px solid #eaeaea; margin-top: -5px; box-shadow: 0 1px 2px rgba(0,0,0,0.3); }\n#font-modal input[type="range"]::-moz-range-track{ height:6px; background:#6b6b6b; border-radius:4px; }\n#font-modal input[type="range"]::-moz-range-thumb{ width:16px; height:16px; border-radius:50%; background:#bfbfbf; border:1px solid #eaeaea; box-shadow: 0 1px 2px rgba(0,0,0,0.3); }\n';
                    document.head.appendChild(style);
                }
            }
            const range = document.getElementById('font-range');
            if (!range) { console.warn('font-range 未找到'); return; }
            range.value = (typeof textFontLevel !== 'undefined' && textFontLevel) ? textFontLevel : 2;
            modal.style.display = 'block';
            // 居中到主viewport并绑定自适应
            try {
                requestAnimationFrame(() => {
                    if (typeof fitModalToViewport === 'function') fitModalToViewport(modal);
                    if (typeof bindModalAutoFit === 'function') bindModalAutoFit(modal);
                });
            } catch (e) {}
            // 绑定事件（只绑定一次）
            if (!range._bound){
                range.addEventListener('input', onFontLevelChange);
                range._bound = true;
            }
            applyFontLevel(range.value|0);
        }

        function closeFontModal(){
            const modal = document.getElementById('font-modal');
            modal.style.display = 'none';
            modal._unbindFit && modal._unbindFit();
        }

        function onFontLevelChange(e){
            const lvl = parseInt(e.target.value, 10) || 2;
            applyFontLevel(lvl);
            // 持久化到内存与存档
            textFontLevel = lvl;
            // if (typeof syncGameDataFromVariables === 'function') syncGameDataFromVariables();
            // if (typeof saveGameData === 'function') { try { saveGameData(); } catch(_){} }
        }

        function applyFontLevel(level){
            // 基于基础字号步进：14px为第二档的基准，±2px 步进
            const base = 14; // 当前默认字号
            const delta = (level - 2) * 2; // 每档±2px
            const size = base + delta;
            const story = document.getElementById('story-text');
            if (story) story.style.fontSize = size + 'px';
        }

        // 根据inputEnable控制自由行动输入框、发送按钮、跳过一周按钮和返回天山派按钮
        function updateFreeActionInputState() {
            const inputElement = document.getElementById('free-action-input');
            const sendButton = document.getElementById('free-action-send-btn');
            const skipWeekBtn = document.getElementById('skip-week-btn');
            const slgReturnBtn = document.getElementById('slg-return-btn');
            
            if (inputEnable === 0) {
                // 禁用输入框和按钮
                if (inputElement) {
                    inputElement.disabled = true;
                    inputElement.placeholder = '当前无法输入';
                    inputElement.style.opacity = '0.5';
                    inputElement.style.cursor = 'not-allowed';
                }
                if (sendButton) {
                    sendButton.disabled = true;
                    sendButton.style.opacity = '0.5';
                    sendButton.style.cursor = 'not-allowed';
                }
                // 禁用跳过一周按钮
                if (skipWeekBtn) {
                    skipWeekBtn.disabled = true;
                    skipWeekBtn.style.opacity = '0.5';
                    skipWeekBtn.style.cursor = 'not-allowed';
                }
                // 禁用返回天山派按钮
                if (slgReturnBtn) {
                    slgReturnBtn.disabled = true;
                    slgReturnBtn.style.opacity = '0.5';
                    slgReturnBtn.style.cursor = 'not-allowed';
                }
            } else {
                // 启用输入框和按钮
                if (inputElement) {
                    inputElement.disabled = false;
                    inputElement.placeholder = '输入自由行动内容';
                    inputElement.style.opacity = '1';
                    inputElement.style.cursor = '';
                }
                if (sendButton) {
                    sendButton.disabled = false;
                    sendButton.style.opacity = '1';
                    sendButton.style.cursor = '';
                }
                // 启用跳过一周按钮
                if (skipWeekBtn) {
                    skipWeekBtn.disabled = false;
                    skipWeekBtn.style.opacity = '1';
                    skipWeekBtn.style.cursor = '';
                }
                // 启用返回天山派按钮
                if (slgReturnBtn) {
                    slgReturnBtn.disabled = false;
                    slgReturnBtn.style.opacity = '1';
                    slgReturnBtn.style.cursor = '';
                }
            }
        }

        async function initializeOrSync() {
            await loadOrInitGameData();
            console.log('初始化完成');
            // 初始化：仅在SLG模式渲染加载图层兜底；普通模式移除SLG全局隐藏
            try {
                if (GameMode === 1) {
                    try { document.body.classList.add('slg-global'); } catch (e) {}
                    const viewport = document.getElementById('main-viewport');
                    if (viewport && !viewport.querySelector('.slg-loading-layer')) {
                        const loading = document.createElement('div');
                        loading.className = 'slg-loading-layer';
                        const spinner = document.createElement('div');
                        spinner.className = 'slg-loading-spinner';
                        const text = document.createElement('div');
                        text.className = 'slg-loading-text';
                        text.textContent = '场景加载中';
                        loading.appendChild(spinner);
                        loading.appendChild(text);
                        viewport.insertBefore(loading, viewport.firstChild);
                    }
                } else {
                    try { document.body.classList.remove('slg-global'); } catch (e) {}
                    const viewport = document.getElementById('main-viewport');
                    const old = viewport ? viewport.querySelector('.slg-loading-layer') : null;
                    if (old) old.remove();
                }
            } catch (e) {}
            checkAllValueRanges();

            // 初始化季节
            seasonStatus = calculateSeason(currentWeek);
            
            // 更新场景背景
            updateSceneBackgrounds();
            updateAllDisplays();
            setupLocationEvents();
            if (typeof setupMapHitAreas === 'function') {
                setupMapHitAreas();
            }
            setupMessageListeners();

            if (isInRenderEnvironment()) {
                const refreshBtn = document.querySelector('.refresh-npc-btn');
                if (refreshBtn) {
                    refreshBtn.style.display = 'none';
                }
            }
            
            if (userLocation === 'tianshanpai'){
                // 先移除所有场景的active类
                const scenes = document.querySelectorAll('.scene');
                scenes.forEach(scene => {
                    scene.classList.remove('active');
                });
                // 然后只激活地图场景
                document.getElementById('map-scene').classList.add('active');
                if (typeof setupMapHitAreas === 'function') {
                    setupMapHitAreas();
                }
                //switchScene('map');
            }else{
                switchScene(userLocation);
            }
            // 新增：初始化时更新SLG返回按钮显示
            updateSLGReturnButton();
            updateCgToggleLabel();
            // 初始化完成后应用字体档位
            try { applyFontLevel((typeof textFontLevel !== 'undefined' && textFontLevel) ? textFontLevel : 2); } catch(_){}
            // 初始化时更新自由行动输入框状态
            updateFreeActionInputState();
            /* === 新增 === */
            window.__initDone = true;
            if (window.__pendingTemplateVars) {
                const cached = window.__pendingTemplateVars;
                window.__pendingTemplateVars = null;
                updateTemplateVariables(cached);   // 现在再解析一次，绝不会被 sync 覆盖
            }
        }

        try {
            if (window.parent) {
                const inputElement = window.parent.document.getElementById('send_textarea');
                const sendButton = window.parent.document.getElementById('send_button');
                
                if (inputElement) {
                    inputElement.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            localState.turnUpdateApplied = false;
                        }
                    });
                }
                
                if (sendButton) {
                    sendButton.addEventListener('click', function() {
                        localState.turnUpdateApplied = false;
                    });
                }
            }
        } catch (error) {
        }
        window.showPlayerStats = showPlayerStats;
        window.showRelationships = showRelationships;
        window.skipWeek = skipWeek;
        window.performAction = performAction;
        window.refreshNpcLocations = refreshNpcLocations;
        window.backToMap = backToMap;
        window.closeModal = closeModal;
        window.sendInteraction = sendInteraction;
        window.addAttack = addAttack;
        window.addHP = addHP;
        window.npcAction = npcAction;
        window.goToLocation = goToLocation;
        window.sendFreeAction = sendFreeAction;
        window.startBattle = startBattle;
        window.fleeBattle = fleeBattle;
        window.goToPage = goToPage;
        window.prevPage = prevPage;
        window.nextPage = nextPage;
        window.toggleStoryExpand = toggleStoryExpand;
        window.returnFromSLG = returnFromSLG;
        window.toggleNpcVisibility = toggleNpcVisibility;
        window.giveGift = giveGift;
        window.toggleDropdown = toggleDropdown;
        window.saveGame = saveGame;
        window.loadGame = loadGame;
        window.showDifficultySettings = showDifficultySettings;
        window.saveDifficulty = saveDifficulty;
        window.closeDifficultyModal = closeDifficultyModal;
        window.showCheatMode = showCheatMode;
        window.saveCheatValues = saveCheatValues;
        window.closeCheatModal = closeCheatModal;
        window.showInventory = showInventory;
        window.showEquipment = showEquipment;
        window.closeInventoryModal = closeInventoryModal;
        window.closeEquipmentModal = closeEquipmentModal;
        window.showTrading = showTrading;
        window.buyItem = buyItem;
        window.sellItem = sellItem;
        window.closeTrading = closeTrading;
        window.showShopItemDetail = showShopItemDetail;
        window.buyItemFromDetail = buyItemFromDetail;
        window.closeShopDetailModal = closeShopDetailModal;
        window.showLastUserInput = showLastUserInput;
        window.showHistorySummary = showHistorySummary;
        window.closeHistorySummaryModal = closeHistorySummaryModal;
        window.toggleEditMode = toggleEditMode;
        window.saveEditedInput = saveEditedInput;
        window.cancelEdit = cancelEdit;
        window.closeLastInputModal = closeLastInputModal;
        window.showWorldMap = showWorldMap;
        window.toggleCgContent = toggleCgContent;
        window.toggleCompressSummary = toggleCompressSummary;
        window.showFontSettings = showFontSettings;
        window.openPlayGuide = openPlayGuide;
        window.closeFontModal = closeFontModal;
        // 暴露 updateFreeActionInputState 到全局，供 game-events.js 调用
        window.updateFreeActionInputState = updateFreeActionInputState;
        initializeOrSync();
    });

    // ========== 建筑轮廓与热区（SVG） ==========
    function setupMapHitAreas() {
        try {
            const svg = document.getElementById('map-hit-areas');
            if (!svg) return;

            if (!document.getElementById('map-hit-areas-style')) {
                const style = document.createElement('style');
                style.id = 'map-hit-areas-style';
                style.textContent = `
                    #map-hit-areas { pointer-events: none; }
                    #map-hit-areas polygon {
                        fill: transparent;
                        stroke: rgba(255,255,255,0);
                        stroke-width: 2.5;
                        vector-effect: non-scaling-stroke;
                        pointer-events: all;
                        transition: stroke 120ms, stroke-width 120ms, filter 120ms;
                    }
                    #map-hit-areas polygon:hover,
                    #map-hit-areas polygon.active {
                        stroke: #4ecdc4; /* 与地点弹窗标题同款青色 */
                        fill: transparent;
                        filter: drop-shadow(0 0 6px rgba(78,205,196,0.55)) drop-shadow(0 0 12px rgba(78,205,196,0.35));
                        cursor: pointer;
                    }
                    @media (max-width: 600px) {
                        #map-hit-areas polygon { stroke-width: 1.6; }
                    }
                    .scene.slg-mode #map-hit-areas { pointer-events: none; }
                `;
                document.head.appendChild(style);
            }

            setMapHitAreasViewBox();

            const buildingPolygons = [
                { id: 'yishiting', name: '议事厅', points: '788,236 792,203 807,193 798,184 813,173 821,161 827,152 828,133 823,123 814,118 807,113 818,112 828,107 837,100 844,89 849,81 844,71 850,65 853,74 860,80 868,80 881,83 894,86 908,83 912,76 915,68 921,73 920,80 917,84 920,91 928,97 933,102 943,104 949,106 946,112 941,119 937,125 927,132 924,144 925,152 933,158 941,158 949,158 943,167 940,178 938,188 937,193 949,193 951,196 951,204 950,217 949,223 943,233 940,239 936,249 928,251 920,251 891,251 859,246 844,246 827,242 810,242 798,242 786,242' },
                { id: 'yanwuchang', name: '演武场', points: '776,721 537,630 705,400 876,445 778,714' },
                { id: 'nandizi', name: '男弟子房', points: '911,419 917,385 888,377 917,301 923,294 928,283 940,248 937,239 957,239 963,219 960,207 996,196 998,183 1004,184 1006,196 1031,210 1041,209 1035,219 1037,245 1053,251 1064,248 1063,256 1069,306 1079,309 1070,320 1061,316 1073,404 1079,410 1070,413 1057,407 1047,407 1041,430 1037,439 978,430 918,420' },
                { id: 'nvdizi', name: '女弟子房', points: '649,374 601,362 566,353 549,349 545,317 523,309 543,297 558,284 558,256 545,251 530,242 542,241 555,239 579,217 578,201 585,193 590,201 597,204 620,199 633,184 636,174 642,170 647,177 647,190 662,203 697,213 692,220 682,230 688,256 701,264 716,262 724,261 720,274 708,283 701,288 705,314 691,330 681,342 665,358 653,369' },
                { id: 'cangjingge', name: '藏经阁', points: '220,410 213,368 194,361 213,355 219,346 222,338 202,329 190,323 187,317 202,311 200,307 190,301 205,298 215,291 219,288 218,269 202,262 196,254 209,255 218,251 219,242 210,238 207,232 216,230 222,223 222,213 218,204 207,193 205,184 215,191 225,201 248,193 264,193 286,187 299,183 309,180 312,168 317,173 316,181 315,188 319,199 329,203 341,207 349,210 358,210 346,216 342,225 344,233 349,236 358,233 362,230 358,238 352,245 355,262 364,265 372,265 383,259 384,268 378,281 384,287 393,285 399,285 393,291 386,296 393,303 401,303 407,300 412,296 412,303 413,310 420,320 427,320 435,320 427,327 425,335 422,340 416,346 419,356 419,364 422,368 423,379 425,390 422,395 413,401 404,406 388,416 377,424 367,430 357,430 341,427 331,420 325,416 319,420 312,424 297,424 270,417 248,414 228,410' },
                { id: 'gongtian', name: '公田', points: '247,448 315,476 348,481 377,491 396,492 393,501 268,604 89,524 186,478 245,450' },
                { id: 'tiejiangpu', name: '铁匠铺', points: '1226,691 1219,673 1215,659 1192,657 1179,615 1185,595 1200,591 1192,579 1212,540 1205,529 1212,529 1218,531 1250,524 1255,514 1263,511 1264,523 1264,531 1287,546 1299,576 1309,600 1321,618 1335,639 1345,647 1347,652 1334,653 1325,650 1315,663 1309,675 1302,688 1299,696 1293,702 1279,699 1250,694 1234,692' },
                { id: 'huofang', name: '伙房', points: '879,704 888,639 868,630 869,618 882,618 915,459 909,453 912,449 933,450 954,445 975,433 991,450 1008,461 1030,471 1035,474 1033,478 1027,478 1027,511 1025,546 1027,586 1030,624 1030,653 1038,659 1041,672 1030,679 1012,672 998,731 885,707' },
                { id: 'shanmen', name: '山门', points: '565,725 525,811 501,869 473,914 440,969 424,990 552,993 565,954 586,902 607,841 628,792 644,753 571,729' },
                { id: 'houshan', name: '后山', points: '1457,141 1439,142 1429,149 1412,168 1406,184 1394,201 1387,214 1376,213 1368,228 1363,239 1354,245 1345,242 1342,236 1339,228 1339,219 1329,219 1322,219 1313,223 1310,230 1310,236 1310,245 1305,252 1300,255 1284,290 1274,300 1264,303 1258,317 1247,320 1232,351 1218,375 1199,407 1283,448 1368,450 1458,449 1458,148' },
                { id: 'danfang', name: '丹房', points: '494,579 462,573 438,569 416,563 399,495 374,485 393,478 407,471 417,459 520,381 540,361 543,352 548,352 566,375 584,387 607,393 603,400 608,469 578,501 542,536 500,578' }
            ];

            svg.innerHTML = '';
            buildingPolygons.forEach(b => {
                const p = document.createElementNS('http://www.w3.org/2000/svg','polygon');
                p.setAttribute('points', b.points);
                p.dataset.location = b.id;
                p.addEventListener('click', (e) => {
                    svg.querySelectorAll('polygon.active').forEach(n => n.classList.remove('active'));
                    p.classList.add('active');
                    if (typeof showLocationInfo === 'function') { showLocationInfo(b.id, e); }
                    e.stopPropagation();
                });
                svg.appendChild(p);
            });
        } catch (e) { console.warn(e); }
    }

    function setMapHitAreasViewBox() {
        const svg = document.getElementById('map-hit-areas');
        const vp = document.getElementById('main-viewport');
        if (!svg || !vp) return;
        const rect = vp.getBoundingClientRect();
        const ratio = rect.width / rect.height || 1.46;
        const baseH = 1000;
        const vbW = Math.max(1, Math.round(baseH * ratio));
        svg.setAttribute('viewBox', `0 0 ${vbW} ${baseH}`);
        svg.setAttribute('preserveAspectRatio', 'xMidYMid slice');
        svg.dataset.vbWidth = vbW;
        svg.dataset.vbHeight = baseH;
    }

    (function bindResizeForViewBox(){
        let rafId = null;
        const onResize = () => {
            if (rafId) cancelAnimationFrame(rafId);
            rafId = requestAnimationFrame(() => setMapHitAreasViewBox());
        };
        window.addEventListener('resize', onResize, { passive: true });
    })();

    window.enableMapPointPicker = function enableMapPointPicker() {
        const svg = document.getElementById('map-hit-areas');
        if (!svg) { console.warn('未找到 #map-hit-areas'); return; }
        const ns = 'http://www.w3.org/2000/svg';
        const pt = svg.createSVGPoint();
        const toSvg = (e) => {
            pt.x = e.clientX; pt.y = e.clientY;
            return pt.matrixTransform(svg.getScreenCTM().inverse());
        };

        let points = [];
        let dots = [];
        let guide = svg.querySelector('#__guide_poly');
        if (!guide) {
            guide = document.createElementNS(ns, 'polyline');
            guide.id = '__guide_poly';
            guide.setAttribute('fill', 'rgba(255,255,0,0.12)');
            guide.setAttribute('stroke', '#ffd400');
            guide.setAttribute('stroke-width', '3');
            guide.setAttribute('vector-effect', 'non-scaling-stroke');
            guide.style.pointerEvents = 'none';
            svg.appendChild(guide);
        }

        const redraw = () => { guide.setAttribute('points', points.map(p => `${p.x},${p.y}`).join(' ')); };
        const addDot = (p) => {
            const c = document.createElementNS(ns, 'circle');
            c.setAttribute('cx', p.x); c.setAttribute('cy', p.y); c.setAttribute('r', 6);
            c.setAttribute('fill', '#ffd400'); c.setAttribute('stroke', '#000');
            c.setAttribute('vector-effect', 'non-scaling-stroke');
            c.style.pointerEvents = 'none';
            svg.appendChild(c);
            dots.push(c);
        };

        const onClick = (e) => {
            const p = toSvg(e);
            const np = { x: Math.round(p.x), y: Math.round(p.y) };
            points.push(np); addDot(np); redraw();
        };
        const onKey = (e) => {
            if (e.key === 'z' || e.key === 'Z') { points.pop(); const d = dots.pop(); if (d) d.remove(); redraw(); }
            else if (e.key === 'c' || e.key === 'C') { points = []; dots.forEach(d => d.remove()); dots = []; redraw(); console.log('已清空'); }
            else if (e.key === 'Enter') {
                if (points.length >= 3) { const out = points.map(p => `${p.x},${p.y}`).join(' '); console.log('复制到 buildingPolygons.points：\n', out); }
                else { console.log('至少需要3个点'); }
            }
        };

        const oldPointer = svg.style.pointerEvents;
        svg.style.pointerEvents = 'auto';
        svg.addEventListener('click', onClick);
        window.addEventListener('keydown', onKey);
        console.log('取点器就绪：点击添加点；Z 撤销，C 清空，Enter 输出 points。调用 window.disableMapPointPicker() 退出。');

        window.disableMapPointPicker = function disableMapPointPicker() {
            svg.removeEventListener('click', onClick);
            window.removeEventListener('keydown', onKey);
            svg.style.pointerEvents = oldPointer || '';
            console.log('取点器已关闭');
        };
    };

    (function wrapSwitchScene(){
        const orig = window.switchScene;
        if (typeof orig !== 'function') return;
        window.switchScene = function(sceneName){
            const ret = orig.apply(this, arguments);
            if (sceneName === 'map' && typeof setupMapHitAreas === 'function') {
                setupMapHitAreas();
            }
            return ret;
        };
    })();
    </script>
</body>
</html>
