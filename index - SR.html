<!-- /**
 * index.html 内联函数说明
 * 
 * 这些函数保留在HTML中是为了支持onclick等内联事件调用。
 * 它们主要是对其他模块函数的封装或直接实现。
 * 
 * 主要函数：
 * 
 * - showPlayerStats(): 显示角色属性界面
 *   作用：切换到属性面板场景，显示玩家的各项数值
 * 
 * - showRelationships(): 显示人际关系界面
 *   作用：切换到关系面板场景，显示与各NPC的好感度
 * 
 * - skipWeek(): 跳过当前周
 *   作用：推进游戏时间一周，重置行动点
 * 
 * - performAction(action, location): 执行地点行动
 *   作用：处理玩家在各地点的行动选择，计算结果
 * 
 * - refreshNpcLocations(): 刷新NPC位置
 *   作用：重新随机分配所有NPC的位置
 * 
 * - backToMap(): 返回地图
 *   作用：从其他场景返回主地图界面
 * 
 * - closeModal(): 关闭弹窗
 *   作用：关闭当前显示的模态弹窗
 * 
 * - sendInteraction(): 发送NPC互动
 *   作用：处理玩家输入的NPC互动内容
 * 
 * - addAttack(): 增加攻击力
 *   作用：消耗属性点增加10点攻击力
 * 
 * - addHP(): 增加生命值
 *   作用：消耗属性点增加25点生命值
 * 
 * - npcAction(npcId, action): NPC动作处理
 *   作用：处理对NPC的切磋或互动操作
 * 
 * - goToLocation(locationId): 前往地点
 *   作用：从地图点击前往具体场景
 * 
 * - sendFreeAction(): 发送自由行动
 *   作用：处理玩家输入的自由行动内容
 * 
 * - startBattle(): 发起战斗
 *   作用：开始战斗事件的战斗
 * 
 * - fleeBattle(): 放弃战斗
 *   作用：放弃战斗事件，避开战斗
 */ -->

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>类脑群侠传</title>
    
    <!-- 从GitHub加载CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@8edf6c9/module/game-styles.css">
</head>
<body>
    <div class="container">
        <div class="viewport-wrapper">
            <div class="viewport" id="main-viewport">
                <!-- 悬浮提示框 -->
                <div class="tooltip" id="tooltip"></div>

                <!-- NPC信息弹窗 -->
                <div class="npc-info-popup" id="npc-info-popup"></div>

                <!-- 地点信息弹窗 - 新增 -->
                <div class="location-info-popup" id="location-info-popup"></div>
                <!-- <button class="slg-return-btn" id="slg-return-btn" onclick="returnFromSLG()">返回天山派</button> -->
                <!-- 地图场景 -->
                <div id="map-scene" class="scene active">
                    <div class="status-display">
                        <div class="date-display" id="date-display">第1年第1月第1周</div>
                        <div class="mood-display" id="mood-display">体力: 100</div>
                        <div class="action-points-display" id="action-points-display">行动点: 3</div>
                    </div>
                    <button class="refresh-npc-btn" onclick="refreshNpcLocations()">刷新NPC位置</button>
                    <div class="location" id="yanwuchang"></div>
                    <div class="location" id="cangjingge"></div>
                    <div class="location" id="huofang"></div>
                    <div class="location" id="houshan"></div>
                    <div class="location" id="yishiting"></div>
                    <div class="location" id="tiejiangpu"></div>
                    <div class="location" id="nandizi"></div>
                    <div class="location" id="nvdizi"></div>
                    <div class="location" id="shanmen"></div>
                    <div class="location" id="gongtian"></div>
                    <div class="ink-decoration ink1"></div>
                    <div class="ink-decoration ink2"></div>
                </div>

                <!-- 后续场景保持不变 -->
                <!-- 角色属性场景 -->
                <div id="player-stats-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="stats-container">
                        <div class="stats-group">
                            <h3>天赋属性</h3>
                            <div class="stat-item">
                                <span class="stat-name">根骨</span>
                                <div class="stat-bar">
                                    <div class="stat-fill" id="talent-gengu" style="width: 75%"></div>
                                </div>
                                <span class="stat-value" id="talent-gengu-value">75</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">悟性</span>
                                <div class="stat-bar">
                                    <div class="stat-fill" id="talent-wuxing" style="width: 82%"></div>
                                </div>
                                <span class="stat-value" id="talent-wuxing-value">82</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">心性</span>
                                <div class="stat-bar">
                                    <div class="stat-fill" id="talent-xinxing" style="width: 68%"></div>
                                </div>
                                <span class="stat-value" id="talent-xinxing-value">68</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">魅力</span>
                                <div class="stat-bar">
                                    <div class="stat-fill" id="talent-meili" style="width: 70%"></div>
                                </div>
                                <span class="stat-value" id="talent-meili-value">70</span>
                            </div>
                        </div>
                        
                        <div class="bottom-stats-row">
                            <div class="stats-group">
                                <h3>人物数值</h3>
                                <div class="simple-stat-item">
                                    <span class="simple-stat-name">武学</span>
                                    <span class="simple-stat-value" id="stat-wuxue-value">50</span>
                                </div>
                                <div class="simple-stat-item">
                                    <span class="simple-stat-name">学识</span>
                                    <span class="simple-stat-value" id="stat-xueshi-value">35</span>
                                </div>
                                <div class="simple-stat-item">
                                    <span class="simple-stat-name">声望</span>
                                    <span class="simple-stat-value" id="stat-shengwang-value">20</span>
                                </div>
                                <div class="simple-stat-item">
                                    <span class="simple-stat-name">金钱</span>
                                    <span class="simple-stat-value" id="stat-jinqian-value">100</span>
                                </div>
                            </div>
                            
                            <div class="stats-group">
                                <h3>战斗数值</h3>
                                <div class="simple-stat-item">
                                    <span class="simple-stat-name">攻击力</span>
                                    <div class="point-control">
                                        <span class="simple-stat-value" id="combat-attack-value">20</span>
                                        <button class="add-point-btn" id="add-attack-btn" onclick="addAttack()">+</button>
                                    </div>
                                </div>
                                <div class="simple-stat-item">
                                    <span class="simple-stat-name">生命值</span>
                                    <div class="point-control">
                                        <span class="simple-stat-value" id="combat-hp-value">50</span>
                                        <button class="add-point-btn" id="add-hp-btn" onclick="addHP()">+</button>
                                    </div>
                                </div>
                                <div class="simple-stat-item">
                                    <span class="simple-stat-name">剩余点数</span>
                                    <span class="simple-stat-value" id="remaining-points-value">0</span>
                                </div>
                                <div class="skill-list">
                                    <div class="simple-stat-name" style="margin-bottom: 10px;">已学武功</div>
                                    <div id="learned-skills"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 人际关系场景 -->
                <div id="relationships-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="relationships-container">
                        <div class="relationship-grid" id="relationship-grid">
                            <!-- 动态生成 -->
                        </div>
                    </div>
                </div>

                <!-- 各个场景 -->
                <div id="yanwuchang-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="scene-title">演武场</div>
                    <div class="npc-container" id="yanwuchang-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('练武', 'yanwuchang')">练武</button>
                    </div>
                </div>

                <div id="cangjingge-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="scene-title">藏经阁</div>
                    <div class="npc-container" id="cangjingge-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('学习', 'cangjingge')">学习</button>
                    </div>
                </div>

                <div id="huofang-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="scene-title">伙房</div>
                    <div class="npc-container" id="huofang-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('打杂', 'huofang')">打杂</button>
                        <button class="scene-btn" onclick="showTrading('food')">交易</button>
                    </div>
                </div>

                <div id="houshan-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="scene-title">后山</div>
                    <div class="npc-container" id="houshan-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('秘密赌场', 'houshan')">秘密赌场</button>
                        <button class="scene-btn" onclick="performAction('探索', 'houshan')">探索</button>
                    </div>
                </div>

                <div id="yishiting-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="scene-title">议事厅</div>
                    <div class="npc-container" id="yishiting-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('汇报', 'yishiting')">汇报</button>
                    </div>
                </div>

                <div id="tiejiangpu-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="scene-title">铁匠铺</div>
                    <div class="npc-container" id="tiejiangpu-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('打铁', 'tiejiangpu')">打铁</button>
                        <button class="scene-btn" onclick="showTrading('equipment')">交易</button>
                    </div>
                </div>

                <div id="nandizi-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="scene-title">男弟子房</div>
                    <div class="npc-container" id="nandizi-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('休息', 'nandizi')">休息</button>
                    </div>
                </div>

                <div id="nvdizi-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="scene-title">女弟子房</div>
                    <div class="npc-container" id="nvdizi-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('拜访', 'nvdizi')">拜访</button>
                    </div>
                </div>

                <div id="shanmen-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="scene-title">山门</div>
                    <div class="npc-container" id="shanmen-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" disabled>下山</button>
                        <!-- <button class="scene-btn" onclick="performAction('下山', 'shanmen')">下山</button> -->
                    </div>
                </div>

                <div id="gongtian-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="scene-title">公田</div>
                    <div class="npc-container" id="gongtian-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('耕种', 'gongtian')">耕种</button>
                    </div>
                </div>

                <!-- 弹窗 -->
                <div id="modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-text" id="modal-text">新的一周开始了</div>
                        <div class="modal-buttons" id="modal-buttons">
                            <button class="modal-btn" onclick="closeModal()">确定</button>
                        </div>
                    </div>
                </div>

                <!-- 21点游戏iframe弹窗 - 新增 -->
                <div id="blackjack-modal" class="blackjack-modal">
                    <div class="blackjack-container">
                        <iframe id="blackjack-iframe" class="blackjack-iframe"></iframe>
                    </div>
                </div>

                <!-- 战斗iframe弹窗 -->
                <div id="battle-modal" class="battle-modal">
                    <div class="battle-container">
                        <iframe id="battle-iframe" class="battle-iframe"></iframe>
                    </div>
                </div>

                <!-- 农场游戏iframe弹窗 -->
                <div id="farm-modal" class="farm-modal">
                    <div class="farm-container">
                        <iframe id="farm-iframe" class="farm-iframe"></iframe>
                    </div>
                </div>
            </div>
        </div>
         
        <!-- 中间控制按钮 -->
        <div class="control-buttons">
            <!-- 属性查看下拉菜单 -->
            <div class="dropdown-wrapper">
                <button class="control-btn dropdown-toggle" onclick="toggleDropdown('attribute-dropdown')">
                    属性查看 ▲
                </button>
                <div id="attribute-dropdown" class="dropdown-menu">
                    <button class="dropdown-item" onclick="showPlayerStats()">角色属性</button>
                    <button class="dropdown-item" onclick="showRelationships()">人际关系</button>
                    <button class="dropdown-item" onclick="showInventory()">查看背包</button>
                    <button class="dropdown-item" onclick="showEquipment()">查看装备</button>
                </div>
            </div>
            
            <!-- 系统设置下拉菜单 -->
            <div class="dropdown-wrapper">
                <button class="control-btn dropdown-toggle" onclick="toggleDropdown('system-dropdown')">
                    系统设置 ▲
                </button>
                <div id="system-dropdown" class="dropdown-menu">
                    <button class="dropdown-item" onclick="saveGame()">存档</button>
                    <button class="dropdown-item" onclick="loadGame()">读档</button>
                    <button class="dropdown-item" onclick="showDifficultySettings()">难度设置</button>
                    <button class="dropdown-item" onclick="showCheatMode()">金手指</button>
                </div>
            </div>
            
            <!-- 新增：历史信息下拉菜单 -->
            <div class="dropdown-wrapper">
                <button class="control-btn dropdown-toggle" onclick="toggleDropdown('history-dropdown')">
                    历史信息 ▲
                </button>
                <div id="history-dropdown" class="dropdown-menu">
                    <button class="dropdown-item" onclick="showLastUserInput()">上轮输入</button>
                    <button class="dropdown-item" onclick="showHistorySummary()">历史记录</button>
                </div>
            </div>
            
            <button class="control-btn" id="skip-week-btn" onclick="skipWeek()">跳过这一周</button>
            <button class="control-btn" id="slg-return-btn" onclick="returnFromSLG()" style="display: none;">返回天山派</button>
        </div>

        <!-- 自由行动输入框 -->
        <div class="free-action-container">
            <textarea 
                class="free-action-input" 
                id="free-action-input" 
                placeholder="输入自由行动内容"
                rows="1"
            ></textarea>
            <button class="free-action-send-btn" onclick="sendFreeAction()">发送</button>
        </div>

        <!-- 难度设置弹窗 -->
        <div id="difficulty-modal" class="modal viewport-overlay">
            <div class="modal-content">
                <h3>难度设置</h3>
                <p>选择游戏难度，将影响行动成功率的计算：</p>
                    <label class="difficulty-option">
                        <input type="radio" name="difficulty" value="easy" id="diff-easy">
                        <span class="option-content">
                            <strong>简单模式</strong>
                            <small>体力加成 +20，更容易获得成功<br>好感度变化：上升+2/+4，下降-1/-2</small>
                        </span>
                    </label>
                    <label class="difficulty-option">
                        <input type="radio" name="difficulty" value="normal" id="diff-normal" checked>
                        <span class="option-content">
                            <strong>普通模式</strong>
                            <small>体力加成 +10，平衡的游戏体验<br>好感度变化：大幅±2，普通±1</small>
                        </span>
                    </label>
                    <label class="difficulty-option">
                        <input type="radio" name="difficulty" value="hard" id="diff-hard">
                        <span class="option-content">
                            <strong>困难模式</strong>
                            <small>无体力加成，更具挑战性<br>好感度变化：上升+1/+2，下降-2/-4</small>
                        </span>
                    </label>
                <div class="modal-buttons">
                    <button class="modal-btn" onclick="saveDifficulty()">确认</button>
                    <button class="modal-btn cancel" onclick="closeDifficultyModal()">取消</button>
                </div>
            </div>
        </div>

        <!-- 金手指弹窗 -->
        <div id="cheat-modal" class="modal viewport-overlay">
            <div class="modal-content cheat-content">
                <h3>金手指 - 数值修改</h3>
                <div class="cheat-sections">
                    <!-- 天赋属性 -->
                    <div class="cheat-section">
                        <h4>天赋属性</h4>
                        <div class="cheat-grid">
                            <div class="cheat-item">
                                <label>根骨</label>
                                <input type="number" id="cheat-gengu" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>悟性</label>
                                <input type="number" id="cheat-wuxing" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>心性</label>
                                <input type="number" id="cheat-xinxing" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>魅力</label>
                                <input type="number" id="cheat-meili" min="0" max="100">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 人物数值 -->
                    <div class="cheat-section">
                        <h4>人物数值</h4>
                        <div class="cheat-grid">
                            <div class="cheat-item">
                                <label>武学</label>
                                <input type="number" id="cheat-wuxue" min="0" max="300">
                            </div>
                            <div class="cheat-item">
                                <label>学识</label>
                                <input type="number" id="cheat-xueshi" min="0" max="300">
                            </div>
                            <div class="cheat-item">
                                <label>声望</label>
                                <input type="number" id="cheat-shengwang" min="0" max="300">
                            </div>
                            <div class="cheat-item">
                                <label>金钱</label>
                                <input type="number" id="cheat-jinqian" min="0" max="999999">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 战斗数值 -->
                    <div class="cheat-section">
                        <h4>战斗数值</h4>
                        <div class="cheat-grid">
                            <div class="cheat-item">
                                <label>攻击力</label>
                                <input type="number" id="cheat-attack" min="10" max="300">
                            </div>
                            <div class="cheat-item">
                                <label>生命值</label>
                                <input type="number" id="cheat-hp" min="25" max="600">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 其他数值 -->
                    <div class="cheat-section">
                        <h4>其他数值</h4>
                        <div class="cheat-grid">
                            <div class="cheat-item">
                                <label>体力</label>
                                <input type="number" id="cheat-mood" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>行动点</label>
                                <input type="number" id="cheat-actionpoints" min="0" max="3">
                            </div>
                            <div class="cheat-item">
                                <label>当前周数</label>
                                <input type="number" id="cheat-week" min="1" max="9999">
                            </div>
                        </div>
                    </div>
                    
                    <!-- NPC好感度 -->
                    <div class="cheat-section">
                        <h4>NPC好感度</h4>
                        <div class="cheat-grid npc-grid">
                            <div class="cheat-item">
                                <label>破阵子</label>
                                <input type="number" id="cheat-npc-A" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>洞庭君</label>
                                <input type="number" id="cheat-npc-B" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>钱塘君</label>
                                <input type="number" id="cheat-npc-C" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>萧白瑚</label>
                                <input type="number" id="cheat-npc-D" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>姬姒</label>
                                <input type="number" id="cheat-npc-E" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>施延年</label>
                                <input type="number" id="cheat-npc-F" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>呼延显</label>
                                <input type="number" id="cheat-npc-G" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>雨烛</label>
                                <input type="number" id="cheat-npc-H" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>安慕</label>
                                <input type="number" id="cheat-npc-I" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>唐沐梨</label>
                                <input type="number" id="cheat-npc-J" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>洛潜幽</label>
                                <input type="number" id="cheat-npc-K" min="0" max="100">
                            </div>
                            <div class="cheat-item">
                                <label>神秘杂役</label>
                                <input type="number" id="cheat-npc-L" min="0" max="100">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button class="modal-btn" onclick="saveCheatValues()">保存</button>
                    <button class="modal-btn cancel" onclick="closeCheatModal()">取消</button>
                </div>
            </div>
        </div>

        <!-- 汗青集弹窗 -->
        <div id="history-summary-modal" class="modal viewport-overlay">
            <div class="modal-content" style="max-width: 90%; max-height: 80%; display: flex; flex-direction: column;">
                <h3>汗青集</h3>
                <div id="history-summary-content" style="
                    flex: 1;
                    overflow-y: auto;
                    padding: 20px;
                    background: #f5f5f5;
                    border-radius: 8px;
                    margin: 20px 0;
                    white-space: pre-wrap;
                    line-height: 1.8;
                    font-size: 14px;
                ">
                    载入中...
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeHistorySummaryModal()">关闭</button>
                </div>
            </div>
        </div>

        <!-- 背包弹窗 -->
        <div id="inventory-modal" class="modal viewport-overlay">
            <div class="modal-content inventory-content">
                <h3>背包</h3>
                <div class="inventory-grid" id="inventory-grid">
                    <!-- 动态生成 -->
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeInventoryModal()">关闭</button>
                </div>
            </div>
        </div>

        <!-- 装备弹窗 -->
        <div id="equipment-modal" class="modal viewport-overlay">
            <div class="modal-content equipment-content">
                <h3>装备栏</h3>
                <div class="equipment-slots">
                    <div class="equipment-slot">
                        <div class="slot-label">武器</div>
                        <div class="slot-item" id="weapon-slot">
                            <div class="empty-slot">空</div>
                        </div>
                    </div>
                    <div class="equipment-slot">
                        <div class="slot-label">防具</div>
                        <div class="slot-item" id="armor-slot">
                            <div class="empty-slot">空</div>
                        </div>
                    </div>
                    <div class="equipment-slot">
                        <div class="slot-label">饰品1</div>
                        <div class="slot-item" id="accessory1-slot">
                            <div class="empty-slot">空</div>
                        </div>
                    </div>
                    <div class="equipment-slot">
                        <div class="slot-label">饰品2</div>
                        <div class="slot-item" id="accessory2-slot">
                            <div class="empty-slot">空</div>
                        </div>
                    </div>
                </div>
                <div class="equipment-stats">
                    <h4>当前装备效果</h4>
                    <div id="equipment-effect">
                        <!-- 动态显示装备效果 -->
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeEquipmentModal()">关闭</button>
                </div>
            </div>
        </div>

        <!-- 道具详情弹窗 -->
        <div id="item-detail-modal" class="modal">
            <div class="modal-content item-detail-content">
                <h3 id="item-name"></h3>
                <div class="item-description" id="item-description"></div>
                <div class="item-info" id="item-info"></div>
                <div class="modal-buttons" id="item-actions">
                    <!-- 动态生成操作按钮 -->
                </div>
            </div>
        </div>

        <!-- 交易弹窗 -->
        <div id="trading-modal" class="modal viewport-overlay">
            <div class="modal-content trading-content">
                <div class="trading-header">
                    <h3 id="trading-title">交易</h3>
                    <div class="trading-money">当前金钱: <span id="trading-money-value">0</span></div>
                </div>
                <div class="trading-container">
                    <!-- 左侧：用户物品 -->
                    <div class="trading-section user-items">
                        <h4>我的物品</h4>
                        <div class="trading-list" id="user-items-list">
                            <!-- 动态生成 -->
                        </div>
                    </div>
                    
                    <!-- 分隔线 -->
                    <div class="trading-divider"></div>
                    
                    <!-- 右侧：商店物品 -->
                    <div class="trading-section shop-items">
                        <h4 id="shop-title">商店物品</h4>
                        <div class="trading-list" id="shop-items-list">
                            <!-- 动态生成 -->
                        </div>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeTrading()">关闭</button>
                </div>
            </div>
        </div>

        <!-- 商品详情弹窗 -->
        <div id="shop-detail-modal" class="modal">
            <div class="modal-content shop-detail-content">
                <h3 id="shop-item-name"></h3>
                <div class="shop-item-description" id="shop-item-description"></div>
                <div class="shop-item-info" id="shop-item-info"></div>
                <div class="shop-item-price-info">
                    <div class="price-label">价格：</div>
                    <div class="price-value" id="shop-item-price"></div>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn" id="shop-buy-btn" onclick="buyItemFromDetail()">购买</button>
                    <button class="modal-btn cancel" onclick="closeShopDetailModal()">关闭</button>
                </div>
            </div>
        </div>

        <!-- 故事区域 -->
        <div class="story-area">
            <div class="story-content-wrapper">
                <!-- 页面指示器 -->
                <div class="page-indicator" id="page-indicator"></div>
                
                <!-- 翻页箭头 -->
                <button class="story-nav-btn prev" id="story-prev-btn" onclick="prevPage()">◀</button>
                <button class="story-nav-btn next" id="story-next-btn" onclick="nextPage()">▶</button>
                
                <!-- 故事文本 -->
                <div class="story-text" id="story-text">
                    江湖路远，故事未始...
                </div>
                
                <!-- 展开/收起按钮 -->
                <button class="story-expand-btn" id="story-expand-btn" onclick="toggleStoryExpand()">▼ 展开全文</button>
            </div>
            
            <!-- 随机事件容器 -->
            <div class="random-event-container" id="random-event-container">
                <div class="event-title">随机事件</div>
                <div class="event-description" id="event-description"></div>
                <div class="event-options" id="event-options"></div>
            </div>
            <!-- 战斗事件容器 -->
            <div class="battle-event-container" id="battle-event-container">
                <div class="battle-event-title">战斗事件</div>
                <div class="battle-event-description" id="battle-event-description"></div>
                <div class="battle-enemy-info">
                    <div class="enemy-info-item">
                        <span class="enemy-info-label">敌人：</span>
                        <span id="enemy-name-display"></span>
                    </div>
                    <div class="enemy-info-item">
                        <span class="enemy-info-label">攻击力：</span>
                        <span id="enemy-attack-display"></span>
                    </div>
                    <div class="enemy-info-item">
                        <span class="enemy-info-label">生命力：</span>
                        <span id="enemy-health-display"></span>
                    </div>
                </div>
                <div class="battle-reward">
                    <div class="battle-reward-text" id="battle-reward-text"></div>
                </div>
                <div class="battle-actions">
                    <button class="battle-action-btn fight" onclick="startBattle()">发起战斗</button>
                    <button class="battle-action-btn flee" onclick="fleeBattle()">放弃战斗</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载外部库 -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
    <!-- 从GitHub加载游戏模块 -->
    <script src="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@8edf6c9/module/game-config.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@8edf6c9/module/game-utils.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@8edf6c9/module/game-state.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@8edf6c9/module/game-ui.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@8edf6c9/module/game-helpers.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@8edf6c9/module/game-events.js"></script>
     
    <script>
    document.addEventListener('DOMContentLoaded', function() {  
        // 记录原始渲染环境状态
        window._originalRenderer = {
            hasSTscript: typeof window.STscript === 'function',
            hasTriggerSlash: typeof window.triggerSlash === 'function'
        };
        
        // 兼容层
        window.triggerSlash = window.triggerSlash || window.STscript;
        window.STscript = window.STscript || window.triggerSlash;

        window.updateTemplateVariables = function(vars) {
            if (!vars) return;
            
            /* 1. 如果初始化尚未结束，先把 vars 缓存起来 —— 只保留最后一次 */
            if (!window.__initDone) {
                window.__pendingTemplateVars = vars;
                return;
            }

            let hasUpdate = false;

            // 新增：处理SLG_MODE内容（包括脏标签的情况）
            let slgModeContent = null;

            // 方法1：标准化属性名查找
            for (const key in vars) {
                // 移除所有空格、下划线，并转为大写
                const normalizedKey = key.replace(/[\s_]/g, '').toUpperCase();
                if (normalizedKey === 'SLGMODE') {
                    slgModeContent = vars[key];
                    break;
                }
            }
                
            // 如果找到了SLG_MODE内容（无论标签写法如何）
            if (slgModeContent !== null && slgModeContent !== undefined) {
                // 提取正文：从第一个汉字、# 或 * 开始到第一个<为止
                // 扩展的Unicode范围支持更多中文字符（包括繁体）
                const mainTextMatch = slgModeContent.match(/[#*\u4e00-\u9fff\u3400-\u4dbf...][^<]*/);
                if (mainTextMatch) {
                    const startIndex = slgModeContent.indexOf(mainTextMatch[0]);
                    const endIndex = slgModeContent.indexOf('<', startIndex);
                    const mainText = endIndex > -1 
                        ? slgModeContent.substring(startIndex, endIndex) 
                        : slgModeContent.substring(startIndex);
                    
                    console.log(`成功捕捉到正文（通过汉字/#/*特征）`);
                    console.log(`${startIndex}`);
                    console.log(`${endIndex}`);   
                    localState.currentStoryText = mainText.trim();
                    console.log(`${localState.currentStoryText}`);
                    updateStoryText(localState.currentStoryText);
                }

                // 新增：提取SUMMARY内容
                // const summaryMatch = slgModeContent.match(/<SUMMARY>([\s\S]*?)<\/SUMMARY>/);
                const summaryRegex = /<[\s_]*[Ss][Uu][Mm][Mm][Aa][Rr][Yy][\s_]*>([\s\S]*?)<[\s_]*\/[\s_]*[Ss][Uu][Mm][Mm][Aa][Rr][Yy][\s_]*>/;
                const summaryMatch = slgModeContent.match(summaryRegex);
                if (summaryMatch && summaryMatch[1]) {
                    const summaryContent = summaryMatch[1].trim();
                    console.log('成功捕捉到SUMMARY内容：', summaryContent);
                    
                    // 追加到summary_Small（带时间戳）
                    const year = Math.floor((currentWeek - 1) / 48) + 1;
                    const remainingWeeks = (currentWeek - 1) % 48;
                    const month = Math.floor(remainingWeeks / 4) + 1;
                    const week = remainingWeeks % 4 + 1;
                    
                    const timestamp = `[第${year}年第${month}月第${week}周]`;
                    
                    if (summary_Small) {
                        summary_Small += `\n\n${timestamp}\n${summaryContent}`;
                    } else {
                        summary_Small = `${timestamp}\n${summaryContent}`;
                    }
                    
                    //gameData.summary_Small = summary_Small;
                    console.log('SUMMARY已追加到summary_Small');
                } else {
                    // 如果没有找到SUMMARY标签，尝试更鲁棒的方法
                    // 从第一个{符号往前找汉字，再回溯到>符号
                    const jsonStartIndex = slgModeContent.indexOf('{');
                    if (jsonStartIndex > -1) {
                        // 从{往前搜索，找到可能的SUMMARY结束位置
                        let searchStart = jsonStartIndex - 1;
                        while (searchStart >= 0) {
                            const char = slgModeContent[searchStart];
                            // 检查是否是汉字或其他有意义的字符
                            if (/[\u4e00-\u9fff\u3400-\u4dbf\w]/.test(char)) {
                                // 找到了有意义的字符，现在向前找>符号
                                let summaryStartSearch = searchStart;
                                while (summaryStartSearch >= 0 && slgModeContent[summaryStartSearch] !== '>') {
                                    summaryStartSearch--;
                                }
                                
                                if (summaryStartSearch >= 0) {
                                    // 找到了>符号，提取这段内容
                                    const potentialSummary = slgModeContent.substring(summaryStartSearch + 1, searchStart + 1).trim();
                                    
                                    // 检查是否包含SUMMARY相关内容
                                    if (potentialSummary.length > 0 && !potentialSummary.includes('<MAIN_TEXT>')) {
                                        console.log('通过鲁棒方法捕捉到可能的SUMMARY内容：', potentialSummary);
                                        // 追加到summary_Small
                                        const year = Math.floor((currentWeek - 1) / 48) + 1;
                                        const remainingWeeks = (currentWeek - 1) % 48;
                                        const month = Math.floor(remainingWeeks / 4) + 1;
                                        const week = remainingWeeks % 4 + 1;
                                        
                                        const timestamp = `[第${year}年第${month}月第${week}周]`;
                                        
                                        if (summary_Small) {
                                            summary_Small += `\n\n${timestamp}\n${potentialSummary}`;
                                        } else {
                                            summary_Small = `${timestamp}\n${potentialSummary}`;
                                        }
                                        
                                        // gameData.summary_Small = summary_Small;
                                    }
                                }
                                break;
                            }
                            searchStart--;
                        }
                    }
                }
                
                // 提取JSON：从第一个{开始到下一个<为止（如果没有<则到结尾）
                const jsonStartIndex = slgModeContent.indexOf('{');
                if (jsonStartIndex > -1 && !localState.turnUpdateApplied) {
                    const jsonEndIndex = slgModeContent.indexOf('<', jsonStartIndex);
                    const jsonText = jsonEndIndex > -1 
                        ? slgModeContent.substring(jsonStartIndex, jsonEndIndex)
                        : slgModeContent.substring(jsonStartIndex);
                    
                    try {
                        console.log(`成功捕捉到JSON（通过{特征）`);
                        let llmResponse = jsonText.trim();
                        console.log(`提取的JSON文本：${llmResponse}`);
                        
                        if (typeof llmResponse === 'string') {
                            llmResponse = JSON.parse(llmResponse);
                        }
                        parseLLMResponse(llmResponse, localState.currentStoryText);
                        hasUpdate = true;
                    } catch (error) {
                        console.error('解析SIDE_NOTE失败:', error);
                    }
                }
            }

            if (vars.MAIN_TEXT !== undefined) {
                console.log(`成功捕捉到正文`);
                localState.currentStoryText = vars.MAIN_TEXT;
                updateStoryText(localState.currentStoryText);
                //hasUpdate = true;
            }
            
            console.log(`vars.SIDE_NOTE为：${vars.SIDE_NOTE}`);
            console.log(`localState.turnUpdateApplied为：${localState.turnUpdateApplied}`);
            if (vars.SIDE_NOTE !== undefined && !localState.turnUpdateApplied) {
                try {
                    console.log(`成功捕捉到JSON`);
                    let llmResponse = vars.SIDE_NOTE;
                    if (typeof llmResponse === 'string') {
                        llmResponse = JSON.parse(llmResponse);
                    }
                    parseLLMResponse(llmResponse, localState.currentStoryText);
                    hasUpdate = true;
                } catch (error) {
                    console.error('解析SIDE_NOTE失败:', error);
                }
            }
            
            if (hasUpdate) {
                localState.turnUpdateApplied = true;
            }
        };
        
        // 模板变量
        // const mainText = `$1`;
        // const llmResponse = $2;
        
        // ========== 保留在HTML中的函数（用于onclick调用） ==========
        
        // 修改 showPlayerStats 函数
        function showPlayerStats() {
            // 只有当前场景不是角色属性或人际关系时才记录
            const activeScene = document.querySelector('.scene.active');
            if (activeScene && 
                activeScene.id !== 'player-stats-scene' && 
                activeScene.id !== 'relationships-scene') {
                previousScene = activeScene.id.replace('-scene', '');
                wasInSLGMode = GameMode === 1;
            }
            
            // 清除SLG相关元素
            const viewport = document.getElementById('main-viewport');
            const existingLayers = viewport.querySelectorAll('.slg-layer-container, .slg-layer');
            existingLayers.forEach(layer => layer.remove());
            const existingMask = viewport.querySelector('.slg-interaction-mask');
            if (existingMask) existingMask.remove();
            
            // 先切换场景
            switchScene('player-stats');
            updateStatsDisplay();
            
            // 如果是SLG模式，移除该场景的slg-mode类
            if (GameMode === 1) {
                const statsScene = document.getElementById('player-stats-scene');
                statsScene.classList.remove('slg-mode');
            }
        }

        // 修改 showRelationships 函数
        function showRelationships() {
            // 只有当前场景不是角色属性或人际关系时才记录
            const activeScene = document.querySelector('.scene.active');
            if (activeScene && 
                activeScene.id !== 'player-stats-scene' && 
                activeScene.id !== 'relationships-scene') {
                previousScene = activeScene.id.replace('-scene', '');
                wasInSLGMode = GameMode === 1;
            }
            
            // 清除SLG相关元素
            const viewport = document.getElementById('main-viewport');
            const existingLayers = viewport.querySelectorAll('.slg-layer-container, .slg-layer');
            existingLayers.forEach(layer => layer.remove());
            const existingMask = viewport.querySelector('.slg-interaction-mask');
            if (existingMask) existingMask.remove();
            
            // 先切换场景
            switchScene('relationships');
            updateRelationshipsDisplay();
            
            // 如果是SLG模式，移除该场景的slg-mode类
            if (GameMode === 1) {
                const relScene = document.getElementById('relationships-scene');
                relScene.classList.remove('slg-mode');
            }
        }

        // 切换NPC可见性
        function toggleNpcVisibility(npcId) {
            const checkbox = document.getElementById(`visibility-${npcId}`);
            npcVisibility[npcId] = checkbox.checked;
            
            // 如果NPC被设置为不显示，立即将其位置设为none
            if (!npcVisibility[npcId]) {
                currentNpcLocations[npcId] = 'none';
                
                // 更新对应的位置变量
                switch(npcId) {
                    case 'A': npcLocationA = 'none'; break;
                    case 'B': npcLocationB = 'none'; break;
                    case 'C': npcLocationC = 'none'; break;
                    case 'D': npcLocationD = 'none'; break;
                    case 'E': npcLocationE = 'none'; break;
                    case 'F': npcLocationF = 'none'; break;
                    case 'G': npcLocationG = 'none'; break;
                    case 'H': npcLocationH = 'none'; break;
                    case 'I': npcLocationI = 'none'; break;
                    case 'J': npcLocationJ = 'none'; break;
                    case 'K': npcLocationK = 'none'; break;
                    case 'L': npcLocationL = 'none'; break;
                }
                
                // 如果当前场景有该NPC，更新显示
                const activeScene = document.querySelector('.scene.active');
                if (activeScene && activeScene.id !== 'map-scene') {
                    const locationName = activeScene.id.replace('-scene', '');
                    displayNpcs(locationName);
                }
            }
            
            // 保存游戏数据
            saveGameData();
        }

        // 送礼函数
        async function giveGift(npcId) {
            const npc = npcs[npcId];
            const currentFavorability = npcFavorability[npcId];
            
            // 再次检查条件
            if (npcGiftGiven[npcId]) {
                showModal('本周已经给该NPC送过礼物了！');
                return;
            }
            
            if (currentFavorability > 40) {
                showModal(`${npc.name}的好感度已经超过40，无需再送礼！`);
                return;
            }
            
            if (playerStats.金钱 < 500) {
                showModal('金钱不足500，无法送礼！');
                return;
            }
            
            // 执行送礼
            playerStats.金钱 -= 500;
            npcFavorability[npcId] = Math.min(100, npcFavorability[npcId] + 5);
            npcGiftGiven[npcId] = true;
            
            checkAllValueRanges();
            updateStatsDisplay();
            updateRelationshipsDisplay();
            
            // 发送消息
            const message = `你花费500金钱给${npc.name}送了一份礼物<br>` +
                        `${npc.name}的好感度提升至${npcFavorability[npcId]}`;
            
            await showModal(message);
        }

        // 修改 skipWeek 函数，在跳过周时重置送礼状态
        function skipWeek() {
            showConfirmModal(
                '确认跳过',
                '确定要跳过这一周吗？',
                async () => {
                    currentWeek++;
                    actionPoints = 3;
                    userLocation = "tianshanpai";
                    
                    // 更新季节
                    const newSeason = calculateSeason(currentWeek);
                    if (newSeason !== seasonStatus) {
                        seasonStatus = newSeason;
                        console.log(`季节更新为：${seasonStatus}`);
                    }
                    
                    // 更新场景背景
                    updateSceneBackgrounds();
                    
                    // 重置所有NPC的送礼状态
                    Object.keys(npcGiftGiven).forEach(npcId => {
                        npcGiftGiven[npcId] = false;
                    });
                    
                    // 重置所有NPC的切磋状态
                    Object.keys(npcSparred).forEach(npcId => {
                        npcSparred[npcId] = false;
                    });
                    
                    checkAllValueRanges();
                    updateAllDisplays();
                    refreshNpcLocations();
                    await handleMessageOutput('新的一周开始了<br>当前第' + currentWeek + '周');
                }
            );
        }

        // 执行互动
        async function performAction(action, location) {
            // 新增：如果是SLG模式，不执行任何操作
            if (GameMode === 1) {
                return;
            }
            if (action === '秘密赌场') {
                if (actionPoints < 1) {
                    showModal('行动点不足，无法进行此操作！');
                    return;
                }
                
                let actionPointConsumed = true;
                const mindChance = playerTalents.心性 / 2;
                if (Math.random() * 100 < mindChance) {
                    actionPointConsumed = false;
                } else {
                    actionPoints--;
                }
                checkAllValueRanges();
                updateAllDisplays();
                
                showBlackjackGame();
                
                if (!actionPointConsumed) {
                    window.pendingMindMessage = true;
                }
                return;
            }

            if (action === '耕种') {
                // if (actionPoints < 1) {
                //     showModal('行动点不足，无法进行此操作！');
                //     return;
                // }
                
                // let actionPointConsumed = true;
                // const mindChance = playerTalents.心性 / 2;
                // if (Math.random() * 100 < mindChance) {
                //     actionPointConsumed = false;
                // } else {
                //     actionPoints--;
                // }
                // checkAllValueRanges();
                // updateAllDisplays();
                
                showFarmGame();
                
                if (!actionPointConsumed) {
                    window.pendingMindMessage = true;
                }
                return;
            }

            if (actionPoints < 1) {
                showModal('行动点不足，无法进行此操作！');
                return;
            }

            let actionPointConsumed = true;
            let mindMessageShown = false;
            const mindChance = playerTalents.心性 / 2;
            if (Math.random() * 100 < mindChance) {
                actionPointConsumed = false;
                mindMessageShown = true;
            } else {
                actionPoints--;
            }
            
            const config = actionConfigs[action];
            const talentBonus = playerTalents[config.talentBonus] / 2;
            
            // 根据难度调整成功率计算
            let moodBonus = 10; // 默认普通难度
            
            switch(difficulty) {
                case 'easy':
                    moodBonus = 20;
                    break;
                case 'normal':
                    moodBonus = 10;
                    break;
                case 'hard':
                    moodBonus = 0;
                    break;
            }
            
            const randomRoll = Math.random() * 100;
            const finalValue = (randomRoll + talentBonus) * (playerMood + moodBonus) / 100;

            let successLevel, successText, moodCost;
            let statChange = {};
            
            if (finalValue >= 80) {
                successLevel = '大成功';
                successText = '成果斐然！';
                moodCost = 0;
                if (action === '休息') {
                    const oldMood = playerMood;
                    playerMood = Math.min(100, playerMood + 90);  // 限制最多到100
                    statChange.体力 = '+' + (playerMood - oldMood);  // 显示实际增加值
                } else if (config.affects === '金钱') {
                    statChange[config.affects] = 1000;
                } else if (config.affects === '声望') {
                    statChange[config.affects] = 5;
                } else {
                    statChange[config.affects] = 5;
                }
            } else if (finalValue >= 60) {
                successLevel = '成功';
                successText = '收获颇丰。';
                moodCost = 5;
                if (action === '休息') {
                    const oldMood = playerMood;
                    playerMood = Math.min(100, playerMood + 60);  // 限制最多到100
                    statChange.体力 = '+' + (playerMood - oldMood);  // 显示实际增加值
                } else if (config.affects === '金钱') {
                    statChange[config.affects] = 500;
                } else if (config.affects === '声望') {
                    statChange[config.affects] = 3;
                } else {
                    statChange[config.affects] = 3;
                }
            } else if (finalValue >= 40) {
                successLevel = '一般';
                successText = '平平无奇。';
                moodCost = 10;
                if (action === '休息') {
                    const oldMood = playerMood;
                    playerMood = Math.min(100, playerMood + 45);  // 限制最多到100
                    statChange.体力 = '+' + (playerMood - oldMood);  // 显示实际增加值
                } else if (config.affects === '金钱') {
                    statChange[config.affects] = 100;
                } else if (config.affects === '声望') {
                    statChange[config.affects] = 1;
                } else {
                    statChange[config.affects] = 1;
                }
            } else if (finalValue >= 20) {
                successLevel = '失败';
                successText = '事与愿违...';
                moodCost = 15;
                if (action === '休息') {
                    const oldMood = playerMood;
                    playerMood = Math.min(100, playerMood + 30);  // 限制最多到100
                    statChange.体力 = '+' + (playerMood - oldMood);  // 显示实际增加值
                } else if (config.affects === '金钱') {
                    statChange[config.affects] = -500;
                } else if (config.affects === '声望') {
                    statChange[config.affects] = -2;
                } else {
                    statChange[config.affects] = 0;
                }
            } else {
                successLevel = '大失败';
                successText = '惨不忍睹！';
                moodCost = 20;
                if (action === '休息') {
                    const oldMood = playerMood;
                    playerMood = Math.min(100, playerMood + 30);  // 限制最多到100
                    statChange.体力 = '+' + (playerMood - oldMood);  // 显示实际增加值
                } else if (config.affects === '金钱') {
                    statChange[config.affects] = -1000;
                } else if (config.affects === '声望') {
                    statChange[config.affects] = -5;
                } else {
                    statChange[config.affects] = 0;
                }
            }

            if (config.affects !== '体力') {
                playerStats[config.affects] = Math.max(0, playerStats[config.affects] + statChange[config.affects]);
                if (action !== '休息') {
                    playerMood = Math.max(0, playerMood - moodCost);
                }
            }

            checkAllValueRanges();

            const npcsPresent = getNpcsAtLocation(location).map(npc => npc.name).join('、') || '无';

            let changeText = '';
            Object.entries(statChange).forEach(([key, value]) => {
                changeText += `<br>${key}: ${value > 0 ? '+' : ''}${value}`;
            });
            if (action !== '休息') {
                changeText += `<br>体力: -${moodCost}`;
            }
            
            if (actionPointConsumed) {
                changeText += '<br>行动点: -1';
            } else {
                changeText += '<br>行动点: -0（心性判定成功）';
            }

            // 检查并更新季节（以防某些行动改变了周数）
            const newSeason = calculateSeason(currentWeek);
            if (newSeason !== seasonStatus) {
                seasonStatus = newSeason;
                updateSceneBackgrounds();
            }

            let locationInfo = '';
            if (userLocation === userLocation_old) {
                locationInfo = `地点：${locationNames[location]}<br>`;
            } else {
                const oldLocationName = locationNames[userLocation_old] || userLocation_old;
                const newLocationName = locationNames[userLocation] || locationNames[location];
                locationInfo = `地点：从${oldLocationName}来到${newLocationName}<br>`;
            }

            let resultMessage = `时间：第${Math.floor((currentWeek - 1) / 48) + 1}年第${Math.floor(((currentWeek - 1) % 48) / 4) + 1}月第${((currentWeek - 1) % 4) + 1}周<br>` +
                `季节：${seasonNameMap[seasonStatus] || '冬天'}<br>` +
                locationInfo +  // 使用新的地点信息
                `{{user}}行动选择：${action}<br>` +
                `在场NPC：${npcsPresent}<br>` +
                `选择结果：${successLevel} - ${successText}<br><br>` +
                `属性变化：${changeText}`;

            updateAllDisplays();
            refreshNpcLocations();
            
            await handleMessageOutput(resultMessage);
        }

        // 刷新NPC位置
        function refreshNpcLocations() {
            // 获取用户当前位置（排除特殊场景）
            const currentLocation = userLocation === 'tianshanpai' || 
                                userLocation === 'player-stats' || 
                                userLocation === 'relationships' ? null : userLocation;
            
            // 保存当前位置的NPC
            const npcsAtCurrentLocation = [];
            if (currentLocation) {
                Object.keys(currentNpcLocations).forEach(npcId => {
                    if (currentNpcLocations[npcId] === currentLocation) {
                        npcsAtCurrentLocation.push(npcId);
                    }
                });
            }
            
            const locationCount = {
                yanwuchang: 0,
                cangjingge: 0,
                huofang: 0,
                houshan: 0,
                yishiting: 0,
                tiejiangpu: 0,
                nandizi: 0,
                nvdizi: 0,
                shanmen: 0,
                gongtian: 0
            };
            
            // 如果有当前位置，先统计该位置的NPC数量
            if (currentLocation && locationCount.hasOwnProperty(currentLocation)) {
                locationCount[currentLocation] = npcsAtCurrentLocation.length;
            }

            // 只对不在当前位置的NPC进行重新分配
            const npcsToShuffle = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L'].filter(
                npcId => !npcsAtCurrentLocation.includes(npcId)
            );
            const npcOrder = npcsToShuffle.sort(() => Math.random() - 0.5);

            npcOrder.forEach(npcId => {
                // 新增：检查NPC是否被设置为不显示
                if (!npcVisibility[npcId]) {
                    currentNpcLocations[npcId] = 'none';
                    return;
                }
                
                let assigned = false;
                let attempts = 0;
                const maxAttempts = 20;

                while (!assigned && attempts < maxAttempts) {
                    const location = getRandomLocation(npcId);
                    
                    // 跳过用户当前位置
                    if (currentLocation && location === currentLocation) {
                        attempts++;
                        continue;
                    }
                    
                    if (location === 'none') {
                        currentNpcLocations[npcId] = location;
                        assigned = true;
                    } else if (locationCount[location] < 2) {
                        currentNpcLocations[npcId] = location;
                        locationCount[location]++;
                        assigned = true;
                    }
                    
                    attempts++;
                }

                if (!assigned) {
                    currentNpcLocations[npcId] = 'none';
                }
            });

            // 更新各个NPC的位置变量
            npcLocationA = currentNpcLocations.A;
            npcLocationB = currentNpcLocations.B;
            npcLocationC = currentNpcLocations.C;
            npcLocationD = currentNpcLocations.D;
            npcLocationE = currentNpcLocations.E;
            npcLocationF = currentNpcLocations.F;
            npcLocationG = currentNpcLocations.G;
            npcLocationH = currentNpcLocations.H;
            npcLocationI = currentNpcLocations.I;
            npcLocationJ = currentNpcLocations.J;
            npcLocationK = currentNpcLocations.K;
            npcLocationL = currentNpcLocations.L;
            
            const activeScene = document.querySelector('.scene.active');
            if (activeScene && activeScene.id !== 'map-scene') {
                const locationName = activeScene.id.replace('-scene', '');
                displayNpcs(locationName);
            }
        }

        // 修改 backToMap 函数
        function backToMap() {
            // 移除返回按钮的偏移类
            const backBtns = document.querySelectorAll('.back-btn.slg-mode-offset');
            backBtns.forEach(btn => btn.classList.remove('slg-mode-offset'));
            
            // 获取当前场景
            const activeScene = document.querySelector('.scene.active');
            const currentSceneId = activeScene ? activeScene.id : '';
            
            // 如果是从角色属性或人际关系界面返回，且之前在SLG模式
            if ((currentSceneId === 'player-stats-scene' || currentSceneId === 'relationships-scene') 
                && wasInSLGMode && GameMode === 1) {
                
                // 直接返回到之前的SLG场景
                switchScene(previousScene);
                
                // 如果不是地图场景，添加slg-mode类
                if (previousScene !== 'map') {
                    const targetScene = document.getElementById(previousScene + '-scene');
                    if (targetScene) {
                        targetScene.classList.add('slg-mode');
                    }
                }
                
                // 恢复SLG显示
                updateStoryDisplay();
                
                // 重置状态
                wasInSLGMode = false;
            } else {
                // 普通模式：返回地图
                const scenes = document.querySelectorAll('.scene');
                scenes.forEach(scene => {
                    scene.classList.remove('active');
                });

                document.getElementById('map-scene').classList.add('active');
                userLocation = 'tianshanpai';
            }
        }

        // 关闭弹窗
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // 发送互动内容
        async function sendInteraction() {
            const interactionContent = document.getElementById('interaction-input').value.trim();
            
            if (!interactionContent) {
                alert('请输入互动内容！');
                return;
            }
            
            const activeScene = document.querySelector('.scene.active');
            const location = activeScene.id.replace('-scene', '');
            
            const npc = npcs[currentInteractionNpc];
            const npcsPresent = getNpcsAtLocation(location).map(npc => npc.name).join('、') || '无';
            
            let locationInfo = '';
            if (userLocation === userLocation_old) {
                locationInfo = `地点：${locationNames[location]}<br>`;
            } else {
                const oldLocationName = locationNames[userLocation_old] || userLocation_old;
                const newLocationName = locationNames[userLocation] || locationNames[location];
                locationInfo = `地点：从${oldLocationName}来到${newLocationName}<br>`;
            }

            const resultMessage = `时间：第${Math.floor((currentWeek - 1) / 48) + 1}年第${Math.floor(((currentWeek - 1) % 48) / 4) + 1}月第${((currentWeek - 1) % 4) + 1}周<br>` +
                `季节：${seasonNameMap[seasonStatus] || '冬天'}<br>` +
                locationInfo +  // 使用新的地点信息
                `{{user}}行动选择：NPC互动<br>` +
                `&nbsp;&nbsp;&nbsp;&nbsp;互动对象：${npc.name}<br>` +
                `&nbsp;&nbsp;&nbsp;&nbsp;互动内容：<span class="interaction-content">${interactionContent}</span><br>` +
                `在场NPC：${npcsPresent}`;
            
            closeModal();
            
            currentInteractionNpc = null;
            currentInteractionLocation = null;
            
            await handleMessageOutput(resultMessage);
        }

        // 增加攻击力
        function addAttack() {
            const remainingPoints = calculateRemainingPoints();
            if (remainingPoints > 0) {
                showConfirmModal(
                    '确认加点',
                    '消耗1点分配点数，增加10点攻击力？',
                    () => {
                        combatStats.攻击力 += 10;
                        checkAllValueRanges();
                        updateStatsDisplay();
                        setTimeout(() => {
                            showModal(`攻击力提升至 ${combatStats.攻击力}`);
                        }, 100);
                    }
                );
            }
        }

        // 增加生命值
        function addHP() {
            const remainingPoints = calculateRemainingPoints();
            if (remainingPoints > 0) {
                showConfirmModal(
                    '确认加点',
                    '消耗1点分配点数，增加25点生命值？',
                    () => {
                        combatStats.生命值 += 25;
                        checkAllValueRanges();
                        updateStatsDisplay();
                        setTimeout(() => {
                            showModal(`生命值提升至 ${combatStats.生命值}`);
                        }, 100);
                    }
                );
            }
        }

        // NPC动作
        function npcAction(npcId, action) {
            const popup = document.getElementById('npc-info-popup');
            popup.classList.remove('show');
            document.removeEventListener('click', closeNpcInfo);
            
            if (action === '互动') {
                const activeScene = document.querySelector('.scene.active');
                const location = activeScene.id.replace('-scene', '');
                showInteractionInput(npcId, location);
            } else if (action === '切磋') {
                // 检查是否本周已经切磋过
                if (npcSparred[npcId]) {
                    showModal('本周已经和该NPC切磋过了！');
                    return;
                }
                
                const npc = npcs[npcId];
                currentBattleType = 'npc';
                currentBattleNpcName = npc.name;
                currentBattleNpcId = npcId;  // 新增：记录NPC ID
                
                const battleData = {
                    player: {
                        name: '你',
                        attack: combatStats.攻击力,
                        health: combatStats.生命值
                    },
                    enemy: {
                        name: npc.name,
                        maxHealth: '中',
                        basicDamage: '中'
                    }
                };
                
                showBattleGame(battleData);
            }
        }

        // 前往地点
        function goToLocation(locationId) {
            // 新增：如果是SLG模式，不允许切换场景
            if (GameMode === 1) {
                return;
            }
            
            const popup = document.getElementById('location-info-popup');
            popup.classList.remove('show');
            document.removeEventListener('click', closeLocationInfo);
            
            userLocation = locationId;
            switchScene(locationId);
        }

        // 发送自由行动
        async function sendFreeAction() {
            const inputElement = document.getElementById('free-action-input');
            const actionContent = inputElement.value.trim();
            
            const year = Math.floor((currentWeek - 1) / 48) + 1;
            const remainingWeeks = (currentWeek - 1) % 48;
            const month = Math.floor(remainingWeeks / 4) + 1;
            const week = remainingWeeks % 4 + 1;

            if (!actionContent) {
                alert('请输入自由行动内容！');
                return;
            }
            
            const activeScene = document.querySelector('.scene.active');
            let currentLocation = '';
            
            const npcsPresent = getNpcsAtLocation(userLocation).map(npc => npc.name).join('、') || '无';
            
            let locationInfo = '';
            if (activeScene.id === 'map-scene') {
                // 地图场景特殊处理
                if (userLocation === userLocation_old) {
                    locationInfo = `地点：天山派（地图）<br>`;
                } else {
                    const oldLocationName = locationNames[userLocation_old] || userLocation_old;
                    locationInfo = `地点：从${oldLocationName}来到天山派（地图）<br>`;
                }
            } else {
                const sceneName = activeScene.id.replace('-scene', '');
                const currentLocationName = locationNames[sceneName] || sceneName;
                
                if (userLocation === userLocation_old) {
                    locationInfo = `地点：${currentLocationName}<br>`;
                } else {
                    const oldLocationName = locationNames[userLocation_old] || userLocation_old;
                    locationInfo = `地点：从${oldLocationName}来到${currentLocationName}<br>`;
                }
            }

            const resultMessage = `时间：第${year}年第${month}月第${week}周<br>` +
                `季节：${seasonNameMap[seasonStatus] || '冬天'}<br>` +
                locationInfo +  // 使用新的地点信息
                `{{user}}自由行动："${actionContent}"<br>` +
                `在场NPC：${npcsPresent}`;
            
            inputElement.value = '';
            inputElement.style.height = 'auto';
            
            await handleMessageOutput(resultMessage);
        }

        // 发起战斗
        function startBattle() {
            if (!currentBattleEvent || !currentBattleEvent.敌方信息) return;
            
            const enemyInfo = currentBattleEvent.敌方信息;
            currentBattleType = 'event';
            
            const battleData = {
                player: {
                    name: '你',
                    attack: combatStats.攻击力,
                    health: combatStats.生命值
                },
                enemy: {
                    name: enemyInfo.名称,
                    maxHealth: enemyInfo.属性?.生命力 || '中',
                    basicDamage: enemyInfo.属性?.攻击力 || '中'
                }
            };
            
            showBattleGame(battleData);
        }

        // 放弃战斗
        async function fleeBattle() {
            if (!currentBattleEvent) return;
            
            const resultMessage = currentBattleEvent.事件描述 + '<br><br>你选择避开了战斗';
            
            hideBattleEvent();
            
            await handleMessageOutput(resultMessage);
        }
        
        // ========== 初始化 ==========
        // window.onload = async function() {
        //     //await loadOrInitGameData();
        //     checkAllValueRanges();
        //     updateAllDisplays();
        //     setupLocationEvents();
        //     setupMessageListeners();
            
        //     if (isInRenderEnvironment()) {
        //         const refreshBtn = document.querySelector('.refresh-npc-btn');
        //         if (refreshBtn) {
        //             refreshBtn.style.display = 'none';
        //         }
        //     }
            
        //     if (userLocation === 'tianshanpai') {
        //         document.getElementById('map-scene').classList.add('active');
        //     } else {
        //         switchScene(userLocation);
        //     }
            
        //     // parseLLMResponse(llmResponse, mainText);
        // };
        
        // 自由行动输入框事件
        document.getElementById('free-action-input').addEventListener('input', function() {
            this.style.height = 'auto';
            const scrollHeight = this.scrollHeight;
            this.style.height = Math.min(scrollHeight, 120) + 'px';
        });
        
        document.getElementById('free-action-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendFreeAction();
            }
        });
        
        // 弹窗背景点击事件
        document.getElementById('blackjack-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                const iframe = document.getElementById('blackjack-iframe');
                try {
                    iframe.contentWindow.postMessage({ type: 'close-game' }, '*');
                } catch(e) {
                    this.style.display = 'none';
                    iframe.src = '';
                }
            }
        });
        
        document.getElementById('battle-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                if (confirm('确定要退出战斗吗？')) {
                    this.style.display = 'none';
                    document.getElementById('battle-iframe').src = '';
                    
                    if (currentBattleType === 'event') {
                        hideBattleEvent();
                    }
                    
                    currentBattleType = null;
                    currentBattleReward = null;
                }
            }
        });

        document.getElementById('farm-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                if (confirm('确定要退出农场吗？')) {
                    this.style.display = 'none';
                    document.getElementById('farm-iframe').src = '';
                }
            }
        });

        // 翻页相关函数（调用game-ui.js中的实际实现）
        function goToPage(pageNum) {
            if (typeof doGoToPage === 'function') {
                doGoToPage(pageNum);
            }
        }

        function prevPage() {
            if (typeof doPrevPage === 'function') {
                doPrevPage();
            }
        }

        function nextPage() {
            if (typeof doNextPage === 'function') {
                doNextPage();
            }
        }

        function toggleStoryExpand() {
            if (typeof doToggleStoryExpand === 'function') {
                doToggleStoryExpand();
            }
        }

        // 从SLG模式返回
        async function returnFromSLG() {
            const message = '你结束了山下的游历，回到了天山派';
            
            // 重置游戏模式
            GameMode = 0;
            slgModeData = [];
            
            // 清除SLG图层
            const viewport = document.getElementById('main-viewport');
            const existingLayers = viewport.querySelectorAll('.slg-layer');
            existingLayers.forEach(layer => layer.remove());
            const existingMask = viewport.querySelector('.slg-interaction-mask');
            if (existingMask) existingMask.remove();
            
            // 移除场景的SLG模式标记
            const scenes = document.querySelectorAll('.scene');
            scenes.forEach(scene => {
                scene.classList.remove('slg-mode');
            });
            
            // 设置userLocation为天山派地图
            userLocation = 'tianshanpai';
            
            // 切换到地图场景
            switchScene('map');
            document.getElementById('map-scene').classList.add('active');
            
            // 更新按钮显示
            updateSLGReturnButton();
            
            // 刷新NPC位置
            refreshNpcLocations();
            
            // 保存游戏数据
            // await saveGameData();
            
            // // 根据环境处理消息输出
            // if (isInRenderEnvironment()) {
            //     const renderFunc = getRenderFunction();
            //     try {
            //         await renderFunc(`/send at={{lastMessageId}}+1 ${message}`);
            //         await renderFunc('/trigger');
            //         console.log('SLG return message sent:', message);
            //     } catch (error) {
            //         console.error('Error sending message:', error);
            //         showModal(message);
            //     }
            // } else {
            //     showModal(message);
            // }
            await handleMessageOutput(message);
        }

        // 下拉菜单控制
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const allDropdowns = document.querySelectorAll('.dropdown-menu');
            const button = dropdown.previousElementSibling;
            
            // 关闭其他下拉菜单
            allDropdowns.forEach(d => {
                if (d.id !== dropdownId) {
                    d.classList.remove('show');
                    d.previousElementSibling.classList.remove('active');
                }
            });
            
            // 切换当前下拉菜单
            dropdown.classList.toggle('show');
            button.classList.toggle('active');
        }

        // 点击外部关闭下拉菜单
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.dropdown-wrapper')) {
                document.querySelectorAll('.dropdown-menu').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
                document.querySelectorAll('.dropdown-toggle').forEach(button => {
                    button.classList.remove('active');
                });
            }
        });

        // 存档功能
        async function saveGame() {
            // 计算时间信息
            const year = Math.floor((currentWeek - 1) / 48) + 1;
            const remainingWeeks = (currentWeek - 1) % 48;
            const month = Math.floor(remainingWeeks / 4) + 1;
            const week = remainingWeeks % 4 + 1;
            
            // 获取当前地点名称
            const locationName = locationNames[userLocation] || '未知地点';
            
            // 构建存档名称
            const saveName = `第${year}年第${month}月第${week}周_所在地${locationName}`;
            
            // 调用SillyTavern的checkpoint命令
            if (isInRenderEnvironment()) {
                const renderFunc = getRenderFunction();
                try {
                    await renderFunc(`/checkpoint-create mesId={{LastMessageID}} ${saveName}`);
                    showModal('存档成功！<br>存档名称：' + saveName);
                } catch (error) {
                    console.error('存档失败:', error);
                    showModal('存档失败，请重试');
                }
            } else {
                showModal('当前环境不支持存档功能');
            }
            
            // 关闭下拉菜单
            toggleDropdown('system-dropdown');
        }

        // 读档功能
        async function loadGame() {
            if (isInRenderEnvironment()) {
                const renderFunc = getRenderFunction();
                try {
                    await renderFunc('/chat-manager');
                } catch (error) {
                    console.error('打开聊天管理器失败:', error);
                    showModal('无法打开聊天管理器');
                }
            } else {
                showModal('当前环境不支持读档功能');
            }
            
            // 关闭下拉菜单
            toggleDropdown('system-dropdown');
        }

        /* 打开难度设置 */
        function showDifficultySettings() {
            closeAllSpecialModals();
            const modal = document.getElementById('difficulty-modal');
            document.getElementById(`diff-${difficulty||'normal'}`).checked = true;
            
            // 先显示modal
            modal.style.display = 'block';
            
            // 延迟一帧后调整位置，确保DOM更新完成
            requestAnimationFrame(() => {
                fitModalToViewport(modal);
                bindModalAutoFit(modal);
            });
            
            toggleDropdown('system-dropdown');
        }

        // 保存难度设置
        async function saveDifficulty() {
            const selectedDifficulty = document.querySelector('input[name="difficulty"]:checked').value;
            difficulty = selectedDifficulty;
            
            // 保存到SillyTavern变量
            await saveGameData();
            
            // 显示确认信息
            const difficultyNames = {
                'easy': '简单',
                'normal': '普通',
                'hard': '困难'
            };
            showModal(`难度已设置为：${difficultyNames[selectedDifficulty]}`);
            
            // 关闭弹窗
            closeDifficultyModal();
        }

        /* 关闭难度设置 */
        function closeDifficultyModal(){
            const modal=document.getElementById('difficulty-modal');
            modal.style.display='none';
            modal._unbindFit && modal._unbindFit();
        }

        // 显示金手指
        function showCheatMode() {
            closeAllSpecialModals();
            // 填充当前数值
            document.getElementById('cheat-gengu').value = playerTalents.根骨;
            document.getElementById('cheat-wuxing').value = playerTalents.悟性;
            document.getElementById('cheat-xinxing').value = playerTalents.心性;
            document.getElementById('cheat-meili').value = playerTalents.魅力;
            
            document.getElementById('cheat-wuxue').value = playerStats.武学;
            document.getElementById('cheat-xueshi').value = playerStats.学识;
            document.getElementById('cheat-shengwang').value = playerStats.声望;
            document.getElementById('cheat-jinqian').value = playerStats.金钱;
            
            document.getElementById('cheat-attack').value = combatStats.攻击力;
            document.getElementById('cheat-hp').value = combatStats.生命值;
            
            document.getElementById('cheat-mood').value = playerMood;
            document.getElementById('cheat-actionpoints').value = actionPoints;
            document.getElementById('cheat-week').value = currentWeek;
            
            // 填充NPC好感度
            document.getElementById('cheat-npc-A').value = npcFavorability.A;
            document.getElementById('cheat-npc-B').value = npcFavorability.B;
            document.getElementById('cheat-npc-C').value = npcFavorability.C;
            document.getElementById('cheat-npc-D').value = npcFavorability.D;
            document.getElementById('cheat-npc-E').value = npcFavorability.E;
            document.getElementById('cheat-npc-F').value = npcFavorability.F;
            document.getElementById('cheat-npc-G').value = npcFavorability.G;
            document.getElementById('cheat-npc-H').value = npcFavorability.H;
            document.getElementById('cheat-npc-I').value = npcFavorability.I;
            document.getElementById('cheat-npc-J').value = npcFavorability.J;
            document.getElementById('cheat-npc-K').value = npcFavorability.K;
            document.getElementById('cheat-npc-L').value = npcFavorability.L;
            
            const modal = document.getElementById('cheat-modal');
            modal.style.display = 'block';
            
            // 延迟一帧后调整位置
            requestAnimationFrame(() => {
                fitModalToViewport(modal);
                bindModalAutoFit(modal);
            });
            
            toggleDropdown('system-dropdown');
        }

        // 保存金手指数值
        async function saveCheatValues() {
            // 更新天赋属性
            playerTalents.根骨 = parseInt(document.getElementById('cheat-gengu').value);
            playerTalents.悟性 = parseInt(document.getElementById('cheat-wuxing').value);
            playerTalents.心性 = parseInt(document.getElementById('cheat-xinxing').value);
            playerTalents.魅力 = parseInt(document.getElementById('cheat-meili').value);
            
            // 更新人物数值
            playerStats.武学 = parseInt(document.getElementById('cheat-wuxue').value);
            playerStats.学识 = parseInt(document.getElementById('cheat-xueshi').value);
            playerStats.声望 = parseInt(document.getElementById('cheat-shengwang').value);
            playerStats.金钱 = parseInt(document.getElementById('cheat-jinqian').value);
            
            // 更新战斗数值
            combatStats.攻击力 = parseInt(document.getElementById('cheat-attack').value);
            combatStats.生命值 = parseInt(document.getElementById('cheat-hp').value);
            
            // 更新其他数值
            playerMood = parseInt(document.getElementById('cheat-mood').value);
            actionPoints = parseInt(document.getElementById('cheat-actionpoints').value);
            currentWeek = parseInt(document.getElementById('cheat-week').value);
            
            // 更新NPC好感度
            npcFavorability.A = parseInt(document.getElementById('cheat-npc-A').value);
            npcFavorability.B = parseInt(document.getElementById('cheat-npc-B').value);
            npcFavorability.C = parseInt(document.getElementById('cheat-npc-C').value);
            npcFavorability.D = parseInt(document.getElementById('cheat-npc-D').value);
            npcFavorability.E = parseInt(document.getElementById('cheat-npc-E').value);
            npcFavorability.F = parseInt(document.getElementById('cheat-npc-F').value);
            npcFavorability.G = parseInt(document.getElementById('cheat-npc-G').value);
            npcFavorability.H = parseInt(document.getElementById('cheat-npc-H').value);
            npcFavorability.I = parseInt(document.getElementById('cheat-npc-I').value);
            npcFavorability.J = parseInt(document.getElementById('cheat-npc-J').value);
            npcFavorability.K = parseInt(document.getElementById('cheat-npc-K').value);
            npcFavorability.L = parseInt(document.getElementById('cheat-npc-L').value);
            
            // 检查数值范围
            checkAllValueRanges();
            
            // 更新所有显示
            updateAllDisplays();
            
            // 如果在关系界面，更新关系显示
            const activeScene = document.querySelector('.scene.active');
            if (activeScene && activeScene.id === 'relationships-scene') {
                updateRelationshipsDisplay();
            }
            
            // 保存到SillyTavern
            await saveGameData();
            
            // 显示确认信息
            showModal('数值已修改并保存！');
            
            // 关闭弹窗
            closeCheatModal();
        }

        // 关闭金手指弹窗
        function closeCheatModal(){
            const modal=document.getElementById('cheat-modal');
            modal.style.display='none';
            modal._unbindFit && modal._unbindFit();
        }

        // 显示背包
        function showInventory() {
            closeAllSpecialModals();
            const grid = document.getElementById('inventory-grid');
            grid.innerHTML = '';
            
            for (const [itemName, quantity] of Object.entries(inventory)) {
                if (quantity > 0) {
                    const itemData = item_list[itemName];
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'inventory-item';
                    itemDiv.onclick = () => showItemDetail(itemName);
                    
                    let icon = '📦';
                    if (itemData) {
                        if (itemData.装备类型 === '武器') icon = '⚔️';
                        else if (itemData.装备类型 === '防具') icon = '🛡️';
                        else if (itemData.装备类型 === '饰品') icon = '💎';
                        else if (itemData.可使用) icon = '🍖';
                    }
                    
                    itemDiv.innerHTML = `
                        <div class="item-icon">${icon}</div>
                        <div class="item-name">${itemName}</div>
                        <div class="item-quantity">×${quantity}</div>
                    `;
                    
                    grid.appendChild(itemDiv);
                }
            }
            
            if (grid.children.length === 0) {
                grid.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">背包空空如也</div>';
            }
            
            const modal = document.getElementById('inventory-modal');
            modal.style.display = 'block';
            
            // 延迟一帧后调整位置
            requestAnimationFrame(() => {
                fitModalToViewport(modal);
                bindModalAutoFit(modal);
            });
            
            toggleDropdown('attribute-dropdown');
        }

        // 显示装备
        function showEquipment() {
            closeAllSpecialModals();
            updateEquipmentSlot('weapon-slot', equipment.武器);
            updateEquipmentSlot('armor-slot', equipment.防具);
            updateEquipmentSlot('accessory1-slot', equipment.饰品1);
            updateEquipmentSlot('accessory2-slot', equipment.饰品2);
            
            // 显示当前装备效果
            const effectDiv = document.getElementById('equipment-effect');
            effectDiv.innerHTML = '';
            
            let hasEffect = false;
            for (const [slot, itemName] of Object.entries(equipment)) {
                if (itemName && item_list[itemName]) {
                    const item = item_list[itemName];
                    effectDiv.innerHTML += `<div class="stat-effect">${itemName}: ${item.装备属性} +${item.装备数值}</div>`;
                    hasEffect = true;
                }
            }
            
            if (!hasEffect) {
                effectDiv.innerHTML = '<div style="color: #999;">暂无装备效果</div>';
            }
            
            const modal = document.getElementById('equipment-modal');
            modal.style.display = 'block';
            
            // 延迟一帧后调整位置
            requestAnimationFrame(() => {
                fitModalToViewport(modal);
                bindModalAutoFit(modal);
            });
            
            toggleDropdown('attribute-dropdown');
        }

        // 关闭弹窗函数
        function closeInventoryModal() {
            const modal = document.getElementById('inventory-modal');
            modal.style.display = 'none';
            modal._unbindFit && modal._unbindFit();
        }

        function closeEquipmentModal() {
            const modal = document.getElementById('equipment-modal');
            modal.style.display = 'none';
            modal._unbindFit && modal._unbindFit();
        }

        // 当前交易类型
        let currentTradingType = 'food';

        // 显示交易界面
        function showTrading(type) {
            closeAllSpecialModals();
            currentTradingType = type;
            
            // 设置标题
            const title = type === 'food' ? '伙房交易' : '铁匠铺交易';
            document.getElementById('trading-title').textContent = title;
            document.getElementById('shop-title').textContent = type === 'food' ? '伙房食物' : '铁匠铺装备';
            
            // 显示当前金钱
            document.getElementById('trading-money-value').textContent = playerStats.金钱;
            
            // 生成用户可卖物品列表
            const userList = document.getElementById('user-items-list');
            userList.innerHTML = '';
            
            let hasTradeableItems = false;
            for (const [itemName, quantity] of Object.entries(inventory)) {
                if (quantity > 0 && item_list[itemName] && item_list[itemName].可交易) {
                    hasTradeableItems = true;
                    const item = item_list[itemName];
                    
                    const itemRow = document.createElement('div');
                    itemRow.className = 'trading-item-row';
                    
                    itemRow.innerHTML = `
                        <div class="trading-item-info">
                            <div class="trading-item-name">${itemName} × ${quantity}</div>
                            <div class="trading-item-price">售价: ${item.卖出价格}金</div>
                        </div>
                        <button class="trading-btn sell-btn" onclick="sellItem('${itemName}')">卖出</button>
                    `;
                    
                    userList.appendChild(itemRow);
                }
            }
            
            if (!hasTradeableItems) {
                userList.innerHTML = '<div class="trading-empty">没有可交易的物品</div>';
            }
            
            // 生成商店物品列表
            const shopList = document.getElementById('shop-items-list');
            shopList.innerHTML = '';

            let shopItems = [];

            if (type === 'food') {
                // 伙房出售食物
                shopItems = ['胡饼', '桂花糕', '烤羊腿'];
            } else {
                // 铁匠铺出售装备
                shopItems = ['制式铁剑', '精钢长剑', '普通弟子服', '铁环软锁甲'];
            }

            shopItems.forEach(itemName => {
                const item = item_list[itemName];
                if (item && item.可交易) {
                    const itemRow = document.createElement('div');
                    itemRow.className = 'trading-item-row shop-item-row';
                    
                    // 只保留详情按钮，移除购买按钮
                    itemRow.innerHTML = `
                        <div class="trading-item-info">
                            <div class="trading-item-name">${itemName}</div>
                            <div class="trading-item-price">价格: ${item.买入价格}金</div>
                        </div>
                        <button class="trading-btn detail-btn" onclick="showShopItemDetail('${itemName}')">详情</button>
                    `;
                    
                    shopList.appendChild(itemRow);
                }
            });
            
            const modal = document.getElementById('trading-modal');
            modal.style.display = 'block';
            
            // 延迟一帧后调整位置
            requestAnimationFrame(() => {
                fitModalToViewport(modal);
                bindModalAutoFit(modal);
            });
        }

        // 购买物品
        async function buyItem(itemName) {
            const item = item_list[itemName];
            if (!item || playerStats.金钱 < item.买入价格) return;
            
            playerStats.金钱 -= item.买入价格;
            inventory[itemName] = (inventory[itemName] || 0) + 1;
            
            checkAllValueRanges();
            updateAllDisplays();
            await saveGameData();
            
            // 不显示弹窗，直接刷新交易界面
            showTrading(currentTradingType);
        }

        // 卖出物品（只保留这一个）
        async function sellItem(itemName) {
            const item = item_list[itemName];
            if (!item || !inventory[itemName] || inventory[itemName] <= 0) return;
            
            // 检查是否是已装备的物品
            const isEquipped = Object.values(equipment).includes(itemName);
            if (isEquipped && inventory[itemName] === 1) {
                showModal('该物品已装备，请先卸下装备再卖出！');
                return;
            }
            
            playerStats.金钱 += item.卖出价格;
            inventory[itemName]--;
            if (inventory[itemName] <= 0) {
                delete inventory[itemName];
            }
            
            checkAllValueRanges();
            updateAllDisplays();
            await saveGameData();
            
            // 不显示弹窗，直接刷新交易界面
            showTrading(currentTradingType);
        }

        // 关闭交易弹窗
        function closeTrading() {
            const modal = document.getElementById('trading-modal');
            modal.style.display = 'none';
            modal._unbindFit && modal._unbindFit();
        }

        // 当前查看的商品
        let currentShopItem = null;

        // 显示商品详情
        function showShopItemDetail(itemName) {
            const item = item_list[itemName];
            if (!item) return;
            
            currentShopItem = itemName;
            
            document.getElementById('shop-item-name').textContent = itemName;
            document.getElementById('shop-item-description').textContent = item.描述;
            document.getElementById('shop-item-price').textContent = item.买入价格 + ' 金';
            
            let infoHTML = '';
            if (item.可装备) {
                infoHTML += `<div class="shop-item-stat"><span class="shop-item-stat-label">装备类型：</span>${item.装备类型}</div>`;
                infoHTML += `<div class="shop-item-stat"><span class="shop-item-stat-label">装备属性：</span>${item.装备属性} +${item.装备数值}</div>`;
            }
            if (item.可使用) {
                infoHTML += `<div class="shop-item-stat"><span class="shop-item-stat-label">使用效果：</span>${getItemEffectText(item)}</div>`;
            }
            document.getElementById('shop-item-info').innerHTML = infoHTML;
            
            // 更新购买按钮状态
            const buyBtn = document.getElementById('shop-buy-btn');
            const canAfford = playerStats.金钱 >= item.买入价格;
            buyBtn.disabled = !canAfford;
            buyBtn.textContent = canAfford ? '购买' : '金钱不足';
            
            const modal = document.getElementById('shop-detail-modal');
            modal.style.display = 'block';
            
            // 将商品详情弹窗定位在交易弹窗的中心
            const tradingModal = document.getElementById('trading-modal');
            const tradingRect = tradingModal.getBoundingClientRect();
            const detailContent = modal.querySelector('.modal-content');
            
            // 设置商品详情弹窗的位置
            detailContent.style.position = 'fixed';
            detailContent.style.left = tradingRect.left + tradingRect.width / 2 + 'px';
            detailContent.style.top = tradingRect.top + tradingRect.height / 2 + 'px';
            detailContent.style.transform = 'translate(-50%, -50%)';
            
            // 确保弹窗不超出交易弹窗的范围
            requestAnimationFrame(() => {
                const detailRect = detailContent.getBoundingClientRect();
                
                // 检查是否超出边界并调整
                if (detailRect.left < tradingRect.left + 20) {
                    detailContent.style.left = (tradingRect.left + 20 + detailRect.width / 2) + 'px';
                }
                if (detailRect.right > tradingRect.right - 20) {
                    detailContent.style.left = (tradingRect.right - 20 - detailRect.width / 2) + 'px';
                }
                if (detailRect.top < tradingRect.top + 20) {
                    detailContent.style.top = (tradingRect.top + 20 + detailRect.height / 2) + 'px';
                }
                if (detailRect.bottom > tradingRect.bottom - 20) {
                    detailContent.style.top = (tradingRect.bottom - 20 - detailRect.height / 2) + 'px';
                }
            });
        }

        // 从详情弹窗购买
        async function buyItemFromDetail() {
            if (!currentShopItem) return;
            
            const item = item_list[currentShopItem];
            if (!item || playerStats.金钱 < item.买入价格) return;
            
            playerStats.金钱 -= item.买入价格;
            inventory[currentShopItem] = (inventory[currentShopItem] || 0) + 1;
            
            checkAllValueRanges();
            updateAllDisplays();
            await saveGameData();
            
            showModal(`购买了${currentShopItem}！<br>花费: ${item.买入价格}金`);
            
            closeShopDetailModal();
            showTrading(currentTradingType);
        }

        // 关闭商品详情弹窗
        function closeShopDetailModal() {
            document.getElementById('shop-detail-modal').style.display = 'none';
            currentShopItem = null;
        }

        function showLastUserInput() {
            // 关闭下拉菜单
            toggleDropdown('history-dropdown');
            
            // 获取储存的消息
            const lastMessage = gameData.lastUserMessage || '暂无历史输入记录';
            
            // 构建HTML内容
            const htmlContent = `
                <h3 style="margin-bottom: 20px;">上轮输入内容</h3>
                <div style="
                    background: #f5f5f5;
                    padding: 15px;
                    border-radius: 8px;
                    margin-bottom: 20px;
                    font-size: 14px;
                    line-height: 1.6;
                    max-height: 400px;
                    overflow-y: auto;
                    text-align: left;
                    white-space: pre-wrap;
                    word-break: break-word;
                ">${lastMessage}</div>
            `;
            
            // 复用showModal显示内容
            showModal(htmlContent);
        }

        // 显示汗青集（聊天总结记录）
        async function showHistorySummary() {
            // 关闭下拉菜单
            toggleDropdown('history-dropdown');
            
            // 关闭其他弹窗
            closeAllSpecialModals();
            
            // 显示弹窗
            const modal = document.getElementById('history-summary-modal');
            modal.style.display = 'block';
            
            // 获取并显示总结内容
            const contentDiv = document.getElementById('history-summary-content');
            
            // 直接从summary_Small读取内容
            if (summary_Small && summary_Small.trim()) {
                contentDiv.textContent = gameData.summary_Small;
            } else {
                contentDiv.textContent = '暂无聊天总结记录';
            }
            
            // 延迟一帧后调整位置
            requestAnimationFrame(() => {
                fitModalToViewport(modal);
                bindModalAutoFit(modal);
            });
        }

        // 关闭汗青集弹窗
        function closeHistorySummaryModal() {
            const modal = document.getElementById('history-summary-modal');
            modal.style.display = 'none';
            modal._unbindFit && modal._unbindFit();
        }

        async function initializeOrSync() {
            await loadOrInitGameData();
            console.log('初始化完成');
            checkAllValueRanges();

            // 初始化季节
            seasonStatus = calculateSeason(currentWeek);
            
            // 更新场景背景
            updateSceneBackgrounds();
            updateAllDisplays();
            setupLocationEvents();

            if (isInRenderEnvironment()) {
                const refreshBtn = document.querySelector('.refresh-npc-btn');
                if (refreshBtn) {
                    refreshBtn.style.display = 'none';
                }
            }
            
            if (userLocation === 'tianshanpai'){
                // 先移除所有场景的active类
                const scenes = document.querySelectorAll('.scene');
                scenes.forEach(scene => {
                    scene.classList.remove('active');
                });
                // 然后只激活地图场景
                document.getElementById('map-scene').classList.add('active');
                //switchScene('map');
            }else{
                switchScene(userLocation);
            }
            // 新增：初始化时更新SLG返回按钮显示
            updateSLGReturnButton();
            /* === 新增 === */
            window.__initDone = true;
            if (window.__pendingTemplateVars) {
                const cached = window.__pendingTemplateVars;
                window.__pendingTemplateVars = null;
                updateTemplateVariables(cached);   // 现在再解析一次，绝不会被 sync 覆盖
            }
        }

        try {
            if (window.parent) {
                const inputElement = window.parent.document.getElementById('send_textarea');
                const sendButton = window.parent.document.getElementById('send_button');
                
                if (inputElement) {
                    inputElement.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            localState.turnUpdateApplied = false;
                        }
                    });
                }
                
                if (sendButton) {
                    sendButton.addEventListener('click', function() {
                        localState.turnUpdateApplied = false;
                    });
                }
            }
        } catch (error) {
        }
        window.showPlayerStats = showPlayerStats;
        window.showRelationships = showRelationships;
        window.skipWeek = skipWeek;
        window.performAction = performAction;
        window.refreshNpcLocations = refreshNpcLocations;
        window.backToMap = backToMap;
        window.closeModal = closeModal;
        window.sendInteraction = sendInteraction;
        window.addAttack = addAttack;
        window.addHP = addHP;
        window.npcAction = npcAction;
        window.goToLocation = goToLocation;
        window.sendFreeAction = sendFreeAction;
        window.startBattle = startBattle;
        window.fleeBattle = fleeBattle;
        window.goToPage = goToPage;
        window.prevPage = prevPage;
        window.nextPage = nextPage;
        window.toggleStoryExpand = toggleStoryExpand;
        window.returnFromSLG = returnFromSLG;
        window.toggleNpcVisibility = toggleNpcVisibility;
        window.giveGift = giveGift;
        window.toggleDropdown = toggleDropdown;
        window.saveGame = saveGame;
        window.loadGame = loadGame;
        window.showDifficultySettings = showDifficultySettings;
        window.saveDifficulty = saveDifficulty;
        window.closeDifficultyModal = closeDifficultyModal;
        window.showCheatMode = showCheatMode;
        window.saveCheatValues = saveCheatValues;
        window.closeCheatModal = closeCheatModal;
        window.showInventory = showInventory;
        window.showEquipment = showEquipment;
        window.closeInventoryModal = closeInventoryModal;
        window.closeEquipmentModal = closeEquipmentModal;
        window.showTrading = showTrading;
        window.buyItem = buyItem;
        window.sellItem = sellItem;
        window.closeTrading = closeTrading;
        window.showShopItemDetail = showShopItemDetail;
        window.buyItemFromDetail = buyItemFromDetail;
        window.closeShopDetailModal = closeShopDetailModal;
        window.showLastUserInput = showLastUserInput;
        window.showHistorySummary = showHistorySummary;
        window.closeHistorySummaryModal = closeHistorySummaryModal;
        initializeOrSync();
    });
    </script>
</body>
</html>
