<!-- /**
 * index.html 内联函数说明
 * 
 * 这些函数保留在HTML中是为了支持onclick等内联事件调用。
 * 它们主要是对其他模块函数的封装或直接实现。
 * 
 * 主要函数：
 * 
 * - showPlayerStats(): 显示角色属性界面
 *   作用：切换到属性面板场景，显示玩家的各项数值
 * 
 * - showRelationships(): 显示人际关系界面
 *   作用：切换到关系面板场景，显示与各NPC的好感度
 * 
 * - skipWeek(): 跳过当前周
 *   作用：推进游戏时间一周，重置行动点
 * 
 * - performAction(action, location): 执行地点行动
 *   作用：处理玩家在各地点的行动选择，计算结果
 * 
 * - refreshNpcLocations(): 刷新NPC位置
 *   作用：重新随机分配所有NPC的位置
 * 
 * - backToMap(): 返回地图
 *   作用：从其他场景返回主地图界面
 * 
 * - closeModal(): 关闭弹窗
 *   作用：关闭当前显示的模态弹窗
 * 
 * - sendInteraction(): 发送NPC互动
 *   作用：处理玩家输入的NPC互动内容
 * 
 * - addAttack(): 增加攻击力
 *   作用：消耗属性点增加10点攻击力
 * 
 * - addHP(): 增加生命值
 *   作用：消耗属性点增加25点生命值
 * 
 * - npcAction(npcId, action): NPC动作处理
 *   作用：处理对NPC的切磋或互动操作
 * 
 * - goToLocation(locationId): 前往地点
 *   作用：从地图点击前往具体场景
 * 
 * - sendFreeAction(): 发送自由行动
 *   作用：处理玩家输入的自由行动内容
 * 
 * - startBattle(): 发起战斗
 *   作用：开始战斗事件的战斗
 * 
 * - fleeBattle(): 放弃战斗
 *   作用：放弃战斗事件，避开战斗
 */ -->

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>类脑群侠传</title>
    
    <!-- 从GitHub加载CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/module/game-styles.css">
    <!-- <link rel="stylesheet" href="module/game-styles.css"> -->
</head>
<body>
    <div class="container">
        <div class="viewport-wrapper">
            <div class="viewport" id="main-viewport">
                <!-- 悬浮提示框 -->
                <div class="tooltip" id="tooltip"></div>

                <!-- NPC信息弹窗 -->
                <div class="npc-info-popup" id="npc-info-popup"></div>

                <!-- 地点信息弹窗 - 新增 -->
                <div class="location-info-popup" id="location-info-popup"></div>
                <!-- <button class="slg-return-btn" id="slg-return-btn" onclick="returnFromSLG()">返回天山派</button> -->
                <!-- 地图场景 -->
                <div id="map-scene" class="scene active">
                    <div class="status-display">
                        <div class="date-display" id="date-display">第1年第1月第1周</div>
                        <div class="mood-display" id="mood-display">心情: 100</div>
                        <div class="action-points-display" id="action-points-display">行动点: 3</div>
                    </div>
                    <button class="refresh-npc-btn" onclick="refreshNpcLocations()">刷新NPC位置</button>
                    <div class="location" id="yanwuchang"></div>
                    <div class="location" id="cangjingge"></div>
                    <div class="location" id="huofang"></div>
                    <div class="location" id="houshan"></div>
                    <div class="location" id="yishiting"></div>
                    <div class="location" id="tiejiangpu"></div>
                    <div class="location" id="nandizi"></div>
                    <div class="location" id="nvdizi"></div>
                    <div class="location" id="shanmen"></div>
                    <div class="ink-decoration ink1"></div>
                    <div class="ink-decoration ink2"></div>
                </div>

                <!-- 后续场景保持不变 -->
                <!-- 角色属性场景 -->
                <div id="player-stats-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="stats-container">
                        <div class="stats-group">
                            <h3>天赋属性</h3>
                            <div class="stat-item">
                                <span class="stat-name">根骨</span>
                                <div class="stat-bar">
                                    <div class="stat-fill" id="talent-gengu" style="width: 75%"></div>
                                </div>
                                <span class="stat-value" id="talent-gengu-value">75</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">悟性</span>
                                <div class="stat-bar">
                                    <div class="stat-fill" id="talent-wuxing" style="width: 82%"></div>
                                </div>
                                <span class="stat-value" id="talent-wuxing-value">82</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">心性</span>
                                <div class="stat-bar">
                                    <div class="stat-fill" id="talent-xinxing" style="width: 68%"></div>
                                </div>
                                <span class="stat-value" id="talent-xinxing-value">68</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">魅力</span>
                                <div class="stat-bar">
                                    <div class="stat-fill" id="talent-meili" style="width: 70%"></div>
                                </div>
                                <span class="stat-value" id="talent-meili-value">70</span>
                            </div>
                        </div>
                        
                        <div class="bottom-stats-row">
                            <div class="stats-group">
                                <h3>人物数值</h3>
                                <div class="simple-stat-item">
                                    <span class="simple-stat-name">武学</span>
                                    <span class="simple-stat-value" id="stat-wuxue-value">50</span>
                                </div>
                                <div class="simple-stat-item">
                                    <span class="simple-stat-name">学识</span>
                                    <span class="simple-stat-value" id="stat-xueshi-value">35</span>
                                </div>
                                <div class="simple-stat-item">
                                    <span class="simple-stat-name">声望</span>
                                    <span class="simple-stat-value" id="stat-shengwang-value">20</span>
                                </div>
                                <div class="simple-stat-item">
                                    <span class="simple-stat-name">金钱</span>
                                    <span class="simple-stat-value" id="stat-jinqian-value">100</span>
                                </div>
                            </div>
                            
                            <div class="stats-group">
                                <h3>战斗数值</h3>
                                <div class="simple-stat-item">
                                    <span class="simple-stat-name">攻击力</span>
                                    <div class="point-control">
                                        <span class="simple-stat-value" id="combat-attack-value">20</span>
                                        <button class="add-point-btn" id="add-attack-btn" onclick="addAttack()">+</button>
                                    </div>
                                </div>
                                <div class="simple-stat-item">
                                    <span class="simple-stat-name">生命值</span>
                                    <div class="point-control">
                                        <span class="simple-stat-value" id="combat-hp-value">50</span>
                                        <button class="add-point-btn" id="add-hp-btn" onclick="addHP()">+</button>
                                    </div>
                                </div>
                                <div class="simple-stat-item">
                                    <span class="simple-stat-name">剩余点数</span>
                                    <span class="simple-stat-value" id="remaining-points-value">0</span>
                                </div>
                                <div class="skill-list">
                                    <div class="simple-stat-name" style="margin-bottom: 10px;">已学武功</div>
                                    <div id="learned-skills"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 人际关系场景 -->
                <div id="relationships-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <div class="relationships-container">
                        <div class="relationship-grid" id="relationship-grid">
                            <!-- 动态生成 -->
                        </div>
                    </div>
                </div>

                <!-- 各个场景 -->
                <div id="yanwuchang-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <button class="refresh-npc-btn scene-refresh-btn" onclick="refreshNpcLocations()">刷新NPC位置</button>
                    <div class="scene-title">演武场</div>
                    <div class="npc-container" id="yanwuchang-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('练武', 'yanwuchang')">练武</button>
                    </div>
                </div>

                <div id="cangjingge-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <button class="refresh-npc-btn scene-refresh-btn" onclick="refreshNpcLocations()">刷新NPC位置</button>
                    <div class="scene-title">藏经阁</div>
                    <div class="npc-container" id="cangjingge-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('学习', 'cangjingge')">学习</button>
                    </div>
                </div>

                <div id="huofang-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <button class="refresh-npc-btn scene-refresh-btn" onclick="refreshNpcLocations()">刷新NPC位置</button>
                    <div class="scene-title">伙房</div>
                    <div class="npc-container" id="huofang-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('打杂', 'huofang')">打杂</button>
                    </div>
                </div>

                <div id="houshan-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <button class="refresh-npc-btn scene-refresh-btn" onclick="refreshNpcLocations()">刷新NPC位置</button>
                    <div class="scene-title">后山</div>
                    <div class="npc-container" id="houshan-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('秘密赌场', 'houshan')">秘密赌场</button>
                        <button class="scene-btn" onclick="performAction('探索', 'houshan')">探索</button>
                    </div>
                </div>

                <div id="yishiting-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <button class="refresh-npc-btn scene-refresh-btn" onclick="refreshNpcLocations()">刷新NPC位置</button>
                    <div class="scene-title">议事厅</div>
                    <div class="npc-container" id="yishiting-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('汇报', 'yishiting')">汇报</button>
                    </div>
                </div>

                <div id="tiejiangpu-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <button class="refresh-npc-btn scene-refresh-btn" onclick="refreshNpcLocations()">刷新NPC位置</button>
                    <div class="scene-title">铁匠铺</div>
                    <div class="npc-container" id="tiejiangpu-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('打铁', 'tiejiangpu')">打铁</button>
                    </div>
                </div>

                <div id="nandizi-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <button class="refresh-npc-btn scene-refresh-btn" onclick="refreshNpcLocations()">刷新NPC位置</button>
                    <div class="scene-title">男弟子房</div>
                    <div class="npc-container" id="nandizi-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('休息', 'nandizi')">休息</button>
                    </div>
                </div>

                <div id="nvdizi-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <button class="refresh-npc-btn scene-refresh-btn" onclick="refreshNpcLocations()">刷新NPC位置</button>
                    <div class="scene-title">女弟子房</div>
                    <div class="npc-container" id="nvdizi-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" onclick="performAction('拜访', 'nvdizi')">拜访</button>
                    </div>
                </div>

                <div id="shanmen-scene" class="scene">
                    <button class="back-btn" onclick="backToMap()">返回</button>
                    <button class="refresh-npc-btn scene-refresh-btn" onclick="refreshNpcLocations()">刷新NPC位置</button>
                    <div class="scene-title">山门</div>
                    <div class="npc-container" id="shanmen-npcs"></div>
                    <div class="scene-actions">
                        <button class="scene-btn" disabled>下山</button>
                        <!-- <button class="scene-btn" onclick="performAction('下山', 'shanmen')">下山</button> -->
                    </div>
                </div>
                <!-- 弹窗 -->
                <div id="modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-text" id="modal-text">新的一周开始了</div>
                        <div class="modal-buttons" id="modal-buttons">
                            <button class="modal-btn" onclick="closeModal()">确定</button>
                        </div>
                    </div>
                </div>

                <!-- 21点游戏iframe弹窗 - 新增 -->
                <div id="blackjack-modal" class="blackjack-modal">
                    <div class="blackjack-container">
                        <iframe id="blackjack-iframe" class="blackjack-iframe"></iframe>
                    </div>
                </div>

                <!-- 战斗iframe弹窗 -->
                <div id="battle-modal" class="battle-modal">
                    <div class="battle-container">
                        <iframe id="battle-iframe" class="battle-iframe"></iframe>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 自由行动输入框 -->
        <div class="free-action-container">
            <textarea 
                class="free-action-input" 
                id="free-action-input" 
                placeholder="输入自由行动内容"
                rows="1"
            ></textarea>
            <button class="free-action-send-btn" onclick="sendFreeAction()">发送</button>
        </div>
        
        <!-- 中间控制按钮 -->
        <div class="control-buttons">
            <button class="control-btn" onclick="showPlayerStats()">角色属性</button>
            <button class="control-btn" onclick="showRelationships()">人际关系</button>
            <button class="control-btn" id="skip-week-btn" onclick="skipWeek()">跳过这一周</button>
            <button class="control-btn" id="slg-return-btn" onclick="returnFromSLG()" style="display: none;">返回天山派</button>
        </div>

        <!-- 故事区域 -->
        <div class="story-area">
            <div class="story-content-wrapper">
                <!-- 页面指示器 -->
                <div class="page-indicator" id="page-indicator"></div>
                
                <!-- 翻页箭头 -->
                <button class="story-nav-btn prev" id="story-prev-btn" onclick="prevPage()">◀</button>
                <button class="story-nav-btn next" id="story-next-btn" onclick="nextPage()">▶</button>
                
                <!-- 故事文本 -->
                <div class="story-text" id="story-text">
                    江湖路远，故事未始...
                </div>
                
                <!-- 展开/收起按钮 -->
                <button class="story-expand-btn" id="story-expand-btn" onclick="toggleStoryExpand()">▼ 展开全文</button>
            </div>
            
            <!-- 随机事件容器 -->
            <div class="random-event-container" id="random-event-container">
                <div class="event-title">随机事件</div>
                <div class="event-description" id="event-description"></div>
                <div class="event-options" id="event-options"></div>
            </div>
            <!-- 战斗事件容器 -->
            <div class="battle-event-container" id="battle-event-container">
                <div class="battle-event-title">战斗事件</div>
                <div class="battle-event-description" id="battle-event-description"></div>
                <div class="battle-enemy-info">
                    <div class="enemy-info-item">
                        <span class="enemy-info-label">敌人：</span>
                        <span id="enemy-name-display"></span>
                    </div>
                    <div class="enemy-info-item">
                        <span class="enemy-info-label">攻击力：</span>
                        <span id="enemy-attack-display"></span>
                    </div>
                    <div class="enemy-info-item">
                        <span class="enemy-info-label">生命力：</span>
                        <span id="enemy-health-display"></span>
                    </div>
                </div>
                <div class="battle-reward">
                    <div class="battle-reward-text" id="battle-reward-text"></div>
                </div>
                <div class="battle-actions">
                    <button class="battle-action-btn fight" onclick="startBattle()">发起战斗</button>
                    <button class="battle-action-btn flee" onclick="fleeBattle()">放弃战斗</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载外部库 -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
    
    <!-- 从GitHub加载游戏模块 -->
    <script src="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/module/game-config.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/module/game-utils.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/module/game-state.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/module/game-ui.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/module/game-helpers.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/module/game-events.js"></script>

    <!-- <script src="module/game-config.js"></script>
    <script src="module/game-utils.js"></script>
    <script src="module/game-state.js"></script>
    <script src="module/game-ui.js"></script>
    <script src="module/game-helpers.js"></script>
    <script src="module/game-events.js"></script> -->
    
    <script>
        // 记录原始渲染环境状态
        window._originalRenderer = {
            hasSTscript: typeof window.STscript === 'function',
            hasTriggerSlash: typeof window.triggerSlash === 'function'
        };
        
        // 兼容层
        window.triggerSlash = window.triggerSlash || window.STscript;
        window.STscript = window.STscript || window.triggerSlash;
        
        // 模板变量
        const mainText = `$1`;
        const llmResponse = $2;

//         //测试用
//         const mainText = `清晨的第一缕阳光洒在天山雪峰上，你站在外堡通往天山派总坛的石阶前，心脏扑通扑通跳个不停。今天，是你正式拜入天山派的日子。「喂！你还在那里发什么呆！」一个清脆的声音把你从思绪中拉回现实。只见一个娇小的身影正叉着腰站在你面前——银白色的双髻上系着红色铃铛，随着她的动作叮当作响。最引人注目的是她头顶的白色狐耳和身后蓬松的大尾巴，正因为不耐烦而微微竖起。「我是萧白瑚！负责带你上山的！」她鼓起腮帮子，赤红色的圆眼瞪着你，「待会上山跟紧了，要是爬不动了，我可不会等你！」
// 你连忙点头，跟在这个只到你胸口的小师妹身后，开始了漫长的登山之路。山道蜿蜒曲折，两旁古松参天，偶尔能看到雪白的瀑布从崖壁倾泻而下。萧白瑚一边走一边叽叽喳喳：「这里是解剑池，登门上山的客人都要在这里暂存兵器，以前我们门派显赫的时候，这里都摆不下……那边是温泉，冬天也不会结冰，师兄师姐们经常在那里……喂！你有在听吗！」「有、有在听！」你赶紧回应。

// 穿过云雾缭绕的山门，眼前豁然开朗。巨大的演武场上，已经有不少弟子在晨练。「哟，这不是我们的小白狐吗？」一个青年男子的声音传来。你抬头一看，只见一个身穿黑色僧袍的青年正倚在演武场边的石柱上偷懒。他有着一张比女子还要俊美的脸庞，琥珀色的眼眸带着三分笑意，灰色的狼耳懒洋洋地耷拉着。「师兄！」萧白瑚立刻炸毛，「我说过多少次了，不要叫我『小』白狐！」「善哉善哉，」呼延显双手合十，嘴角却带着贱兮兮的笑容，「小师妹不要生气嘛，生气会长不高的哦~」「你！」萧白瑚气得狐尾都炸开了。
// 呼延显笑嘻嘻地转向你：「哎呀，原来是新入门的师弟！阿弥陀佛，小僧呼延显，忝为本派师兄。」他绕着你转了一圈，摇头晃脑：「《华严经》有云：『一花一世界，一叶一如来。』意思就是说——」他凑近你，神秘兮兮地说，「师弟你看，萧师妹头上那朵小花，里面可能住着一个小师妹，那个小师妹头上还有朵花，里面又住着更小的师妹……所以啊，你欺负一个萧白瑚，就等于欺负了无数个萧白瑚！帮无数个小师妹试炼心性，这也是修行中的大功德......」「谁头上有花了！你这个假和尚又在胡说八道！」萧白瑚跳脚。
// 就在这时，一个娇小的身影从天而降，稳稳落在你们三人中间。来人看上去只有十四五岁的样子，额头长着一对精致的青色龙角。「呼延显，不要教坏新来的弟子。」她的声音稚嫩却带着不容置疑的威严。「是是是，洞庭师叔说得是~」呼延显笑嘻嘻地行了个礼，「小僧这就去藏经阁抄经了~」说完，他身形一闪便消失在演武场上。洞庭君转过身，打量着你：「你就是今天要入门的新弟子？跟我来议事厅吧。」萧白瑚小声嘀咕：「明明都是小孩，大师兄凭什么就只对洞庭君客客气气的……」「你说什么？」洞庭君回头。「没、没什么！」


// 议事厅庄严肃穆，供奉着天山派历代掌门的牌位。洞庭君站在一旁，虽然需要微微踮起脚尖才能显得威严些，但她认真的表情让人不敢轻视。「跪下，向历代掌门行礼。」你恭恭敬敬地跪下，三叩九拜。「从今日起，你便是天山派外门弟子。当谨记门规，勤修武学，行侠仗义……」




// 就在洞庭君一本正经地训话时——「砰！」议事厅的大门被猛地推开。「姐~我来找——咦？」一个活泼的少女冒冒失失冲了进来，她看到你，眼睛一亮：「哎呀！这不是{{user}}吗！」你惊讶地看着面前的少女——那张俏丽的脸庞你再熟悉不过。是钱塘君，你自小在外堡相识的损友！虽然她早就拜入天山派门下，但这家伙隔三岔五就偷偷溜下山来找你玩闹，每次都带着一堆八卦趣事，还总是拉着你做些让人哭笑不得的恶作剧。
// 「钱塘君，我在举行入门仪式。」洞庭君皱起眉头。「哎呀姐姐，仪式都快结束了嘛！」钱塘君大大咧咧地走过来，一把搭住你的肩膀，「这可是我从小的跟班呢！今天终于也进天山派了！」她凑到你耳边，坏笑着说：「既然我先入门，你现在得叫我师姐哦~来，叫一声听听？」「我……」「快点快点！不叫的话……」她举的笑容变得『危险』起来，「我就趁你不备把你推下山崖哦~」「钱塘君！」洞庭君忍无可忍。「好啦好啦，我这就带新师弟去熟悉环境！」钱塘君拉起你就往外跑，「走！师姐带你去后山玩！那里可有意思了！」就这样，你还没来得及消化自己已经成为天山弟子的事实，就被儿时的玩伴拖着冲出了议事厅。身后传来洞庭君无奈的叹息声，而萧白瑚气呼呼的声音远远传来：「喂！带新师弟参观明明是我的工作！」`;


// const mainText = `清晨的第一缕阳光洒在天山雪峰上，你站在外堡通往天山派总坛的石阶前，心脏扑通扑通跳个不停。今天，是你正式拜入天山派的日子。「喂！你还在那里发什么呆！」一个清脆的声音把你从思绪中拉回现实。只见一个娇小的身影正叉着腰站在你面前——银白色的双髻上系着红色铃铛，随着她的动作叮当作响。最引人注目的是她头顶的白色狐耳和身后蓬松的大尾巴，正因为不耐烦而微微竖起。「我是萧白瑚！负责带你上山的！」她鼓起腮帮子，赤红色的圆眼瞪着你，「待会上山跟紧了，要是爬不动了，我可不会等你！」|萧白瑚|山门|不满|无


// 穿过云雾缭绕的山门，眼前豁然开朗。巨大的演武场上，已经有不少弟子在晨练。「哟，这不是我们的小白狐吗？」一个青年男子的声音传来。你抬头一看，只见一个身穿黑色僧袍的青年正倚在演武场边的石柱上偷懒。他有着一张比女子还要俊美的脸庞，琥珀色的眼眸带着三分笑意，灰色的狼耳懒洋洋地耷拉着。「师兄！」萧白瑚立刻炸毛，「我说过多少次了，不要叫我『小』白狐！」「善哉善哉，」呼延显双手合十，嘴角却带着贱兮兮的笑容，「小师妹不要生气嘛，生气会长不高的哦~」「你！」萧白瑚气得狐尾都炸开了。|萧白瑚|演武场|不满|亲吻

// 呼延显笑嘻嘻地转向你：「哎呀，原来是新入门的师弟！阿弥陀佛，小僧呼延显，忝为本派师兄。」他绕着你转了一圈，摇头晃脑：「《华严经》有云：『一花一世界，一叶一如来。』意思就是说——」他凑近你，神秘兮兮地说，「师弟你看，萧师妹头上那朵小花，里面可能住着一个小师妹，那个小师妹头上还有朵花，里面又住着更小的师妹……所以啊，你欺负一个萧白瑚，就等于欺负了无数个萧白瑚！帮无数个小师妹试炼心性，这也是修行中的大功德......」「谁头上有花了！你这个假和尚又在胡说八道！」萧白瑚跳脚。|呼延显|演武场|微笑|无



// 就在这时，一个娇小的身影从天而降，稳稳落在你们三人中间。来人看上去只有十四五岁的样子，额头长着一对精致的青色龙角。「呼延显，不要教坏新来的弟子。」她的声音稚嫩却带着不容置疑的威严。「是是是，洞庭师叔说得是~」呼延显笑嘻嘻地行了个礼，「小僧这就去藏经阁抄经了~」说完，他身形一闪便消失在演武场上。洞庭君转过身，打量着你：「你就是今天要入门的新弟子？跟我来议事厅吧。」萧白瑚小声嘀咕：「明明都是小孩，大师兄凭什么就只对洞庭君客客气气的……」「你说什么？」洞庭君回头。「没、没什么！」|洞庭君|演武场|严肃|后背位`;

        // const llmResponse = {
        //     "主要NPC": {
        //         "呼延显": {
        //         "好感变化": "上升",
        //         "位置变动": "演武场|藏经阁"
        //         },
        //         "萧白瑚": {
        //         "好感变化": "上升",
        //         "位置变动": "山门|议事厅"
        //         },
        //         "洞庭君": {
        //         "好感变化": "不变",
        //         "位置变动": "演武场|议事厅"
        //         },
        //         "钱塘君": {
        //         "好感变化": "大幅上升",
        //         "位置变动": "议事厅|后山"
        //         }
        //     },
        //     "其他NPC": "无"
        // };

        // const llmResponse = {
        //     "随机事件": {
        //         "事件类型": "战斗事件",
        //         "事件描述": "你在山门附近训练，发现一人形迹可疑，你上前盘查，对方居然是吐蕃的细作！",
        //         "敌方信息": {
        //         "名称": "吐蕃探子",
        //         "属性": {
        //             "攻击力": "低",
        //             "生命力": "中"
        //         },
        //         "战斗报酬": {
        //             "类型": "金钱",
        //             "数值": 500
        //         }
        //         }
        //     },
        //     "主要NPC": {
        //         "呼延显": {
        //         "好感变化": "上升",
        //         "位置变动": "演武场|藏经阁"
        //         },
        //         "萧白瑚": {
        //         "好感变化": "上升",
        //         "位置变动": "山门|议事厅"
        //         },
        //         "洞庭君": {
        //         "好感变化": "不变",
        //         "位置变动": "演武场|议事厅"
        //         },
        //         "钱塘君": {
        //         "好感变化": "大幅上升",
        //         "位置变动": "议事厅|后山"
        //         }
        //     },
        //     "其他NPC": "无"
        // };

        // const llmResponse = {
        //     "随机事件": {
        //         "事件类型": "选项事件",
        //         "事件描述": "姬姒想要和你探讨昨天练武的心得",
        //         "选项一": {
        //             "描述": "你欣然接受邀请，和姬姒一起讨论",
        //             "奖励": "悟性+3",
        //             "成功率": "25%"
        //         },
        //         "选项二": {
        //             "描述": "你急不可耐，跳过探讨环节，直接和姬姒过招",
        //             "奖励": "根骨+1",
        //             "成功率": "60%"
        //         },
        //         "选项三": {
        //             "描述": "你婉拒姬姒，专注于眼前的工作",
        //             "奖励": "心性+2",
        //             "成功率": "40%"
        //         }
        //     },
        //     "主要NPC": {
        //         "呼延显": {
        //         "好感变化": "上升",
        //         "位置变动": "演武场|藏经阁"
        //         },
        //         "萧白瑚": {
        //         "好感变化": "上升",
        //         "位置变动": "山门|议事厅"
        //         },
        //         "洞庭君": {
        //         "好感变化": "不变",
        //         "位置变动": "演武场|议事厅"
        //         },
        //         "钱塘君": {
        //         "好感变化": "大幅上升",
        //         "位置变动": "议事厅|后山"
        //         }
        //     },
        //     "其他NPC": "无"
        // };
        
        // ========== 保留在HTML中的函数（用于onclick调用） ==========
        
        // 修改 showPlayerStats 函数
        function showPlayerStats() {
            // 只有当前场景不是角色属性或人际关系时才记录
            const activeScene = document.querySelector('.scene.active');
            if (activeScene && 
                activeScene.id !== 'player-stats-scene' && 
                activeScene.id !== 'relationships-scene') {
                previousScene = activeScene.id.replace('-scene', '');
                wasInSLGMode = GameMode === 1;
            }
            
            // 清除SLG相关元素
            const viewport = document.getElementById('main-viewport');
            const existingLayers = viewport.querySelectorAll('.slg-layer-container, .slg-layer');
            existingLayers.forEach(layer => layer.remove());
            const existingMask = viewport.querySelector('.slg-interaction-mask');
            if (existingMask) existingMask.remove();
            
            // 先切换场景
            switchScene('player-stats');
            updateStatsDisplay();
            
            // 如果是SLG模式，移除该场景的slg-mode类
            if (GameMode === 1) {
                const statsScene = document.getElementById('player-stats-scene');
                statsScene.classList.remove('slg-mode');
            }
        }

        // 修改 showRelationships 函数
        function showRelationships() {
            // 只有当前场景不是角色属性或人际关系时才记录
            const activeScene = document.querySelector('.scene.active');
            if (activeScene && 
                activeScene.id !== 'player-stats-scene' && 
                activeScene.id !== 'relationships-scene') {
                previousScene = activeScene.id.replace('-scene', '');
                wasInSLGMode = GameMode === 1;
            }
            
            // 清除SLG相关元素
            const viewport = document.getElementById('main-viewport');
            const existingLayers = viewport.querySelectorAll('.slg-layer-container, .slg-layer');
            existingLayers.forEach(layer => layer.remove());
            const existingMask = viewport.querySelector('.slg-interaction-mask');
            if (existingMask) existingMask.remove();
            
            // 先切换场景
            switchScene('relationships');
            updateRelationshipsDisplay();
            
            // 如果是SLG模式，移除该场景的slg-mode类
            if (GameMode === 1) {
                const relScene = document.getElementById('relationships-scene');
                relScene.classList.remove('slg-mode');
            }
        }

        // 切换NPC可见性
        function toggleNpcVisibility(npcId) {
            const checkbox = document.getElementById(`visibility-${npcId}`);
            npcVisibility[npcId] = checkbox.checked;
            
            // 如果NPC被设置为不显示，立即将其位置设为none
            if (!npcVisibility[npcId]) {
                currentNpcLocations[npcId] = 'none';
                
                // 更新对应的位置变量
                switch(npcId) {
                    case 'A': npcLocationA = 'none'; break;
                    case 'B': npcLocationB = 'none'; break;
                    case 'C': npcLocationC = 'none'; break;
                    case 'D': npcLocationD = 'none'; break;
                    case 'E': npcLocationE = 'none'; break;
                    case 'F': npcLocationF = 'none'; break;
                    case 'G': npcLocationG = 'none'; break;
                    case 'H': npcLocationH = 'none'; break;
                    case 'I': npcLocationI = 'none'; break;
                    case 'J': npcLocationJ = 'none'; break;
                    case 'K': npcLocationK = 'none'; break;
                    case 'L': npcLocationL = 'none'; break;
                }
                
                // 如果当前场景有该NPC，更新显示
                const activeScene = document.querySelector('.scene.active');
                if (activeScene && activeScene.id !== 'map-scene') {
                    const locationName = activeScene.id.replace('-scene', '');
                    displayNpcs(locationName);
                }
            }
            
            // 保存游戏数据
            saveGameData();
        }

        // 送礼函数
        async function giveGift(npcId) {
            const npc = npcs[npcId];
            const currentFavorability = npcFavorability[npcId];
            
            // 再次检查条件
            if (npcGiftGiven[npcId]) {
                showModal('本周已经给该NPC送过礼物了！');
                return;
            }
            
            if (currentFavorability > 40) {
                showModal(`${npc.name}的好感度已经超过40，无需再送礼！`);
                return;
            }
            
            if (playerStats.金钱 < 500) {
                showModal('金钱不足500，无法送礼！');
                return;
            }
            
            // 执行送礼
            playerStats.金钱 -= 500;
            npcFavorability[npcId] = Math.min(100, npcFavorability[npcId] + 5);
            npcGiftGiven[npcId] = true;
            
            checkAllValueRanges();
            updateStatsDisplay();
            updateRelationshipsDisplay();
            
            // 发送消息
            const message = `你花费500金钱给${npc.name}送了一份礼物<br>` +
                        `${npc.name}的好感度提升至${npcFavorability[npcId]}`;
            
            await showModal(message);
        }

        // 修改 skipWeek 函数，在跳过周时重置送礼状态
        function skipWeek() {
            showConfirmModal(
                '确认跳过',
                '确定要跳过这一周吗？',
                async () => {
                    currentWeek++;
                    actionPoints = 3;
                    userLocation = "tianshanpai";
                    
                    // 重置所有NPC的送礼状态
                    Object.keys(npcGiftGiven).forEach(npcId => {
                        npcGiftGiven[npcId] = false;
                    });
                    
                    // 重置所有NPC的切磋状态
                    Object.keys(npcSparred).forEach(npcId => {
                        npcSparred[npcId] = false;
                    });
                    
                    checkAllValueRanges();
                    updateAllDisplays();
                    refreshNpcLocations();
                    await handleMessageOutput('新的一周开始了<br>当前第' + currentWeek + '周');
                }
            );
        }

        // 执行互动
        async function performAction(action, location) {
            // 新增：如果是SLG模式，不执行任何操作
            if (GameMode === 1) {
                return;
            }
            if (action === '秘密赌场') {
                if (actionPoints < 1) {
                    showModal('行动点不足，无法进行此操作！');
                    return;
                }
                
                let actionPointConsumed = true;
                const mindChance = playerTalents.心性 / 2;
                if (Math.random() * 100 < mindChance) {
                    actionPointConsumed = false;
                } else {
                    actionPoints--;
                }
                checkAllValueRanges();
                updateAllDisplays();
                
                showBlackjackGame();
                
                if (!actionPointConsumed) {
                    window.pendingMindMessage = true;
                }
                return;
            }

            if (actionPoints < 1) {
                showModal('行动点不足，无法进行此操作！');
                return;
            }

            let actionPointConsumed = true;
            let mindMessageShown = false;
            const mindChance = playerTalents.心性 / 2;
            if (Math.random() * 100 < mindChance) {
                actionPointConsumed = false;
                mindMessageShown = true;
            } else {
                actionPoints--;
            }
            
            const config = actionConfigs[action];
            const talentBonus = playerTalents[config.talentBonus] / 2;
            
            const randomRoll = Math.random() * 100;
            const finalValue = (randomRoll + talentBonus) * (playerMood + 20) / 100;

            let successLevel, successText, moodCost;
            let statChange = {};
            
            if (finalValue >= 80) {
                successLevel = '大成功';
                successText = '成果斐然！';
                moodCost = 0;
                if (action === '休息') {
                    playerMood = Math.min(100, playerMood + 90);
                    statChange.心情 = '+90';
                } else if (config.affects === '金钱') {
                    statChange[config.affects] = 1000;
                } else if (config.affects === '声望') {
                    statChange[config.affects] = 5;
                } else {
                    statChange[config.affects] = 5;
                }
            } else if (finalValue >= 60) {
                successLevel = '成功';
                successText = '收获颇丰。';
                moodCost = 5;
                if (action === '休息') {
                    playerMood = Math.min(100, playerMood + 60);
                    statChange.心情 = '+60';
                } else if (config.affects === '金钱') {
                    statChange[config.affects] = 500;
                } else if (config.affects === '声望') {
                    statChange[config.affects] = 3;
                } else {
                    statChange[config.affects] = 3;
                }
            } else if (finalValue >= 40) {
                successLevel = '一般';
                successText = '平平无奇。';
                moodCost = 10;
                if (action === '休息') {
                    playerMood = Math.min(100, playerMood + 45);
                    statChange.心情 = '+45';
                } else if (config.affects === '金钱') {
                    statChange[config.affects] = 100;
                } else if (config.affects === '声望') {
                    statChange[config.affects] = 1;
                } else {
                    statChange[config.affects] = 1;
                }
            } else if (finalValue >= 20) {
                successLevel = '失败';
                successText = '事与愿违...';
                moodCost = 15;
                if (action === '休息') {
                    playerMood = Math.min(100, playerMood + 30);
                    statChange.心情 = '+30';
                } else if (config.affects === '金钱') {
                    statChange[config.affects] = -500;
                } else if (config.affects === '声望') {
                    statChange[config.affects] = -2;
                } else {
                    statChange[config.affects] = 0;
                }
            } else {
                successLevel = '大失败';
                successText = '惨不忍睹！';
                moodCost = 20;
                if (action === '休息') {
                    playerMood = Math.min(100, playerMood + 30);
                    statChange.心情 = '+30';
                } else if (config.affects === '金钱') {
                    statChange[config.affects] = -1000;
                } else if (config.affects === '声望') {
                    statChange[config.affects] = -5;
                } else {
                    statChange[config.affects] = 0;
                }
            }

            if (config.affects !== '心情') {
                playerStats[config.affects] = Math.max(0, playerStats[config.affects] + statChange[config.affects]);
                if (action !== '休息') {
                    playerMood = Math.max(0, playerMood - moodCost);
                }
            }

            checkAllValueRanges();

            const npcsPresent = getNpcsAtLocation(location).map(npc => npc.name).join('、') || '无';

            let changeText = '';
            Object.entries(statChange).forEach(([key, value]) => {
                changeText += `<br>${key}: ${value > 0 ? '+' : ''}${value}`;
            });
            if (action !== '休息') {
                changeText += `<br>心情: -${moodCost}`;
            }
            
            if (actionPointConsumed) {
                changeText += '<br>行动点: -1';
            } else {
                changeText += '<br>行动点: -0（心性判定成功）';
            }

            let resultMessage = `时间：第${Math.floor((currentWeek - 1) / 48) + 1}年第${Math.floor(((currentWeek - 1) % 48) / 4) + 1}月第${((currentWeek - 1) % 4) + 1}周<br>` +
                `地点：${locationNames[location]}<br>` +
                `{{user}}行动选择：${action}<br>` +
                `在场NPC：${npcsPresent}<br>` +
                `选择结果：${successLevel} - ${successText}<br><br>` +
                `属性变化：${changeText}`;

            updateAllDisplays();
            refreshNpcLocations();
            
            await handleMessageOutput(resultMessage);
        }

        // 刷新NPC位置
        function refreshNpcLocations() {
            // 获取用户当前位置（排除特殊场景）
            const currentLocation = userLocation === 'tianshanpai' || 
                                userLocation === 'player-stats' || 
                                userLocation === 'relationships' ? null : userLocation;
            
            // 保存当前位置的NPC
            const npcsAtCurrentLocation = [];
            if (currentLocation) {
                Object.keys(currentNpcLocations).forEach(npcId => {
                    if (currentNpcLocations[npcId] === currentLocation) {
                        npcsAtCurrentLocation.push(npcId);
                    }
                });
            }
            
            const locationCount = {
                yanwuchang: 0,
                cangjingge: 0,
                huofang: 0,
                houshan: 0,
                yishiting: 0,
                tiejiangpu: 0,
                nandizi: 0,
                nvdizi: 0,
                shanmen: 0
            };
            
            // 如果有当前位置，先统计该位置的NPC数量
            if (currentLocation && locationCount.hasOwnProperty(currentLocation)) {
                locationCount[currentLocation] = npcsAtCurrentLocation.length;
            }

            // 只对不在当前位置的NPC进行重新分配
            const npcsToShuffle = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L'].filter(
                npcId => !npcsAtCurrentLocation.includes(npcId)
            );
            const npcOrder = npcsToShuffle.sort(() => Math.random() - 0.5);

            npcOrder.forEach(npcId => {
                // 新增：检查NPC是否被设置为不显示
                if (!npcVisibility[npcId]) {
                    currentNpcLocations[npcId] = 'none';
                    return;
                }
                
                let assigned = false;
                let attempts = 0;
                const maxAttempts = 20;

                while (!assigned && attempts < maxAttempts) {
                    const location = getRandomLocation(npcId);
                    
                    // 跳过用户当前位置
                    if (currentLocation && location === currentLocation) {
                        attempts++;
                        continue;
                    }
                    
                    if (location === 'none') {
                        currentNpcLocations[npcId] = location;
                        assigned = true;
                    } else if (locationCount[location] < 2) {
                        currentNpcLocations[npcId] = location;
                        locationCount[location]++;
                        assigned = true;
                    }
                    
                    attempts++;
                }

                if (!assigned) {
                    currentNpcLocations[npcId] = 'none';
                }
            });

            // 更新各个NPC的位置变量
            npcLocationA = currentNpcLocations.A;
            npcLocationB = currentNpcLocations.B;
            npcLocationC = currentNpcLocations.C;
            npcLocationD = currentNpcLocations.D;
            npcLocationE = currentNpcLocations.E;
            npcLocationF = currentNpcLocations.F;
            npcLocationG = currentNpcLocations.G;
            npcLocationH = currentNpcLocations.H;
            npcLocationI = currentNpcLocations.I;
            npcLocationJ = currentNpcLocations.J;
            npcLocationK = currentNpcLocations.K;
            npcLocationL = currentNpcLocations.L;
            
            const activeScene = document.querySelector('.scene.active');
            if (activeScene && activeScene.id !== 'map-scene') {
                const locationName = activeScene.id.replace('-scene', '');
                displayNpcs(locationName);
            }
        }

        // 修改 backToMap 函数
        function backToMap() {
            // 移除返回按钮的偏移类
            const backBtns = document.querySelectorAll('.back-btn.slg-mode-offset');
            backBtns.forEach(btn => btn.classList.remove('slg-mode-offset'));
            
            // 获取当前场景
            const activeScene = document.querySelector('.scene.active');
            const currentSceneId = activeScene ? activeScene.id : '';
            
            // 如果是从角色属性或人际关系界面返回，且之前在SLG模式
            if ((currentSceneId === 'player-stats-scene' || currentSceneId === 'relationships-scene') 
                && wasInSLGMode && GameMode === 1) {
                
                // 直接返回到之前的SLG场景
                switchScene(previousScene);
                
                // 如果不是地图场景，添加slg-mode类
                if (previousScene !== 'map') {
                    const targetScene = document.getElementById(previousScene + '-scene');
                    if (targetScene) {
                        targetScene.classList.add('slg-mode');
                    }
                }
                
                // 恢复SLG显示
                updateStoryDisplay();
                
                // 重置状态
                wasInSLGMode = false;
            } else {
                // 普通模式：返回地图
                const scenes = document.querySelectorAll('.scene');
                scenes.forEach(scene => {
                    scene.classList.remove('active');
                });

                document.getElementById('map-scene').classList.add('active');
                userLocation = 'tianshanpai';
            }
        }

        // 关闭弹窗
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // 发送互动内容
        async function sendInteraction() {
            const interactionContent = document.getElementById('interaction-input').value.trim();
            
            if (!interactionContent) {
                alert('请输入互动内容！');
                return;
            }
            
            const activeScene = document.querySelector('.scene.active');
            const location = activeScene.id.replace('-scene', '');
            
            const npc = npcs[currentInteractionNpc];
            const npcsPresent = getNpcsAtLocation(location).map(npc => npc.name).join('、') || '无';
            
            const resultMessage = `时间：第${Math.floor((currentWeek - 1) / 48) + 1}年第${Math.floor(((currentWeek - 1) % 48) / 4) + 1}月第${((currentWeek - 1) % 4) + 1}周<br>` +
                `地点：${locationNames[location]}<br>` +
                `{{user}}行动选择：NPC互动<br>` +
                `&nbsp;&nbsp;&nbsp;&nbsp;互动对象：${npc.name}<br>` +
                `&nbsp;&nbsp;&nbsp;&nbsp;互动内容：<span class="interaction-content">${interactionContent}</span><br>` +
                `在场NPC：${npcsPresent}`;
            
            closeModal();
            
            currentInteractionNpc = null;
            currentInteractionLocation = null;
            
            await handleMessageOutput(resultMessage);
        }

        // 增加攻击力
        function addAttack() {
            const remainingPoints = calculateRemainingPoints();
            if (remainingPoints > 0) {
                showConfirmModal(
                    '确认加点',
                    '消耗1点分配点数，增加10点攻击力？',
                    () => {
                        combatStats.攻击力 += 10;
                        checkAllValueRanges();
                        updateStatsDisplay();
                        setTimeout(() => {
                            showModal(`攻击力提升至 ${combatStats.攻击力}`);
                        }, 100);
                    }
                );
            }
        }

        // 增加生命值
        function addHP() {
            const remainingPoints = calculateRemainingPoints();
            if (remainingPoints > 0) {
                showConfirmModal(
                    '确认加点',
                    '消耗1点分配点数，增加25点生命值？',
                    () => {
                        combatStats.生命值 += 25;
                        checkAllValueRanges();
                        updateStatsDisplay();
                        setTimeout(() => {
                            showModal(`生命值提升至 ${combatStats.生命值}`);
                        }, 100);
                    }
                );
            }
        }

        // NPC动作
        function npcAction(npcId, action) {
            const popup = document.getElementById('npc-info-popup');
            popup.classList.remove('show');
            document.removeEventListener('click', closeNpcInfo);
            
            if (action === '互动') {
                const activeScene = document.querySelector('.scene.active');
                const location = activeScene.id.replace('-scene', '');
                showInteractionInput(npcId, location);
            } else if (action === '切磋') {
                // 检查是否本周已经切磋过
                if (npcSparred[npcId]) {
                    showModal('本周已经和该NPC切磋过了！');
                    return;
                }
                
                const npc = npcs[npcId];
                currentBattleType = 'npc';
                currentBattleNpcName = npc.name;
                currentBattleNpcId = npcId;  // 新增：记录NPC ID
                
                const battleData = {
                    player: {
                        name: '你',
                        attack: combatStats.攻击力,
                        health: combatStats.生命值
                    },
                    enemy: {
                        name: npc.name,
                        maxHealth: '中',
                        basicDamage: '中'
                    }
                };
                
                showBattleGame(battleData);
            }
        }

        // 前往地点
        function goToLocation(locationId) {
            // 新增：如果是SLG模式，不允许切换场景
            if (GameMode === 1) {
                return;
            }
            
            const popup = document.getElementById('location-info-popup');
            popup.classList.remove('show');
            document.removeEventListener('click', closeLocationInfo);
            
            userLocation = locationId;
            switchScene(locationId);
        }

        // 发送自由行动
        async function sendFreeAction() {
            const inputElement = document.getElementById('free-action-input');
            const actionContent = inputElement.value.trim();
            
            if (!actionContent) {
                alert('请输入自由行动内容！');
                return;
            }
            
            const activeScene = document.querySelector('.scene.active');
            let currentLocation = '';
            let npcsPresent = '无';
            
            if (activeScene.id === 'map-scene') {
                currentLocation = '天山派（地图）';
                npcsPresent = '无在场NPC';
            } else {
                const sceneName = activeScene.id.replace('-scene', '');
                currentLocation = locationNames[sceneName] || sceneName;
                
                const npcsAtLocation = getNpcsAtLocation(sceneName);
                if (npcsAtLocation.length > 0) {
                    npcsPresent = npcsAtLocation.map(npc => npc.name).join('、');
                }
            }
            
            const year = Math.floor((currentWeek - 1) / 48) + 1;
            const remainingWeeks = (currentWeek - 1) % 48;
            const month = Math.floor(remainingWeeks / 4) + 1;
            const week = remainingWeeks % 4 + 1;
            
            const resultMessage = `时间：第${year}年第${month}月第${week}周<br>` +
                `地点：${currentLocation}<br>` +
                `{{user}}自由行动："${actionContent}"<br>` +
                `在场NPC：${npcsPresent}`;
            
            inputElement.value = '';
            inputElement.style.height = 'auto';
            
            await handleMessageOutput(resultMessage);
        }

        // 发起战斗
        function startBattle() {
            if (!currentBattleEvent || !currentBattleEvent.敌方信息) return;
            
            const enemyInfo = currentBattleEvent.敌方信息;
            currentBattleType = 'event';
            
            const battleData = {
                player: {
                    name: '你',
                    attack: combatStats.攻击力,
                    health: combatStats.生命值
                },
                enemy: {
                    name: enemyInfo.名称,
                    maxHealth: enemyInfo.属性?.生命力 || '中',
                    basicDamage: enemyInfo.属性?.攻击力 || '中'
                }
            };
            
            showBattleGame(battleData);
        }

        // 放弃战斗
        async function fleeBattle() {
            if (!currentBattleEvent) return;
            
            const resultMessage = currentBattleEvent.事件描述 + '<br><br>你选择避开了战斗';
            
            hideBattleEvent();
            
            await handleMessageOutput(resultMessage);
        }

        // 翻页相关函数（调用game-ui.js中的实际实现）
        function goToPage(pageNum) {
            if (typeof doGoToPage === 'function') {
                doGoToPage(pageNum);
            }
        }

        function prevPage() {
            if (typeof doPrevPage === 'function') {
                doPrevPage();
            }
        }

        function nextPage() {
            if (typeof doNextPage === 'function') {
                doNextPage();
            }
        }

        function toggleStoryExpand() {
            if (typeof doToggleStoryExpand === 'function') {
                doToggleStoryExpand();
            }
        }
        // 从SLG模式返回
        async function returnFromSLG() {
            const message = '你结束了山下的游历，回到了天山派';
            
            // 重置游戏模式
            GameMode = 0;
            slgModeData = [];
            
            // 清除SLG图层
            const viewport = document.getElementById('main-viewport');
            const existingLayers = viewport.querySelectorAll('.slg-layer');
            existingLayers.forEach(layer => layer.remove());
            const existingMask = viewport.querySelector('.slg-interaction-mask');
            if (existingMask) existingMask.remove();
            
            // 移除场景的SLG模式标记
            const scenes = document.querySelectorAll('.scene');
            scenes.forEach(scene => {
                scene.classList.remove('slg-mode');
            });
            
            // 设置userLocation为天山派地图
            userLocation = 'tianshanpai';
            
            // 切换到地图场景
            switchScene('map');
            document.getElementById('map-scene').classList.add('active');
            
            // 更新按钮显示
            updateSLGReturnButton();
            
            // 刷新NPC位置
            refreshNpcLocations();
            
            // 保存游戏数据
            // await saveGameData();
            
            // // 根据环境处理消息输出
            // if (isInRenderEnvironment()) {
            //     const renderFunc = getRenderFunction();
            //     try {
            //         await renderFunc(`/send at={{lastMessageId}}+1 ${message}`);
            //         await renderFunc('/trigger');
            //         console.log('SLG return message sent:', message);
            //     } catch (error) {
            //         console.error('Error sending message:', error);
            //         showModal(message);
            //     }
            // } else {
            //     showModal(message);
            // }
            await handleMessageOutput(message);
        }
        // ========== 初始化 ==========
        window.onload = async function() {
            await loadOrInitGameData();
            checkAllValueRanges();
            updateAllDisplays();
            setupLocationEvents();
            setupMessageListeners();
            
            if (isInRenderEnvironment()) {
                // 隐藏所有刷新NPC按钮（包括地图和各个场景的）
                const refreshBtns = document.querySelectorAll('.refresh-npc-btn');
                refreshBtns.forEach(btn => {
                    btn.style.display = 'none';
                });
            }
            
            if (userLocation === 'tianshanpai') {
                document.getElementById('map-scene').classList.add('active');
            } else {
                switchScene(userLocation);
            }
            
            parseLLMResponse(llmResponse, mainText);
            // 新增：初始化时更新SLG返回按钮显示
            updateSLGReturnButton();
        };
        
        // 自由行动输入框事件
        document.getElementById('free-action-input').addEventListener('input', function() {
            this.style.height = 'auto';
            const scrollHeight = this.scrollHeight;
            this.style.height = Math.min(scrollHeight, 120) + 'px';
        });
        
        document.getElementById('free-action-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendFreeAction();
            }
        });
        
        // 弹窗背景点击事件
        document.getElementById('blackjack-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                const iframe = document.getElementById('blackjack-iframe');
                try {
                    iframe.contentWindow.postMessage({ type: 'close-game' }, '*');
                } catch(e) {
                    this.style.display = 'none';
                    iframe.src = '';
                }
            }
        });
        
        document.getElementById('battle-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                if (confirm('确定要退出战斗吗？')) {
                    this.style.display = 'none';
                    document.getElementById('battle-iframe').src = '';
                    
                    if (currentBattleType === 'event') {
                        hideBattleEvent();
                    }
                    
                    currentBattleType = null;
                    currentBattleReward = null;
                }
            }
        });
    </script>
</body>
</html>
