<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¹æˆ˜ç³»ç»Ÿ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    user-select: none;
}

body {
    font-family: 'ZCOOL XiaoWei', 'Microsoft YaHei', sans-serif;
    background-color: #000;
    color: #fff;
    overflow: hidden;
    margin: 0;  /* ç¡®ä¿æ²¡æœ‰margin */
    padding: 0;  /* ç¡®ä¿æ²¡æœ‰padding */
    display: flex;
    justify-content: center;
    align-items: flex-start;  /* ä»centeræ”¹ä¸ºflex-startï¼Œè®©å†…å®¹ä»é¡¶éƒ¨å¼€å§‹ */
    width: 100vw;
    height: 100vh;
}

.game-container {
    /* é€šè¿‡JSåŠ¨æ€è®¾ç½®å®½é«˜ï¼Œä¿æŒ4:3æ¯”ä¾‹ */
    position: relative;
    display: flex;
    flex-direction: column;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    margin-top: 0;  /* ç¡®ä¿ç´§è´´é¡¶éƒ¨ */
}

/* //å›åˆåˆ¶ç³»ç»Ÿé›†æˆæ›´æ–° - ä¿®æ”¹é€€å‡ºæŒ‰é’®æ ·å¼åˆ°å³ä¸‹è§’ */
.exit-battle-btn {
    position: absolute;
    bottom: 0px;
    right: 18px;
    padding: 10px 20px;
    background: #1a1a1a;
    color: #ffffff;
    border: 2px solid #333;
    border-radius: 5px;
    cursor: pointer;
    font-size: clamp(0.9rem, 2.2vw, 1.8rem);
    font-weight: bold;
    font-family: 'Ma Shan Zheng', cursive;  /* ç»Ÿä¸€å­—ä½“ */
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    z-index: 100;
    font-weight: bold;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
}

.exit-battle-btn:hover {
    background: #2a2a2a;
    border-color: #555;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
}

.battle-scene {
    flex: 1;
    position: relative;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    padding-bottom: clamp(60px, 12vw, 120px);
}

/* çŠ¶æ€åŒºæ ·å¼ - è¿›ä¸€æ­¥ç¼©å°æ‰‹æœºç«¯æ˜¾ç¤º */
.player-status-area {
    position: absolute;
    top: clamp(6px, 1.5vw, 15px);
    left: clamp(6px, 1.5vw, 15px);
    background-color: rgba(0, 0, 0, 0.85);
    border-radius: clamp(3px, 0.8vw, 6px);
    padding: clamp(4px, 1vw, 10px);
    z-index: 5;
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 0 8px rgba(0, 0, 0, 0.6);
    min-width: clamp(120px, 20vw, 200px);
    max-width: clamp(160px, 25vw, 250px);
}

.character-name {
    font-size: clamp(11px, 2.2vw, 16px);
    font-weight: bold;
    color: #ffcc00;
    margin-bottom: clamp(3px, 0.8vw, 6px);
    text-align: center;
    font-family: 'Ma Shan Zheng', cursive;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
    border-bottom: 1px solid rgba(255, 204, 0, 0.3);
    padding-bottom: clamp(2px, 0.5vw, 4px);
}

.enemy-status-area {
    position: absolute;
    top: clamp(6px, 1.5vw, 15px);
    right: clamp(6px, 1.5vw, 15px);
    background-color: rgba(0, 0, 0, 0.85);
    border-radius: clamp(3px, 0.8vw, 6px);
    padding: clamp(4px, 1vw, 10px);
    z-index: 5;
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 0 8px rgba(0, 0, 0, 0.6);
    min-width: clamp(120px, 20vw, 200px);
    max-width: clamp(160px, 25vw, 250px);
}

.health-container {
    display: flex;
    align-items: center;
    min-width: clamp(110px, 18vw, 180px);
    margin-bottom: clamp(2px, 0.5vw, 5px);
    position: relative;
}

.health-bar {
    flex: 1;
    height: clamp(12px, 2.5vw, 20px);
    background-color: #333;
    border-radius: clamp(2px, 0.4vw, 3px);
    overflow: hidden;
    margin-right: clamp(30px, 6vw, 60px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.health-fill {
    height: 100%;
    background: linear-gradient(to right, #ff0043, #ff6a00);
    width: 100%;
    transition: width 0.5s cubic-bezier(.4,2,.6,1);
}

.health-text {
    position: absolute;
    right: 0;
    font-size: clamp(10px, 2vw, 14px);
    color: #fff;
    min-width: clamp(30px, 6vw, 60px);
    text-align: right;
    font-weight: bold;
}

.energy-display {
    display: flex;
    justify-content: flex-end;
    align-items: center;
}

.energy-value {
    font-size: clamp(10px, 2vw, 14px);
    color: #ffcc00;
    margin-right: clamp(2px, 0.5vw, 5px);
    font-weight: bold;
}

.energy-icon {
    color: #ffcc00;
    font-size: clamp(12px, 2.5vw, 16px);
}

/* æŒ‘è¡…çŠ¶æ€æ˜¾ç¤ºæ ·å¼ */
.taunt-status {
    display: none;
    margin-top: clamp(3px, 0.8vw, 6px);
    padding: clamp(2px, 0.5vw, 4px) clamp(4px, 1vw, 8px);
    background: linear-gradient(135deg, rgba(255, 60, 60, 0.8), rgba(180, 20, 20, 0.9));
    border-radius: clamp(2px, 0.4vw, 4px);
    font-size: clamp(9px, 1.8vw, 12px);
    font-weight: bold;
    color: #fff;
    text-align: center;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    animation: taunt-pulse 1s ease-in-out infinite;
    border: 1px solid rgba(255, 100, 100, 0.6);
}

.taunt-status.active {
    display: block;
}

@keyframes taunt-pulse {
    0% { opacity: 0.8; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.02); }
    100% { opacity: 0.8; transform: scale(1); }
}

/* å›åˆæŒ‡ç¤ºå™¨ - ä¼˜åŒ–ä½ç½®é¿å…è¢«é®æŒ¡ */
.turn-indicator {
    position: absolute;
    top: 0;  /* æ”¹ä¸º0ï¼Œç´§è´´ä¸Šè¾¹ç¼˜ */
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(0, 0, 0, 0.85);
    padding: clamp(4px, 1vw, 8px) clamp(10px, 2.5vw, 20px);
    border-radius: 0 0 clamp(12px, 3vw, 20px) clamp(12px, 3vw, 20px); /* ä¿®æ”¹ä¸ºåªæœ‰åº•éƒ¨åœ†è§’ */
    z-index: 6;
    font-size: clamp(12px, 2.8vw, 18px);
    font-weight: bold;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-top: none; /* ç§»é™¤é¡¶éƒ¨è¾¹æ¡† */
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
    font-family: 'Ma Shan Zheng', cursive;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
    white-space: nowrap;
}

/* å‘½ä»¤åŒºåŸŸ - æ°´å¢¨é£æ ¼ */
.command-area {
    position: absolute;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 800px;
    background-color: rgba(0, 0, 0, 0.7);
    border-radius: 10px;
    padding: 15px;
    z-index: 10;
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
}

.command-label {
    margin-bottom: 10px;
    font-size: 24px;
    color: #eee;
    text-align: center;
    font-family: 'Ma Shan Zheng', cursive;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
}

.command-buttons {
    display: flex;
    justify-content: space-around;
    gap: 10px;
}

/* æŒ‡ä»¤æŒ‰é’®æµ®åŠ¨æ ·å¼ - ä¼˜åŒ–ç‰ˆæœ¬ï¼šå§‹ç»ˆç´§è´´å·¦è¾¹ç¼˜ */
.command-buttons-floating {
    position: absolute;
    left: 0;
    bottom: 0;
    display: flex;
    flex-direction: row;
    gap: clamp(2px, 1vw, 12px);
    padding: clamp(2px, 0.5vw, 8px) 0 0 clamp(2px, 0.5vw, 8px);
    z-index: 10;
    width: 50vw;
    min-width: 280px;
    max-width: 50vw;
    justify-content: space-between;
}

.command-btn {
    flex: 1 1 0;
    margin: 0;
    padding: clamp(0.5vw, 1.2vw, 1.5vw) clamp(0.3vw, 0.8vw, 1vw);
    height: clamp(60px, 8vw, 120px);
    border-radius: clamp(4px, 0.8vw, 8px);
    background: #111 !important;
    color: #fff !important;
    border: 1px solid #333;
    box-shadow: 1px 1px 4px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 0;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
}

.command-btn::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    z-index: -1;
    border-radius: clamp(4px, 0.8vw, 8px);
}

.command-btn:hover:not(.disabled) {
    background: #222 !important;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
    border-color: #666;
}

.command-btn:active:not(.disabled) {
    background: #333 !important;
    transform: translateY(0);
}

.command-btn.selected {
    background: linear-gradient(135deg, #1a3a75, #0c1f3e) !important;
    border-color: #3a6cbf;
    box-shadow: 0 0 15px rgba(58, 108, 191, 0.6);
}

.command-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* é”®ä½æç¤ºè‡ªé€‚åº” */
.command-btn .key-hint {
    position: absolute;
    top: clamp(2px, 0.5vw, 6px);
    left: clamp(2px, 0.5vw, 6px);
    background-color: rgba(0, 0, 0, 0.7);
    color: #fff;
    font-size: clamp(0.7rem, 1.5vw, 1rem);
    padding: clamp(1px, 0.3vw, 4px) clamp(3px, 0.6vw, 8px);
    border-radius: clamp(2px, 0.4vw, 4px);
    line-height: 1;
}

/* æŒ‰é’®åç§°è‡ªé€‚åº” */
.command-btn .btn-name {
    font-size: clamp(0.9rem, 2.2vw, 1.8rem);
    font-weight: bold;
    font-family: 'Ma Shan Zheng', cursive;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    text-align: center;
    line-height: 1.1;
    margin-top: clamp(2px, 0.5vw, 8px);
}

/* æˆ˜æ–—æ—¥å¿— - è‡ªé€‚åº”ä¼˜åŒ– */
.battle-log {
    height: clamp(50px, 10vw, 80px);
    background-color: rgba(0, 0, 0, 0.85);
    border-top: 1px solid #444;
    padding: clamp(6px, 1.5vw, 10px) clamp(12px, 2.5vw, 20px);
    overflow-y: auto;
    font-size: clamp(12px, 2.5vw, 16px);
    line-height: 1.4;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    position: relative;
    z-index: 10;
}

.battle-log p {
    margin-bottom: clamp(1px, 0.3vw, 4px);
    word-wrap: break-word;
}

/* ç¡®è®¤å¼¹çª— - æ‰‹æœºä¼˜åŒ– */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 100;
    align-items: center;
    justify-content: center;
    padding: 15px;
}

.modal-content {
    width: clamp(240px, 60vw, 320px);
    max-width: 85vw;
    border-radius: clamp(4px, 1vw, 8px);
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
    color: #fff;
    position: relative;
    border: 2px solid #553c28;
    overflow: hidden;
}

.modal-header {
    padding: clamp(6px, 2vw, 12px);
    background-color: rgba(0, 0, 0, 0.6);
    font-size: clamp(14px, 3.2vw, 20px);
    font-weight: bold;
    text-align: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    font-family: 'Ma Shan Zheng', cursive;
    /* æ·»åŠ é»‘è‰²æè¾¹æ•ˆæœ */
    text-shadow: 
    -1px -1px 1px #000,
    1px -1px 1px #000,
    -1px 1px 1px #000,
    1px 1px 1px #000,
    2px 2px 3px rgba(0, 0, 0, 0.8);
}

.modal-body {
    padding: clamp(8px, 2.5vw, 15px);
    font-size: clamp(12px, 2.8vw, 16px);
    text-align: center;
    line-height: 1.4;
    /* æ·»åŠ ä¸æŒ‰é’®ç›¸åŒçš„å­—ä½“æ ·å¼ */
    font-family: 'Ma Shan Zheng', cursive;
    font-weight: bold;
    color: #fff;
    /* é»‘è‰²æè¾¹æ•ˆæœ */
    text-shadow: 
        -1px -1px 1px #000,
        1px -1px 1px #000,
        -1px 1px 1px #000,
        1px 1px 1px #000,
        2px 2px 3px rgba(0, 0, 0, 0.8);
}

.modal-footer {
    padding: clamp(6px, 2vw, 12px);
    display: flex;
    justify-content: space-around;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    gap: clamp(6px, 1.5vw, 12px);
}

.modal-footer button {
    padding: clamp(4px, 1.5vw, 8px) clamp(10px, 3vw, 16px);
    border: none;
    border-radius: clamp(3px, 0.8vw, 6px);
    cursor: pointer;
    font-size: clamp(11px, 2.5vw, 14px);
    font-family: 'ZCOOL XiaoWei', sans-serif;
    transition: all 0.3s;
    flex: 1;
    min-height: clamp(24px, 5vw, 36px);
}

#confirm-action {
    background: linear-gradient(to bottom, #5c3b1c, #34210f);
    color: white;
    border: 1px solid #7c5a3d;
}

#confirm-action:hover {
    background: linear-gradient(to bottom, #6c4a2b, #3e2914);
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
}

#cancel-action {
    background: linear-gradient(to bottom, #444, #222);
    color: #ddd;
    border: 1px solid #666;
}

#cancel-action:hover {
    background: linear-gradient(to bottom, #555, #333);
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
}

/* åŠ¨ç”»æ•ˆæœ */
@keyframes attack {
    0% { transform: translateX(0); }
    25% { transform: translateX(40px); }
    50% { transform: translateX(0); }
    100% { transform: translateX(0); }
}

@keyframes enemy-attack {
    0% { transform: translateX(0); }
    25% { transform: translateX(-40px); }
    50% { transform: translateX(0); }
    100% { transform: translateX(0); }
}

@keyframes hit {
    0% { filter: brightness(1); }
    25% { filter: brightness(3) saturate(2); }
    50% { filter: brightness(1); }
    100% { filter: brightness(1); }
}

@keyframes defend {
    0% { filter: brightness(1); }
    50% { filter: brightness(1.5) hue-rotate(120deg); }
    100% { filter: brightness(1); }
}

@keyframes special {
    0% { filter: brightness(1); }
    25% { filter: brightness(2) saturate(2) hue-rotate(270deg); }
    50% { filter: brightness(1.5) saturate(1.5) hue-rotate(180deg); }
    75% { filter: brightness(2) saturate(2) hue-rotate(90deg); }
    100% { filter: brightness(1); }
}

.player-attack {
    animation: attack 0.6s ease;
}

.enemy-attack {
    animation: enemy-attack 0.6s ease;
}

.player-hit {
    animation: hit 0.6s ease;
}

.enemy-hit {
    animation: hit 0.6s ease;
}

.player-defend {
    animation: defend 1s ease;
}

.enemy-defend {
    animation: defend 1s ease;
}

.player-special {
    animation: special 1s ease;
}

.enemy-special {
    animation: special 1s ease;
}

/* ç”»é¢æ™ƒåŠ¨åŠ¨ç”» */
@keyframes shake {
  0% { transform: translate(0, 0); }
  20% { transform: translate(-10px, 0); }
  40% { transform: translate(10px, 0); }
  60% { transform: translate(-10px, 0); }
  80% { transform: translate(10px, 0); }
  100% { transform: translate(0, 0); }
}
.shake {
  animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
}

/* å—å‡»çº¢è‰²è¾¹ç¼˜é«˜äº®åŠ¨ç”» */
@keyframes damage-flash {
  0% { box-shadow: 0 0 0 0 rgba(255,0,0,0.7); }
  30% { box-shadow: 0 0 0 20px rgba(255,0,0,0.5); }
  60% { box-shadow: 0 0 0 40px rgba(255,0,0,0.2); }
  100% { box-shadow: 0 0 0 0 rgba(255,0,0,0); }
}
.damage-flash {
  animation: damage-flash 0.5s;
}

.npc-portrait-layer {
    position: absolute;
    left: 7.5%;  /* æ°´å¹³å±…ä¸­ */
    bottom: 0;  /* ç´§è´´ä¸‹è¾¹ç¼˜ */
    width: 85%; /* æ”¹ä¸º70%å¤§å° */
    height: 85%; /* æ”¹ä¸º70%å¤§å° */
    /* transform: translateX(-50%); æ°´å¹³å±…ä¸­å¯¹é½ */
    pointer-events: none;
    z-index: 3;
    background: none;
    background-position: center bottom; /* æ”¹ä¸ºåº•éƒ¨å¯¹é½ */
    background-repeat: no-repeat;
    background-size: contain; /* æ”¹ä¸ºcontainä¿æŒæ¯”ä¾‹ */
    transition: background-image 0.3s;
}

.npc-portrait-layer.shake {
    animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
}

.screen-flash {
    position: fixed;
    left: 0; top: 0; right: 0; bottom: 0;
    width: 100vw;
    height: 100vh;
    pointer-events: none;
    z-index: 1000;
    opacity: 0;
    background: rgba(255,0,0,0.3);
    box-shadow: 0 0 0 20px rgba(255,0,0,0.5), 0 0 60px 40px rgba(255,0,0,0.2) inset;
    transition: opacity 0.2s;
}

.screen-flash.active {
    opacity: 1;
    transition: opacity 0.1s;
}

#restart-game {
    background: linear-gradient(to bottom, #5c3b1c, #34210f);
    color: white;
    border: 1px solid #7c5a3d;
    padding: clamp(6px, 2vw, 12px) clamp(20px, 4vw, 32px);
    border-radius: clamp(3px, 0.8vw, 6px);
    cursor: pointer;
    font-size: clamp(12px, 2.8vw, 16px);
    font-family: 'Ma Shan Zheng', cursive;
    transition: all 0.3s;
    width: 100%;
    min-height: clamp(28px, 6vw, 40px);
}

#restart-game:hover {
    background: linear-gradient(to bottom, #6c4a2b, #3e2914);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
}

/* ç§»åŠ¨ç«¯ä¼˜åŒ– */
@media (max-width: 900px) {
    .command-buttons-floating {
        width: 70vw;
        min-width: 260px;
        gap: clamp(2px, 0.8vw, 6px);
        padding: clamp(2px, 0.4vw, 6px) 0 0 clamp(2px, 0.4vw, 6px);
    }
    
    .command-btn {
        height: clamp(45px, 9vw, 70px);
    }
    
    .command-btn .btn-name {
        font-size: clamp(0.8rem, 2.8vw, 1.1rem);
    }
    
    .command-btn .key-hint {
        font-size: clamp(0.6rem, 1.8vw, 0.9rem);
    }
}

@media (max-width: 600px) {
    .command-buttons-floating {
        width: 85vw;
        min-width: 240px;
        gap: clamp(1px, 0.5vw, 4px);
        padding: clamp(1px, 0.3vw, 4px) 0 0 clamp(1px, 0.3vw, 4px);
        flex-direction: row;
    }
    
    .command-btn {
        height: clamp(35px, 10vw, 55px);
    }
    
    .command-btn .btn-name {
        font-size: clamp(0.7rem, 3vw, 1rem);
    }
    
    .command-btn .key-hint {
        font-size: clamp(0.5rem, 2vw, 0.8rem);
    }
}

/* è¶…å¤§å±å¹•ä¼˜åŒ– */
@media (min-width: 1400px) {
    .command-buttons-floating {
        width: 45vw;
        max-width: 700px;
    }
    
    .command-btn {
        height: clamp(80px, 6vw, 100px);
    }
    
    .command-btn .btn-name {
        font-size: clamp(1.2rem, 1.8vw, 1.6rem);
    }
}

/* è¶…å°å±å¹•ä¼˜åŒ– */
@media (max-width: 480px) {
    .command-buttons-floating {
        width: 95vw;
        min-width: 200px;
        gap: clamp(1px, 0.2vw, 2px);
        padding: 2px 0 0 2px;
        flex-direction: row;
    }
    
    .command-btn {
        height: clamp(30px, 11vw, 45px);
        padding: clamp(0.2vw, 0.8vw, 1vw) clamp(0.1vw, 0.4vw, 0.6vw);
    }
    
    .command-btn .btn-name {
        font-size: clamp(0.6rem, 3.5vw, 0.9rem);
    }
    
    .command-btn .key-hint {
        font-size: clamp(0.4rem, 2.8vw, 0.7rem);
        padding: clamp(0.5px, 0.1vw, 2px) clamp(2px, 0.3vw, 4px);
    }
}

/* æ¨ªå±æ‰‹æœºä¼˜åŒ– */
@media (max-width: 900px) and (orientation: landscape) {
    .battle-scene {
        padding-bottom: clamp(60px, 10vw, 100px);
    }
    
    .command-btn {
        height: clamp(30px, 6vw, 50px);
    }
    
    .turn-indicator {
        top: 0;
    }
}

/* ç»Ÿä¸€çš„å¼¹çª—æŒ‰é’®é£æ ¼ */
.modal-actions {
    display: flex;
    gap: clamp(8px, 2vw, 14px);
    justify-content: center;
    padding: clamp(8px, 2vw, 14px);
    background: rgba(0,0,0,0.4);
    border-top: 1px solid rgba(255,255,255,0.18);
}

/* é“å…·å¼¹çª—æ ·å¼ - å…¨å±è¦†ç›–game-containerï¼Œç´§å‡‘å¸ƒå±€ç¡®ä¿4ä¸ªé“å…·åŒå±æ˜¾ç¤º */
#item-modal {
    position: absolute !important;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    z-index: 100;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 0;
}

.item-modal-content {
    width: 100%;
    height: 100%;
    max-width: 100%;
    max-height: 100%;
    border-radius: 0;
    box-shadow: none;
    color: #fff;
    position: relative;
    border: none;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    background-color: rgba(20, 15, 10, 0.98);
    background-size: cover;
    background-position: center;
}

.item-modal-header {
    padding: 1.5vh 2vw;
    background-color: rgba(0, 0, 0, 0.6);
    font-size: clamp(0.9rem, 2.5vw, 1.4rem);
    font-weight: bold;
    text-align: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.25);
    font-family: 'Ma Shan Zheng', cursive;
    text-shadow:
        -1px -1px 1px #000,
        1px -1px 1px #000,
        -1px 1px 1px #000,
        1px 1px 1px #000,
        2px 2px 3px rgba(0, 0, 0, 0.8);
    flex-shrink: 0;
}

.item-list {
    padding: 1.5vh 3vw;
    display: flex;
    flex-direction: column;
    gap: 1.5vh;
    flex: 1;
    overflow: hidden;
    justify-content: space-evenly;
}

.item-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.2vh 2.5vw;
    background: rgba(0, 0, 0, 0.6);
    border-radius: 0.6vw;
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: all 0.15s ease;
    flex: 1;
    max-height: 16vh;
    min-height: 0;
}

.item-row:hover {
    background: rgba(60, 50, 30, 0.7);
    border-color: rgba(255, 200, 100, 0.5);
}

.item-row.disabled {
    opacity: 0.5;
    pointer-events: none;
}

.item-info {
    display: flex;
    flex-direction: column;
    gap: 0.3vh;
    flex: 1;
    min-width: 0;
}

.item-name {
    font-size: clamp(0.85rem, 2.2vw, 1.2rem);
    font-weight: bold;
    font-family: 'Ma Shan Zheng', cursive;
    color: #ffd700;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.item-desc {
    font-size: clamp(0.6rem, 1.5vw, 0.85rem);
    color: #bbb;
    font-family: 'ZCOOL XiaoWei', sans-serif;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.item-count {
    font-size: clamp(0.8rem, 2vw, 1.1rem);
    color: #88ff88;
    font-weight: bold;
    min-width: 5vw;
    text-align: center;
    margin: 0 1.5vw;
    flex-shrink: 0;
}

.item-count.empty {
    color: #ff6666;
}

.item-use-btn {
    padding: 0.8vh 2.5vw;
    background: linear-gradient(135deg, #5c3b1c, #34210f);
    color: #fff;
    border: 1px solid #7c5a3d;
    border-radius: 0.5vw;
    font-size: clamp(0.75rem, 1.8vw, 1rem);
    font-family: 'Ma Shan Zheng', cursive;
    cursor: pointer;
    transition: all 0.15s ease;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.6);
    white-space: nowrap;
    flex-shrink: 0;
}

.item-use-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, #7c5b3c, #4e3020);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
}

.item-use-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

.item-modal-footer {
    padding: 1.5vh 2vw;
    background: rgba(0, 0, 0, 0.5);
    border-top: 1px solid rgba(255, 255, 255, 0.15);
    text-align: center;
    flex-shrink: 0;
}

.item-close-btn {
    padding: 1vh 5vw;
    background: linear-gradient(135deg, #444, #222);
    color: #ddd;
    border: 1px solid #666;
    border-radius: 0.5vw;
    font-size: clamp(0.8rem, 2vw, 1.1rem);
    font-family: 'Ma Shan Zheng', cursive;
    cursor: pointer;
    transition: all 0.15s ease;
}

.item-close-btn:hover {
    background: linear-gradient(135deg, #555, #333);
}

/* é“å…·ä½¿ç”¨æç¤ºæ ·å¼ */
.item-used-hint {
    padding: 2vh 3vw;
    background: rgba(100, 60, 20, 0.9);
    border: 1px solid #ffd700;
    border-radius: 0.6vw;
    text-align: center;
    font-family: 'Ma Shan Zheng', cursive;
    font-size: clamp(0.9rem, 2.2vw, 1.2rem);
    color: #ffd700;
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* æ¨ªå±å’Œå°å±å¹•ä¸‹çš„é“å…·å¼¹çª—ä¼˜åŒ– */
@media (max-height: 500px) {
    .item-modal-header {
        padding: 0.8vh 2vw;
        font-size: clamp(0.8rem, 2vw, 1rem);
    }
    
    .item-list {
        padding: 0.8vh 2vw;
        gap: 0.8vh;
    }
    
    .item-row {
        padding: 0.6vh 2vw;
        max-height: 20vh;
    }
    
    .item-name {
        font-size: clamp(0.75rem, 1.8vw, 1rem);
    }
    
    .item-desc {
        font-size: clamp(0.55rem, 1.2vw, 0.75rem);
    }
    
    .item-use-btn {
        padding: 0.5vh 2vw;
        font-size: clamp(0.65rem, 1.5vw, 0.85rem);
    }
    
    .item-modal-footer {
        padding: 0.8vh 2vw;
    }
    
    .item-close-btn {
        padding: 0.6vh 4vw;
        font-size: clamp(0.7rem, 1.6vw, 0.9rem);
    }
}

/* æå°å±å¹•ä¼˜åŒ– */
@media (max-height: 400px) {
    .item-modal-header {
        padding: 0.5vh 1.5vw;
    }
    
    .item-list {
        padding: 0.5vh 1.5vw;
        gap: 0.5vh;
    }
    
    .item-row {
        padding: 0.4vh 1.5vw;
    }
    
    .item-info {
        gap: 0;
    }
    
    .item-modal-footer {
        padding: 0.5vh 1.5vw;
    }
}
.modal-actions .btn {
    min-width: clamp(90px, 20vw, 160px);
    padding: clamp(8px, 1.8vw, 12px) clamp(14px, 2.8vw, 22px);
    border-radius: clamp(6px, 1vw, 10px);
    border: 1px solid rgba(255,255,255,0.25);
    font-family: 'Ma Shan Zheng', cursive;
    font-weight: bold;
    color: #fff;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.35);
    transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
}
.modal-actions .btn:hover { transform: translateY(-2px); filter: brightness(1.05); box-shadow: 0 8px 18px rgba(0,0,0,0.45); }
.modal-actions .btn:active { transform: translateY(0); }
.modal-actions .btn.btn-cancel { background: linear-gradient(135deg, #2b2b2b 0%, #1a1a1a 100%); border-color: #555; }
.modal-actions .btn.btn-danger { background: linear-gradient(135deg, #C62828 0%, #8E0000 100%); border-color: #ff6b6b; }
.modal-actions .btn.btn-danger:hover { box-shadow: 0 8px 20px rgba(198,40,40,0.5); }

</style>
</head>
<body>
    <div class="game-container">
        <!-- //å›åˆåˆ¶ç³»ç»Ÿé›†æˆæ›´æ–° - æ·»åŠ æ‰‹åŠ¨é€€å‡ºæŒ‰é’® -->
        <button class="exit-battle-btn" onclick="confirmExitBattle()">é€€å‡ºæˆ˜æ–—</button>
        
        <div class="npc-portrait-layer"></div>
        <div class="screen-flash"></div>
        <!-- æˆ˜æ–—åœºæ™¯ -->
        <div class="battle-scene">
 
            <!-- ç©å®¶çŠ¶æ€åŒº -->
            <div class="player-status-area">
                <div class="character-name" id="player-name">user</div>
                <div class="health-container">
                    <div class="health-bar">
                        <div class="health-fill" id="player-health"></div>
                    </div>
                    <div class="health-text">
                        <span id="player-health-value">50</span>/<span id="player-max-health">50</span>
                    </div>
                </div>
                <div class="energy-display">
                    <div class="energy-value"><span id="player-energy">0</span>/10</div>
                    <div class="energy-icon">âš¡</div>
                </div>
                <div class="taunt-status" id="player-taunt-status">ğŸ”¥ æŒ‘è¡…ä¸­</div>
            </div>

            <!-- æ•ŒäººçŠ¶æ€åŒº -->
            <div class="enemy-status-area">
                <div class="character-name" id="enemy-name">åŒ—æ¡</div>
                <div class="health-container">
                    <div class="health-bar">
                        <div class="health-fill" id="enemy-health"></div>
                    </div>
                    <div class="health-text">
                        <span id="enemy-health-value">50</span>/<span id="enemy-max-health">50</span>
                    </div>
                </div>
                <div class="energy-display">
                    <div class="energy-value"><span id="enemy-energy">0</span>/10</div>
                    <div class="energy-icon">âš¡</div>
                </div>
                <div class="taunt-status" id="enemy-taunt-status">ğŸ”¥ æŒ‘è¡…ä¸­</div>
            </div>

            <!-- å›åˆæŒ‡ç¤ºå™¨ -->
            <div class="turn-indicator">
                <div id="turn-text">ç¬¬1å›åˆ</div>
            </div>

            <!-- å·¦ä¾§ç©å®¶è§’è‰² -->
            <div class="character player-character"></div>

            <!-- å³ä¾§æ•Œæ–¹è§’è‰² -->
            <div class="character enemy-character"></div>

            <!-- æˆ˜æ–—å‘½ä»¤åŒºåŸŸ -->
            <div class="command-buttons-floating">
                <div class="command-btn" id="gather" data-key="Q">
                    <div class="key-hint">Q</div>
                    <div class="btn-name">é›†æ°”</div>
                </div>
                <div class="command-btn" id="defend" data-key="W">
                    <div class="key-hint">W</div>
                    <div class="btn-name">é˜²å¾¡</div>
                </div>
                <div class="command-btn" id="light-attack" data-key="E">
                    <div class="key-hint">E</div>
                    <div class="btn-name">è½»æ”»å‡»</div>
                </div>
                <div class="command-btn" id="heavy-attack" data-key="R">
                    <div class="key-hint">R</div>
                    <div class="btn-name">é‡æ”»å‡»</div>
                </div>
                <div class="command-btn" id="special" data-key="F">
                    <div class="key-hint">T</div>
                    <div class="btn-name">ç»æ‹›</div>
                </div>
                <div class="command-btn" id="taunt" data-key="C">
                    <div class="key-hint">Y</div>
                    <div class="btn-name">å˜´ç‚®</div>
                </div>
                <div class="command-btn" id="item" data-key="U">
                    <div class="key-hint">U</div>
                    <div class="btn-name">é“å…·</div>
                </div>
            </div>
        </div>

        <!-- æˆ˜æ–—æ—¥å¿— -->
        <div class="battle-log" id="battle-log">
            <p>æˆ˜æ–—å¼€å§‹ï¼Œè¯·é€‰æ‹©è¡ŒåŠ¨...</p>
        </div>
        
        <!-- ç¡®è®¤å¼¹çª— -->
        <div id="confirm-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">ç¡®è®¤è¡ŒåŠ¨</div>
                <div class="modal-body" id="confirm-body">
                    ä½ ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ
                    <div id="selected-action" style="margin-top:8px;"></div>
                </div>
                <div class="modal-actions">
                    <button id="cancel-action" class="btn btn-cancel">è¿”å›æˆ˜æ–—</button>
                    <button id="confirm-action" class="btn btn-danger">ç¡®è®¤è¡ŒåŠ¨</button>
                 </div>
             </div>
         </div>

        <!-- é€€å‡ºæˆ˜æ–—ç¡®è®¤ï¼ˆå…¨å±å›ºå®šï¼‰ -->
        <div id="exit-battle-overlay" class="modal" style="z-index:1000;">
            <div class="modal-content">
                <div class="modal-header">ç¡®è®¤é€€å‡º</div>
                <div class="modal-body">ç¡®å®šè¦é€€å‡ºæˆ˜æ–—å—ï¼Ÿ</div>
                <div class="modal-actions">
                    <button class="btn btn-cancel" onclick="document.getElementById('exit-battle-overlay').style.display='none'">è¿”å›æˆ˜æ–—</button>
                    <button class="btn btn-danger" onclick="exitBattle('quit')">ç¡®è®¤é€€å‡º</button>
                 </div>
             </div>
         </div>

        <!-- æ¸¸æˆç»“æŸå¼¹çª— -->
        <div id="game-over-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header" id="game-over-title">æ¸¸æˆç»“æŸ</div>
                <div class="modal-body" id="game-over-message">
                    æ¸¸æˆç»“æŸä¿¡æ¯
                </div>
                <div class="modal-footer" id="game-over-footer">
                    <button id="restart-game">é‡æ–°å¼€å§‹</button>
                </div>
            </div>
        </div>

        <!-- é“å…·é€‰æ‹©å¼¹çª— -->
        <div id="item-modal" class="modal">
            <div class="item-modal-content">
                <div class="item-modal-header">é€‰æ‹©é“å…·</div>
                <div class="item-list" id="item-list">
                    <!-- é“å…·åˆ—è¡¨å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="item-modal-footer">
                    <button class="item-close-btn" onclick="closeItemModal()">è¿”å›æˆ˜æ–—</button>
                </div>
            </div>
        </div>
    </div>
    <script>
// //å›åˆåˆ¶ç³»ç»Ÿé›†æˆæ›´æ–° - è·å–URLå‚æ•°
const urlParams = new URLSearchParams(window.location.search);

// é“å…·ç³»ç»Ÿå˜é‡
const battleItems = {
    daliwan: parseInt(urlParams.get('daliwan')) || 5,      // å¤§åŠ›ä¸¸
    jingutie: parseInt(urlParams.get('jingutie')) || 5,    // ç­‹éª¨è´´
    jinchuangyao: parseInt(urlParams.get('jinchuangyao')) || 5,  // é‡‘ç–®è¯
    piliwan: parseInt(urlParams.get('piliwan')) || 5       // éœ¹é›³ä¸¸
};

// é“å…·ä½¿ç”¨çŠ¶æ€
let itemUsedThisBattle = false;  // æœ¬åœºæˆ˜æ–—æ˜¯å¦å·²ä½¿ç”¨é“å…·
let usedItemKey = null;          // ä½¿ç”¨çš„é“å…·ç±»å‹
let damageMultiplier = 1.0;      // ä¼¤å®³å€ç‡ï¼ˆå¤§åŠ›ä¸¸æ•ˆæœï¼‰
let defenseMultiplier = 1.0;     // é˜²å¾¡å€ç‡ï¼ˆç­‹éª¨è´´æ•ˆæœï¼‰

// é“å…·é…ç½®
const itemConfig = {
    daliwan: {
        name: 'å¤§åŠ›ä¸¸',
        desc: 'æœ¬åœºæˆ˜æ–—æ‰€æœ‰ä¼¤å®³Ã—1.25',
        effect: () => {
            damageMultiplier = 1.25;
            addLog('ã€é“å…·ã€‘æœç”¨å¤§åŠ›ä¸¸ï¼Œæ”»å‡»åŠ›å¤§å¢ï¼');
        }
    },
    jingutie: {
        name: 'ç­‹éª¨è´´',
        desc: 'æœ¬åœºæˆ˜æ–—æ‰€å—ä¼¤å®³Ã·1.25',
        effect: () => {
            defenseMultiplier = 1.25;
            addLog('ã€é“å…·ã€‘è´´ä¸Šç­‹éª¨è´´ï¼Œé˜²å¾¡åŠ›æå‡ï¼');
        }
    },
    jinchuangyao: {
        name: 'é‡‘ç–®è¯',
        desc: 'ç«‹å³æ¢å¤30%æœ€å¤§ç”Ÿå‘½å€¼',
        effect: () => {
            const healAmount = Math.round(gameState.player.maxHealth * 0.3);
            gameState.player.currentHealth = Math.min(
                gameState.player.currentHealth + healAmount,
                gameState.player.maxHealth
            );
            addLog(`ã€é“å…·ã€‘ä½¿ç”¨é‡‘ç–®è¯ï¼Œæ¢å¤${healAmount}ç‚¹ç”Ÿå‘½ï¼`);
            updateDisplay();
        }
    },
    piliwan: {
        name: 'éœ¹é›³ä¸¸',
        desc: 'ç«‹å³å¯¹æ•Œäººé€ æˆ1.5å€æ”»å‡»ä¼¤å®³',
        effect: () => {
            const damage = Math.round(gameState.player.basicDamage * 1.5);
            gameState.enemy.currentHealth -= damage;
            if (gameState.enemy.currentHealth < 0) gameState.enemy.currentHealth = 0;
            addLog(`ã€é“å…·ã€‘æŠ•æ·éœ¹é›³ä¸¸ï¼Œå¯¹${gameState.enemy.name}é€ æˆ${damage}ç‚¹ä¼¤å®³ï¼`);
            
            // è§¦å‘æ•Œäººå—å‡»åŠ¨ç”»
            const npcPortraitLayer = document.querySelector('.npc-portrait-layer');
            npcPortraitLayer.classList.add('shake');
            setTimeout(() => {
                npcPortraitLayer.classList.remove('shake');
            }, 400);
            
            updateDisplay();
            
            // æ£€æŸ¥æ˜¯å¦å‡»æ€æ•Œäºº
            if (gameState.enemy.currentHealth <= 0) {
                setTimeout(() => {
                    checkGameOver();
                }, 500);
            }
        }
    }
};

// //å›åˆåˆ¶ç³»ç»Ÿé›†æˆæ›´æ–° - ç©å®¶ä¿¡æ¯ä»URLå‚æ•°è·å–
const PLAYER_INFO = {
    name: urlParams.get('playerName') || 'ä½ ',
    maxHealth: parseInt(urlParams.get('playerHealth')) || 500,
    currentHealth: parseInt(urlParams.get('playerHealth')) || 500,
    energy: 0,
    maxEnergy: 10,
    selectedAction: null,
    basicDamage: parseInt(urlParams.get('playerAttack')) || 20,
    tauntedTurns: 0  // æŒ‘è¡…çŠ¶æ€å‰©ä½™å›åˆæ•°
};

// //å›åˆåˆ¶ç³»ç»Ÿé›†æˆæ›´æ–° - æ„å»ºæ•Œæ–¹ä¿¡æ¯æ–‡æœ¬
const enemyInfoText = `
å‘èµ·æˆ˜æ–—ï¼Œæ•Œæ–¹ä¿¡æ¯å¦‚ä¸‹
name: ${urlParams.get('enemyName') || 'ç¥ç§˜æ‚å½¹'}
  maxHealth: ${urlParams.get('enemyMaxHealth') || 'æä½'}
  basicDamage: ${urlParams.get('enemyBasicDamage') || 'æä½'}
`;

// æ¸¸æˆä¸»èƒŒæ™¯å’Œå¼¹çª—èƒŒæ™¯å›¾ç‰‡é“¾æ¥
const GAME_BG_URL = urlParams.get('backgroundUrl') || 'https://files.catbox.moe/4qg2k3.png';
const MODAL_BG_URL = 'https://files.catbox.moe/jabi3y.jpg';


// ç”Ÿå‘½å€¼å’Œä¼¤å®³ç­‰çº§æ˜ å°„
const healthMap = { 'æä½': 25,'ä½': 50, 'ä¸­':100, 'é«˜': 175, 'æé«˜': 275 };
const damageMap = { 'æä½': 10,'ä½': 20, 'ä¸­': 40, 'é«˜': 70, 'æé«˜': 120 };
const styles = ['é£', 'ç«', 'æ—', 'å±±'];

// åŠ æƒéšæœºé€‰æ‹©å‡½æ•°
function weightedRandom(options, debugInfo = null) {
    // options: { 'action': weight, ... }
    const entries = Object.entries(options);
    const totalWeight = entries.reduce((sum, [, weight]) => sum + weight, 0);
    const rollValue = Math.random() * totalWeight;
    let remaining = rollValue;
    
    // å¦‚æœéœ€è¦è°ƒè¯•è¾“å‡º
    if (debugInfo) {
        const actionNames = {
            'gather': 'é›†æ°”',
            'defend': 'é˜²å¾¡',
            'light-attack': 'è½»æ”»å‡»',
            'heavy-attack': 'é‡æ”»å‡»',
            'special': 'ç»æ‹›',
            'taunt': 'å˜´ç‚®'
        };
        const probabilities = entries.map(([action, weight]) => {
            const probability = (weight / totalWeight * 100).toFixed(1);
            return `${actionNames[action] || action}(${probability}%)`;
        });
        console.log(`[AIç­–ç•¥] é£æ ¼: ${debugInfo.style}, èƒ½é‡èŒƒå›´: ${debugInfo.energyKey}`);
        console.log(`[AIç­–ç•¥] å‚ä¸åŠ æƒçš„è¡ŒåŠ¨: ${probabilities.join(', ')}`);
        console.log(`[AIç­–ç•¥] Rollç‚¹: ${rollValue.toFixed(2)} / ${totalWeight} (${(rollValue / totalWeight * 100).toFixed(1)}%)`);
    }
    
    for (const [action, weight] of entries) {
        remaining -= weight;
        if (remaining <= 0) {
            if (debugInfo) {
                const actionNames = {
                    'gather': 'é›†æ°”',
                    'defend': 'é˜²å¾¡',
                    'light-attack': 'è½»æ”»å‡»',
                    'heavy-attack': 'é‡æ”»å‡»',
                    'special': 'ç»æ‹›',
                    'taunt': 'å˜´ç‚®'
                };
                console.log(`[AIç­–ç•¥] é€‰æ‹©ç»“æœ: ${actionNames[action] || action}`);
            }
            return action;
        }
    }
    // å…œåº•è¿”å›ç¬¬ä¸€ä¸ªé€‰é¡¹
    if (debugInfo) {
        console.log(`[AIç­–ç•¥] é€‰æ‹©ç»“æœ(å…œåº•): ${entries[0][0]}`);
    }
    return entries[0][0];
}

// é£æ ¼ç­–ç•¥é…ç½®ï¼šåŸºäºèƒ½é‡èŒƒå›´çš„æ¦‚ç‡åˆ†å¸ƒ
const STYLE_STRATEGIES = {
    'é£': {
        // é£æ ¼ï¼šå¿«æ”»å‹ï¼Œåå¥½è½»æ”»å‡»å’Œå˜´ç‚®ç ´é˜²
        0: { 'gather': 100},
        1: { 'gather': 25, 'taunt': 30, 'light-attack': 45 },
        '2-4': { 'gather': 10, 'taunt': 25, 'light-attack': 45, 'heavy-attack': 20 },
        '5+': { 'gather': 10, 'taunt': 5, 'light-attack': 30, 'heavy-attack': 20, 'special': 35 }
    },
    'ç«': {
        // ç«æ ¼ï¼šçˆ†å‘å‹ï¼Œåå¥½é‡æ”»å‡»
        0: { 'gather': 100},
        1: { 'gather': 50, 'taunt': 15, 'light-attack': 35 },
        '2-4': { 'gather': 20, 'taunt': 5, 'light-attack': 20, 'heavy-attack': 55 },
        '5+': { 'gather': 10, 'taunt': 5, 'light-attack': 10, 'heavy-attack': 35, 'special': 40 }
    },
    'æ—': {
        // æ—æ ¼ï¼šè“„åŠ›å‹ï¼Œåå¥½é›†æ°”å’Œç»æ‹›
        0: { 'gather': 100},
        1: { 'gather': 75, 'taunt': 10, 'light-attack': 15 },
        '2-4': { 'gather': 60, 'taunt': 10, 'light-attack': 15, 'heavy-attack': 15 },
        '5+': { 'gather': 10, 'taunt': 5, 'light-attack': 10, 'heavy-attack': 15, 'special': 60}
    },
    'å±±': {
        // å±±æ ¼ï¼šé˜²å®ˆå‹ï¼ˆé˜²å¾¡åœ¨ç‹¬ç«‹é˜¶æ®µå¤„ç†ï¼‰
        0: { 'gather': 100},
        1: { 'gather': 50, 'taunt': 10, 'light-attack': 40 },
        '2-4': { 'gather': 50, 'taunt': 5, 'light-attack': 20, 'heavy-attack': 25 },
        '5+': { 'gather': 10, 'taunt': 5, 'light-attack': 15, 'heavy-attack': 20, 'special': 50 }
    }
};

// æ ¹æ®èƒ½é‡è·å–å¯¹åº”çš„ç­–ç•¥é…ç½®
function getEnergyRangeKey(energy) {
    if (energy === 0) return 0;
    if (energy === 1) return 1;
    if (energy >= 2 && energy <= 4) return '2-4';
    return '5+';
}

// ç‰¹æ®ŠNPCä¿¡æ¯
const commonNPCs = {
    'ç ´é˜µå­': {
        name: 'ç ´é˜µå­',
        maxHealth: 200,
        basicDamage: 140,
        style: 'ç«',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/ç ´é˜µå­.png'
    },
    'æ´åº­å›': {
        name: 'æ´åº­å›',
        maxHealth: 275,
        basicDamage: 100,
        style: 'æ—',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/æ´åº­å›.png'
    },
    'è‹“é›ªå¦ƒ': {
        name: 'è‹“é›ªå¦ƒ',
        maxHealth: 250,
        basicDamage: 160,
        style: 'é£',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/è‹“é›ªå¦ƒ.png'
    },    
    'ç„å¤©é’': {
        name: 'ç„å¤©é’',
        maxHealth: 300,
        basicDamage: 60,
        style: 'å±±',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/ç„å¤©é’.png'
    },
    'é’±å¡˜å›': {
        name: 'é’±å¡˜å›',
        maxHealth: 150,
        basicDamage: 100,
        style: 'ç«',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/é’±å¡˜å›.png'
    },
    'è§ç™½ç‘š': {
        name: 'è§ç™½ç‘š',
        maxHealth: 125,
        basicDamage: 60,
        style: 'é£',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/è§ç™½ç‘š.png'
    },
    'å§¬å§’': {
        name: 'å§¬å§’',
        maxHealth: 350,
        basicDamage: 70,
        style: 'å±±',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/å§¬å§’.png'
    },
    'æ–½å»¶å¹´': {
        name: 'æ–½å»¶å¹´',
        maxHealth: 200,
        basicDamage: 50,
        style: 'å±±',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/æ–½å»¶å¹´.png'
    },
    'å‘¼å»¶æ˜¾': {
        name: 'å‘¼å»¶æ˜¾',
        maxHealth: 200,
        basicDamage: 100,
        style: 'æ—',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/å‘¼å»¶æ˜¾.png'
    },
    'é›¨çƒ›': {
        name: 'é›¨çƒ›',
        maxHealth: 100,
        basicDamage: 90,
        style: 'é£',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/é›¨çƒ›.png'
    },
    'å®‰æ…•': {
        name: 'å®‰æ…•',
        maxHealth: 75,
        basicDamage: 110,
        style: 'ç«',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/å®‰æ…•.png'
    },
    'å”æ²æ¢¨': {
        name: 'å”æ²æ¢¨',
        maxHealth: 175,
        basicDamage: 80,
        style: 'é£',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/å”æ²æ¢¨.png'
    },
    'æ´›æ½œå¹½': {
        name: 'æ´›æ½œå¹½',
        maxHealth: 50,
        basicDamage: 20,
        style: 'å±±',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/æ´›æ½œå¹½.png'
    },
    'ç¥ç§˜æ‚å½¹': {
        name: 'ç¥ç§˜æ‚å½¹',
        maxHealth: 75,
        basicDamage: 300,
        style: 'é£',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/ç¥ç§˜æ‚å½¹.png'
    },
    'é¹¿æ¤¿è‹¥': {
        name: 'é¹¿æ¤¿è‹¥',
        maxHealth: 150,
        basicDamage: 30,
        style: 'æ—',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/é¹¿æ¤¿è‹¥.png'
    }
};

const genericNPCPortraits = [
    'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/æ‚é±¼1.png',  // å ä½é“¾æ¥1
    'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/æ‚é±¼2.png',  // å ä½é“¾æ¥2
    'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/æ‚é±¼3.png'   // å ä½é“¾æ¥3
];

// è§£ææ•Œæ–¹ä¿¡æ¯çš„å‡½æ•°
function parseEnemyInfo(text) {
    // æå–åç§°
    const nameMatch = text.match(/name:\s*([^\n]+)/);
    const npcName = nameMatch ? nameMatch[1].trim() : '';
    clearEnemyPortrait();
    
    // è·å–éš¾åº¦å‚æ•°
    const currentDifficulty = urlParams.get('difficulty') || 'normal';
    
    // ä¼˜å…ˆæŸ¥æ‰¾å¸¸è§NPC
    if (npcName && commonNPCs[npcName]) {
        const npc = commonNPCs[npcName];
        // æ›´æ–°æ•Œäººç«‹ç»˜
        updateEnemyPortrait(npc.portrait);
        
        // æ ¹æ®éš¾åº¦è°ƒæ•´å±æ€§
        let maxHealth = npc.maxHealth;
        let basicDamage = npc.basicDamage;
        
        if (currentDifficulty === 'normal') {
            maxHealth = Math.round(maxHealth * 1.25);
            basicDamage = Math.round(basicDamage * 1.25);
        } else if (currentDifficulty === 'hard') {
            maxHealth = Math.round(maxHealth * 1.5);
            basicDamage = Math.round(basicDamage * 1.5);
        }
        
        return {
            name: npc.name,
            maxHealth: maxHealth,
            currentHealth: maxHealth,
            energy: 0,
            maxEnergy: 10,
            selectedAction: null,
            basicDamage: basicDamage,
            style: npc.style,
            tauntedTurns: 0  // æŒ‘è¡…çŠ¶æ€å‰©ä½™å›åˆæ•°
        };
    }

    // æ²¡æœ‰åŒ¹é…åˆ°å¸¸è§NPCï¼Œä¸ºæ™®é€šNPCéšæœºé€‰æ‹©ç«‹ç»˜
    const randomPortrait = genericNPCPortraits[Math.floor(Math.random() * genericNPCPortraits.length)];
    updateEnemyPortrait(randomPortrait);
    
    // èµ°åŸæœ‰è§£æé€»è¾‘ï¼Œé£æ ¼éšæœº
    const maxHealthMatch = text.match(/maxHealth:\s*([^\n]+)/);
    const basicDamageMatch = text.match(/basicDamage:\s*([^\n]+)/);
    
    let baseHealth = maxHealthMatch ? healthMap[maxHealthMatch[1].trim()] || 80 : 80;
    let baseDamage = basicDamageMatch ? damageMap[basicDamageMatch[1].trim()] || 30 : 30;
    
    // æ ¹æ®éš¾åº¦è°ƒæ•´å±æ€§
    if (currentDifficulty === 'normal') {
        baseHealth = Math.round(baseHealth * 1.25);
        baseDamage = Math.round(baseDamage * 1.25);
    } else if (currentDifficulty === 'hard') {
        baseHealth = Math.round(baseHealth * 1.5);
        baseDamage = Math.round(baseDamage * 1.5);
    }
    
    return {
        name: npcName,
        maxHealth: baseHealth,
        currentHealth: baseHealth,
        energy: 0,
        maxEnergy: 10,
        selectedAction: null,
        basicDamage: baseDamage,
        style: styles[Math.floor(Math.random() * styles.length)],
        tauntedTurns: 0  // æŒ‘è¡…çŠ¶æ€å‰©ä½™å›åˆæ•°
    };
}

// æ›´æ–°æ•Œäººç«‹ç»˜
function updateEnemyPortrait(portraitUrl) {
    const npcPortraitLayer = document.querySelector('.npc-portrait-layer');
    npcPortraitLayer.style.backgroundImage = `url('${portraitUrl}')`;
}

// æ¸…é™¤æ•Œäººç«‹ç»˜
function clearEnemyPortrait() {
    const npcPortraitLayer = document.querySelector('.npc-portrait-layer');
    npcPortraitLayer.style.backgroundImage = '';
}

// //å›åˆåˆ¶ç³»ç»Ÿé›†æˆæ›´æ–° - é€€å‡ºæˆ˜æ–—
function exitBattle(result) {
    // å‘çˆ¶çª—å£å‘é€æˆ˜æ–—ç»“æœå’Œé“å…·æ¶ˆè€—ä¿¡æ¯
    if (window.parent !== window) {
        window.parent.postMessage({
            type: 'battle-exit',
            result: result, // 'victory' æˆ– 'defeat' æˆ– 'quit'
            itemUsed: usedItemKey,  // ä½¿ç”¨çš„é“å…·ç±»å‹
            remainingItems: battleItems  // å‰©ä½™é“å…·æ•°é‡
        }, '*');
    }
}

// æ‰“å¼€é“å…·å¼¹çª—
function openItemModal() {
    // å¦‚æœä¸æ˜¯ç©å®¶å›åˆæˆ–æ­£åœ¨ç­‰å¾…ç¡®è®¤ï¼Œè¿”å›
    if (gameState.currentTurn !== 'player' || gameState.waitingForConfirmation) return;
    
    const itemModal = document.getElementById('item-modal');
    const itemList = document.getElementById('item-list');
    
    // æ¸…ç©ºåˆ—è¡¨
    itemList.innerHTML = '';
    
    // å¦‚æœæœ¬åœºæˆ˜æ–—å·²ä½¿ç”¨é“å…·ï¼Œæ˜¾ç¤ºæç¤º
    if (itemUsedThisBattle) {
        itemList.innerHTML = `
            <div class="item-used-hint">
                æœ¬åœºæˆ˜æ–—å·²ä½¿ç”¨è¿‡é“å…·ï¼Œæ— æ³•å†æ¬¡ä½¿ç”¨
            </div>
        `;
    } else {
        // ç”Ÿæˆé“å…·åˆ—è¡¨
        for (const [key, config] of Object.entries(itemConfig)) {
            const count = battleItems[key];
            const isEmpty = count <= 0;
            
            const itemRow = document.createElement('div');
            itemRow.className = `item-row${isEmpty ? ' disabled' : ''}`;
            itemRow.innerHTML = `
                <div class="item-info">
                    <div class="item-name">${config.name}</div>
                    <div class="item-desc">${config.desc}</div>
                </div>
                <div class="item-count${isEmpty ? ' empty' : ''}">Ã—${count}</div>
                <button class="item-use-btn" ${isEmpty ? 'disabled' : ''} onclick="useItem('${key}')">ä½¿ç”¨</button>
            `;
            itemList.appendChild(itemRow);
        }
    }
    
    itemModal.style.display = 'flex';
}

// å…³é—­é“å…·å¼¹çª—
function closeItemModal() {
    const itemModal = document.getElementById('item-modal');
    itemModal.style.display = 'none';
}

// ä½¿ç”¨é“å…·
function useItem(itemKey) {
    if (itemUsedThisBattle) {
        addLog('æœ¬åœºæˆ˜æ–—å·²ä½¿ç”¨è¿‡é“å…·ï¼');
        return;
    }
    
    if (battleItems[itemKey] <= 0) {
        addLog('è¯¥é“å…·æ•°é‡ä¸è¶³ï¼');
        return;
    }
    
    // æ¶ˆè€—é“å…·
    battleItems[itemKey]--;
    itemUsedThisBattle = true;
    usedItemKey = itemKey;
    
    // å…³é—­å¼¹çª—
    closeItemModal();
    
    // æ‰§è¡Œé“å…·æ•ˆæœ
    const config = itemConfig[itemKey];
    if (config && config.effect) {
        config.effect();
    }
    
    // ç¦ç”¨é“å…·æŒ‰é’®
    const itemBtn = document.getElementById('item');
    if (itemBtn) {
        itemBtn.classList.add('disabled');
    }
}

// //å›åˆåˆ¶ç³»ç»Ÿé›†æˆæ›´æ–° - ç¡®è®¤é€€å‡ºæˆ˜æ–—
function confirmExitBattle() {
    const ov = document.getElementById('exit-battle-overlay');
    if (ov) { ov.style.display = 'flex'; }
}

const playerNameDisplay = document.getElementById('player-name');
const enemyNameDisplay = document.getElementById('enemy-name');
// æ¸¸æˆçŠ¶æ€å¯¹è±¡
const gameState = {
    currentTurn: 'player',
    turnNumber: 1, // æ·»åŠ å›åˆè®¡æ•°å™¨
    waitingForConfirmation: false,
    player: { ...PLAYER_INFO },
    enemy: parseEnemyInfo(enemyInfoText)
};

// è·å–DOMå…ƒç´ 
const playerHealthBar = document.getElementById('player-health');
const enemyHealthBar = document.getElementById('enemy-health');
const playerHealthValue = document.getElementById('player-health-value');
const enemyHealthValue = document.getElementById('enemy-health-value');
const playerMaxHealth = document.getElementById('player-max-health'); // æ–°å¢
const enemyMaxHealth = document.getElementById('enemy-max-health'); // æ–°å¢
const playerEnergyDisplay = document.getElementById('player-energy');
const enemyEnergyDisplay = document.getElementById('enemy-energy');
const battleLog = document.getElementById('battle-log');
const turnText = document.getElementById('turn-text');
const selectedActionText = document.getElementById('selected-action');
const confirmActionButton = document.getElementById('confirm-action');
const cancelActionButton = document.getElementById('cancel-action');
const commandButtons = document.querySelectorAll('.command-btn');
const confirmModal = document.getElementById('confirm-modal');
const gameOverModal = document.getElementById('game-over-modal');
const gameOverTitle = document.getElementById('game-over-title');
const gameOverMessage = document.getElementById('game-over-message');
const restartGameButton = document.getElementById('restart-game');

// è§’è‰²å…ƒç´ 
const playerCharacter = document.querySelector('.player-character');
const enemyCharacter = document.querySelector('.enemy-character');

// åˆå§‹åŒ–æ¸¸æˆ
function initGame() {
    updateDisplay();
    addLog('æˆ˜æ–—å¼€å§‹ï¼Œè¯·é€‰æ‹©è¡ŒåŠ¨...');
    
    // æ·»åŠ æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - æ”¯æŒè§¦å±å’Œé¼ æ ‡
    setupButtonEvents();
    
    // é”®ç›˜æ§åˆ¶
    document.addEventListener('keydown', handleKeyPress);
}

// è®¾ç½®æŒ‰é’®äº‹ä»¶
function setupButtonEvents() {
    document.getElementById('gather').addEventListener('click', () => selectAction('gather'));
    document.getElementById('defend').addEventListener('click', () => selectAction('defend'));
    document.getElementById('light-attack').addEventListener('click', () => selectAction('light-attack'));
    document.getElementById('heavy-attack').addEventListener('click', () => selectAction('heavy-attack'));
    document.getElementById('special').addEventListener('click', () => selectAction('special'));
    document.getElementById('taunt').addEventListener('click', () => selectAction('taunt'));
    document.getElementById('item').addEventListener('click', openItemModal);
    
    // ç¡®è®¤æŒ‰é’®äº‹ä»¶
    confirmActionButton.addEventListener('click', () => {
        if (confirmModal) confirmModal.style.display = 'none';
        confirmAction();
    });
    
    // å–æ¶ˆæŒ‰é’®äº‹ä»¶
    cancelActionButton.addEventListener('click', () => {
        if (confirmModal) confirmModal.style.display = 'none';
        gameState.player.selectedAction = null;
        updateDisplay();
    });

    // //å›åˆåˆ¶ç³»ç»Ÿé›†æˆæ›´æ–° - ä¿®æ”¹é‡æ–°å¼€å§‹æŒ‰é’®çš„å¤„ç†
    restartGameButton.addEventListener('click', () => {
        // å¦‚æœåœ¨iframeä¸­ï¼Œé€€å‡ºåˆ°çˆ¶çª—å£
        if (window.parent !== window) {
            exitBattle('restart');
        } else {
            window.location.reload();
        }
    });
}

// æ›´æ–°æ˜¾ç¤º
function updateDisplay() {
    // æ›´æ–°ç”Ÿå‘½å€¼æ˜¾ç¤º
    playerHealthBar.style.width = `${(gameState.player.currentHealth / gameState.player.maxHealth) * 100}%`;
    enemyHealthBar.style.width = `${(gameState.enemy.currentHealth / gameState.enemy.maxHealth) * 100}%`;
    
    // æ›´æ–°ç”Ÿå‘½å€¼æ–‡æœ¬
    playerHealthValue.textContent = gameState.player.currentHealth;
    enemyHealthValue.textContent = gameState.enemy.currentHealth;
    
    // æ›´æ–°æœ€å¤§ç”Ÿå‘½å€¼æ–‡æœ¬
    playerMaxHealth.textContent = gameState.player.maxHealth;
    enemyMaxHealth.textContent = gameState.enemy.maxHealth;
    
    // æ›´æ–°èƒ½é‡å€¼
    playerEnergyDisplay.textContent = gameState.player.energy;
    enemyEnergyDisplay.textContent = gameState.enemy.energy;
    
    // æ›´æ–°è§’è‰²åå­—æ˜¾ç¤º
    playerNameDisplay.textContent = gameState.player.name;
    enemyNameDisplay.textContent = gameState.enemy.name;
    
    // æ ¹æ®æ•Œäººæˆ˜æ–—é£æ ¼è®¾ç½®åå­—é¢œè‰²
    const styleColors = {
        'é£': '#4169E1',  // é›è“è‰² (Royal Blue)
        'æ—': '#228B22',  // æ·±ç»¿è‰² (Forest Green)
        'ç«': '#B22222',  // æš—çº¢è‰² (Firebrick)
        'å±±': '#DAA520'   // åœŸé»„è‰² (Goldenrod)
    };
    const enemyStyle = gameState.enemy.style;
    if (enemyStyle && styleColors[enemyStyle]) {
        enemyNameDisplay.style.color = styleColors[enemyStyle];
    }
    
    // æ›´æ–°å›åˆæ•°æ˜¾ç¤º
    turnText.textContent = `ç¬¬${gameState.turnNumber}å›åˆ`;
    
    // æ›´æ–°æŒ‘è¡…çŠ¶æ€æ˜¾ç¤º
    const playerTauntStatus = document.getElementById('player-taunt-status');
    const enemyTauntStatus = document.getElementById('enemy-taunt-status');
    
    if (gameState.player.tauntedTurns > 0) {
        playerTauntStatus.textContent = `ğŸ”¥ æŒ‘è¡…ä¸­ (${gameState.player.tauntedTurns}å›åˆ)`;
        playerTauntStatus.classList.add('active');
    } else {
        playerTauntStatus.classList.remove('active');
    }
    
    if (gameState.enemy.tauntedTurns > 0) {
        enemyTauntStatus.textContent = `ğŸ”¥ æŒ‘è¡…ä¸­ (${gameState.enemy.tauntedTurns}å›åˆ)`;
        enemyTauntStatus.classList.add('active');
    } else {
        enemyTauntStatus.classList.remove('active');
    }
    
    // æ ¹æ®èƒ½é‡å€¼å¯ç”¨/ç¦ç”¨æŒ‰é’®
    checkButtonAvailability();
}

// æ£€æŸ¥æŒ‰é’®å¯ç”¨æ€§
function checkButtonAvailability() {
    // å¦‚æœä¸æ˜¯ç©å®¶å›åˆæˆ–æ­£åœ¨ç­‰å¾…ç¡®è®¤ï¼Œç¦ç”¨æ‰€æœ‰æŒ‰é’®
    if (gameState.currentTurn !== 'player' || gameState.waitingForConfirmation) {
        commandButtons.forEach(btn => {
            btn.classList.add('disabled');
        });
        return;
    }
    
    // é‡ç½®æŒ‰é’®çŠ¶æ€
    commandButtons.forEach(btn => {
        btn.classList.remove('disabled');
        btn.classList.remove('selected');
    });
    
    // æ ¹æ®èƒ½é‡å€¼å¯ç”¨/ç¦ç”¨æŒ‰é’®
    if (gameState.player.energy < 1) {
        document.getElementById('light-attack').classList.add('disabled');
    }
    
    if (gameState.player.energy < 2) {
        document.getElementById('heavy-attack').classList.add('disabled');
    }
    
    if (gameState.player.energy < 5) {
        document.getElementById('special').classList.add('disabled');
    }
    
    // æŒ‘è¡…çŠ¶æ€ä¸‹ç¦ç”¨é˜²å¾¡
    if (gameState.player.tauntedTurns > 0) {
        document.getElementById('defend').classList.add('disabled');
    }
    
    // æœ¬åœºæˆ˜æ–—å·²ä½¿ç”¨é“å…·åˆ™ç¦ç”¨é“å…·æŒ‰é’®
    if (itemUsedThisBattle) {
        document.getElementById('item').classList.add('disabled');
    }
    
    // å¦‚æœæœ‰é€‰ä¸­çš„åŠ¨ä½œï¼Œé«˜äº®æ˜¾ç¤º
    if (gameState.player.selectedAction) {
        document.getElementById(gameState.player.selectedAction).classList.add('selected');
    }
}

// æ·»åŠ æˆ˜æ–—æ—¥å¿—
function addLog(message) {
    const logEntry = document.createElement('p');
    logEntry.textContent = message;
    battleLog.appendChild(logEntry);
    battleLog.scrollTop = battleLog.scrollHeight;
}

// é€‰æ‹©åŠ¨ä½œ
function selectAction(action) {
    // å¦‚æœä¸æ˜¯ç©å®¶å›åˆæˆ–æ­£åœ¨ç­‰å¾…ç¡®è®¤ï¼Œè¿”å›
    if (gameState.currentTurn !== 'player' || gameState.waitingForConfirmation) return;
    
    // æ£€æŸ¥æŒ‰é’®æ˜¯å¦è¢«ç¦ç”¨
    if (document.getElementById(action).classList.contains('disabled')) {
        return;
    }
    
    // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
    commandButtons.forEach(btn => btn.classList.remove('selected'));
    
    // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„èƒ½é‡
    if ((action === 'light-attack' && gameState.player.energy < 1) ||
        (action === 'heavy-attack' && gameState.player.energy < 2) ||
        (action === 'special' && gameState.player.energy < 5)) {
        addLog('èƒ½é‡ä¸è¶³ï¼Œæ— æ³•æ‰§è¡Œæ­¤åŠ¨ä½œï¼');
        return;
    }
    
    // è®¾ç½®é€‰ä¸­çŠ¶æ€
    document.getElementById(action).classList.add('selected');
    gameState.player.selectedAction = action;
    
    // æ›´æ–°é€‰æ‹©æ˜¾ç¤º
    const actionNames = {
        'gather': 'é›†æ°”',
        'defend': 'é˜²å¾¡',
        'light-attack': 'è½»æ”»å‡»',
        'heavy-attack': 'é‡æ”»å‡»',
        'special': 'ç»æ‹›',
        'taunt': 'å˜´ç‚®'
    };
    selectedActionText.textContent = actionNames[action];
    
    // æ˜¾ç¤ºç¡®è®¤å¼¹çª—
    confirmModal.style.display = 'flex';
}

// ç¡®è®¤åŠ¨ä½œ
function confirmAction() {
    if (!gameState.player.selectedAction) return;
    
    // è®¾ç½®ä¸ºç­‰å¾…ç¡®è®¤çŠ¶æ€
    gameState.waitingForConfirmation = true;
    
    // ç¦ç”¨æŒ‰é’®
    commandButtons.forEach(btn => {
        btn.classList.add('disabled');
    });
    
    addLog(`${gameState.player.name}å‡†å¤‡è¡ŒåŠ¨...`);
    
    // æ•ŒäººAIé€‰æ‹©åŠ¨ä½œ
    selectEnemyAction();
    
    // æ‰§è¡Œå›åˆç»“ç®—
    setTimeout(executeTurn, 1000);
}

// æ•ŒäººAIé€‰æ‹©åŠ¨ä½œ
function selectEnemyAction() {
    const enemy = gameState.enemy;
    const player = gameState.player;
    const style = enemy.style || 'é£'; // é»˜è®¤é£æ ¼
    
    // æ£€æŸ¥æ˜¯å¦å¤„äºæŒ‘è¡…çŠ¶æ€ï¼ˆä¸èƒ½ä½¿ç”¨é˜²å¾¡ï¼‰
    const canDefend = enemy.tauntedTurns <= 0;

    // ç©å®¶æ°”çš„å¨èƒç­‰çº§
    const playerEnergy = player.energy;

    // å˜´ç‚®åˆ¤å®šï¼šç©å®¶æ°”æ»¡5æ—¶ï¼Œæ•Œäººæœ‰è¾ƒé«˜æ¦‚ç‡å˜´ç‚®
    if (playerEnergy >= 5) {
        if (style === 'å±±' && Math.random() < 0.6) {
            enemy.selectedAction = 'taunt';
            return;
        }
        if (style === 'æ—' && Math.random() < 0.5) {
            enemy.selectedAction = 'taunt';
            return;
        }
        if (style === 'ç«' && Math.random() < 0.5) {
            enemy.selectedAction = 'taunt';
            return;
        }
        if (style === 'é£' && Math.random() < 0.4) {
            enemy.selectedAction = 'taunt';
            return;
        }
    }

    // é˜²å¾¡åˆ¤å®šï¼šç©å®¶æ°”è¾ƒé«˜æ—¶ï¼Œæ•Œäººæœ‰æ¦‚ç‡é˜²å¾¡ï¼ˆæŒ‘è¡…çŠ¶æ€ä¸‹ä¸å¯é˜²å¾¡ï¼‰
    if (playerEnergy >= 1 && canDefend) {
        if (style === 'å±±' && Math.random() < 0.5) {
            enemy.selectedAction = 'defend';
            return;
        }
        if (style === 'æ—' && Math.random() < 0.3) {
            enemy.selectedAction = 'defend';
            return;
        }
        if (style === 'ç«' && Math.random() < 0.25) {
            enemy.selectedAction = 'defend';
            return;
        }
        if (style === 'é£' && Math.random() < 0.25) {
            enemy.selectedAction = 'defend';
            return;
        }
    }

    // é£æ ¼ä¸»ç­–ç•¥ï¼šåŸºäºèƒ½é‡èŒƒå›´çš„åŠ æƒéšæœºé€‰æ‹©
    const styleStrategy = STYLE_STRATEGIES[style];
    if (styleStrategy) {
        const energyKey = getEnergyRangeKey(enemy.energy);
        const options = { ...styleStrategy[energyKey] };
        
        // æ ¹æ®èƒ½é‡é™åˆ¶è¿‡æ»¤ä¸å¯ç”¨çš„è¡ŒåŠ¨
        if (enemy.energy < 1) {
            delete options['light-attack'];
        }
        if (enemy.energy < 2) {
            delete options['heavy-attack'];
        }
        if (enemy.energy < 5) {
            delete options['special'];
        }
        
        // è¿‡æ»¤æ‰æ— æ”¶ç›Šçš„å˜´ç‚®é€‰é¡¹ï¼šç©å®¶å·²è¢«æŒ‘è¡…ä¸”æ°”ä¸è¶³5æ—¶ï¼Œå˜´ç‚®æ— æ”¶ç›Š
        if (player.tauntedTurns > 0 && playerEnergy < 5) {
            delete options['taunt'];
        }
        
        // å¦‚æœè¿‡æ»¤åè¿˜æœ‰é€‰é¡¹ï¼Œä½¿ç”¨åŠ æƒéšæœºé€‰æ‹©
        if (Object.keys(options).length > 0) {
            const debugInfo = {
                style: style,
                energyKey: energyKey
            };
            enemy.selectedAction = weightedRandom(options, debugInfo);
            return;
        }
    }

    // é»˜è®¤è¡Œä¸º
    enemy.selectedAction = 'gather';
}

// æ‰§è¡Œå›åˆ
function executeTurn() {
    const player = gameState.player;
    const enemy = gameState.enemy;
    
    // è·å–åŒæ–¹è¡ŒåŠ¨
    const playerAction = player.selectedAction;
    const enemyAction = enemy.selectedAction;
    
    addLog(`${enemy.name}é€‰æ‹©äº†è¡ŒåŠ¨...`);
    
    // æ ¹æ®è¡ŒåŠ¨ç±»å‹æ‰§è¡Œç‰¹æ•ˆå’Œç»“ç®—
    setTimeout(() => {
        // æ˜¾ç¤ºåŒæ–¹é€‰æ‹©çš„åŠ¨ä½œ
        const actionNames = {
            'gather': 'é›†æ°”',
            'defend': 'é˜²å¾¡',
            'light-attack': 'è½»æ”»å‡»',
            'heavy-attack': 'é‡æ”»å‡»',
            'special': 'ç»æ‹›',
            'taunt': 'å˜´ç‚®'
        };
        
        addLog(`${player.name}ä½¿ç”¨äº†${actionNames[playerAction]}ï¼${enemy.name}ä½¿ç”¨äº†${actionNames[enemyAction]}ï¼`);
        
        // å¤„ç†è¡ŒåŠ¨ç»“æœ
        processActions(playerAction, enemyAction);
        
        // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
        if (checkGameOver()) {
            return;
        }
        
        // ç»§ç»­ä¸‹ä¸€å›åˆ
        continueGame();
    }, 1000);
}

// å¤„ç†åŒæ–¹è¡ŒåŠ¨çš„ç»“æœ
function processActions(playerAction, enemyAction) {
    const player = gameState.player;
    const enemy = gameState.enemy;
    const gameContainer = document.querySelector('.game-container');
    const npcPortraitLayer = document.querySelector('.npc-portrait-layer');
    const screenFlash = document.querySelector('.screen-flash');
    let playerWasHit = false;
    let enemyWasHit = false;
    
    // å¤„ç†é›†æ°”
    if (playerAction === 'gather') {
        if (player.energy < player.maxEnergy) {
            player.energy += 1;
            addLog(`${player.name}é›†æ°”æˆåŠŸï¼Œèƒ½é‡+1ï¼`);
        } else {
            addLog(`${player.name}çš„èƒ½é‡å·²æ»¡ï¼`);
        }
    }
    
    if (enemyAction === 'gather') {
        if (enemy.energy < enemy.maxEnergy) {
            enemy.energy += 1;
            addLog(`${enemy.name}é›†æ°”æˆåŠŸï¼Œèƒ½é‡+1ï¼`);
        } else {
            addLog(`${enemy.name}çš„èƒ½é‡å·²æ»¡ï¼`);
        }
    }
    
    // å¤„ç†é˜²å¾¡çŠ¶æ€
    const playerDefending = playerAction === 'defend';
    const enemyDefending = enemyAction === 'defend';
    
    if (playerDefending) {
        playerCharacter.classList.add('player-defend');
        setTimeout(() => {
            playerCharacter.classList.remove('player-defend');
        }, 1000);
        addLog(`${player.name}è¿›å…¥é˜²å¾¡çŠ¶æ€ï¼`);
    }
    
    if (enemyDefending) {
        enemyCharacter.classList.add('enemy-defend');
        setTimeout(() => {
            enemyCharacter.classList.remove('enemy-defend');
        }, 1000);
        addLog(`${enemy.name}è¿›å…¥é˜²å¾¡çŠ¶æ€ï¼`);
    }
    
    // å˜´ç‚®é€»è¾‘å¤„ç†
    let playerTauntSuccess = false;
    let enemyTauntSuccess = false;
    
    // åŒæ–¹åŒæ—¶å˜´ç‚®ï¼Œæ— äº‹å‘ç”Ÿ
    if (playerAction === 'taunt' && enemyAction === 'taunt') {
        addLog('åŒæ–¹äº’ç›¸å˜´ç‚®ï¼Œä¸åˆ†é«˜ä¸‹ï¼');
    } else {
        // å˜´ç‚®å¯¹é˜²å¾¡çš„æ•ˆæœï¼šæŒ‘è¡…
        if (playerAction === 'taunt' && enemyDefending) {
            // ç©å®¶å˜´ç‚® vs æ•Œäººé˜²å¾¡ï¼šæ•Œäººæ°”-1ï¼Œè¿›å…¥æŒ‘è¡…çŠ¶æ€
            if (enemy.energy > 0) {
                enemy.energy -= 1;
                addLog(`${player.name}çš„å˜´ç‚®æ¿€æ€’äº†${enemy.name}ï¼${enemy.name}æ°”-1ï¼Œè¿›å…¥æŒ‘è¡…çŠ¶æ€ï¼`);
            } else {
                addLog(`${player.name}çš„å˜´ç‚®æ¿€æ€’äº†${enemy.name}ï¼${enemy.name}è¿›å…¥æŒ‘è¡…çŠ¶æ€ï¼`);
            }
            enemy.tauntedTurns = 3;
        }
        
        if (enemyAction === 'taunt' && playerDefending) {
            // æ•Œäººå˜´ç‚® vs ç©å®¶é˜²å¾¡ï¼šç©å®¶æ°”-1ï¼Œè¿›å…¥æŒ‘è¡…çŠ¶æ€
            if (player.energy > 0) {
                player.energy -= 1;
                addLog(`${enemy.name}çš„å˜´ç‚®æ¿€æ€’äº†${player.name}ï¼${player.name}æ°”-1ï¼Œè¿›å…¥æŒ‘è¡…çŠ¶æ€ï¼`);
            } else {
                addLog(`${enemy.name}çš„å˜´ç‚®æ¿€æ€’äº†${player.name}ï¼${player.name}è¿›å…¥æŒ‘è¡…çŠ¶æ€ï¼`);
            }
            player.tauntedTurns = 3;
        }
        
        // å˜´ç‚®å¯¹ç»æ‹›çš„æ•ˆæœï¼šæ— æ•ˆåŒ–ä¼¤å®³ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
        if (playerAction === 'taunt' && enemyAction === 'special') {
            playerTauntSuccess = true;
            addLog(`${player.name}çš„å˜´ç‚®æˆåŠŸæ— æ•ˆåŒ–äº†${enemy.name}çš„ç»æ‹›ä¼¤å®³ï¼`);
        }
        
        if (enemyAction === 'taunt' && playerAction === 'special') {
            enemyTauntSuccess = true;
            addLog(`${enemy.name}çš„å˜´ç‚®æˆåŠŸæ— æ•ˆåŒ–äº†${player.name}çš„ç»æ‹›ä¼¤å®³ï¼`);
        }
    }
    
    // å¤„ç†ç»æ‹›ï¼ˆæ— è§†é˜²å¾¡ï¼‰
    if (playerAction === 'special') {
        // æ— è®ºç»æ‹›æ˜¯å¦è¢«å˜´ç‚®æ— æ•ˆåŒ–ï¼Œéƒ½æ¶ˆè€—èƒ½é‡
        player.energy -= 5;
        playerCharacter.classList.add('player-special');
        
        if (!enemyTauntSuccess) {
            enemyCharacter.classList.add('enemy-hit');
            
            setTimeout(() => {
                enemyCharacter.classList.remove('enemy-hit');
            }, 1000);
            
            const damage = Math.round(player.basicDamage * 3 * damageMultiplier);
            enemy.currentHealth -= damage;
            addLog(`${player.name}ä½¿ç”¨ç»æ‹›ï¼Œå¯¹${enemy.name}é€ æˆ${damage}ç‚¹ä¼¤å®³ï¼`);
            enemyWasHit = true;
        } else {
            addLog(`${player.name}ä½¿ç”¨ç»æ‹›ï¼Œä½†ä¼¤å®³è¢«${enemy.name}çš„å˜´ç‚®æ— æ•ˆåŒ–äº†ï¼`);
        }
        
        setTimeout(() => {
            playerCharacter.classList.remove('player-special');
        }, 1000);
        
        // æ— æ•ˆåŒ–æ•Œäººçš„æ™®é€šæ”»å‡»
        if (enemyAction === 'light-attack' || enemyAction === 'heavy-attack') {
            addLog(`${enemy.name}çš„æ”»å‡»è¢«${player.name}çš„ç»æ‹›æ— æ•ˆåŒ–äº†ï¼`);
            // æ•Œäººæ¶ˆè€—çš„èƒ½é‡ä¸è¿”è¿˜
            if (enemyAction === 'light-attack') enemy.energy -= 1;
            if (enemyAction === 'heavy-attack') enemy.energy -= 2;
        }
    }
    
    if (enemyAction === 'special') {
        // æ— è®ºç»æ‹›æ˜¯å¦è¢«å˜´ç‚®æ— æ•ˆåŒ–ï¼Œéƒ½æ¶ˆè€—èƒ½é‡
        enemy.energy -= 5;
        enemyCharacter.classList.add('enemy-special');
        
        if (!playerTauntSuccess) {
            playerCharacter.classList.add('player-hit');
            
            setTimeout(() => {
                playerCharacter.classList.remove('player-hit');
            }, 1000);
            
            const damage = Math.round(enemy.basicDamage * 3 / defenseMultiplier);
            player.currentHealth -= damage;
            addLog(`${enemy.name}ä½¿ç”¨ç»æ‹›ï¼Œå¯¹${player.name}é€ æˆ${damage}ç‚¹ä¼¤å®³ï¼`);
            playerWasHit = true;
        } else {
            addLog(`${enemy.name}ä½¿ç”¨ç»æ‹›ï¼Œä½†ä¼¤å®³è¢«${player.name}çš„å˜´ç‚®æ— æ•ˆåŒ–äº†ï¼`);
        }
        
        setTimeout(() => {
            enemyCharacter.classList.remove('enemy-special');
        }, 1000);
        
        // æ— æ•ˆåŒ–ç©å®¶çš„æ™®é€šæ”»å‡»
        if (playerAction === 'light-attack' || playerAction === 'heavy-attack') {
            addLog(`${player.name}çš„æ”»å‡»è¢«${enemy.name}çš„ç»æ‹›æ— æ•ˆåŒ–äº†ï¼`);
            // ç©å®¶æ¶ˆè€—çš„èƒ½é‡ä¸è¿”è¿˜
            if (playerAction === 'light-attack') player.energy -= 1;
            if (playerAction === 'heavy-attack') player.energy -= 2;
        }
    }
    
    // å¦‚æœæ²¡æœ‰è¢«ç»æ‹›æ— æ•ˆï¼Œå¤„ç†é‡æ”»å‡»
    if (playerAction === 'heavy-attack' &&
        enemyAction !== 'special' &&
        playerAction !== 'special') {
        player.energy -= 2;
        
        // æ£€æŸ¥æ˜¯å¦è¢«é˜²å¾¡æˆ–æ˜¯å¦æ— æ•ˆå¯¹æ–¹è½»æ”»å‡»
        if (enemyDefending) {
            playerCharacter.classList.add('player-attack');
            // enemyCharacter.classList.add('enemy-hit');
            
            setTimeout(() => {
                playerCharacter.classList.remove('player-attack');
                // enemyCharacter.classList.remove('enemy-hit');
            }, 600);
            
            // é˜²å¾¡é‡æ”»å‡»å—åˆ°25%ä¼¤å®³
            const reducedDamage = Math.round(player.basicDamage * 1.5 * 0.25 * damageMultiplier);
            enemy.currentHealth -= reducedDamage;
            addLog(`${player.name}çš„é‡æ”»å‡»è¢«${enemy.name}é˜²å¾¡äº†ï¼Œä½†ä»é€ æˆ${reducedDamage}ç‚¹ä¼¤å®³ï¼`);
            enemyWasHit = true;
        } else if (enemyAction === 'light-attack') {
            // é‡æ”»å‡»å…‹åˆ¶è½»æ”»å‡»
            playerCharacter.classList.add('player-attack');
            enemyCharacter.classList.add('enemy-hit');
            
            setTimeout(() => {
                playerCharacter.classList.remove('player-attack');
                enemyCharacter.classList.remove('enemy-hit');
            }, 600);
            
            const damage = Math.round(player.basicDamage * 1.5 * damageMultiplier);
            enemy.currentHealth -= damage;
            enemy.energy -= 1; // æ¶ˆè€—æ•Œäººçš„èƒ½é‡
            addLog(`${player.name}çš„é‡æ”»å‡»æ— æ•ˆåŒ–äº†${enemy.name}çš„è½»æ”»å‡»ï¼Œå¹¶é€ æˆ${damage}ç‚¹ä¼¤å®³ï¼`);
            enemyWasHit = true;
        } else {
            playerCharacter.classList.add('player-attack');
            enemyCharacter.classList.add('enemy-hit');
            
            setTimeout(() => {
                playerCharacter.classList.remove('player-attack');
                enemyCharacter.classList.remove('enemy-hit');
            }, 600);
            
            const damage = Math.round(player.basicDamage * 1.5 * damageMultiplier);
            enemy.currentHealth -= damage;
            addLog(`${player.name}çš„é‡æ”»å‡»å¯¹${enemy.name}é€ æˆ${damage}ç‚¹ä¼¤å®³ï¼`);
            enemyWasHit = true;
        }
    }
    
    if (enemyAction === 'heavy-attack' &&
        playerAction !== 'special' &&
        enemyAction !== 'special') {
        enemy.energy -= 2;
        
        // æ£€æŸ¥æ˜¯å¦è¢«é˜²å¾¡æˆ–æ˜¯å¦æ— æ•ˆå¯¹æ–¹è½»æ”»å‡»
        if (playerDefending) {
            enemyCharacter.classList.add('enemy-attack');
            // playerCharacter.classList.add('player-hit');
            
            setTimeout(() => {
                enemyCharacter.classList.remove('enemy-attack');
                // playerCharacter.classList.remove('player-hit');
            }, 600);
            
            // é˜²å¾¡é‡æ”»å‡»å—åˆ°20%ä¼¤å®³
            const reducedDamage = Math.round(enemy.basicDamage * 1.5 * 0.2 / defenseMultiplier);
            player.currentHealth -= reducedDamage;
            addLog(`${enemy.name}çš„é‡æ”»å‡»è¢«${player.name}é˜²å¾¡äº†ï¼Œä½†ä»é€ æˆ${reducedDamage}ç‚¹ä¼¤å®³ï¼`);
            playerWasHit = true;
        } else if (playerAction === 'light-attack') {
            // é‡æ”»å‡»å…‹åˆ¶è½»æ”»å‡»
            enemyCharacter.classList.add('enemy-attack');
            playerCharacter.classList.add('player-hit');
            
            setTimeout(() => {
                enemyCharacter.classList.remove('enemy-attack');
                playerCharacter.classList.remove('player-hit');
            }, 600);
            
            const damage = Math.round(enemy.basicDamage * 1.5 / defenseMultiplier);
            player.currentHealth -= damage;
            player.energy -= 1; // æ¶ˆè€—ç©å®¶çš„èƒ½é‡
            addLog(`${enemy.name}çš„é‡æ”»å‡»æ— æ•ˆåŒ–äº†${player.name}çš„è½»æ”»å‡»ï¼Œå¹¶é€ æˆ${damage}ç‚¹ä¼¤å®³ï¼`);
            playerWasHit = true;
        } else {
            enemyCharacter.classList.add('enemy-attack');
            playerCharacter.classList.add('player-hit');
            
            setTimeout(() => {
                enemyCharacter.classList.remove('enemy-attack');
                playerCharacter.classList.remove('player-hit');
            }, 600);
            
            const damage = Math.round(enemy.basicDamage * 1.5 / defenseMultiplier);
            player.currentHealth -= damage;
            addLog(`${enemy.name}çš„é‡æ”»å‡»å¯¹${player.name}é€ æˆ${damage}ç‚¹ä¼¤å®³ï¼`);
            playerWasHit = true;
        }
    }
    
    // å¦‚æœæ²¡æœ‰è¢«é‡æ”»å‡»æˆ–ç»æ‹›æ— æ•ˆï¼Œå¤„ç†è½»æ”»å‡»
    if (playerAction === 'light-attack' && 
        enemyAction !== 'heavy-attack' && 
        enemyAction !== 'special') {
        player.energy -= 1;
        
        // æ£€æŸ¥æ˜¯å¦è¢«é˜²å¾¡
        if (enemyDefending) {
            playerCharacter.classList.add('player-attack');
            // enemyCharacter.classList.add('enemy-hit');
            
            setTimeout(() => {
                playerCharacter.classList.remove('player-attack');
                // enemyCharacter.classList.remove('enemy-hit');
            }, 600);
            
            // é˜²å¾¡è½»æ”»å‡»å—åˆ°15%ä¼¤å®³
            const reducedDamage = Math.round(player.basicDamage * 0.15 * damageMultiplier);
            enemy.currentHealth -= reducedDamage;
            addLog(`${player.name}çš„è½»æ”»å‡»è¢«${enemy.name}é˜²å¾¡äº†ï¼Œä½†ä»é€ æˆ${reducedDamage}ç‚¹ä¼¤å®³ï¼`);
            enemyWasHit = true;
        } else {
            playerCharacter.classList.add('player-attack');
            enemyCharacter.classList.add('enemy-hit');
            
            setTimeout(() => {
                playerCharacter.classList.remove('player-attack');
                enemyCharacter.classList.remove('enemy-hit');
            }, 600);
            
            const damage = Math.round(player.basicDamage * damageMultiplier);
            enemy.currentHealth -= damage;
            addLog(`${player.name}çš„è½»æ”»å‡»å¯¹${enemy.name}é€ æˆ${damage}ç‚¹ä¼¤å®³ï¼`);
            enemyWasHit = true;
        }
    }
    
    if (enemyAction === 'light-attack' && 
        playerAction !== 'heavy-attack' && 
        playerAction !== 'special') {
        enemy.energy -= 1;
        
        // æ£€æŸ¥æ˜¯å¦è¢«é˜²å¾¡
        if (playerDefending) {
            enemyCharacter.classList.add('enemy-attack');
            // playerCharacter.classList.add('player-hit');
            
            setTimeout(() => {
                enemyCharacter.classList.remove('enemy-attack');
                // playerCharacter.classList.remove('player-hit');
            }, 600);
            
            // é˜²å¾¡è½»æ”»å‡»å—åˆ°15%ä¼¤å®³
            const reducedDamage = Math.round(enemy.basicDamage * 0.15 / defenseMultiplier);
            player.currentHealth -= reducedDamage;
            addLog(`${enemy.name}çš„è½»æ”»å‡»è¢«${player.name}é˜²å¾¡äº†ï¼Œä½†ä»é€ æˆ${reducedDamage}ç‚¹ä¼¤å®³ï¼`);
            playerWasHit = true;
        } else {
            enemyCharacter.classList.add('enemy-attack');
            playerCharacter.classList.add('player-hit');
            
            setTimeout(() => {
                enemyCharacter.classList.remove('enemy-attack');
                playerCharacter.classList.remove('player-hit');
            }, 600);
            
            const damage = Math.round(enemy.basicDamage / defenseMultiplier);
            player.currentHealth -= damage;
            addLog(`${enemy.name}çš„è½»æ”»å‡»å¯¹${player.name}é€ æˆ${damage}ç‚¹ä¼¤å®³ï¼`);
            playerWasHit = true;
        }
    }
    
    // ç¡®ä¿ç”Ÿå‘½å€¼ä¸ä¸ºè´Ÿæ•°
    if (player.currentHealth < 0) player.currentHealth = 0;
    if (enemy.currentHealth < 0) enemy.currentHealth = 0;
    
    // å—å‡»åé¦ˆåŠ¨ç”»
    if (playerWasHit) {
        gameContainer.classList.add('shake');
        screenFlash.classList.add('active');
        setTimeout(() => {
            gameContainer.classList.remove('shake');
            screenFlash.classList.remove('active');
        }, 400);
    }
    if (enemyWasHit) {
        npcPortraitLayer.classList.add('shake');
        setTimeout(() => {
            npcPortraitLayer.classList.remove('shake');
        }, 400);
    }
    
    // æ›´æ–°æ˜¾ç¤º
    updateDisplay();
}

// ç»§ç»­æ¸¸æˆ
function continueGame() {
    // é‡ç½®é€‰æ‹©çŠ¶æ€
    gameState.player.selectedAction = null;
    gameState.enemy.selectedAction = null;
    gameState.waitingForConfirmation = false;
    selectedActionText.textContent = 'æ— ';
    
    // é€’å‡æŒ‘è¡…çŠ¶æ€è®¡æ•°
    if (gameState.player.tauntedTurns > 0) {
        gameState.player.tauntedTurns--;
        if (gameState.player.tauntedTurns === 0) {
            addLog(`${gameState.player.name}çš„æŒ‘è¡…çŠ¶æ€ç»“æŸäº†ã€‚`);
        }
    }
    if (gameState.enemy.tauntedTurns > 0) {
        gameState.enemy.tauntedTurns--;
        if (gameState.enemy.tauntedTurns === 0) {
            addLog(`${gameState.enemy.name}çš„æŒ‘è¡…çŠ¶æ€ç»“æŸäº†ã€‚`);
        }
    }
    
    // å¢åŠ å›åˆæ•°
    gameState.turnNumber++;
    
    // æ›´æ–°æ˜¾ç¤º
    updateDisplay();
    
    // ç»§ç»­æ¸¸æˆ
    addLog('å‡†å¤‡ä¸‹ä¸€å›åˆ...');
    
    // æ›´æ–°å›åˆæŒ‡ç¤º
    setTimeout(() => {
        addLog('è¯·é€‰æ‹©ä½ çš„è¡ŒåŠ¨...');
    }, 1000);
}

// æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
function checkGameOver() {
    if (gameState.player.currentHealth <= 0) {
        addLog(`${gameState.player.name}è¢«å‡»è´¥äº†ï¼æ¸¸æˆç»“æŸã€‚`);
        gameEnd(false);
        return true;
    } else if (gameState.enemy.currentHealth <= 0) {
        addLog(`${gameState.enemy.name}è¢«å‡»è´¥äº†ï¼èƒœåˆ©ï¼`);
        gameEnd(true);
        return true;
    }
    return false;
}

// //å›åˆåˆ¶ç³»ç»Ÿé›†æˆæ›´æ–° - æ¸¸æˆç»“æŸ
function gameEnd(isVictory) {
    // ç¦ç”¨æ‰€æœ‰æŒ‰é’®
    commandButtons.forEach(btn => {
        btn.classList.add('disabled');
    });
    
    // è·å–è§’è‰²åå­—
    const playerName = gameState.player.name;
    const enemyName = gameState.enemy.name;
    
    // è®¾ç½®å¼¹çª—å†…å®¹
    if (isVictory) {
        gameOverTitle.textContent = 'æˆ˜æ–—èƒœåˆ©';
        gameOverMessage.textContent = `${playerName}æˆ˜èƒœäº†${enemyName}ï¼`;
        addLog('æ­å–œä½ å–å¾—èƒœåˆ©ï¼');
    } else {
        gameOverTitle.textContent = 'æˆ˜æ–—å¤±è´¥';
        gameOverMessage.textContent = `${playerName}è´¥ç»™äº†${enemyName}ï¼`;
        addLog('æ¸¸æˆç»“æŸï¼Œå†æ¥å†å‰ï¼');
    }
    
    // æ£€æŸ¥æ˜¯å¦åœ¨iframeä¸­è¿è¡Œ
    const isInIframe = window.parent !== window;
    
    if (isInIframe) {
        // åœ¨iframeä¸­ï¼Œéšè—é‡æ–°å¼€å§‹æŒ‰é’®å’Œæ•´ä¸ªfooter
        document.getElementById('game-over-footer').style.display = 'none';
        
        // æ˜¾ç¤ºæ¸¸æˆç»“æŸå¼¹çª—
        gameOverModal.style.display = 'flex';
        
        // 3ç§’åè‡ªåŠ¨é€€å‡ºï¼ˆç¨å¾®å»¶é•¿ä¸€ç‚¹æ—¶é—´è®©ç©å®¶çœ‹åˆ°ç»“æœï¼‰
        setTimeout(() => {
            exitBattle(isVictory ? 'victory' : 'defeat');
        }, 3000);
    } else {
        // ä¸åœ¨iframeä¸­ï¼Œæ˜¾ç¤ºé‡æ–°å¼€å§‹æŒ‰é’®
        document.getElementById('game-over-footer').style.display = 'flex';
        
        // æ˜¾ç¤ºæ¸¸æˆç»“æŸå¼¹çª—
        gameOverModal.style.display = 'flex';
    }
}


// é”®ç›˜äº‹ä»¶å¤„ç†
function handleKeyPress(event) {
    // å¦‚æœé“å…·å¼¹çª—æ˜¾ç¤ºä¸­ï¼ŒæŒ‰ESCå…³é—­
    const itemModal = document.getElementById('item-modal');
    if (itemModal && itemModal.style.display === 'flex' && event.key === 'Escape') {
        closeItemModal();
        return;
    }
    
    // å¦‚æœå¼¹çª—æ˜¾ç¤ºä¸­ï¼ŒæŒ‰ESCå…³é—­
    if (confirmModal.style.display === 'flex' && event.key === 'Escape') {
        confirmModal.style.display = 'none'; gameState.player.selectedAction = null;
        updateDisplay(); return;
    }


    // å¦‚æœå¼¹çª—æ˜¾ç¤ºä¸­ï¼ŒæŒ‰Enterç¡®è®¤
    if (confirmModal.style.display === 'flex' && event.key === 'Enter') {
        confirmModal.style.display = 'none';
        confirmAction();
        return;
    }

    // å¦‚æœä¸æ˜¯ç©å®¶å›åˆæˆ–æ­£åœ¨ç­‰å¾…ç¡®è®¤ï¼Œè¿”å›
    if (gameState.currentTurn !== 'player' || gameState.waitingForConfirmation) return;

    const key = event.key.toUpperCase();

    switch (key) {
        case 'Q':
            selectAction('gather');
            break;
        case 'W':
            selectAction('defend');
            break;
        case 'E':
            selectAction('light-attack');
            break;
        case 'R':
            selectAction('heavy-attack');
            break;
        case 'T':
            selectAction('special');
            break;
        case 'Y':
            selectAction('taunt');
            break;
        case 'U':
            openItemModal();
            break;
    }
}

// åˆå§‹åŒ–æ¸¸æˆ 
// åŠ¨æ€è®¾ç½®1.46æ¯”ä¾‹çš„å‡½æ•° 
function setAspectRatio() { 
    const gameContainer = document.querySelector('.game-container'); 
    if (!gameContainer) return;

    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;

    // è®¡ç®—1.46æ¯”ä¾‹çš„å°ºå¯¸ï¼ˆä¸ä¸»ç•Œé¢viewportä¸€è‡´ï¼‰
    const aspectRatio = 1.46;
    let gameWidth, gameHeight;

    // ä¼˜å…ˆåŸºäºå®½åº¦è®¡ç®—ï¼ˆé«˜åº¦ä¸ºå®½åº¦çš„ 1/1.46 â‰ˆ 0.685ï¼‰
    gameWidth = viewportWidth;
    gameHeight = viewportWidth / aspectRatio;

    // å¦‚æœè®¡ç®—å‡ºçš„é«˜åº¦è¶…è¿‡è§†å£é«˜åº¦ï¼Œåˆ™æ ¹æ®é«˜åº¦åæ¨å®½åº¦
    if (gameHeight > viewportHeight) {
        gameHeight = viewportHeight;
        gameWidth = viewportHeight * aspectRatio;
    }

    // ç¡®ä¿ä¸ä¼šè¶…å‡ºè¾¹ç•Œ
    gameWidth = Math.min(gameWidth, viewportWidth);
    gameHeight = Math.min(gameHeight, viewportHeight);

    // åº”ç”¨å°ºå¯¸
    gameContainer.style.width = `${gameWidth}px`;
    gameContainer.style.height = `${gameHeight}px`;
    
    // ç¡®ä¿å®¹å™¨ç´§è´´é¡¶éƒ¨
    gameContainer.style.marginTop = '0';
    
    // æ°´å¹³å±…ä¸­ï¼ˆå¦‚æœå®½åº¦å°äºè§†å£å®½åº¦ï¼‰
    if (gameWidth < viewportWidth) {
        gameContainer.style.marginLeft = `${(viewportWidth - gameWidth) / 2}px`;
        gameContainer.style.marginRight = 'auto';
    } else {
        gameContainer.style.marginLeft = '0';
        gameContainer.style.marginRight = '0';
    }

    console.log(`æ¸¸æˆå®¹å™¨å°ºå¯¸: ${gameWidth}x${gameHeight}, è§†å£: ${viewportWidth}x${viewportHeight}, æ¯”ä¾‹: ${(gameWidth/gameHeight).toFixed(2)}`);
}

// çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è®¾ç½®æ¯”ä¾‹ 
function handleResize() { 
    setAspectRatio(); 
}

// åˆå§‹åŒ–å°ºå¯¸è®¾ç½® 
function initAspectRatio() { 
    setAspectRatio();

    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
    window.addEventListener('resize', handleResize);
    window.addEventListener('orientationchange', () => {
        // å»¶è¿Ÿæ‰§è¡Œï¼Œç­‰å¾…æ–¹å‘å˜åŒ–å®Œæˆ
        setTimeout(setAspectRatio, 100);
    });
}

// ä¿®æ”¹åŸæœ‰çš„DOMContentLoadedäº‹ä»¶ç›‘å¬ 
document.addEventListener('DOMContentLoaded', () => { 
    // é¦–å…ˆè®¾ç½®4:3æ¯”ä¾‹ 
    initAspectRatio();

    // è®¾ç½®ä¸»èƒŒæ™¯
    const gameContainer = document.querySelector('.game-container');
    if (gameContainer) {
        gameContainer.style.backgroundImage = `url('${GAME_BG_URL}')`;
    }

    // è®¾ç½®å¼¹çª—èƒŒæ™¯ - æ’é™¤é“å…·å¼¹çª—
    const modalContents = document.querySelectorAll('.modal-content');
    modalContents.forEach(modal => {
        modal.style.background = `url('${MODAL_BG_URL}') center center / cover`;
    });
    
    // é“å…·å¼¹çª—ä½¿ç”¨ä¸é€æ˜çº¯è‰²èƒŒæ™¯
    const itemModalContent = document.querySelector('.item-modal-content');
    if (itemModalContent) {
        itemModalContent.style.background = 'linear-gradient(135deg, #1a1410 0%, #2a2018 50%, #1a1410 100%)';
    }

    // åˆå§‹åŒ–æ¸¸æˆ
    initGame();
});

    </script> 
</body> 
</html>
