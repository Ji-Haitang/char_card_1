<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¹æˆ˜ç³»ç»Ÿ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    user-select: none;
}

body {
    font-family: 'ZCOOL XiaoWei', 'Microsoft YaHei', sans-serif;
    background-color: #000;
    color: #fff;
    overflow: hidden;
    margin: 0;  /* ç¡®ä¿æ²¡æœ‰margin */
    padding: 0;  /* ç¡®ä¿æ²¡æœ‰padding */
    display: flex;
    justify-content: center;
    align-items: flex-start;  /* ä»centeræ”¹ä¸ºflex-startï¼Œè®©å†…å®¹ä»é¡¶éƒ¨å¼€å§‹ */
    width: 100vw;
    height: 100vh;
}

.game-container {
    /* é€šè¿‡JSåŠ¨æ€è®¾ç½®å®½é«˜ï¼Œä¿æŒ4:3æ¯”ä¾‹ */
    position: relative;
    display: flex;
    flex-direction: column;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    margin-top: 0;  /* ç¡®ä¿ç´§è´´é¡¶éƒ¨ */
    overflow: hidden;  /* é˜²æ­¢å­å…ƒç´ æº¢å‡º */
}

/* èƒŒæ™¯æ¯›ç»ç’ƒå±‚ */
.game-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: inherit;
    background-size: inherit;
    background-position: inherit;
    filter: blur(3px);
    z-index: 0;
}

/* èƒŒæ™¯é®ç½©å±‚ï¼ˆè®©æ¯›ç»ç’ƒæ•ˆæœæ›´æŸ”å’Œï¼‰ */
.game-container::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.15);
    z-index: 1;
}

.battle-scene {
    flex: 1;
    position: relative;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    padding-bottom: clamp(60px, 12vw, 120px);
}

/* çŠ¶æ€åŒºæ ·å¼ - ä½¿ç”¨clampé€‚é…ä¸åŒå±å¹• */
.player-status-area {
    position: absolute;
    top: clamp(5px, 1vw, 15px);
    left: clamp(5px, 1vw, 15px);
    width: clamp(130px, 20vw, 240px);
    height: auto;
    background-color: rgba(0, 0, 0, 0.85);
    border-radius: clamp(4px, 0.5vw, 8px);
    padding: clamp(6px, 1vw, 12px);
    z-index: 5;
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 0 8px rgba(0, 0, 0, 0.6);
}

/* åå­—è¡Œï¼šåŒ…å«åå­—å’ŒæŒ‘è¡…çŠ¶æ€ */
.name-row {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: clamp(6px, 1vw, 12px);
    margin-bottom: clamp(3px, 0.5vw, 6px);
    border-bottom: 1px solid rgba(255, 204, 0, 0.3);
    padding-bottom: clamp(2px, 0.3vw, 5px);
}

.character-name {
    font-size: clamp(14px, 1.6vw, 20px);
    font-weight: bold;
    color: #ffcc00;
    text-align: left;
    font-family: 'Ma Shan Zheng', cursive;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
}

.enemy-status-area {
    position: absolute;
    top: clamp(5px, 1vw, 15px);
    right: clamp(5px, 1vw, 15px);
    width: clamp(130px, 20vw, 240px);
    height: auto;
    background-color: rgba(0, 0, 0, 0.85);
    border-radius: clamp(4px, 0.5vw, 8px);
    padding: clamp(6px, 1vw, 12px);
    z-index: 5;
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 0 8px rgba(0, 0, 0, 0.6);
}

/* HPå’Œæ°”åŒä¸€è¡Œæ˜¾ç¤º */
.stats-row {
    display: flex;
    align-items: center;
    gap: clamp(6px, 1vw, 12px);
}

.health-container {
    flex: 1;
    display: flex;
    align-items: center;
    position: relative;
}

.health-bar {
    flex: 1;
    height: clamp(16px, 2.2vw, 26px);
    background-color: #333;
    border-radius: clamp(2px, 0.3vw, 4px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    position: relative;
    overflow: visible;
}

.health-fill {
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    background: linear-gradient(to right, #ff0043, #ff6a00);
    width: 100%;
    transition: width 0.5s cubic-bezier(.4,2,.6,1);
    border-radius: clamp(2px, 0.3vw, 4px) 0 0 clamp(2px, 0.3vw, 4px);
}

/* HPæ•°å­—æ˜¾ç¤ºåœ¨è¡€æ¡å†…éƒ¨ */
.health-text {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    font-size: clamp(10px, 1.2vw, 14px);
    color: #fff;
    text-align: center;
    font-weight: bold;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8), 
                 -1px -1px 2px rgba(0, 0, 0, 0.8),
                 1px -1px 2px rgba(0, 0, 0, 0.8),
                 -1px 1px 2px rgba(0, 0, 0, 0.8);
    white-space: nowrap;
    z-index: 2;
}

/* æ°”å€¼æ˜¾ç¤ºåœ¨å³è¾¹ */
.energy-display {
    display: flex;
    align-items: center;
    flex-shrink: 0;
}

.energy-value {
    font-size: clamp(11px, 1.3vw, 16px);
    color: #ffcc00;
    font-weight: bold;
    white-space: nowrap;
}

.energy-icon {
    display: none;
}

/* æŒ‘è¡…çŠ¶æ€æ˜¾ç¤ºæ ·å¼ - æ˜¾ç¤ºåœ¨åå­—å³ä¾§ */
.taunt-status {
    display: none;
    padding: clamp(1px, 0.3vw, 3px) clamp(4px, 0.6vw, 8px);
    background: linear-gradient(135deg, rgba(255, 60, 60, 0.9), rgba(180, 20, 20, 0.95));
    border-radius: clamp(2px, 0.3vw, 4px);
    font-size: clamp(9px, 1vw, 12px);
    font-weight: bold;
    color: #fff;
    text-align: center;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    animation: taunt-pulse 1s ease-in-out infinite;
    border: 1px solid rgba(255, 100, 100, 0.6);
    white-space: nowrap;
    flex-shrink: 0;
}

.taunt-status.active {
    display: inline-block;
}

@keyframes taunt-pulse {
    0% { opacity: 0.8; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.02); }
    100% { opacity: 0.8; transform: scale(1); }
}

/* é¡¶éƒ¨çŠ¶æ€æ å®¹å™¨ - æ”¹ä¸ºçºµå‘æ’åˆ— */
.top-status-bar {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    flex-direction: column;
    align-items: stretch;
    z-index: 20;
}

/* å›åˆæŒ‡ç¤ºå™¨ - å¯ç‚¹å‡»æ˜¾ç¤ºæ—¥å¿— */
.turn-indicator {
    position: relative;
    background-color: rgba(0, 0, 0, 0.85);
    padding: clamp(6px, 0.8vw, 12px) clamp(12px, 2vw, 25px);
    border-radius: 0 0 clamp(8px, 1.2vw, 15px) clamp(8px, 1.2vw, 15px);
    font-size: clamp(14px, 1.8vw, 22px);
    font-weight: bold;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-top: none;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
    font-family: 'Ma Shan Zheng', cursive;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
    white-space: nowrap;
    cursor: pointer;
    transition: background-color 0.2s;
}

.turn-indicator:hover {
    background-color: rgba(30, 30, 30, 0.95);
}

.turn-indicator {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.turn-indicator::after {
    content: 'â–¼';
    font-size: clamp(8px, 1vw, 12px);
    opacity: 0.7;
    margin-top: clamp(2px, 0.3vw, 4px);
}

/* æ—¥å¿—ä¸‹æ‹‰æ¡† */
.log-dropdown {
    display: none;
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    width: clamp(280px, 50vw, 550px);
    max-height: 35vh;
    background-color: rgba(0, 0, 0, 0.75);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 0 0 clamp(6px, 1vw, 12px) clamp(6px, 1vw, 12px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    overflow-y: auto;
    z-index: 19;
    padding: clamp(8px, 1.2vw, 15px);
}

.log-dropdown.active {
    display: block;
}

.log-dropdown p {
    margin: clamp(3px, 0.5vw, 6px) 0;
    padding: clamp(3px, 0.5vw, 6px) 0;
    font-size: clamp(13px, 1.5vw, 18px);
    color: #fff;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    line-height: 1.5;
}

.log-dropdown p:last-child {
    border-bottom: none;
}

/* ========== åœºåœ°æ•ˆæœæŒ‡ç¤ºå™¨ - åœ¨å›åˆæ•°ä¸Šæ–¹ ========== */
.field-effect-indicator {
    position: relative;
    background-color: rgba(0, 0, 0, 0.85);
    padding: clamp(3px, 0.5vw, 6px) clamp(12px, 2vw, 25px);
    border-radius: 0;  /* æ— åœ†è§’ */
    font-size: clamp(10px, 1.2vw, 14px);
    font-weight: bold;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-bottom: none;  /* å’Œä¸‹æ–¹å›åˆæ•°å®¹å™¨è¿æ¥ */
    box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.6);
    font-family: 'Ma Shan Zheng', cursive;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
    white-space: nowrap;
    cursor: pointer;
    transition: all 0.3s ease;
    display: none;
    justify-content: center;
}

.field-effect-indicator.active {
    display: flex;
    align-items: center;
    gap: clamp(4px, 0.6vw, 8px);
}

.field-effect-icon {
    font-size: clamp(14px, 1.8vw, 22px);
}

.field-effect-name {
    color: #fff;
}

.field-effect-timer {
    color: #ffcc00;
    font-size: clamp(10px, 1.2vw, 14px);
    opacity: 0.9;
}

/* åœºåœ°æ•ˆæœé¢œè‰²ä¸»é¢˜ */
.field-effect-indicator.killing-intent {
    border-color: rgba(255, 60, 60, 0.6);
    background: linear-gradient(135deg, rgba(80, 20, 20, 0.95), rgba(40, 10, 10, 0.95));
}

.field-effect-indicator.miasma {
    border-color: rgba(150, 50, 200, 0.6);
    background: linear-gradient(135deg, rgba(60, 20, 80, 0.95), rgba(30, 10, 40, 0.95));
}

.field-effect-indicator.fortify {
    border-color: rgba(100, 150, 255, 0.6);
    background: linear-gradient(135deg, rgba(20, 40, 80, 0.95), rgba(10, 20, 50, 0.95));
}

.field-effect-indicator.energy-tide {
    border-color: rgba(255, 200, 50, 0.6);
    background: linear-gradient(135deg, rgba(80, 60, 20, 0.95), rgba(50, 35, 10, 0.95));
}

.field-effect-indicator.melee {
    border-color: rgba(200, 150, 100, 0.6);
    background: linear-gradient(135deg, rgba(60, 45, 30, 0.95), rgba(35, 25, 15, 0.95));
}

.field-effect-indicator.rejuvenation {
    border-color: rgba(80, 220, 120, 0.6);
    background: linear-gradient(135deg, rgba(20, 70, 40, 0.95), rgba(10, 40, 20, 0.95));
}

/* åœºåœ°æ•ˆæœä¸‹æ‹‰ä»‹ç»æ¡† - ç›¸å¯¹äºgame-containerå±…ä¸­æ˜¾ç¤º */
.field-effect-dropdown {
    display: none;
    position: absolute;
    top: 12%;
    left: 50%;
    transform: translateX(-50%);
    width: 60%;
    max-width: 280px;
    min-width: 180px;
    background-color: rgba(0, 0, 0, 0.95);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: clamp(6px, 1vw, 12px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.7);
    padding: clamp(8px, 1.5vw, 14px);
    z-index: 100;
    word-wrap: break-word;
    overflow-wrap: break-word;
    box-sizing: border-box;
}

/* åœºåœ°å¼¹çª—é¢œè‰²ä¸»é¢˜ - è¾¹æ¡†é¢œè‰²å’Œåœºåœ°æ•ˆæœä¸€è‡´ */
.field-effect-dropdown.killing-intent {
    border-color: rgba(255, 60, 60, 0.8);
}

.field-effect-dropdown.miasma {
    border-color: rgba(150, 50, 200, 0.8);
}

.field-effect-dropdown.fortify {
    border-color: rgba(100, 150, 255, 0.8);
}

.field-effect-dropdown.energy-tide {
    border-color: rgba(255, 200, 50, 0.8);
}

.field-effect-dropdown.melee {
    border-color: rgba(200, 150, 100, 0.8);
}

.field-effect-dropdown.rejuvenation {
    border-color: rgba(80, 220, 120, 0.8);
}

.field-effect-dropdown.active {
    display: block;
}

.field-effect-dropdown-title {
    font-size: clamp(14px, 1.8vw, 20px);
    color: #ffcc00;
    margin-bottom: clamp(6px, 1vw, 12px);
    padding-bottom: clamp(4px, 0.6vw, 8px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    gap: clamp(6px, 1vw, 10px);
}

.field-effect-dropdown-desc {
    font-size: clamp(11px, 1.3vw, 15px);
    color: #ccc;
    line-height: 1.5;
    font-family: 'ZCOOL XiaoWei', sans-serif;
}

.field-effect-dropdown-effect {
    margin-top: clamp(6px, 1vw, 10px);
    padding: clamp(5px, 0.8vw, 10px);
    background: rgba(255, 255, 255, 0.08);
    border-left: 2px solid #ffcc00;
    font-size: clamp(9px, 1.1vw, 13px);
    color: #fff;
    line-height: 1.4;
    word-wrap: break-word;
}

/* åœºåœ°æ•ˆæœè§¦å‘åŠ¨ç”» */
@keyframes field-effect-appear {
    0% { opacity: 0; transform: translateY(-10px); }
    100% { opacity: 1; transform: translateY(0); }
}

.field-effect-indicator.appearing {
    animation: field-effect-appear 0.5s ease-out;
}

/* åœºåœ°æ•ˆæœå…¨å±æç¤º */
.field-effect-announce {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.7);
    z-index: 500;
    pointer-events: none;
}

.field-effect-announce.active {
    display: flex;
    animation: announce-fade 2s ease-out forwards;
}

@keyframes announce-fade {
    0% { opacity: 0; }
    20% { opacity: 1; }
    80% { opacity: 1; }
    100% { opacity: 0; }
}

.field-effect-announce-content {
    text-align: center;
    animation: announce-scale 2s ease-out;
}

@keyframes announce-scale {
    0% { transform: scale(0.5); opacity: 0; }
    20% { transform: scale(1.1); opacity: 1; }
    30% { transform: scale(1); }
    80% { transform: scale(1); opacity: 1; }
    100% { transform: scale(1.2); opacity: 0; }
}

.field-effect-announce-icon {
    font-size: clamp(48px, 10vw, 80px);
    margin-bottom: clamp(10px, 2vw, 20px);
}

.field-effect-announce-name {
    font-family: 'Ma Shan Zheng', cursive;
    font-size: clamp(32px, 6vw, 56px);
    color: #fff;
    text-shadow: 0 0 20px rgba(255, 200, 50, 0.8), 2px 2px 4px rgba(0, 0, 0, 0.8);
}

/* å‘½ä»¤åŒºåŸŸ - æ°´å¢¨é£æ ¼ */
.command-area {
    position: absolute;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 800px;
    background-color: rgba(0, 0, 0, 0.7);
    border-radius: 10px;
    padding: 15px;
    z-index: 10;
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
}

.command-label {
    margin-bottom: 10px;
    font-size: 24px;
    color: #eee;
    text-align: center;
    font-family: 'Ma Shan Zheng', cursive;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
}

.command-buttons {
    display: flex;
    justify-content: space-around;
    gap: 10px;
}

/* æŒ‡ä»¤æŒ‰é’®æµ®åŠ¨æ ·å¼ - 60%å±å¹•å®½åº¦ï¼Œé å³æ”¾ç½® */
.command-buttons-floating {
    position: absolute;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: row;
    gap: clamp(3px, 0.5vw, 8px);
    padding: clamp(4px, 0.6vw, 10px);
    z-index: 10;
    justify-content: flex-end;
    flex-wrap: nowrap;
    width: 60%;
    max-width: 60vw;
}

.command-btn {
    flex: 1 1 0;
    min-width: 0;
    /* ä½¿ç”¨aspect-ratioç¡®ä¿é«˜åº¦å§‹ç»ˆæ˜¯å®½åº¦çš„2å€ */
    aspect-ratio: 1 / 2;
    height: auto;
    margin: 0;
    padding: clamp(4px, 0.6vw, 10px);
    border-radius: clamp(4px, 0.6vw, 8px);
    background: #111 !important;
    color: #fff !important;
    border: 1px solid #333;
    box-shadow: 1px 1px 4px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: visible;
}

.command-btn::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    z-index: -1;
    border-radius: clamp(4px, 0.6vw, 8px);
}

.command-btn:hover:not(.disabled) {
    background: #222 !important;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
    border-color: #666;
}

.command-btn:active:not(.disabled) {
    background: #333 !important;
    transform: translateY(0);
}

.command-btn.selected {
    background: linear-gradient(135deg, #1a3a75, #0c1f3e) !important;
    border-color: #3a6cbf;
    box-shadow: 0 0 15px rgba(58, 108, 191, 0.6);
}

/* é€ƒè·‘æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
.command-btn.escape-btn {
    background: linear-gradient(135deg, #4a1a1a, #2a0a0a) !important;
    border-color: #733;
}

.command-btn.escape-btn:hover:not(.disabled) {
    background: linear-gradient(135deg, #5a2a2a, #3a1a1a) !important;
    border-color: #944;
}

.command-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* é”®ä½æç¤ºè‡ªé€‚åº” */
.command-btn .key-hint {
    position: absolute;
    top: clamp(2px, 0.3vw, 5px);
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(0, 0, 0, 0.7);
    color: #fff;
    font-size: clamp(8px, 1vw, 12px);
    padding: clamp(1px, 0.2vw, 3px) clamp(2px, 0.4vw, 5px);
    border-radius: clamp(2px, 0.2vw, 4px);
    line-height: 1;
}

/* æŒ‰é’®åç§° - çºµå‘æ’åˆ— */
.command-btn .btn-name {
    display: block !important;
    font-size: clamp(14px, 2vw, 22px) !important;
    font-weight: bold !important;
    font-family: 'Ma Shan Zheng', cursive !important;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5) !important;
    text-align: center !important;
    line-height: 1.2 !important;
    margin-top: clamp(12px, 2vw, 20px) !important;
    writing-mode: vertical-rl !important;
    text-orientation: upright !important;
    letter-spacing: 0.15em !important;
    white-space: nowrap !important;
}

/* æˆ˜æ–—æ—¥å¿— - éšè—ï¼ˆæ”¹ä¸ºä¸‹æ‹‰æ¡†æ˜¾ç¤ºï¼‰ */
.battle-log {
    display: none;
}

/* ç¡®è®¤å¼¹çª— - æ‰‹æœºä¼˜åŒ– */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 100;
    align-items: center;
    justify-content: center;
    padding: 15px;
}

.modal-content {
    width: clamp(240px, 60vw, 320px);
    max-width: 85vw;
    border-radius: clamp(4px, 1vw, 8px);
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
    color: #fff;
    position: relative;
    border: 2px solid #553c28;
    overflow: hidden;
}

.modal-header {
    padding: clamp(6px, 2vw, 12px);
    background-color: rgba(0, 0, 0, 0.6);
    font-size: clamp(14px, 3.2vw, 20px);
    font-weight: bold;
    text-align: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    font-family: 'Ma Shan Zheng', cursive;
    /* æ·»åŠ é»‘è‰²æè¾¹æ•ˆæœ */
    text-shadow: 
    -1px -1px 1px #000,
    1px -1px 1px #000,
    -1px 1px 1px #000,
    1px 1px 1px #000,
    2px 2px 3px rgba(0, 0, 0, 0.8);
}

.modal-body {
    padding: clamp(8px, 2.5vw, 15px);
    font-size: clamp(12px, 2.8vw, 16px);
    text-align: center;
    line-height: 1.4;
    /* æ·»åŠ ä¸æŒ‰é’®ç›¸åŒçš„å­—ä½“æ ·å¼ */
    font-family: 'Ma Shan Zheng', cursive;
    font-weight: bold;
    color: #fff;
    /* é»‘è‰²æè¾¹æ•ˆæœ */
    text-shadow: 
        -1px -1px 1px #000,
        1px -1px 1px #000,
        -1px 1px 1px #000,
        1px 1px 1px #000,
        2px 2px 3px rgba(0, 0, 0, 0.8);
}

.modal-footer {
    padding: clamp(6px, 2vw, 12px);
    display: flex;
    justify-content: space-around;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    gap: clamp(6px, 1.5vw, 12px);
}

.modal-footer button {
    padding: clamp(4px, 1.5vw, 8px) clamp(10px, 3vw, 16px);
    border: none;
    border-radius: clamp(3px, 0.8vw, 6px);
    cursor: pointer;
    font-size: clamp(11px, 2.5vw, 14px);
    font-family: 'ZCOOL XiaoWei', sans-serif;
    transition: all 0.3s;
    flex: 1;
    min-height: clamp(24px, 5vw, 36px);
}

#confirm-action {
    background: linear-gradient(to bottom, #5c3b1c, #34210f);
    color: white;
    border: 1px solid #7c5a3d;
}

#confirm-action:hover {
    background: linear-gradient(to bottom, #6c4a2b, #3e2914);
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
}

#cancel-action {
    background: linear-gradient(to bottom, #444, #222);
    color: #ddd;
    border: 1px solid #666;
}

#cancel-action:hover {
    background: linear-gradient(to bottom, #555, #333);
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
}

/* åŠ¨ç”»æ•ˆæœ */
@keyframes attack {
    0% { transform: translateX(0); }
    25% { transform: translateX(40px); }
    50% { transform: translateX(0); }
    100% { transform: translateX(0); }
}

@keyframes enemy-attack {
    0% { transform: translateX(0); }
    25% { transform: translateX(-40px); }
    50% { transform: translateX(0); }
    100% { transform: translateX(0); }
}

@keyframes hit {
    0% { filter: brightness(1); }
    25% { filter: brightness(3) saturate(2); }
    50% { filter: brightness(1); }
    100% { filter: brightness(1); }
}

@keyframes defend {
    0% { filter: brightness(1); }
    50% { filter: brightness(1.5) hue-rotate(120deg); }
    100% { filter: brightness(1); }
}

@keyframes special {
    0% { filter: brightness(1); }
    25% { filter: brightness(2) saturate(2) hue-rotate(270deg); }
    50% { filter: brightness(1.5) saturate(1.5) hue-rotate(180deg); }
    75% { filter: brightness(2) saturate(2) hue-rotate(90deg); }
    100% { filter: brightness(1); }
}

.player-attack {
    animation: attack 0.6s ease;
}

.enemy-attack {
    animation: enemy-attack 0.6s ease;
}

.player-hit {
    animation: hit 0.6s ease;
}

.enemy-hit {
    animation: hit 0.6s ease;
}

.player-defend {
    animation: defend 1s ease;
}

.enemy-defend {
    animation: defend 1s ease;
}

.player-special {
    animation: special 1s ease;
}

.enemy-special {
    animation: special 1s ease;
}

/* ç”»é¢æ™ƒåŠ¨åŠ¨ç”» */
@keyframes shake {
  0% { transform: translate(0, 0); }
  20% { transform: translate(-10px, 0); }
  40% { transform: translate(10px, 0); }
  60% { transform: translate(-10px, 0); }
  80% { transform: translate(10px, 0); }
  100% { transform: translate(0, 0); }
}
.shake {
  animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
}

/* å—å‡»çº¢è‰²è¾¹ç¼˜é«˜äº®åŠ¨ç”» */
@keyframes damage-flash {
  0% { box-shadow: 0 0 0 0 rgba(255,0,0,0.7); }
  30% { box-shadow: 0 0 0 20px rgba(255,0,0,0.5); }
  60% { box-shadow: 0 0 0 40px rgba(255,0,0,0.2); }
  100% { box-shadow: 0 0 0 0 rgba(255,0,0,0); }
}
.damage-flash {
  animation: damage-flash 0.5s;
}

/* ä¸»è§’å›¾å±‚ */
.player-portrait-layer {
    position: absolute;
    left: 0;
    bottom: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 3;
    background: none;
    background-position: center bottom;
    background-repeat: no-repeat;
    background-size: contain;
    transition: background-image 0.3s, filter 0.2s ease;
    /* ä½¿ç”¨CSSå˜é‡æ§åˆ¶æè¾¹é¢œè‰²ï¼Œé»˜è®¤ç™½è‰² */
    --glow-color: 255, 255, 255;
    --glow-intensity: 0.8;
    filter: drop-shadow(0 0 1px rgba(var(--glow-color), var(--glow-intensity)))
            drop-shadow(0 0 2px rgba(var(--glow-color), calc(var(--glow-intensity) * 0.6)))
            drop-shadow(0 0 3px rgba(var(--glow-color), calc(var(--glow-intensity) * 0.4)));
}

.player-portrait-layer.shake {
    animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
}

/* NPCå›¾å±‚ */
.npc-portrait-layer {
    position: absolute;
    left: 0;
    bottom: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 3;
    background: none;
    background-position: center bottom;
    background-repeat: no-repeat;
    background-size: contain;
    transition: background-image 0.3s, filter 0.2s ease;
    /* ä½¿ç”¨CSSå˜é‡æ§åˆ¶æè¾¹é¢œè‰²ï¼Œé»˜è®¤ç™½è‰² */
    --glow-color: 255, 255, 255;
    --glow-intensity: 0.8;
    filter: drop-shadow(0 0 1px rgba(var(--glow-color), var(--glow-intensity)))
            drop-shadow(0 0 2px rgba(var(--glow-color), calc(var(--glow-intensity) * 0.6)))
            drop-shadow(0 0 3px rgba(var(--glow-color), calc(var(--glow-intensity) * 0.4)));
}

.npc-portrait-layer.shake {
    animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
}

/* æ”»å‡»æè¾¹æ•ˆæœ - é»„è‰²ï¼ˆè½»æ”»å‡»ï¼‰ */
.player-portrait-layer.glow-yellow,
.npc-portrait-layer.glow-yellow {
    --glow-color: 255, 215, 0;
    --glow-intensity: 1;
    filter: drop-shadow(0 0 1px rgba(var(--glow-color), var(--glow-intensity)))
            drop-shadow(0 0 2px rgba(var(--glow-color), calc(var(--glow-intensity) * 0.6)))
            drop-shadow(0 0 3px rgba(var(--glow-color), calc(var(--glow-intensity) * 0.4)));
}

/* æ”»å‡»æè¾¹æ•ˆæœ - æ©™è‰²ï¼ˆé‡æ”»å‡»ï¼‰ */
.player-portrait-layer.glow-orange,
.npc-portrait-layer.glow-orange {
    --glow-color: 255, 140, 0;
    --glow-intensity: 1;
    filter: drop-shadow(0 0 1px rgba(var(--glow-color), var(--glow-intensity)))
            drop-shadow(0 0 2px rgba(var(--glow-color), calc(var(--glow-intensity) * 0.6)))
            drop-shadow(0 0 3px rgba(var(--glow-color), calc(var(--glow-intensity) * 0.4)));
}

/* æ”»å‡»æè¾¹æ•ˆæœ - çº¢è‰²ï¼ˆç»æ‹›ï¼‰ */
.player-portrait-layer.glow-red,
.npc-portrait-layer.glow-red {
    --glow-color: 255, 48, 48;
    --glow-intensity: 1;
    filter: drop-shadow(0 0 1px rgba(var(--glow-color), var(--glow-intensity)))
            drop-shadow(0 0 2px rgba(var(--glow-color), calc(var(--glow-intensity) * 0.6)))
            drop-shadow(0 0 3px rgba(var(--glow-color), calc(var(--glow-intensity) * 0.4)));
}

.screen-flash {
    position: fixed;
    left: 0; top: 0; right: 0; bottom: 0;
    width: 100vw;
    height: 100vh;
    pointer-events: none;
    z-index: 1000;
    opacity: 0;
    background: rgba(255,0,0,0.3);
    box-shadow: 0 0 0 20px rgba(255,0,0,0.5), 0 0 60px 40px rgba(255,0,0,0.2) inset;
    transition: opacity 0.2s;
}

.screen-flash.active {
    opacity: 1;
    transition: opacity 0.1s;
}

/* ========== æˆ˜æ–—ç‰¹æ•ˆå›¾å±‚ ========== */
/* ç‰¹æ•ˆåŸºç¡€æ ·å¼ */
.battle-effect {
    position: absolute;
    pointer-events: none;
    visibility: hidden;
    z-index: 5;  /* é«˜äºç«‹ç»˜å±‚z-index:3ï¼Œç¡®ä¿ç‰¹æ•ˆå¯è§ */
}

.battle-effect.active {
    visibility: visible;
}

/* å˜´ç‚®ç‰¹æ•ˆ - ç©å®¶ï¼ˆå·¦ä¾§ï¼Œå¤´éƒ¨ä¸Šæ–¹åå³ï¼‰ */
/* å˜´ç‚®æ˜¯é€æ˜PNGï¼Œä¸éœ€è¦mix-blend-mode */
.player-taunt-effect {
    left: 23%;
    top: 37%;
    /* width: clamp(80px, 15vw, 180px); */
    width: 15%;
    height: auto;
    transform: scaleX(1);
}

/* å˜´ç‚®ç‰¹æ•ˆ - æ•Œäººï¼ˆå³ä¾§ï¼Œå¤´éƒ¨ä¸Šæ–¹åå·¦ï¼‰ */
.enemy-taunt-effect {
    right: 23%;
    top: 27%;
    /* width: clamp(100px, 18vw, 220px); */
    width: 12%;
    height: auto;
    transform: scaleX(-1);
}

/* é›†æ°”ç‰¹æ•ˆ - ç©å®¶ï¼ˆå·¦ä¾§è„šä¸‹ï¼‰ */
.player-gather-effect {
    left: -13%;
    bottom: -21%;
    /* width: clamp(240px, 44vw, 560px); */
    width:  55%;
    height: auto;
}

/* é›†æ°”ç‰¹æ•ˆ - æ•Œäººï¼ˆå³ä¾§è„šä¸‹ï¼‰ */
.enemy-gather-effect {
    right: -3%;
    bottom: 4%;
    /* width: clamp(188px, 35vw, 438px); */
    width: 40%;
    height: auto;
}

/* æ”»å‡»ç‰¹æ•ˆ - ç©å®¶è¢«å‡»ä¸­ï¼ˆå·¦ä¾§èº«ä½“ä¸­å¤®ï¼‰ */
.player-hit-effect {
    left: -3%;
    top: 50%;
    /* width: clamp(140px, 35vw, 350px); */
    width: 40%;
    height: auto;
}

/* æ”»å‡»ç‰¹æ•ˆ - æ•Œäººè¢«å‡»ä¸­ï¼ˆå³ä¾§èº«ä½“ä¸­å¤®ï¼‰ */
.enemy-hit-effect {
    right: 0%;
    top: 35%;
    /* width: clamp(130px, 25vw, 320px); */
    width: 27%;
    height: auto;
}

/* ç‰¹æ•ˆå›¾ç‰‡æ ·å¼ */
.battle-effect img {
    width: 100%;
    height: auto;
    display: block;
}

/* é»‘åº•å…‰æ•ˆGIFä½¿ç”¨screenæ··åˆæ¨¡å¼ï¼Œè®©é»‘è‰²å˜é€æ˜ */
/* åŒæ—¶å¢åŠ å¯¹æ¯”åº¦ï¼Œæ¶ˆé™¤è¾¹ç¼˜ç°è‰²/å‘ç™½é—®é¢˜ */
.player-gather-effect,
.enemy-gather-effect,
.player-hit-effect,
.enemy-hit-effect {
    mix-blend-mode: screen;
}

.player-gather-effect img,
.enemy-gather-effect img,
.player-hit-effect img,
.enemy-hit-effect img {
    mix-blend-mode: screen;
    /* å¢åŠ å¯¹æ¯”åº¦ï¼Œè®©æ¥è¿‘é»‘è‰²çš„ç°è¾¹å˜æˆçº¯é»‘ï¼ˆé€æ˜ï¼‰ */
    filter: contrast(1.3) brightness(1.1);
}

#restart-game {
    background: linear-gradient(to bottom, #5c3b1c, #34210f);
    color: white;
    border: 1px solid #7c5a3d;
    padding: clamp(6px, 2vw, 12px) clamp(20px, 4vw, 32px);
    border-radius: clamp(3px, 0.8vw, 6px);
    cursor: pointer;
    font-size: clamp(12px, 2.8vw, 16px);
    font-family: 'Ma Shan Zheng', cursive;
    transition: all 0.3s;
    width: 100%;
    min-height: clamp(28px, 6vw, 40px);
}

#restart-game:hover {
    background: linear-gradient(to bottom, #6c4a2b, #3e2914);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
}

/* ç§»åŠ¨ç«¯ä¼˜åŒ– */
@media (max-width: 900px) {
    /* .command-buttons-floating {
        width: 70vw;
        min-width: 260px;
        gap: clamp(2px, 0.8vw, 6px);
        padding: clamp(2px, 0.4vw, 6px) 0 0 clamp(2px, 0.4vw, 6px);
    } */
    
    .command-btn .btn-name {
        font-size: clamp(0.8rem, 2.8vw, 1.1rem);
    }
    
    .command-btn .key-hint {
        font-size: clamp(0.6rem, 1.8vw, 0.9rem);
    }
}

@media (max-width: 600px) {
    /* .command-buttons-floating {
        width: 85vw;
        min-width: 240px;
        gap: clamp(1px, 0.5vw, 4px);
        padding: clamp(1px, 0.3vw, 4px) 0 0 clamp(1px, 0.3vw, 4px);
        flex-direction: row;
    } */
    
    .command-btn .btn-name {
        font-size: clamp(0.7rem, 3vw, 1rem);
    }
    
    .command-btn .key-hint {
        font-size: clamp(0.5rem, 2vw, 0.8rem);
    }
}

/* è¶…å¤§å±å¹•ä¼˜åŒ– */
@media (min-width: 1400px) {
    /* .command-buttons-floating {
        width: 45vw;
        max-width: 700px;
    } */
    
    .command-btn .btn-name {
        font-size: clamp(1.2rem, 1.8vw, 1.6rem);
    }
}

/* è¶…å°å±å¹•ä¼˜åŒ– */
@media (max-width: 480px) {
    /* .command-buttons-floating {
        width: 95vw;
        min-width: 200px;
        gap: clamp(1px, 0.2vw, 2px);
        padding: 2px 0 0 2px;
        flex-direction: row;
    } */
    
    .command-btn {
        padding: clamp(0.2vw, 0.8vw, 1vw) clamp(0.1vw, 0.4vw, 0.6vw);
    }
    
    .command-btn .btn-name {
        font-size: clamp(0.6rem, 3.5vw, 0.9rem);
    }
    
    .command-btn .key-hint {
        font-size: clamp(0.4rem, 2.8vw, 0.7rem);
        padding: clamp(0.5px, 0.1vw, 2px) clamp(2px, 0.3vw, 4px);
    }
}

/* æ¨ªå±æ‰‹æœºä¼˜åŒ– */
@media (max-width: 900px) and (orientation: landscape) {
    .battle-scene {
        padding-bottom: clamp(60px, 10vw, 100px);
    }
    
    .turn-indicator {
        top: 0;
    }
}

/* ç»Ÿä¸€çš„å¼¹çª—æŒ‰é’®é£æ ¼ */
.modal-actions {
    display: flex;
    gap: clamp(8px, 2vw, 14px);
    justify-content: center;
    padding: clamp(8px, 2vw, 14px);
    background: rgba(0,0,0,0.4);
    border-top: 1px solid rgba(255,255,255,0.18);
}

/* é“å…·å¼¹çª—æ ·å¼ - å…¨å±è¦†ç›–game-containerï¼Œç´§å‡‘å¸ƒå±€ç¡®ä¿4ä¸ªé“å…·åŒå±æ˜¾ç¤º */
#item-modal {
    position: absolute !important;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    z-index: 100;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 0;
}

.item-modal-content {
    width: 100%;
    height: 100%;
    max-width: 100%;
    max-height: 100%;
    border-radius: 0;
    box-shadow: none;
    color: #fff;
    position: relative;
    border: none;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    background-color: rgba(20, 15, 10, 0.98);
    background-size: cover;
    background-position: center;
}

.item-modal-header {
    padding: 1.5vh 2vw;
    background-color: rgba(0, 0, 0, 0.6);
    font-size: clamp(0.9rem, 2.5vw, 1.4rem);
    font-weight: bold;
    text-align: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.25);
    font-family: 'Ma Shan Zheng', cursive;
    text-shadow:
        -1px -1px 1px #000,
        1px -1px 1px #000,
        -1px 1px 1px #000,
        1px 1px 1px #000,
        2px 2px 3px rgba(0, 0, 0, 0.8);
    flex-shrink: 0;
}

.item-list {
    padding: 1.5vh 3vw;
    display: flex;
    flex-direction: column;
    gap: 1.5vh;
    flex: 1;
    overflow: hidden;
    justify-content: space-evenly;
}

.item-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.2vh 2.5vw;
    background: rgba(0, 0, 0, 0.6);
    border-radius: 0.6vw;
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: all 0.15s ease;
    flex: 1;
    max-height: 16vh;
    min-height: 0;
}

.item-row:hover {
    background: rgba(60, 50, 30, 0.7);
    border-color: rgba(255, 200, 100, 0.5);
}

.item-row.disabled {
    opacity: 0.5;
    pointer-events: none;
}

.item-info {
    display: flex;
    flex-direction: column;
    gap: 0.3vh;
    flex: 1;
    min-width: 0;
}

.item-name {
    font-size: clamp(0.85rem, 2.2vw, 1.2rem);
    font-weight: bold;
    font-family: 'Ma Shan Zheng', cursive;
    color: #ffd700;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.item-desc {
    font-size: clamp(0.6rem, 1.5vw, 0.85rem);
    color: #bbb;
    font-family: 'ZCOOL XiaoWei', sans-serif;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.item-count {
    font-size: clamp(0.8rem, 2vw, 1.1rem);
    color: #88ff88;
    font-weight: bold;
    min-width: 5vw;
    text-align: center;
    margin: 0 1.5vw;
    flex-shrink: 0;
}

.item-count.empty {
    color: #ff6666;
}

.item-use-btn {
    padding: 0.8vh 2.5vw;
    background: linear-gradient(135deg, #5c3b1c, #34210f);
    color: #fff;
    border: 1px solid #7c5a3d;
    border-radius: 0.5vw;
    font-size: clamp(0.75rem, 1.8vw, 1rem);
    font-family: 'Ma Shan Zheng', cursive;
    cursor: pointer;
    transition: all 0.15s ease;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.6);
    white-space: nowrap;
    flex-shrink: 0;
}

.item-use-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, #7c5b3c, #4e3020);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
}

.item-use-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

.item-modal-footer {
    padding: 1.5vh 2vw;
    background: rgba(0, 0, 0, 0.5);
    border-top: 1px solid rgba(255, 255, 255, 0.15);
    text-align: center;
    flex-shrink: 0;
}

.item-close-btn {
    padding: 1vh 5vw;
    background: linear-gradient(135deg, #444, #222);
    color: #ddd;
    border: 1px solid #666;
    border-radius: 0.5vw;
    font-size: clamp(0.8rem, 2vw, 1.1rem);
    font-family: 'Ma Shan Zheng', cursive;
    cursor: pointer;
    transition: all 0.15s ease;
}

.item-close-btn:hover {
    background: linear-gradient(135deg, #555, #333);
}

/* é“å…·ä½¿ç”¨æç¤ºæ ·å¼ */
.item-used-hint {
    padding: 2vh 3vw;
    background: rgba(100, 60, 20, 0.9);
    border: 1px solid #ffd700;
    border-radius: 0.6vw;
    text-align: center;
    font-family: 'Ma Shan Zheng', cursive;
    font-size: clamp(0.9rem, 2.2vw, 1.2rem);
    color: #ffd700;
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* æ¨ªå±å’Œå°å±å¹•ä¸‹çš„é“å…·å¼¹çª—ä¼˜åŒ– */
@media (max-height: 500px) {
    .item-modal-header {
        padding: 0.8vh 2vw;
        font-size: clamp(0.8rem, 2vw, 1rem);
    }
    
    .item-list {
        padding: 0.8vh 2vw;
        gap: 0.8vh;
    }
    
    .item-row {
        padding: 0.6vh 2vw;
        max-height: 20vh;
    }
    
    .item-name {
        font-size: clamp(0.75rem, 1.8vw, 1rem);
    }
    
    .item-desc {
        font-size: clamp(0.55rem, 1.2vw, 0.75rem);
    }
    
    .item-use-btn {
        padding: 0.5vh 2vw;
        font-size: clamp(0.65rem, 1.5vw, 0.85rem);
    }
    
    .item-modal-footer {
        padding: 0.8vh 2vw;
    }
    
    .item-close-btn {
        padding: 0.6vh 4vw;
        font-size: clamp(0.7rem, 1.6vw, 0.9rem);
    }
}

/* æå°å±å¹•ä¼˜åŒ– */
@media (max-height: 400px) {
    .item-modal-header {
        padding: 0.5vh 1.5vw;
    }
    
    .item-list {
        padding: 0.5vh 1.5vw;
        gap: 0.5vh;
    }
    
    .item-row {
        padding: 0.4vh 1.5vw;
    }
    
    .item-info {
        gap: 0;
    }
    
    .item-modal-footer {
        padding: 0.5vh 1.5vw;
    }
}
.modal-actions .btn {
    min-width: clamp(90px, 20vw, 160px);
    padding: clamp(8px, 1.8vw, 12px) clamp(14px, 2.8vw, 22px);
    border-radius: clamp(6px, 1vw, 10px);
    border: 1px solid rgba(255,255,255,0.25);
    font-family: 'Ma Shan Zheng', cursive;
    font-weight: bold;
    color: #fff;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.35);
    transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
}
.modal-actions .btn:hover { transform: translateY(-2px); filter: brightness(1.05); box-shadow: 0 8px 18px rgba(0,0,0,0.45); }
.modal-actions .btn:active { transform: translateY(0); }
.modal-actions .btn.btn-cancel { background: linear-gradient(135deg, #2b2b2b 0%, #1a1a1a 100%); border-color: #555; }
.modal-actions .btn.btn-danger { background: linear-gradient(135deg, #C62828 0%, #8E0000 100%); border-color: #ff6b6b; }
.modal-actions .btn.btn-danger:hover { box-shadow: 0 8px 20px rgba(198,40,40,0.5); }

</style>
</head>
<body>
    <div class="game-container">
        <!-- ä¸»è§’å›¾å±‚ -->
        <div class="player-portrait-layer"></div>
        <!-- NPCå›¾å±‚ -->
        <div class="npc-portrait-layer"></div>
        <div class="screen-flash"></div>
        
        <!-- æˆ˜æ–—ç‰¹æ•ˆå›¾å±‚ -->
        <!-- ç©å®¶ç‰¹æ•ˆ -->
        <div class="battle-effect player-taunt-effect" id="player-taunt-effect">
            <img src="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/assets/image/static/å˜´ç‚®.png" alt="å˜´ç‚®">
        </div>
        <div class="battle-effect player-gather-effect" id="player-gather-effect">
            <img src="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/assets/image/static/é›†æ°”.gif" alt="é›†æ°”">
        </div>
        <div class="battle-effect player-hit-effect" id="player-hit-effect">
            <img src="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/assets/image/static/æ”»å‡».gif" alt="æ”»å‡»">
        </div>
        <!-- æ•Œäººç‰¹æ•ˆ -->
        <div class="battle-effect enemy-taunt-effect" id="enemy-taunt-effect">
            <img src="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/assets/image/static/å˜´ç‚®.png" alt="å˜´ç‚®">
        </div>
        <div class="battle-effect enemy-gather-effect" id="enemy-gather-effect">
            <img src="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/assets/image/static/é›†æ°”.gif" alt="é›†æ°”">
        </div>
        <div class="battle-effect enemy-hit-effect" id="enemy-hit-effect">
            <img src="https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/assets/image/static/æ”»å‡».gif" alt="æ”»å‡»">
        </div>
        
        <!-- æˆ˜æ–—åœºæ™¯ -->
        <div class="battle-scene">
 
            <!-- ç©å®¶çŠ¶æ€åŒº -->
            <div class="player-status-area">
                <div class="name-row">
                    <div class="character-name" id="player-name">user</div>
                    <div class="taunt-status" id="player-taunt-status">æŒ‘è¡…ä¸­</div>
                </div>
                <div class="stats-row">
                    <div class="health-container">
                        <div class="health-bar">
                            <div class="health-fill" id="player-health"></div>
                            <div class="health-text">
                                <span id="player-health-value">50</span>/<span id="player-max-health">50</span>
                            </div>
                        </div>
                    </div>
                    <div class="energy-display">
                        <div class="energy-value">æ°”:<span id="player-energy">0</span></div>
                    </div>
                </div>
            </div>

            <!-- æ•ŒäººçŠ¶æ€åŒº -->
            <div class="enemy-status-area">
                <div class="name-row">
                    <div class="character-name" id="enemy-name">åŒ—æ¡</div>
                    <div class="taunt-status" id="enemy-taunt-status">æŒ‘è¡…ä¸­</div>
                </div>
                <div class="stats-row">
                    <div class="health-container">
                        <div class="health-bar">
                            <div class="health-fill" id="enemy-health"></div>
                            <div class="health-text">
                                <span id="enemy-health-value">50</span>/<span id="enemy-max-health">50</span>
                            </div>
                        </div>
                    </div>
                    <div class="energy-display">
                        <div class="energy-value">æ°”:<span id="enemy-energy">0</span></div>
                    </div>
                </div>
            </div>

            <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
            <div class="top-status-bar">
                <!-- åœºåœ°æ•ˆæœæŒ‡ç¤ºå™¨ï¼ˆåœ¨ä¸Šæ–¹ï¼‰ -->
                <div class="field-effect-indicator" id="field-effect-indicator" onclick="toggleFieldEffectDropdown(event)">
                    <span class="field-effect-icon" id="field-effect-icon">ğŸ”¥</span>
                    <span class="field-effect-name" id="field-effect-name">æ€æ„</span>
                    <span class="field-effect-timer" id="field-effect-timer">(3)</span>
                </div>
                
                <!-- å›åˆæŒ‡ç¤ºå™¨ï¼ˆåœ¨ä¸‹æ–¹ï¼Œç‚¹å‡»æ˜¾ç¤ºæ—¥å¿—ï¼‰ -->
                <div class="turn-indicator" id="turn-indicator" onclick="toggleLogDropdown()">
                    <div id="turn-text">ç¬¬1å›åˆ</div>
                    <!-- æ—¥å¿—ä¸‹æ‹‰æ¡† -->
                    <div class="log-dropdown" id="log-dropdown">
                        <p>æˆ˜æ–—å¼€å§‹ï¼Œè¯·é€‰æ‹©è¡ŒåŠ¨...</p>
                    </div>
                </div>
            </div>
            
            <!-- åœºåœ°æ•ˆæœä»‹ç»ä¸‹æ‹‰æ¡† - ç‹¬ç«‹äºæŒ‡ç¤ºå™¨ï¼Œä½œä¸ºgame-containerçš„ç›´æ¥å­å…ƒç´  -->
            <div class="field-effect-dropdown" id="field-effect-dropdown">
                <div class="field-effect-dropdown-title">
                    <span id="field-dropdown-icon">ğŸ”¥</span>
                    <span id="field-dropdown-name">æ€æ„</span>
                </div>
                <div class="field-effect-dropdown-desc" id="field-dropdown-desc">
                    æˆ˜åœºæ€æ°”å¼¥æ¼«ï¼Œæ¿€å‘åŒæ–¹æˆ˜æ„
                </div>
                <div class="field-effect-dropdown-effect" id="field-dropdown-effect">
                    åŒæ–¹æ”»å‡»ä¼¤å®³Ã—1.5ï¼Œä½†æ¯æ¬¡æ”»å‡»è‡ªå·±ä¹Ÿå—åˆ°25%ä¼¤å®³
                </div>
            </div>
            
            <!-- åœºåœ°æ•ˆæœå…¨å±æç¤º -->
            <div class="field-effect-announce" id="field-effect-announce">
                <div class="field-effect-announce-content">
                    <div class="field-effect-announce-icon" id="announce-icon">ğŸ”¥</div>
                    <div class="field-effect-announce-name" id="announce-name">æ€æ„</div>
                </div>
            </div>

            <!-- å·¦ä¾§ç©å®¶è§’è‰² -->
            <div class="character player-character"></div>

            <!-- å³ä¾§æ•Œæ–¹è§’è‰² -->
            <div class="character enemy-character"></div>

            <!-- æˆ˜æ–—å‘½ä»¤åŒºåŸŸ -->
            <div class="command-buttons-floating">
                <div class="command-btn" id="gather" data-key="Q">
                    <div class="key-hint">Q</div>
                    <div class="btn-name">é›†æ°”</div>
                </div>
                <div class="command-btn" id="defend" data-key="W">
                    <div class="key-hint">W</div>
                    <div class="btn-name">é˜²å¾¡</div>
                </div>
                <div class="command-btn" id="light-attack" data-key="E">
                    <div class="key-hint">E</div>
                    <div class="btn-name">è½»å‡»</div>
                </div>
                <div class="command-btn" id="heavy-attack" data-key="R">
                    <div class="key-hint">R</div>
                    <div class="btn-name">é‡å‡»</div>
                </div>
                <div class="command-btn" id="special" data-key="T">
                    <div class="key-hint">T</div>
                    <div class="btn-name">ç»æ‹›</div>
                </div>
                <div class="command-btn" id="taunt" data-key="Y">
                    <div class="key-hint">Y</div>
                    <div class="btn-name">å˜´ç‚®</div>
                </div>
                <div class="command-btn" id="item" data-key="U">
                    <div class="key-hint">U</div>
                    <div class="btn-name">é“å…·</div>
                </div>
                <div class="command-btn escape-btn" id="escape" data-key="Escape">
                    <div class="key-hint">Esc</div>
                    <div class="btn-name">é€ƒè·‘</div>
                </div>
            </div>
        </div>

        <!-- æˆ˜æ–—æ—¥å¿—ï¼ˆéšè—ï¼Œæ•°æ®ä¿ç•™ç”¨äºä¸‹æ‹‰æ¡†åŒæ­¥ï¼‰ -->
        <div class="battle-log" id="battle-log">
            <p>æˆ˜æ–—å¼€å§‹ï¼Œè¯·é€‰æ‹©è¡ŒåŠ¨...</p>
        </div>
        
        <!-- ç¡®è®¤å¼¹çª— -->
        <div id="confirm-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">ç¡®è®¤è¡ŒåŠ¨</div>
                <div class="modal-body" id="confirm-body">
                    ä½ ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ
                    <div id="selected-action" style="margin-top:8px;"></div>
                </div>
                <div class="modal-actions">
                    <button id="cancel-action" class="btn btn-cancel">è¿”å›æˆ˜æ–—</button>
                    <button id="confirm-action" class="btn btn-danger">ç¡®è®¤è¡ŒåŠ¨</button>
                 </div>
             </div>
         </div>

        <!-- é€€å‡ºæˆ˜æ–—ç¡®è®¤ï¼ˆå…¨å±å›ºå®šï¼‰ -->
        <div id="exit-battle-overlay" class="modal" style="z-index:1000;">
            <div class="modal-content">
                <div class="modal-header">ç¡®è®¤é€€å‡º</div>
                <div class="modal-body">ç¡®å®šè¦é€€å‡ºæˆ˜æ–—å—ï¼Ÿ</div>
                <div class="modal-actions">
                    <button class="btn btn-cancel" onclick="document.getElementById('exit-battle-overlay').style.display='none'">è¿”å›æˆ˜æ–—</button>
                    <button class="btn btn-danger" onclick="exitBattle('quit')">ç¡®è®¤é€€å‡º</button>
                 </div>
             </div>
         </div>

        <!-- æ¸¸æˆç»“æŸå¼¹çª— -->
        <div id="game-over-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header" id="game-over-title">æ¸¸æˆç»“æŸ</div>
                <div class="modal-body" id="game-over-message">
                    æ¸¸æˆç»“æŸä¿¡æ¯
                </div>
                <div class="modal-footer" id="game-over-footer">
                    <button id="restart-game">é‡æ–°å¼€å§‹</button>
                </div>
            </div>
        </div>

        <!-- é“å…·é€‰æ‹©å¼¹çª— -->
        <div id="item-modal" class="modal">
            <div class="item-modal-content">
                <div class="item-modal-header">é€‰æ‹©é“å…·</div>
                <div class="item-list" id="item-list">
                    <!-- é“å…·åˆ—è¡¨å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="item-modal-footer">
                    <button class="item-close-btn" onclick="closeItemModal()">è¿”å›æˆ˜æ–—</button>
                </div>
            </div>
        </div>
    </div>
    <script>
// //å›åˆåˆ¶ç³»ç»Ÿé›†æˆæ›´æ–° - è·å–URLå‚æ•°
const urlParams = new URLSearchParams(window.location.search);

// æ•Œäººç±»åˆ«åˆ—è¡¨ï¼ˆç”¨äºæ¨¡ç³ŠåŒ¹é…ï¼‰
const ENEMY_CATEGORIES = ['æ­£æ´¾å¼Ÿå­', 'åæ´¾å¼Ÿå­', 'æ¸¸ä¾ ', 'å†›å£«', 'åŒªå¾’', 'å¹³æ°‘', 'è’™é¢äºº', 'é‡å…½', 'æœªçŸ¥'];

// ç±»åˆ«åŒä¹‰è¯æ˜ å°„ï¼ˆç”¨äºæ¨¡ç³ŠåŒ¹é…ï¼‰
const CATEGORY_SYNONYMS = {
    'é—¨æ´¾å¼Ÿå­': 'æ­£æ´¾å¼Ÿå­',
    'æ­¦æ—å¼Ÿå­': 'æ­£æ´¾å¼Ÿå­',
    'æ­£é“å¼Ÿå­': 'æ­£æ´¾å¼Ÿå­',
    'é­”æ•™å¼Ÿå­': 'åæ´¾å¼Ÿå­',
    'é‚ªé“å¼Ÿå­': 'åæ´¾å¼Ÿå­',
    'é‚ªæ´¾å¼Ÿå­': 'åæ´¾å¼Ÿå­',
    'é­”é“å¼Ÿå­': 'åæ´¾å¼Ÿå­',
    'ä¾ å®¢': 'æ¸¸ä¾ ',
    'æ±Ÿæ¹–äºº': 'æ¸¸ä¾ ',
    'æ­¦è€…': 'æ¸¸ä¾ ',
    'å£«å…µ': 'å†›å£«',
    'å®˜å…µ': 'å†›å£«',
    'å®ˆå«': 'å†›å£«',
    'åœŸåŒª': 'åŒªå¾’',
    'ç›—è´¼': 'åŒªå¾’',
    'å¼ºç›—': 'åŒªå¾’',
    'å±±è´¼': 'åŒªå¾’',
    'é©¬è´¼': 'åŒªå¾’',
    'ç™¾å§“': 'å¹³æ°‘',
    'æ‘æ°‘': 'å¹³æ°‘',
    'å•†äºº': 'å¹³æ°‘',
    'è·¯äºº': 'å¹³æ°‘',
    'åˆºå®¢': 'è’™é¢äºº',
    'é»‘è¡£äºº': 'è’™é¢äºº',
    'ç¥ç§˜äºº': 'è’™é¢äºº',
    'çŒ›å…½': 'é‡å…½',
    'é‡ç‹¼': 'é‡å…½',
    'çŒ›è™': 'é‡å…½',
    'æ¯’è›‡': 'é‡å…½',
    'åŠ¨ç‰©': 'é‡å…½',
    'æ€ªç‰©': 'é‡å…½'
};

// é“å…·ç³»ç»Ÿå˜é‡
const battleItems = {
    daliwan: parseInt(urlParams.get('daliwan')) || 0,      // å¤§åŠ›ä¸¸
    jingutie: parseInt(urlParams.get('jingutie')) || 0,    // ç­‹éª¨è´´
    jinchuangyao: parseInt(urlParams.get('jinchuangyao')) || 0,  // é‡‘ç–®è¯
    piliwan: parseInt(urlParams.get('piliwan')) || 0       // éœ¹é›³ä¸¸
};

// é“å…·ä½¿ç”¨çŠ¶æ€
let itemUsedThisBattle = false;  // æœ¬åœºæˆ˜æ–—æ˜¯å¦å·²ä½¿ç”¨é“å…·
let usedItemKey = null;          // ä½¿ç”¨çš„é“å…·ç±»å‹
let damageMultiplier = 1.0;      // ä¼¤å®³å€ç‡ï¼ˆå¤§åŠ›ä¸¸æ•ˆæœï¼‰
let defenseMultiplier = 1.0;     // é˜²å¾¡å€ç‡ï¼ˆç­‹éª¨è´´æ•ˆæœï¼‰

// ========== åœºåœ°æ•ˆæœç³»ç»Ÿ ==========
const FIELD_EFFECTS = {
    'killing-intent': {
        id: 'killing-intent',
        name: 'æ€æ„',
        icon: 'ğŸ”¥',
        cssClass: 'killing-intent',
        desc: 'æˆ˜åœºæ€æ°”å¼¥æ¼«ï¼Œæ¿€å‘åŒæ–¹æˆ˜æ„',
        effectDesc: 'åŒæ–¹æ”»å‡»ä¼¤å®³Ã—1.5ï¼Œä½†æ¯æ¬¡æ”»å‡»è‡ªå·±ä¹Ÿå—åˆ°é€ æˆä¼¤å®³çš„25%',
        duration: 3
    },
    'miasma': {
        id: 'miasma',
        name: 'ç˜´ç– ',
        icon: 'â˜ ï¸',
        cssClass: 'miasma',
        desc: 'æ¯’ç˜´ç¬¼ç½©æˆ˜åœºï¼Œä¾µèš€åŒæ–¹ä½“é­„',
        effectDesc: 'åŒæ–¹æ¯å›åˆæŸå¤±10%å½“å‰ç”Ÿå‘½å€¼',
        duration: 3
    },
    'fortify': {
        id: 'fortify',
        name: 'å›ºå®ˆ',
        icon: 'ğŸ›¡ï¸',
        cssClass: 'fortify',
        desc: 'å¤©åœ°ä¹‹æ°”å‡èšï¼ŒæŠ¤ä½‘å®ˆæ–¹',
        effectDesc: 'åŒæ–¹é˜²å¾¡æ•ˆæœæå‡ä¸ºå®Œå…¨å…ä¼¤',
        duration: 3
    },
    'energy-tide': {
        id: 'energy-tide',
        name: 'æ°”æµ·',
        icon: 'âœ¨',
        cssClass: 'energy-tide',
        desc: 'çµæ°”æ½®æ¶Œï¼Œå……ç›ˆå‘¨èº«',
        effectDesc: 'åŒæ–¹æ¯å›åˆè‡ªåŠ¨è·å¾—+1æ°”',
        duration: 3
    },
    'melee': {
        id: 'melee',
        name: 'ç¼ æ–—',
        icon: 'ğŸ¤',
        cssClass: 'melee',
        desc: 'è¿‘èº«è‚‰æï¼Œæ— æš‡è¨€è¯­',
        effectDesc: 'åŒæ–¹æ— æ³•ä½¿ç”¨å˜´ç‚®',
        duration: 3
    },
    'rejuvenation': {
        id: 'rejuvenation',
        name: 'å›æ˜¥',
        icon: 'ğŸ’š',
        cssClass: 'rejuvenation',
        desc: 'ç”Ÿæœºç›ç„¶ï¼Œæ¢å¤å…ƒæ°”',
        effectDesc: 'åŒæ–¹æ¯å›åˆæ¢å¤10%æœ€å¤§ç”Ÿå‘½å€¼',
        duration: 3
    }
};

// åœºåœ°æ•ˆæœçŠ¶æ€
let activeFieldEffect = null;     // å½“å‰æ¿€æ´»çš„åœºåœ°æ•ˆæœ
let fieldEffectRemaining = 0;     // å‰©ä½™å›åˆæ•°
let fieldDropdownOpen = false;    // ä¸‹æ‹‰æ¡†æ˜¯å¦å±•å¼€

// ========== èµ„æºé¢„åŠ è½½ç³»ç»Ÿ ==========
const preloadedImages = new Map();  // ç¼“å­˜å·²é¢„åŠ è½½çš„å›¾ç‰‡

// é¢„åŠ è½½å•å¼ å›¾ç‰‡
function preloadImage(url) {
    return new Promise((resolve, reject) => {
        if (preloadedImages.has(url)) {
            resolve(preloadedImages.get(url));
            return;
        }
        const img = new Image();
        img.onload = () => {
            preloadedImages.set(url, img);
            console.log(`[é¢„åŠ è½½] æˆåŠŸ: ${url.split('/').pop()}`);
            resolve(img);
        };
        img.onerror = () => {
            console.warn(`[é¢„åŠ è½½] å¤±è´¥: ${url.split('/').pop()}`);
            reject(new Error(`Failed to load: ${url}`));
        };
        img.src = url;
    });
}

// é¢„åŠ è½½æˆ˜æ–—èµ„æºï¼ˆç«‹ç»˜å·®åˆ†+ç‰¹æ•ˆï¼‰
async function preloadBattleResources(enemyName) {
    console.log('[é¢„åŠ è½½] å¼€å§‹é¢„åŠ è½½æˆ˜æ–—èµ„æº...');
    
    const baseUrl = 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main';
    const states = ['å¾…æœº', 'æ”»å‡»', 'é˜²å¾¡', 'å—å‡»'];
    const urls = [];
    
    // ä¸»è§’çš„4ä¸ªç«‹ç»˜å·®åˆ†
    states.forEach(state => {
        urls.push(`${baseUrl}/img/æˆ˜æ–—å·®åˆ†/ä¸»è§’-${state}.png`);
    });
    
    // æ•Œäººçš„4ä¸ªç«‹ç»˜å·®åˆ†
    if (enemyName) {
        states.forEach(state => {
            urls.push(`${baseUrl}/img/æˆ˜æ–—å·®åˆ†/${enemyName}-${state}.png`);
        });
    }
    
    // ç‰¹æ•ˆæ–‡ä»¶
    urls.push(`${baseUrl}/assets/image/static/é›†æ°”.gif`);
    urls.push(`${baseUrl}/assets/image/static/æ”»å‡».gif`);
    urls.push(`${baseUrl}/assets/image/static/å˜´ç‚®.png`);
    
    // å¹¶è¡Œé¢„åŠ è½½æ‰€æœ‰èµ„æº
    const results = await Promise.allSettled(urls.map(url => preloadImage(url)));
    
    const succeeded = results.filter(r => r.status === 'fulfilled').length;
    const failed = results.filter(r => r.status === 'rejected').length;
    console.log(`[é¢„åŠ è½½] å®Œæˆ: ${succeeded}ä¸ªæˆåŠŸ, ${failed}ä¸ªå¤±è´¥`);
    
    return { succeeded, failed };
}

// é“å…·é…ç½®
const itemConfig = {
    daliwan: {
        name: 'å¤§åŠ›ä¸¸',
        desc: 'æœ¬åœºæˆ˜æ–—æ‰€æœ‰ä¼¤å®³Ã—1.25',
        effect: () => {
            damageMultiplier = 1.25;
            addLog('ã€é“å…·ã€‘æœç”¨å¤§åŠ›ä¸¸ï¼Œæ”»å‡»åŠ›å¤§å¢ï¼');
        }
    },
    jingutie: {
        name: 'ç­‹éª¨è´´',
        desc: 'æœ¬åœºæˆ˜æ–—æ‰€å—ä¼¤å®³Ã·1.25',
        effect: () => {
            defenseMultiplier = 1.25;
            addLog('ã€é“å…·ã€‘è´´ä¸Šç­‹éª¨è´´ï¼Œé˜²å¾¡åŠ›æå‡ï¼');
        }
    },
    jinchuangyao: {
        name: 'é‡‘ç–®è¯',
        desc: 'ç«‹å³æ¢å¤30%æœ€å¤§ç”Ÿå‘½å€¼',
        effect: () => {
            const healAmount = Math.round(gameState.player.maxHealth * 0.3);
            gameState.player.currentHealth = Math.min(
                gameState.player.currentHealth + healAmount,
                gameState.player.maxHealth
            );
            addLog(`ã€é“å…·ã€‘ä½¿ç”¨é‡‘ç–®è¯ï¼Œæ¢å¤${healAmount}ç‚¹ç”Ÿå‘½ï¼`);
            updateDisplay();
        }
    },
    piliwan: {
        name: 'éœ¹é›³ä¸¸',
        desc: 'ç«‹å³å¯¹æ•Œäººé€ æˆ1.5å€æ”»å‡»ä¼¤å®³',
        effect: () => {
            const damage = Math.round(gameState.player.basicDamage * 1.5);
            gameState.enemy.currentHealth -= damage;
            if (gameState.enemy.currentHealth < 0) gameState.enemy.currentHealth = 0;
            addLog(`ã€é“å…·ã€‘æŠ•æ·éœ¹é›³ä¸¸ï¼Œå¯¹${gameState.enemy.name}é€ æˆ${damage}ç‚¹ä¼¤å®³ï¼`);
            
            // è§¦å‘æ•Œäººå—å‡»åŠ¨ç”»
            const npcPortraitLayer = document.querySelector('.npc-portrait-layer');
            npcPortraitLayer.classList.add('shake');
            setTimeout(() => {
                npcPortraitLayer.classList.remove('shake');
            }, 400);
            
            updateDisplay();
            
            // æ£€æŸ¥æ˜¯å¦å‡»æ€æ•Œäºº
            if (gameState.enemy.currentHealth <= 0) {
                setTimeout(() => {
                    checkGameOver();
                }, 500);
            }
        }
    }
};

// //å›åˆåˆ¶ç³»ç»Ÿé›†æˆæ›´æ–° - ç©å®¶ä¿¡æ¯ä»URLå‚æ•°è·å–
const PLAYER_INFO = {
    name: urlParams.get('playerName') || 'ä½ ',
    maxHealth: parseInt(urlParams.get('playerHealth')) || 51,
    currentHealth: parseInt(urlParams.get('playerHealth')) || 51,
    energy: 0,
    maxEnergy: 10,
    selectedAction: null,
    basicDamage: parseInt(urlParams.get('playerAttack')) || 20,
    tauntedTurns: 0  // æŒ‘è¡…çŠ¶æ€å‰©ä½™å›åˆæ•°
};

// //å›åˆåˆ¶ç³»ç»Ÿé›†æˆæ›´æ–° - æ„å»ºæ•Œæ–¹ä¿¡æ¯æ–‡æœ¬
const enemyInfoText = `
å‘èµ·æˆ˜æ–—ï¼Œæ•Œæ–¹ä¿¡æ¯å¦‚ä¸‹
name: ${urlParams.get('enemyName') || 'å‘¼å»¶æ˜¾'}
  maxHealth: ${urlParams.get('enemyMaxHealth') || 'æä½'}
  basicDamage: ${urlParams.get('enemyBasicDamage') || 'æä½'}
`;

// æ¸¸æˆä¸»èƒŒæ™¯å’Œå¼¹çª—èƒŒæ™¯å›¾ç‰‡é“¾æ¥
const GAME_BG_URL = urlParams.get('backgroundUrl') || 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/location/åå±±_æ˜¼.webp';
const MODAL_BG_URL = 'https://files.catbox.moe/jabi3y.jpg';


// ç”Ÿå‘½å€¼å’Œä¼¤å®³ç­‰çº§æ˜ å°„
const healthMap = { 'æä½': 25,'ä½': 50, 'ä¸­':100, 'é«˜': 175, 'æé«˜': 275 };
const damageMap = { 'æä½': 10,'ä½': 20, 'ä¸­': 40, 'é«˜': 70, 'æé«˜': 120 };
const styles = ['é£', 'ç«', 'æ—', 'å±±'];

// æ¨¡ç³ŠåŒ¹é…å‡½æ•° - è®¡ç®—ç¼–è¾‘è·ç¦»
function levenshteinDistance(a, b) {
    if (!a || !b) return Math.max((a || '').length, (b || '').length);
    if (a === b) return 0;
    
    const matrix = [];
    const aLen = a.length;
    const bLen = b.length;
    
    for (let i = 0; i <= bLen; i++) {
        matrix[i] = [i];
    }
    for (let j = 0; j <= aLen; j++) {
        matrix[0][j] = j;
    }
    
    for (let i = 1; i <= bLen; i++) {
        for (let j = 1; j <= aLen; j++) {
            if (b.charAt(i - 1) === a.charAt(j - 1)) {
                matrix[i][j] = matrix[i - 1][j - 1];
            } else {
                matrix[i][j] = Math.min(
                    matrix[i - 1][j - 1] + 1,
                    matrix[i][j - 1] + 1,
                    matrix[i - 1][j] + 1
                );
            }
        }
    }
    
    return matrix[bLen][aLen];
}

// æ¨¡ç³ŠåŒ¹é…ç±»åˆ«
function fuzzyMatchCategory(input) {
    if (!input || typeof input !== 'string') return 'æœªçŸ¥';
    
    const normalizedInput = input.trim();
    if (!normalizedInput) return 'æœªçŸ¥';
    
    // 1. ç²¾ç¡®åŒ¹é…
    if (ENEMY_CATEGORIES.includes(normalizedInput)) {
        return normalizedInput;
    }
    
    // 2. åŒä¹‰è¯ç²¾ç¡®åŒ¹é…
    if (CATEGORY_SYNONYMS[normalizedInput]) {
        const synonym = CATEGORY_SYNONYMS[normalizedInput];
        if (ENEMY_CATEGORIES.includes(synonym)) {
            console.log(`[ç±»åˆ«åŒ¹é…] åŒä¹‰è¯åŒ¹é…: "${normalizedInput}" -> "${synonym}"`);
            return synonym;
        }
    }
    
    // 3. åŒ…å«åŒ¹é…
    for (const category of ENEMY_CATEGORIES) {
        if (normalizedInput.includes(category) || category.includes(normalizedInput)) {
            console.log(`[ç±»åˆ«åŒ¹é…] åŒ…å«åŒ¹é…: "${normalizedInput}" -> "${category}"`);
            return category;
        }
    }
    
    // 4. åŒä¹‰è¯çš„åŒ…å«åŒ¹é…
    for (const [key, value] of Object.entries(CATEGORY_SYNONYMS)) {
        if (normalizedInput.includes(key) || key.includes(normalizedInput)) {
            if (ENEMY_CATEGORIES.includes(value)) {
                console.log(`[ç±»åˆ«åŒ¹é…] åŒä¹‰è¯åŒ…å«åŒ¹é…: "${normalizedInput}" (via "${key}") -> "${value}"`);
                return value;
            }
        }
    }
    
    // 5. ç¼–è¾‘è·ç¦»åŒ¹é…
    let bestMatch = 'æœªçŸ¥';
    let bestDistance = Infinity;
    const threshold = 2; // å…è®¸çš„æœ€å¤§ç¼–è¾‘è·ç¦»
    
    for (const category of ENEMY_CATEGORIES) {
        const distance = levenshteinDistance(normalizedInput, category);
        if (distance < bestDistance && distance <= threshold) {
            bestDistance = distance;
            bestMatch = category;
        }
    }
    
    if (bestMatch !== 'æœªçŸ¥') {
        console.log(`[ç±»åˆ«åŒ¹é…] ç¼–è¾‘è·ç¦»åŒ¹é…: "${normalizedInput}" -> "${bestMatch}" (è·ç¦»: ${bestDistance})`);
    } else {
        console.log(`[ç±»åˆ«åŒ¹é…] æ— æ³•åŒ¹é…: "${normalizedInput}"ï¼Œä½¿ç”¨é»˜è®¤å€¼"æœªçŸ¥"`);
    }
    
    return bestMatch;
}

// åŠ æƒéšæœºé€‰æ‹©å‡½æ•°
function weightedRandom(options, debugInfo = null) {
    // options: { 'action': weight, ... }
    const entries = Object.entries(options);
    const totalWeight = entries.reduce((sum, [, weight]) => sum + weight, 0);
    const rollValue = Math.random() * totalWeight;
    let remaining = rollValue;
    
    // å¦‚æœéœ€è¦è°ƒè¯•è¾“å‡º
    if (debugInfo) {
        const actionNames = {
            'gather': 'é›†æ°”',
            'defend': 'é˜²å¾¡',
            'light-attack': 'è½»æ”»å‡»',
            'heavy-attack': 'é‡æ”»å‡»',
            'special': 'ç»æ‹›',
            'taunt': 'å˜´ç‚®'
        };
        const probabilities = entries.map(([action, weight]) => {
            const probability = (weight / totalWeight * 100).toFixed(1);
            return `${actionNames[action] || action}(${probability}%)`;
        });
        console.log(`[AIç­–ç•¥] é£æ ¼: ${debugInfo.style}, èƒ½é‡èŒƒå›´: ${debugInfo.energyKey}`);
        console.log(`[AIç­–ç•¥] å‚ä¸åŠ æƒçš„è¡ŒåŠ¨: ${probabilities.join(', ')}`);
        console.log(`[AIç­–ç•¥] Rollç‚¹: ${rollValue.toFixed(2)} / ${totalWeight} (${(rollValue / totalWeight * 100).toFixed(1)}%)`);
    }
    
    for (const [action, weight] of entries) {
        remaining -= weight;
        if (remaining <= 0) {
            if (debugInfo) {
                const actionNames = {
                    'gather': 'é›†æ°”',
                    'defend': 'é˜²å¾¡',
                    'light-attack': 'è½»æ”»å‡»',
                    'heavy-attack': 'é‡æ”»å‡»',
                    'special': 'ç»æ‹›',
                    'taunt': 'å˜´ç‚®'
                };
                console.log(`[AIç­–ç•¥] é€‰æ‹©ç»“æœ: ${actionNames[action] || action}`);
            }
            return action;
        }
    }
    // å…œåº•è¿”å›ç¬¬ä¸€ä¸ªé€‰é¡¹
    if (debugInfo) {
        console.log(`[AIç­–ç•¥] é€‰æ‹©ç»“æœ(å…œåº•): ${entries[0][0]}`);
    }
    return entries[0][0];
}

// é£æ ¼ç­–ç•¥é…ç½®ï¼šåŸºäºèƒ½é‡èŒƒå›´çš„æ¦‚ç‡åˆ†å¸ƒ
const STYLE_STRATEGIES = {
    'é£': {
        // é£æ ¼ï¼šå¿«æ”»å‹ï¼Œåå¥½è½»æ”»å‡»å’Œå˜´ç‚®ç ´é˜²
        0: { 'gather': 100},
        1: { 'gather': 25, 'taunt': 30, 'light-attack': 45 },
        '2-4': { 'gather': 10, 'taunt': 25, 'light-attack': 45, 'heavy-attack': 20 },
        '5+': { 'gather': 10, 'taunt': 5, 'light-attack': 30, 'heavy-attack': 20, 'special': 35 }
    },
    'ç«': {
        // ç«æ ¼ï¼šçˆ†å‘å‹ï¼Œåå¥½é‡æ”»å‡»
        0: { 'gather': 100},
        1: { 'gather': 50, 'taunt': 15, 'light-attack': 35 },
        '2-4': { 'gather': 20, 'taunt': 5, 'light-attack': 20, 'heavy-attack': 55 },
        '5+': { 'gather': 10, 'taunt': 5, 'light-attack': 10, 'heavy-attack': 35, 'special': 40 }
    },
    'æ—': {
        // æ—æ ¼ï¼šè“„åŠ›å‹ï¼Œåå¥½é›†æ°”å’Œç»æ‹›
        0: { 'gather': 100},
        1: { 'gather': 75, 'taunt': 10, 'light-attack': 15 },
        '2-4': { 'gather': 60, 'taunt': 10, 'light-attack': 15, 'heavy-attack': 15 },
        '5+': { 'gather': 10, 'taunt': 5, 'light-attack': 10, 'heavy-attack': 15, 'special': 60}
    },
    'å±±': {
        // å±±æ ¼ï¼šé˜²å®ˆå‹ï¼ˆé˜²å¾¡åœ¨ç‹¬ç«‹é˜¶æ®µå¤„ç†ï¼‰
        0: { 'gather': 100},
        1: { 'gather': 50, 'taunt': 10, 'light-attack': 40 },
        '2-4': { 'gather': 50, 'taunt': 5, 'light-attack': 20, 'heavy-attack': 25 },
        '5+': { 'gather': 10, 'taunt': 5, 'light-attack': 15, 'heavy-attack': 20, 'special': 50 }
    }
};

// æ ¹æ®èƒ½é‡è·å–å¯¹åº”çš„ç­–ç•¥é…ç½®
function getEnergyRangeKey(energy) {
    if (energy === 0) return 0;
    if (energy === 1) return 1;
    if (energy >= 2 && energy <= 4) return '2-4';
    return '5+';
}

// ç‰¹æ®ŠNPCä¿¡æ¯
const commonNPCs = {
    'ç ´é˜µå­': {
        name: 'ç ´é˜µå­',
        maxHealth: 200,
        basicDamage: 140,
        style: 'ç«',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/ç ´é˜µå­.png'
    },
    'æ´åº­å›': {
        name: 'æ´åº­å›',
        maxHealth: 275,
        basicDamage: 100,
        style: 'æ—',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/æ´åº­å›.png'
    },
    'è‹“é›ªå¦ƒ': {
        name: 'è‹“é›ªå¦ƒ',
        maxHealth: 250,
        basicDamage: 160,
        style: 'é£',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/è‹“é›ªå¦ƒ.png'
    },    
    'ç„å¤©é’': {
        name: 'ç„å¤©é’',
        maxHealth: 300,
        basicDamage: 60,
        style: 'å±±',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/ç„å¤©é’.png'
    },
    'é’±å¡˜å›': {
        name: 'é’±å¡˜å›',
        maxHealth: 150,
        basicDamage: 100,
        style: 'ç«',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/é’±å¡˜å›.png'
    },
    'è§ç™½ç‘š': {
        name: 'è§ç™½ç‘š',
        maxHealth: 125,
        basicDamage: 60,
        style: 'é£',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/è§ç™½ç‘š.png'
    },
    'å§¬å§’': {
        name: 'å§¬å§’',
        maxHealth: 350,
        basicDamage: 70,
        style: 'å±±',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/å§¬å§’.png'
    },
    'æ–½å»¶å¹´': {
        name: 'æ–½å»¶å¹´',
        maxHealth: 200,
        basicDamage: 50,
        style: 'å±±',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/æ–½å»¶å¹´.png'
    },
    'å‘¼å»¶æ˜¾': {
        name: 'å‘¼å»¶æ˜¾',
        maxHealth: 200,
        basicDamage: 100,
        style: 'æ—',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/å‘¼å»¶æ˜¾.png'
    },
    'é›¨çƒ›': {
        name: 'é›¨çƒ›',
        maxHealth: 100,
        basicDamage: 90,
        style: 'é£',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/é›¨çƒ›.png'
    },
    'å®‰æ…•': {
        name: 'å®‰æ…•',
        maxHealth: 75,
        basicDamage: 110,
        style: 'ç«',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/å®‰æ…•.png'
    },
    'å”æ²æ¢¨': {
        name: 'å”æ²æ¢¨',
        maxHealth: 175,
        basicDamage: 80,
        style: 'é£',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/å”æ²æ¢¨.png'
    },
    'æ´›æ½œå¹½': {
        name: 'æ´›æ½œå¹½',
        maxHealth: 50,
        basicDamage: 20,
        style: 'å±±',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/æ´›æ½œå¹½.png'
    },
    'ç¥ç§˜æ‚å½¹': {
        name: 'ç¥ç§˜æ‚å½¹',
        maxHealth: 75,
        basicDamage: 300,
        style: 'é£',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/ç¥ç§˜æ‚å½¹.png'
    },
    'é¹¿æ¤¿è‹¥': {
        name: 'é¹¿æ¤¿è‹¥',
        maxHealth: 150,
        basicDamage: 30,
        style: 'æ—',
        portrait: 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/é¹¿æ¤¿è‹¥.png'
    }
};

const genericNPCPortraits = [
    'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/æ‚é±¼1.png',  // å ä½é“¾æ¥1
    'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/æ‚é±¼2.png',  // å ä½é“¾æ¥2
    'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/NPC/æ‚é±¼3.png'   // å ä½é“¾æ¥3
];

// è§£ææ•Œæ–¹ä¿¡æ¯çš„å‡½æ•°
function parseEnemyInfo(text) {
    // æå–åç§°
    const nameMatch = text.match(/name:\s*([^\n]+)/);
    const npcName = nameMatch ? nameMatch[1].trim() : '';
    clearEnemyPortrait();
    
    // è·å–éš¾åº¦å‚æ•°
    const currentDifficulty = urlParams.get('difficulty') || 'normal';
    
    // è·å–ç±»åˆ«å‚æ•°å¹¶è¿›è¡Œæ¨¡ç³ŠåŒ¹é…
    const rawCategory = urlParams.get('enemyCategory') || 'æœªçŸ¥';
    const enemyCategory = fuzzyMatchCategory(rawCategory);
    console.log(`[æ•Œäººä¿¡æ¯] åŸå§‹ç±»åˆ«: "${rawCategory}" -> åŒ¹é…ç»“æœ: "${enemyCategory}"`);
    
    // ä¼˜å…ˆæŸ¥æ‰¾å¸¸è§NPC
    if (npcName && commonNPCs[npcName]) {
        const npc = commonNPCs[npcName];
        // æ›´æ–°æ•Œäººç«‹ç»˜ - ä½¿ç”¨æˆ˜æ–—å·®åˆ†ç›®å½•
        const npcBattlePortrait = `https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/æˆ˜æ–—å·®åˆ†/${npc.name}-å¾…æœº.png`;
        updateEnemyPortrait(npcBattlePortrait);
        
        // æ ¹æ®éš¾åº¦è°ƒæ•´å±æ€§
        let maxHealth = npc.maxHealth;
        let basicDamage = npc.basicDamage;
        
        if (currentDifficulty === 'normal') {
            maxHealth = Math.round(maxHealth * 1.25);
            basicDamage = Math.round(basicDamage * 1.25);
        } else if (currentDifficulty === 'hard') {
            maxHealth = Math.round(maxHealth * 1.5);
            basicDamage = Math.round(basicDamage * 1.5);
        }
        
        return {
            name: npc.name,
            maxHealth: maxHealth,
            currentHealth: maxHealth,
            energy: 0,
            maxEnergy: 10,
            selectedAction: null,
            basicDamage: basicDamage,
            style: npc.style,
            category: enemyCategory,  // æ·»åŠ ç±»åˆ«å­—æ®µ
            tauntedTurns: 0  // æŒ‘è¡…çŠ¶æ€å‰©ä½™å›åˆæ•°
        };
    }

    // æ²¡æœ‰åŒ¹é…åˆ°å¸¸è§NPCï¼Œæ ¹æ®ç±»åˆ«é€‰æ‹©ç«‹ç»˜
    const categoryPortrait = getCategoryPortrait(enemyCategory);
    updateEnemyPortrait(categoryPortrait);
    
    // èµ°åŸæœ‰è§£æé€»è¾‘ï¼Œé£æ ¼éšæœº
    const maxHealthMatch = text.match(/maxHealth:\s*([^\n]+)/);
    const basicDamageMatch = text.match(/basicDamage:\s*([^\n]+)/);
    
    let baseHealth = maxHealthMatch ? healthMap[maxHealthMatch[1].trim()] || 80 : 80;
    let baseDamage = basicDamageMatch ? damageMap[basicDamageMatch[1].trim()] || 30 : 30;
    
    // æ ¹æ®éš¾åº¦è°ƒæ•´å±æ€§
    if (currentDifficulty === 'normal') {
        baseHealth = Math.round(baseHealth * 1.25);
        baseDamage = Math.round(baseDamage * 1.25);
    } else if (currentDifficulty === 'hard') {
        baseHealth = Math.round(baseHealth * 1.5);
        baseDamage = Math.round(baseDamage * 1.5);
    }
    
    return {
        name: npcName,
        maxHealth: baseHealth,
        currentHealth: baseHealth,
        energy: 0,
        maxEnergy: 10,
        selectedAction: null,
        basicDamage: baseDamage,
        style: styles[Math.floor(Math.random() * styles.length)],
        category: enemyCategory,  // æ·»åŠ ç±»åˆ«å­—æ®µ
        tauntedTurns: 0  // æŒ‘è¡…çŠ¶æ€å‰©ä½™å›åˆæ•°
    };
}

// æ ¹æ®ç±»åˆ«è·å–ç«‹ç»˜
function getCategoryPortrait(category) {
    // ç±»åˆ«ç«‹ç»˜æ˜ å°„ - ä½¿ç”¨æˆ˜æ–—å·®åˆ†ç›®å½•ä¸‹çš„å¾…æœºå›¾
    const categoryPortraits = {
        'æ­£æ´¾å¼Ÿå­': 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/æˆ˜æ–—å·®åˆ†/æ­£æ´¾å¼Ÿå­-å¾…æœº.png',
        'åæ´¾å¼Ÿå­': 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/æˆ˜æ–—å·®åˆ†/åæ´¾å¼Ÿå­-å¾…æœº.png',
        'æ¸¸ä¾ ': 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/æˆ˜æ–—å·®åˆ†/æ¸¸ä¾ -å¾…æœº.png',
        'å†›å£«': 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/æˆ˜æ–—å·®åˆ†/å†›å£«-å¾…æœº.png',
        'åŒªå¾’': 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/æˆ˜æ–—å·®åˆ†/åŒªå¾’-å¾…æœº.png',
        'å¹³æ°‘': 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/æˆ˜æ–—å·®åˆ†/å¹³æ°‘-å¾…æœº.png',
        'è’™é¢äºº': 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/æˆ˜æ–—å·®åˆ†/è’™é¢äºº-å¾…æœº.png',
        'é‡å…½': 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/æˆ˜æ–—å·®åˆ†/é‡å…½-å¾…æœº.png',
        'æœªçŸ¥': 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/æˆ˜æ–—å·®åˆ†/æœªçŸ¥-å¾…æœº.png'
    };
    
    return categoryPortraits[category] || categoryPortraits['æœªçŸ¥'];
}

// æ›´æ–°æ•Œäººç«‹ç»˜
function updateEnemyPortrait(portraitUrl) {
    const npcPortraitLayer = document.querySelector('.npc-portrait-layer');
    npcPortraitLayer.style.backgroundImage = `url('${portraitUrl}')`;
}

// æ¸…é™¤æ•Œäººç«‹ç»˜
function clearEnemyPortrait() {
    const npcPortraitLayer = document.querySelector('.npc-portrait-layer');
    npcPortraitLayer.style.backgroundImage = '';
}

// æ›´æ–°ä¸»è§’ç«‹ç»˜
function updatePlayerPortrait(portraitUrl) {
    const playerPortraitLayer = document.querySelector('.player-portrait-layer');
    if (playerPortraitLayer) {
        playerPortraitLayer.style.backgroundImage = `url('${portraitUrl}')`;
    }
}

// åˆå§‹åŒ–ä¸»è§’ç«‹ç»˜
function initPlayerPortrait() {
    const defaultPlayerPortrait = 'https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/æˆ˜æ–—å·®åˆ†/ä¸»è§’-å¾…æœº.png';
    updatePlayerPortrait(defaultPlayerPortrait);
}

// è·å–ä¸»è§’ç«‹ç»˜URLï¼ˆæ ¹æ®çŠ¶æ€ï¼‰
function getPlayerPortraitUrl(state) {
    return `https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/æˆ˜æ–—å·®åˆ†/ä¸»è§’-${state}.png`;
}

// è·å–æ•Œäººç«‹ç»˜URLï¼ˆæ ¹æ®çŠ¶æ€ï¼‰
function getEnemyPortraitUrl(state) {
    const enemy = gameState.enemy;
    const npcName = enemy.name;
    
    // ä¼˜å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯ç‰¹æ®ŠNPC
    if (npcName && commonNPCs[npcName]) {
        return `https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/æˆ˜æ–—å·®åˆ†/${npcName}-${state}.png`;
    }
    
    // å¦åˆ™ä½¿ç”¨ç±»åˆ«
    const category = enemy.category || 'æœªçŸ¥';
    return `https://cdn.jsdelivr.net/gh/Ji-Haitang/char_card_1@main/img/æˆ˜æ–—å·®åˆ†/${category}-${state}.png`;
}

// è®¾ç½®ç«‹ç»˜æè¾¹æ•ˆæœ
function setPortraitGlow(isPlayer, glowColor) {
    const layer = isPlayer 
        ? document.querySelector('.player-portrait-layer')
        : document.querySelector('.npc-portrait-layer');
    
    if (!layer) return;
    
    // æ¸…é™¤æ‰€æœ‰æè¾¹æ•ˆæœ
    layer.classList.remove('glow-yellow', 'glow-orange', 'glow-red');
    
    // æ·»åŠ æ–°çš„æè¾¹æ•ˆæœ
    if (glowColor) {
        layer.classList.add(glowColor);
    }
}

// åˆ‡æ¢ç«‹ç»˜çŠ¶æ€
function setPortraitState(isPlayer, state, glowColor) {
    if (isPlayer) {
        updatePlayerPortrait(getPlayerPortraitUrl(state));
    } else {
        updateEnemyPortrait(getEnemyPortraitUrl(state));
    }
    setPortraitGlow(isPlayer, glowColor);
}

// æ¢å¤åŒæ–¹ç«‹ç»˜åˆ°å¾…æœºçŠ¶æ€
function resetPortraitsToIdle() {
    setPortraitState(true, 'å¾…æœº', null);   // ç©å®¶æ¢å¤å¾…æœº
    setPortraitState(false, 'å¾…æœº', null);  // æ•Œäººæ¢å¤å¾…æœº
}

// è·å–æ”»å‡»ç±»å‹å¯¹åº”çš„æè¾¹é¢œè‰²ç±»å
function getGlowClass(action, dealtDamage) {
    if (!dealtDamage) return null;
    switch(action) {
        case 'light-attack': return 'glow-yellow';  // é»„è‰²
        case 'heavy-attack': return 'glow-orange';  // æ©™è‰²
        case 'special': return 'glow-red';          // çº¢è‰²
        default: return null;
    }
}

// //å›åˆåˆ¶ç³»ç»Ÿé›†æˆæ›´æ–° - é€€å‡ºæˆ˜æ–—
function exitBattle(result) {
    // å‘çˆ¶çª—å£å‘é€æˆ˜æ–—ç»“æœå’Œé“å…·æ¶ˆè€—ä¿¡æ¯
    if (window.parent !== window) {
        window.parent.postMessage({
            type: 'battle-exit',
            result: result, // 'victory' æˆ– 'defeat' æˆ– 'quit'
            itemUsed: usedItemKey,  // ä½¿ç”¨çš„é“å…·ç±»å‹
            remainingItems: battleItems  // å‰©ä½™é“å…·æ•°é‡
        }, '*');
    }
}

// æ‰“å¼€é“å…·å¼¹çª—
function openItemModal() {
    // å¦‚æœä¸æ˜¯ç©å®¶å›åˆæˆ–æ­£åœ¨ç­‰å¾…ç¡®è®¤ï¼Œè¿”å›
    if (gameState.currentTurn !== 'player' || gameState.waitingForConfirmation) return;
    
    const itemModal = document.getElementById('item-modal');
    const itemList = document.getElementById('item-list');
    
    // æ¸…ç©ºåˆ—è¡¨
    itemList.innerHTML = '';
    
    // å¦‚æœæœ¬åœºæˆ˜æ–—å·²ä½¿ç”¨é“å…·ï¼Œæ˜¾ç¤ºæç¤º
    if (itemUsedThisBattle) {
        itemList.innerHTML = `
            <div class="item-used-hint">
                æœ¬åœºæˆ˜æ–—å·²ä½¿ç”¨è¿‡é“å…·ï¼Œæ— æ³•å†æ¬¡ä½¿ç”¨
            </div>
        `;
    } else {
        // ç”Ÿæˆé“å…·åˆ—è¡¨
        for (const [key, config] of Object.entries(itemConfig)) {
            const count = battleItems[key];
            const isEmpty = count <= 0;
            
            const itemRow = document.createElement('div');
            itemRow.className = `item-row${isEmpty ? ' disabled' : ''}`;
            itemRow.innerHTML = `
                <div class="item-info">
                    <div class="item-name">${config.name}</div>
                    <div class="item-desc">${config.desc}</div>
                </div>
                <div class="item-count${isEmpty ? ' empty' : ''}">Ã—${count}</div>
                <button class="item-use-btn" ${isEmpty ? 'disabled' : ''} onclick="useItem('${key}')">ä½¿ç”¨</button>
            `;
            itemList.appendChild(itemRow);
        }
    }
    
    itemModal.style.display = 'flex';
}

// å…³é—­é“å…·å¼¹çª—
function closeItemModal() {
    const itemModal = document.getElementById('item-modal');
    itemModal.style.display = 'none';
}

// ä½¿ç”¨é“å…·
function useItem(itemKey) {
    if (itemUsedThisBattle) {
        addLog('æœ¬åœºæˆ˜æ–—å·²ä½¿ç”¨è¿‡é“å…·ï¼');
        return;
    }
    
    if (battleItems[itemKey] <= 0) {
        addLog('è¯¥é“å…·æ•°é‡ä¸è¶³ï¼');
        return;
    }
    
    // æ¶ˆè€—é“å…·
    battleItems[itemKey]--;
    itemUsedThisBattle = true;
    usedItemKey = itemKey;
    
    // å…³é—­å¼¹çª—
    closeItemModal();
    
    // æ‰§è¡Œé“å…·æ•ˆæœ
    const config = itemConfig[itemKey];
    if (config && config.effect) {
        config.effect();
    }
    
    // ç¦ç”¨é“å…·æŒ‰é’®
    const itemBtn = document.getElementById('item');
    if (itemBtn) {
        itemBtn.classList.add('disabled');
    }
}

// //å›åˆåˆ¶ç³»ç»Ÿé›†æˆæ›´æ–° - ç¡®è®¤é€€å‡ºæˆ˜æ–—
function confirmExitBattle() {
    const ov = document.getElementById('exit-battle-overlay');
    if (ov) { ov.style.display = 'flex'; }
}

const playerNameDisplay = document.getElementById('player-name');
const enemyNameDisplay = document.getElementById('enemy-name');
// æ¸¸æˆçŠ¶æ€å¯¹è±¡
const gameState = {
    currentTurn: 'player',
    turnNumber: 1, // æ·»åŠ å›åˆè®¡æ•°å™¨
    waitingForConfirmation: false,
    player: { ...PLAYER_INFO },
    enemy: parseEnemyInfo(enemyInfoText)
};

// è·å–DOMå…ƒç´ 
const playerHealthBar = document.getElementById('player-health');
const enemyHealthBar = document.getElementById('enemy-health');
const playerHealthValue = document.getElementById('player-health-value');
const enemyHealthValue = document.getElementById('enemy-health-value');
const playerMaxHealth = document.getElementById('player-max-health'); // æ–°å¢
const enemyMaxHealth = document.getElementById('enemy-max-health'); // æ–°å¢
const playerEnergyDisplay = document.getElementById('player-energy');
const enemyEnergyDisplay = document.getElementById('enemy-energy');
const battleLog = document.getElementById('battle-log');
const turnText = document.getElementById('turn-text');
const selectedActionText = document.getElementById('selected-action');
const confirmActionButton = document.getElementById('confirm-action');
const cancelActionButton = document.getElementById('cancel-action');
const commandButtons = document.querySelectorAll('.command-btn');
const confirmModal = document.getElementById('confirm-modal');
const gameOverModal = document.getElementById('game-over-modal');
const gameOverTitle = document.getElementById('game-over-title');
const gameOverMessage = document.getElementById('game-over-message');
const restartGameButton = document.getElementById('restart-game');

// è§’è‰²å…ƒç´ 
const playerCharacter = document.querySelector('.player-character');
const enemyCharacter = document.querySelector('.enemy-character');

// åˆå§‹åŒ–æ¸¸æˆ
function initGame() {
    // åˆå§‹åŒ–ä¸»è§’ç«‹ç»˜
    initPlayerPortrait();
    
    updateDisplay();
    addLog('æˆ˜æ–—å¼€å§‹ï¼Œè¯·é€‰æ‹©è¡ŒåŠ¨...');
    
    // æ·»åŠ æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - æ”¯æŒè§¦å±å’Œé¼ æ ‡
    setupButtonEvents();
    
    // é”®ç›˜æ§åˆ¶
    document.addEventListener('keydown', handleKeyPress);
    
    // é¢„åŠ è½½æˆ˜æ–—èµ„æºï¼ˆç«‹ç»˜å·®åˆ†+ç‰¹æ•ˆï¼‰
    const enemyName = gameState.enemy.name;
    preloadBattleResources(enemyName).then(result => {
        console.log(`[æˆ˜æ–—åˆå§‹åŒ–] èµ„æºé¢„åŠ è½½å®Œæˆ`);
    }).catch(err => {
        console.warn('[æˆ˜æ–—åˆå§‹åŒ–] èµ„æºé¢„åŠ è½½å‡ºé”™:', err);
    });
}

// è®¾ç½®æŒ‰é’®äº‹ä»¶
function setupButtonEvents() {
    document.getElementById('gather').addEventListener('click', () => selectAction('gather'));
    document.getElementById('defend').addEventListener('click', () => selectAction('defend'));
    document.getElementById('light-attack').addEventListener('click', () => selectAction('light-attack'));
    document.getElementById('heavy-attack').addEventListener('click', () => selectAction('heavy-attack'));
    document.getElementById('special').addEventListener('click', () => selectAction('special'));
    document.getElementById('taunt').addEventListener('click', () => selectAction('taunt'));
    document.getElementById('item').addEventListener('click', openItemModal);
    document.getElementById('escape').addEventListener('click', confirmExitBattle);
    
    // ç¡®è®¤æŒ‰é’®äº‹ä»¶
    confirmActionButton.addEventListener('click', () => {
        if (confirmModal) confirmModal.style.display = 'none';
        confirmAction();
    });
    
    // å–æ¶ˆæŒ‰é’®äº‹ä»¶
    cancelActionButton.addEventListener('click', () => {
        if (confirmModal) confirmModal.style.display = 'none';
        gameState.player.selectedAction = null;
        updateDisplay();
    });

    // //å›åˆåˆ¶ç³»ç»Ÿé›†æˆæ›´æ–° - ä¿®æ”¹é‡æ–°å¼€å§‹æŒ‰é’®çš„å¤„ç†
    restartGameButton.addEventListener('click', () => {
        // å¦‚æœåœ¨iframeä¸­ï¼Œé€€å‡ºåˆ°çˆ¶çª—å£
        if (window.parent !== window) {
            exitBattle('restart');
        } else {
            window.location.reload();
        }
    });
}

// æ›´æ–°æ˜¾ç¤º
function updateDisplay() {
    // æ›´æ–°ç”Ÿå‘½å€¼æ˜¾ç¤º
    playerHealthBar.style.width = `${(gameState.player.currentHealth / gameState.player.maxHealth) * 100}%`;
    enemyHealthBar.style.width = `${(gameState.enemy.currentHealth / gameState.enemy.maxHealth) * 100}%`;
    
    // æ›´æ–°ç”Ÿå‘½å€¼æ–‡æœ¬
    playerHealthValue.textContent = gameState.player.currentHealth;
    enemyHealthValue.textContent = gameState.enemy.currentHealth;
    
    // æ›´æ–°æœ€å¤§ç”Ÿå‘½å€¼æ–‡æœ¬
    playerMaxHealth.textContent = gameState.player.maxHealth;
    enemyMaxHealth.textContent = gameState.enemy.maxHealth;
    
    // æ›´æ–°èƒ½é‡å€¼
    playerEnergyDisplay.textContent = gameState.player.energy;
    enemyEnergyDisplay.textContent = gameState.enemy.energy;
    
    // æ›´æ–°è§’è‰²åå­—æ˜¾ç¤º
    playerNameDisplay.textContent = gameState.player.name;
    enemyNameDisplay.textContent = gameState.enemy.name;
    
    // æ ¹æ®æ•Œäººæˆ˜æ–—é£æ ¼è®¾ç½®åå­—é¢œè‰²
    const styleColors = {
        'é£': '#4169E1',  // é›è“è‰² (Royal Blue)
        'æ—': '#228B22',  // æ·±ç»¿è‰² (Forest Green)
        'ç«': '#B22222',  // æš—çº¢è‰² (Firebrick)
        'å±±': '#DAA520'   // åœŸé»„è‰² (Goldenrod)
    };
    const enemyStyle = gameState.enemy.style;
    if (enemyStyle && styleColors[enemyStyle]) {
        enemyNameDisplay.style.color = styleColors[enemyStyle];
    }
    
    // æ›´æ–°å›åˆæ•°æ˜¾ç¤º
    turnText.textContent = `ç¬¬${gameState.turnNumber}å›åˆ`;
    
    // æ›´æ–°æŒ‘è¡…çŠ¶æ€æ˜¾ç¤º
    const playerTauntStatus = document.getElementById('player-taunt-status');
    const enemyTauntStatus = document.getElementById('enemy-taunt-status');
    
    if (gameState.player.tauntedTurns > 0) {
        playerTauntStatus.textContent = 'æŒ‘è¡…ä¸­';
        playerTauntStatus.classList.add('active');
    } else {
        playerTauntStatus.classList.remove('active');
    }
    
    if (gameState.enemy.tauntedTurns > 0) {
        enemyTauntStatus.textContent = 'æŒ‘è¡…ä¸­';
        enemyTauntStatus.classList.add('active');
    } else {
        enemyTauntStatus.classList.remove('active');
    }
    
    // æ ¹æ®èƒ½é‡å€¼å¯ç”¨/ç¦ç”¨æŒ‰é’®
    checkButtonAvailability();
}

// æ£€æŸ¥æŒ‰é’®å¯ç”¨æ€§
function checkButtonAvailability() {
    // å¦‚æœä¸æ˜¯ç©å®¶å›åˆæˆ–æ­£åœ¨ç­‰å¾…ç¡®è®¤ï¼Œç¦ç”¨æ‰€æœ‰æŒ‰é’®
    if (gameState.currentTurn !== 'player' || gameState.waitingForConfirmation) {
        commandButtons.forEach(btn => {
            btn.classList.add('disabled');
        });
        return;
    }
    
    // é‡ç½®æŒ‰é’®çŠ¶æ€
    commandButtons.forEach(btn => {
        btn.classList.remove('disabled');
        btn.classList.remove('selected');
    });
    
    // æ ¹æ®èƒ½é‡å€¼å¯ç”¨/ç¦ç”¨æŒ‰é’®
    if (gameState.player.energy < 1) {
        document.getElementById('light-attack').classList.add('disabled');
    }
    
    if (gameState.player.energy < 2) {
        document.getElementById('heavy-attack').classList.add('disabled');
    }
    
    if (gameState.player.energy < 5) {
        document.getElementById('special').classList.add('disabled');
    }
    
    // æŒ‘è¡…çŠ¶æ€ä¸‹ç¦ç”¨é˜²å¾¡
    if (gameState.player.tauntedTurns > 0) {
        document.getElementById('defend').classList.add('disabled');
    }
    
    // æœ¬åœºæˆ˜æ–—å·²ä½¿ç”¨é“å…·åˆ™ç¦ç”¨é“å…·æŒ‰é’®
    if (itemUsedThisBattle) {
        document.getElementById('item').classList.add('disabled');
    }
    
    // åœºåœ°æ•ˆæœç¦ç”¨çš„è¡ŒåŠ¨ï¼ˆç¼ æ–—ç¦ç”¨å˜´ç‚®ï¼‰
    if (isActionDisabledByField('taunt')) {
        document.getElementById('taunt').classList.add('disabled');
    }
    
    // å¦‚æœæœ‰é€‰ä¸­çš„åŠ¨ä½œï¼Œé«˜äº®æ˜¾ç¤º
    if (gameState.player.selectedAction) {
        document.getElementById(gameState.player.selectedAction).classList.add('selected');
    }
}

// ========== æˆ˜æ–—ç‰¹æ•ˆæ§åˆ¶å‡½æ•° ==========
// æ˜¾ç¤ºæˆ˜æ–—ç‰¹æ•ˆ
function showBattleEffect(effectId, duration = 1500) {
    const effect = document.getElementById(effectId);
    if (effect) {
        effect.classList.add('active');
        // å¯¹äºGIFï¼Œé‡æ–°åŠ è½½ä»¥ä»å¤´æ’­æ”¾
        const img = effect.querySelector('img');
        if (img && img.src.endsWith('.gif')) {
            const src = img.src;
            img.src = '';
            img.src = src;
        }
        setTimeout(() => {
            effect.classList.remove('active');
        }, duration);
    }
}

// éšè—æˆ˜æ–—ç‰¹æ•ˆ
function hideBattleEffect(effectId) {
    const effect = document.getElementById(effectId);
    if (effect) {
        effect.classList.remove('active');
    }
}

// éšè—æ‰€æœ‰æˆ˜æ–—ç‰¹æ•ˆ
function hideAllBattleEffects() {
    const effects = document.querySelectorAll('.battle-effect');
    effects.forEach(effect => effect.classList.remove('active'));
}

// æ·»åŠ æˆ˜æ–—æ—¥å¿—
function addLog(message) {
    const logEntry = document.createElement('p');
    logEntry.textContent = message;
    battleLog.appendChild(logEntry);
    battleLog.scrollTop = battleLog.scrollHeight;
    
    // åŒæ­¥æ›´æ–°æ—¥å¿—ä¸‹æ‹‰æ¡†
    const logDropdown = document.getElementById('log-dropdown');
    if (logDropdown) {
        const dropdownEntry = document.createElement('p');
        dropdownEntry.textContent = message;
        logDropdown.appendChild(dropdownEntry);
        logDropdown.scrollTop = logDropdown.scrollHeight;
    }
}

// åˆ‡æ¢æ—¥å¿—ä¸‹æ‹‰æ¡†æ˜¾ç¤º
function toggleLogDropdown() {
    const logDropdown = document.getElementById('log-dropdown');
    if (logDropdown) {
        logDropdown.classList.toggle('active');
    }
    // å…³é—­åœºåœ°æ•ˆæœä¸‹æ‹‰æ¡†
    const fieldDropdown = document.getElementById('field-effect-dropdown');
    if (fieldDropdown) {
        fieldDropdown.classList.remove('active');
        fieldDropdownOpen = false;
    }
}

// ========== åœºåœ°æ•ˆæœå‡½æ•° ==========
// åˆ‡æ¢åœºåœ°æ•ˆæœä¸‹æ‹‰æ¡†
function toggleFieldEffectDropdown(event) {
    event.stopPropagation();
    const fieldDropdown = document.getElementById('field-effect-dropdown');
    if (fieldDropdown) {
        fieldDropdownOpen = !fieldDropdownOpen;
        if (fieldDropdownOpen) {
            fieldDropdown.classList.add('active');
        } else {
            fieldDropdown.classList.remove('active');
        }
    }
    // å…³é—­æ—¥å¿—ä¸‹æ‹‰æ¡†
    const logDropdown = document.getElementById('log-dropdown');
    if (logDropdown) {
        logDropdown.classList.remove('active');
    }
}

// æ£€æŸ¥å¹¶è§¦å‘åœºåœ°æ•ˆæœ
function checkFieldEffectTrigger() {
    console.log(`[åœºåœ°æ•ˆæœæ£€æŸ¥] å½“å‰å›åˆ: ${gameState.turnNumber}, å·²æœ‰æ•ˆæœ: ${activeFieldEffect ? activeFieldEffect.name : 'æ— '}`);
    
    // å‰5å›åˆä¸è§¦å‘
    if (gameState.turnNumber <= 5) {
        console.log('[åœºåœ°æ•ˆæœæ£€æŸ¥] å‰5å›åˆä¿æŠ¤æœŸï¼Œè·³è¿‡');
        return;
    }
    
    // å·²æœ‰åœºåœ°æ•ˆæœæ—¶ä¸è§¦å‘
    if (activeFieldEffect !== null) {
        console.log('[åœºåœ°æ•ˆæœæ£€æŸ¥] å·²æœ‰åœºåœ°æ•ˆæœï¼Œè·³è¿‡');
        return;
    }
    
    // ç¬¬6å›åˆç¨³å®šè§¦å‘ï¼Œä¹‹å33%æ¦‚ç‡è§¦å‘
    let shouldTrigger = false;
    if (gameState.turnNumber === 6) {
        console.log('[åœºåœ°æ•ˆæœæ£€æŸ¥] ç¬¬6å›åˆï¼Œç¨³å®šè§¦å‘');
        shouldTrigger = true;
    } else {
        const roll = Math.random();
        console.log(`[åœºåœ°æ•ˆæœæ£€æŸ¥] æ¦‚ç‡åˆ¤å®š: ${(roll * 100).toFixed(1)}% (éœ€è¦ <= 33%)`);
        shouldTrigger = roll <= 0.33;
    }
    
    if (!shouldTrigger) {
        console.log('[åœºåœ°æ•ˆæœæ£€æŸ¥] æ¦‚ç‡åˆ¤å®šå¤±è´¥ï¼Œä¸è§¦å‘');
        return;
    }
    
    console.log('[åœºåœ°æ•ˆæœæ£€æŸ¥] è§¦å‘æˆåŠŸï¼å‡†å¤‡è§¦å‘åœºåœ°æ•ˆæœ');
    
    // éšæœºé€‰æ‹©ä¸€ä¸ªåœºåœ°æ•ˆæœ
    const effectKeys = Object.keys(FIELD_EFFECTS);
    const randomKey = effectKeys[Math.floor(Math.random() * effectKeys.length)];
    const effect = FIELD_EFFECTS[randomKey];
    
    // æ¿€æ´»åœºåœ°æ•ˆæœ
    activateFieldEffect(effect);
}

// æ¿€æ´»åœºåœ°æ•ˆæœ
function activateFieldEffect(effect) {
    activeFieldEffect = effect;
    fieldEffectRemaining = effect.duration;
    
    // æ›´æ–°UI
    updateFieldEffectUI();
    
    // æ˜¾ç¤ºå…¨å±æç¤º
    showFieldEffectAnnounce(effect);
    
    // æ·»åŠ æ—¥å¿—
    addLog(`ã€åœºåœ°æ•ˆæœã€‘${effect.icon} ${effect.name} - ${effect.effectDesc}`);
    
    console.log(`[åœºåœ°æ•ˆæœ] è§¦å‘: ${effect.name}, æŒç»­${effect.duration}å›åˆ`);
}

// æ›´æ–°åœºåœ°æ•ˆæœUI
function updateFieldEffectUI() {
    const indicator = document.getElementById('field-effect-indicator');
    const icon = document.getElementById('field-effect-icon');
    const name = document.getElementById('field-effect-name');
    const timer = document.getElementById('field-effect-timer');
    const dropdown = document.getElementById('field-effect-dropdown');
    const dropdownIcon = document.getElementById('field-dropdown-icon');
    const dropdownName = document.getElementById('field-dropdown-name');
    const dropdownDesc = document.getElementById('field-dropdown-desc');
    const dropdownEffect = document.getElementById('field-dropdown-effect');
    
    if (activeFieldEffect && fieldEffectRemaining > 0) {
        // æ˜¾ç¤ºåœºåœ°æ•ˆæœæŒ‡ç¤ºå™¨
        indicator.classList.add('active', 'appearing', activeFieldEffect.cssClass);
        icon.textContent = activeFieldEffect.icon;
        name.textContent = activeFieldEffect.name;
        timer.textContent = `(${fieldEffectRemaining})`;
        
        // æ›´æ–°ä¸‹æ‹‰æ¡†å†…å®¹å’Œé¢œè‰²
        dropdownIcon.textContent = activeFieldEffect.icon;
        dropdownName.textContent = activeFieldEffect.name;
        dropdownDesc.textContent = activeFieldEffect.desc;
        dropdownEffect.textContent = activeFieldEffect.effectDesc;
        
        // ç»™ä¸‹æ‹‰æ¡†ä¹Ÿæ·»åŠ å¯¹åº”çš„é¢œè‰²class
        dropdown.className = 'field-effect-dropdown ' + activeFieldEffect.cssClass;
        
        // ç§»é™¤åŠ¨ç”»ç±»
        setTimeout(() => {
            indicator.classList.remove('appearing');
        }, 500);
    } else {
        // éšè—åœºåœ°æ•ˆæœ
        indicator.className = 'field-effect-indicator';
        if (dropdown) {
            dropdown.className = 'field-effect-dropdown';
        }
        fieldDropdownOpen = false;
    }
}

// æ˜¾ç¤ºåœºåœ°æ•ˆæœå…¨å±æç¤º
function showFieldEffectAnnounce(effect) {
    const announce = document.getElementById('field-effect-announce');
    const announceIcon = document.getElementById('announce-icon');
    const announceName = document.getElementById('announce-name');
    
    announceIcon.textContent = effect.icon;
    announceName.textContent = effect.name;
    
    announce.classList.add('active');
    
    // 2ç§’åéšè—
    setTimeout(() => {
        announce.classList.remove('active');
    }, 2000);
}

// å¤„ç†åœºåœ°æ•ˆæœå›åˆç»“æŸ
function processFieldEffectTurnEnd() {
    if (activeFieldEffect === null) return;
    
    fieldEffectRemaining--;
    
    if (fieldEffectRemaining <= 0) {
        addLog(`ã€åœºåœ°æ•ˆæœã€‘${activeFieldEffect.icon} ${activeFieldEffect.name} æ•ˆæœæ¶ˆæ•£`);
        activeFieldEffect = null;
        fieldEffectRemaining = 0;
    }
    
    updateFieldEffectUI();
}

// åº”ç”¨åœºåœ°æ•ˆæœ - å›åˆå¼€å§‹æ—¶ï¼ˆæ°”æµ·ã€ç˜´ç– ã€å›æ˜¥ï¼‰
function applyFieldEffectOnTurnStart() {
    if (activeFieldEffect === null) return;
    
    const player = gameState.player;
    const enemy = gameState.enemy;
    
    switch (activeFieldEffect.id) {
        case 'energy-tide':  // æ°”æµ·ï¼šåŒæ–¹+1æ°”
            if (player.energy < player.maxEnergy) {
                player.energy += 1;
                addLog(`ã€æ°”æµ·ã€‘${player.name}è·å¾—1ç‚¹æ°”`);
            }
            if (enemy.energy < enemy.maxEnergy) {
                enemy.energy += 1;
                addLog(`ã€æ°”æµ·ã€‘${enemy.name}è·å¾—1ç‚¹æ°”`);
            }
            break;
            
        case 'miasma':  // ç˜´ç– ï¼šåŒæ–¹æŸå¤±10%å½“å‰ç”Ÿå‘½
            const playerDamage = Math.round(player.currentHealth * 0.1);
            const enemyDamage = Math.round(enemy.currentHealth * 0.1);
            player.currentHealth -= playerDamage;
            enemy.currentHealth -= enemyDamage;
            if (player.currentHealth < 1) player.currentHealth = 1;  // è‡³å°‘ä¿ç•™1ç‚¹
            if (enemy.currentHealth < 1) enemy.currentHealth = 1;
            addLog(`ã€ç˜´ç– ã€‘${player.name}æŸå¤±${playerDamage}ç‚¹ç”Ÿå‘½ï¼Œ${enemy.name}æŸå¤±${enemyDamage}ç‚¹ç”Ÿå‘½`);
            break;
            
        case 'rejuvenation':  // å›æ˜¥ï¼šåŒæ–¹æ¢å¤10%æœ€å¤§ç”Ÿå‘½
            const playerHeal = Math.round(player.maxHealth * 0.1);
            const enemyHeal = Math.round(enemy.maxHealth * 0.1);
            player.currentHealth = Math.min(player.currentHealth + playerHeal, player.maxHealth);
            enemy.currentHealth = Math.min(enemy.currentHealth + enemyHeal, enemy.maxHealth);
            addLog(`ã€å›æ˜¥ã€‘${player.name}æ¢å¤${playerHeal}ç‚¹ç”Ÿå‘½ï¼Œ${enemy.name}æ¢å¤${enemyHeal}ç‚¹ç”Ÿå‘½`);
            break;
    }
    
    updateDisplay();
}

// æ£€æŸ¥åœºåœ°æ•ˆæœæ˜¯å¦ç¦ç”¨æŸè¡ŒåŠ¨
function isActionDisabledByField(action) {
    if (activeFieldEffect === null) return false;
    
    switch (activeFieldEffect.id) {
        case 'melee':  // ç¼ æ–—ï¼šç¦ç”¨å˜´ç‚®
            return action === 'taunt';
        default:
            return false;
    }
}

// è·å–åœºåœ°æ•ˆæœçš„ä¼¤å®³ä¿®æ­£ï¼ˆæ€æ„æ•ˆæœï¼‰
function getFieldDamageMultiplier() {
    if (activeFieldEffect && activeFieldEffect.id === 'killing-intent') {
        return 1.5;
    }
    return 1.0;
}

// è·å–åœºåœ°æ•ˆæœçš„è‡ªä¼¤æ¯”ä¾‹ï¼ˆæ€æ„æ•ˆæœï¼‰
function getFieldSelfDamageRatio() {
    if (activeFieldEffect && activeFieldEffect.id === 'killing-intent') {
        return 0.25;
    }
    return 0;
}

// æ£€æŸ¥åœºåœ°æ•ˆæœæ˜¯å¦å®Œå…¨å…ä¼¤ï¼ˆå›ºå®ˆæ•ˆæœï¼‰
function isFieldFullDefense() {
    return activeFieldEffect && activeFieldEffect.id === 'fortify';
}

// ç‚¹å‡»å…¶ä»–åŒºåŸŸå…³é—­æ—¥å¿—ä¸‹æ‹‰æ¡†å’Œåœºåœ°æ•ˆæœä¸‹æ‹‰æ¡†
document.addEventListener('click', function(e) {
    const turnIndicator = document.getElementById('turn-indicator');
    const logDropdown = document.getElementById('log-dropdown');
    const fieldIndicator = document.getElementById('field-effect-indicator');
    const fieldDropdown = document.getElementById('field-effect-dropdown');
    
    if (turnIndicator && logDropdown && !turnIndicator.contains(e.target)) {
        logDropdown.classList.remove('active');
    }
    
    if (fieldIndicator && fieldDropdown && !fieldIndicator.contains(e.target)) {
        fieldDropdown.classList.remove('active');
        fieldDropdownOpen = false;
    }
});

// é€‰æ‹©åŠ¨ä½œ
function selectAction(action) {
    // å¦‚æœä¸æ˜¯ç©å®¶å›åˆæˆ–æ­£åœ¨ç­‰å¾…ç¡®è®¤ï¼Œè¿”å›
    if (gameState.currentTurn !== 'player' || gameState.waitingForConfirmation) return;
    
    // æ£€æŸ¥æŒ‰é’®æ˜¯å¦è¢«ç¦ç”¨
    if (document.getElementById(action).classList.contains('disabled')) {
        return;
    }
    
    // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
    commandButtons.forEach(btn => btn.classList.remove('selected'));
    
    // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„èƒ½é‡
    if ((action === 'light-attack' && gameState.player.energy < 1) ||
        (action === 'heavy-attack' && gameState.player.energy < 2) ||
        (action === 'special' && gameState.player.energy < 5)) {
        addLog('èƒ½é‡ä¸è¶³ï¼Œæ— æ³•æ‰§è¡Œæ­¤åŠ¨ä½œï¼');
        return;
    }
    
    // è®¾ç½®é€‰ä¸­çŠ¶æ€
    document.getElementById(action).classList.add('selected');
    gameState.player.selectedAction = action;
    
    // æ›´æ–°é€‰æ‹©æ˜¾ç¤º
    const actionNames = {
        'gather': 'é›†æ°”',
        'defend': 'é˜²å¾¡',
        'light-attack': 'è½»æ”»å‡»',
        'heavy-attack': 'é‡æ”»å‡»',
        'special': 'ç»æ‹›',
        'taunt': 'å˜´ç‚®'
    };
    selectedActionText.textContent = actionNames[action];
    
    // æ˜¾ç¤ºç¡®è®¤å¼¹çª—
    confirmModal.style.display = 'flex';
}

// ç¡®è®¤åŠ¨ä½œ
function confirmAction() {
    if (!gameState.player.selectedAction) return;
    
    // è®¾ç½®ä¸ºç­‰å¾…ç¡®è®¤çŠ¶æ€
    gameState.waitingForConfirmation = true;
    
    // ç¦ç”¨æŒ‰é’®
    commandButtons.forEach(btn => {
        btn.classList.add('disabled');
    });
    
    addLog(`${gameState.player.name}å‡†å¤‡è¡ŒåŠ¨...`);
    
    // æ•ŒäººAIé€‰æ‹©åŠ¨ä½œ
    selectEnemyAction();
    
    // æ‰§è¡Œå›åˆç»“ç®—ï¼ˆå‡å°‘å»¶è¿Ÿï¼Œæå‡å“åº”é€Ÿåº¦ï¼‰
    setTimeout(executeTurn, 300);
}

// æ•ŒäººAIé€‰æ‹©åŠ¨ä½œ
function selectEnemyAction() {
    const enemy = gameState.enemy;
    const player = gameState.player;
    const style = enemy.style || 'é£'; // é»˜è®¤é£æ ¼
    
    // æ£€æŸ¥æ˜¯å¦å¤„äºæŒ‘è¡…çŠ¶æ€ï¼ˆä¸èƒ½ä½¿ç”¨é˜²å¾¡ï¼‰
    const canDefend = enemy.tauntedTurns <= 0;
    
    // æ£€æŸ¥åœºåœ°æ•ˆæœæ˜¯å¦ç¦ç”¨å˜´ç‚®ï¼ˆç¼ æ–—æ•ˆæœï¼‰
    const canTaunt = !isActionDisabledByField('taunt');

    // ç©å®¶æ°”çš„å¨èƒç­‰çº§
    const playerEnergy = player.energy;

    // å˜´ç‚®åˆ¤å®šï¼šç©å®¶æ°”æ»¡5æ—¶ï¼Œæ•Œäººæœ‰è¾ƒé«˜æ¦‚ç‡å˜´ç‚®ï¼ˆç¼ æ–—æ—¶ç¦ç”¨ï¼‰
    if (playerEnergy >= 5 && canTaunt) {
        if (style === 'å±±' && Math.random() < 0.6) {
            enemy.selectedAction = 'taunt';
            return;
        }
        if (style === 'æ—' && Math.random() < 0.5) {
            enemy.selectedAction = 'taunt';
            return;
        }
        if (style === 'ç«' && Math.random() < 0.5) {
            enemy.selectedAction = 'taunt';
            return;
        }
        if (style === 'é£' && Math.random() < 0.4) {
            enemy.selectedAction = 'taunt';
            return;
        }
    }

    // é˜²å¾¡åˆ¤å®šï¼šç©å®¶æ°”è¾ƒé«˜æ—¶ï¼Œæ•Œäººæœ‰æ¦‚ç‡é˜²å¾¡ï¼ˆæŒ‘è¡…çŠ¶æ€ä¸‹ä¸å¯é˜²å¾¡ï¼‰
    if (playerEnergy >= 1 && canDefend) {
        if (style === 'å±±' && Math.random() < 0.5) {
            enemy.selectedAction = 'defend';
            return;
        }
        if (style === 'æ—' && Math.random() < 0.3) {
            enemy.selectedAction = 'defend';
            return;
        }
        if (style === 'ç«' && Math.random() < 0.25) {
            enemy.selectedAction = 'defend';
            return;
        }
        if (style === 'é£' && Math.random() < 0.25) {
            enemy.selectedAction = 'defend';
            return;
        }
    }

    // é£æ ¼ä¸»ç­–ç•¥ï¼šåŸºäºèƒ½é‡èŒƒå›´çš„åŠ æƒéšæœºé€‰æ‹©
    const styleStrategy = STYLE_STRATEGIES[style];
    if (styleStrategy) {
        const energyKey = getEnergyRangeKey(enemy.energy);
        const options = { ...styleStrategy[energyKey] };
        
        // æ ¹æ®èƒ½é‡é™åˆ¶è¿‡æ»¤ä¸å¯ç”¨çš„è¡ŒåŠ¨
        if (enemy.energy < 1) {
            delete options['light-attack'];
        }
        if (enemy.energy < 2) {
            delete options['heavy-attack'];
        }
        if (enemy.energy < 5) {
            delete options['special'];
        }
        
        // è¿‡æ»¤æ‰æ— æ”¶ç›Šçš„å˜´ç‚®é€‰é¡¹ï¼šç©å®¶å·²è¢«æŒ‘è¡…ä¸”æ°”ä¸è¶³5æ—¶ï¼Œå˜´ç‚®æ— æ”¶ç›Š
        if (player.tauntedTurns > 0 && playerEnergy < 5) {
            delete options['taunt'];
        }
        
        // åœºåœ°æ•ˆæœç¦ç”¨å˜´ç‚®ï¼ˆç¼ æ–—ï¼‰
        if (!canTaunt) {
            delete options['taunt'];
        }
        
        // å¦‚æœè¿‡æ»¤åè¿˜æœ‰é€‰é¡¹ï¼Œä½¿ç”¨åŠ æƒéšæœºé€‰æ‹©
        if (Object.keys(options).length > 0) {
            const debugInfo = {
                style: style,
                energyKey: energyKey
            };
            enemy.selectedAction = weightedRandom(options, debugInfo);
            return;
        }
    }

    // é»˜è®¤è¡Œä¸º
    enemy.selectedAction = 'gather';
}

// æ‰§è¡Œå›åˆ
function executeTurn() {
    const player = gameState.player;
    const enemy = gameState.enemy;
    
    // è·å–åŒæ–¹è¡ŒåŠ¨
    const playerAction = player.selectedAction;
    const enemyAction = enemy.selectedAction;
    
    addLog(`${enemy.name}é€‰æ‹©äº†è¡ŒåŠ¨...`);
    
    // æ ¹æ®è¡ŒåŠ¨ç±»å‹æ‰§è¡Œç‰¹æ•ˆå’Œç»“ç®—ï¼ˆå‡å°‘å»¶è¿Ÿï¼Œæå‡å“åº”é€Ÿåº¦ï¼‰
    setTimeout(() => {
        // æ˜¾ç¤ºåŒæ–¹é€‰æ‹©çš„åŠ¨ä½œ
        const actionNames = {
            'gather': 'é›†æ°”',
            'defend': 'é˜²å¾¡',
            'light-attack': 'è½»æ”»å‡»',
            'heavy-attack': 'é‡æ”»å‡»',
            'special': 'ç»æ‹›',
            'taunt': 'å˜´ç‚®'
        };
        
        addLog(`${player.name}ä½¿ç”¨äº†${actionNames[playerAction]}ï¼${enemy.name}ä½¿ç”¨äº†${actionNames[enemyAction]}ï¼`);
        
        // å¤„ç†è¡ŒåŠ¨ç»“æœ
        processActions(playerAction, enemyAction);
        
        // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
        if (checkGameOver()) {
            return;
        }
        
        // ç»§ç»­ä¸‹ä¸€å›åˆ
        continueGame();
    }, 200);  // å‡å°‘å»¶è¿Ÿï¼Œæå‡å“åº”é€Ÿåº¦
}

// å¤„ç†åŒæ–¹è¡ŒåŠ¨çš„ç»“æœ
function processActions(playerAction, enemyAction) {
    const player = gameState.player;
    const enemy = gameState.enemy;
    const gameContainer = document.querySelector('.game-container');
    const npcPortraitLayer = document.querySelector('.npc-portrait-layer');
    const playerPortraitLayer = document.querySelector('.player-portrait-layer');
    const screenFlash = document.querySelector('.screen-flash');
    let playerWasHit = false;
    let enemyWasHit = false;
    
    // ç«‹ç»˜åŠ¨ç”»çŠ¶æ€è¿½è¸ª
    let playerDealtDamage = false;      // ç©å®¶æ˜¯å¦é€ æˆä¼¤å®³
    let enemyDealtDamage = false;       // æ•Œäººæ˜¯å¦é€ æˆä¼¤å®³
    let playerSpecialBroken = false;    // ç©å®¶ç»æ‹›æ˜¯å¦è¢«å˜´ç‚®ç ´
    let enemySpecialBroken = false;     // æ•Œäººç»æ‹›æ˜¯å¦è¢«å˜´ç‚®ç ´
    let playerDamageAction = null;      // ç©å®¶é€ æˆä¼¤å®³çš„æ”»å‡»ç±»å‹
    let enemyDamageAction = null;       // æ•Œäººé€ æˆä¼¤å®³çš„æ”»å‡»ç±»å‹
    let playerBrokenByTaunt = false;    // ç©å®¶è¢«å˜´ç‚®ç ´é˜²
    let enemyBrokenByTaunt = false;     // æ•Œäººè¢«å˜´ç‚®ç ´é˜²
    let playerHitBySpecial = false;     // ç©å®¶è¢«ç»æ‹›æ— è§†é˜²å¾¡
    let enemyHitBySpecial = false;      // æ•Œäººè¢«ç»æ‹›æ— è§†é˜²å¾¡
    
    // åœºåœ°æ•ˆæœï¼šè¿½è¸ªæœ¬å›åˆåŒæ–¹é€ æˆçš„æ€»ä¼¤å®³ï¼ˆç”¨äºæ€æ„è‡ªä¼¤ï¼‰
    let playerTotalDamageDealt = 0;
    let enemyTotalDamageDealt = 0;
    
    // åœºåœ°æ•ˆæœï¼šè·å–ä¼¤å®³å€ç‡
    const fieldDamageMultiplier = getFieldDamageMultiplier();  // æ€æ„ï¼š1.5å€
    const fieldFullDefense = isFieldFullDefense();              // å›ºå®ˆï¼šå®Œå…¨å…ä¼¤
    
    // å¤„ç†é›†æ°”
    if (playerAction === 'gather') {
        // æ˜¾ç¤ºç©å®¶é›†æ°”ç‰¹æ•ˆ
        showBattleEffect('player-gather-effect', 1000);
        if (player.energy < player.maxEnergy) {
            player.energy += 1;
            addLog(`${player.name}é›†æ°”æˆåŠŸï¼Œèƒ½é‡+1ï¼`);
        } else {
            addLog(`${player.name}çš„èƒ½é‡å·²æ»¡ï¼`);
        }
    }
    
    if (enemyAction === 'gather') {
        // æ˜¾ç¤ºæ•Œäººé›†æ°”ç‰¹æ•ˆ
        showBattleEffect('enemy-gather-effect', 1000);
        if (enemy.energy < enemy.maxEnergy) {
            enemy.energy += 1;
            addLog(`${enemy.name}é›†æ°”æˆåŠŸï¼Œèƒ½é‡+1ï¼`);
        } else {
            addLog(`${enemy.name}çš„èƒ½é‡å·²æ»¡ï¼`);
        }
    }
    
    // å¤„ç†é˜²å¾¡çŠ¶æ€
    const playerDefending = playerAction === 'defend';
    const enemyDefending = enemyAction === 'defend';
    
    if (playerDefending) {
        playerCharacter.classList.add('player-defend');
        setTimeout(() => {
            playerCharacter.classList.remove('player-defend');
        }, 1000);
        addLog(`${player.name}è¿›å…¥é˜²å¾¡çŠ¶æ€ï¼`);
    }
    
    if (enemyDefending) {
        enemyCharacter.classList.add('enemy-defend');
        setTimeout(() => {
            enemyCharacter.classList.remove('enemy-defend');
        }, 1000);
        addLog(`${enemy.name}è¿›å…¥é˜²å¾¡çŠ¶æ€ï¼`);
    }
    
    // å˜´ç‚®é€»è¾‘å¤„ç†
    let playerTauntSuccess = false;
    let enemyTauntSuccess = false;
    
    // åŒæ–¹åŒæ—¶å˜´ç‚®ï¼Œæ— äº‹å‘ç”Ÿ
    if (playerAction === 'taunt' && enemyAction === 'taunt') {
        // åŒæ–¹éƒ½æ˜¾ç¤ºå˜´ç‚®ç‰¹æ•ˆ
        showBattleEffect('player-taunt-effect', 1500);
        showBattleEffect('enemy-taunt-effect', 1500);
        addLog('åŒæ–¹äº’ç›¸å˜´ç‚®ï¼Œä¸åˆ†é«˜ä¸‹ï¼');
    } else {
        // å˜´ç‚®å¯¹é˜²å¾¡çš„æ•ˆæœï¼šæŒ‘è¡…
        if (playerAction === 'taunt' && enemyDefending) {
            // ç©å®¶å˜´ç‚®æˆåŠŸï¼Œæ˜¾ç¤ºå˜´ç‚®ç‰¹æ•ˆ
            showBattleEffect('player-taunt-effect', 1500);
            // ç©å®¶å˜´ç‚® vs æ•Œäººé˜²å¾¡ï¼šæ•Œäººæ°”-1ï¼Œè¿›å…¥æŒ‘è¡…çŠ¶æ€
            if (enemy.energy > 0) {
                enemy.energy -= 1;
                addLog(`${player.name}çš„å˜´ç‚®æ¿€æ€’äº†${enemy.name}ï¼${enemy.name}æ°”-1ï¼Œè¿›å…¥æŒ‘è¡…çŠ¶æ€ï¼`);
            } else {
                addLog(`${player.name}çš„å˜´ç‚®æ¿€æ€’äº†${enemy.name}ï¼${enemy.name}è¿›å…¥æŒ‘è¡…çŠ¶æ€ï¼`);
            }
            enemy.tauntedTurns = 3;
            enemyWasHit = true;
            enemyBrokenByTaunt = true;  // æ•Œäººè¢«å˜´ç‚®ç ´é˜²
        }
        
        if (enemyAction === 'taunt' && playerDefending) {
            // æ•Œäººå˜´ç‚®æˆåŠŸï¼Œæ˜¾ç¤ºå˜´ç‚®ç‰¹æ•ˆ
            showBattleEffect('enemy-taunt-effect', 1500);
            // æ•Œäººå˜´ç‚® vs ç©å®¶é˜²å¾¡ï¼šç©å®¶æ°”-1ï¼Œè¿›å…¥æŒ‘è¡…çŠ¶æ€
            if (player.energy > 0) {
                player.energy -= 1;
                addLog(`${enemy.name}çš„å˜´ç‚®æ¿€æ€’äº†${player.name}ï¼${player.name}æ°”-1ï¼Œè¿›å…¥æŒ‘è¡…çŠ¶æ€ï¼`);
            } else {
                addLog(`${enemy.name}çš„å˜´ç‚®æ¿€æ€’äº†${player.name}ï¼${player.name}è¿›å…¥æŒ‘è¡…çŠ¶æ€ï¼`);
            }
            player.tauntedTurns = 3;
            playerWasHit = true;
            playerBrokenByTaunt = true;  // ç©å®¶è¢«å˜´ç‚®ç ´é˜²
        }
        
        // å˜´ç‚®å¯¹ç»æ‹›çš„æ•ˆæœï¼šæ— æ•ˆåŒ–ä¼¤å®³ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
        if (playerAction === 'taunt' && enemyAction === 'special') {
            // ç©å®¶å˜´ç‚®ç ´è§£ç»æ‹›ï¼Œæ˜¾ç¤ºå˜´ç‚®ç‰¹æ•ˆ
            showBattleEffect('player-taunt-effect', 1500);
            playerTauntSuccess = true;
            enemySpecialBroken = true;  // æ•Œäººç»æ‹›è¢«ç ´
            addLog(`${player.name}çš„å˜´ç‚®æˆåŠŸæ— æ•ˆåŒ–äº†${enemy.name}çš„ç»æ‹›ä¼¤å®³ï¼`);
        }
        
        if (enemyAction === 'taunt' && playerAction === 'special') {
            // æ•Œäººå˜´ç‚®ç ´è§£ç»æ‹›ï¼Œæ˜¾ç¤ºå˜´ç‚®ç‰¹æ•ˆ
            showBattleEffect('enemy-taunt-effect', 1500);
            enemyTauntSuccess = true;
            playerSpecialBroken = true;  // ç©å®¶ç»æ‹›è¢«ç ´
            addLog(`${enemy.name}çš„å˜´ç‚®æˆåŠŸæ— æ•ˆåŒ–äº†${player.name}çš„ç»æ‹›ä¼¤å®³ï¼`);
        }
        
        // å˜´ç‚®å¯¹å…¶ä»–è¡ŒåŠ¨ï¼ˆé›†æ°”ã€è½»å‡»ã€é‡å‡»ï¼‰ï¼šæ— ç‰¹æ®Šæ•ˆæœï¼Œä½†ä»æ˜¾ç¤ºç‰¹æ•ˆ
        if (playerAction === 'taunt' && !enemyDefending && enemyAction !== 'special' && enemyAction !== 'taunt') {
            showBattleEffect('player-taunt-effect', 1500);
            addLog(`${player.name}å˜´ç‚®äº†ä¸€ç•ªï¼Œä½†${enemy.name}ä¸ä¸ºæ‰€åŠ¨ï¼`);
        }
        if (enemyAction === 'taunt' && !playerDefending && playerAction !== 'special' && playerAction !== 'taunt') {
            showBattleEffect('enemy-taunt-effect', 1500);
            addLog(`${enemy.name}å˜´ç‚®äº†ä¸€ç•ªï¼Œä½†${player.name}ä¸ä¸ºæ‰€åŠ¨ï¼`);
        }
    }
    
    // å¤„ç†ç»æ‹›ï¼ˆæ— è§†é˜²å¾¡ï¼‰
    if (playerAction === 'special') {
        // æ— è®ºç»æ‹›æ˜¯å¦è¢«å˜´ç‚®æ— æ•ˆåŒ–ï¼Œéƒ½æ¶ˆè€—èƒ½é‡
        player.energy -= 5;
        playerCharacter.classList.add('player-special');
        
        if (!enemyTauntSuccess) {
            enemyCharacter.classList.add('enemy-hit');
            // æ˜¾ç¤ºæ•Œäººè¢«æ”»å‡»ç‰¹æ•ˆ
            showBattleEffect('enemy-hit-effect', 1200);
            
            setTimeout(() => {
                enemyCharacter.classList.remove('enemy-hit');
            }, 1000);
            
            const damage = Math.round(player.basicDamage * 3 * damageMultiplier * fieldDamageMultiplier);
            enemy.currentHealth -= damage;
            playerTotalDamageDealt += damage;  // è¿½è¸ªä¼¤å®³ç”¨äºæ€æ„è‡ªä¼¤
            addLog(`${player.name}ä½¿ç”¨ç»æ‹›ï¼Œå¯¹${enemy.name}é€ æˆ${damage}ç‚¹ä¼¤å®³ï¼`);
            enemyWasHit = true;
            playerDealtDamage = true;           // ç©å®¶é€ æˆä¼¤å®³
            playerDamageAction = 'special';     // è®°å½•æ”»å‡»ç±»å‹
            if (enemyDefending) {
                enemyHitBySpecial = true;       // æ•Œäººé˜²å¾¡è¢«ç»æ‹›æ— è§†
            }
        } else {
            addLog(`${player.name}ä½¿ç”¨ç»æ‹›ï¼Œä½†ä¼¤å®³è¢«${enemy.name}çš„å˜´ç‚®æ— æ•ˆåŒ–äº†ï¼`);
        }
        
        setTimeout(() => {
            playerCharacter.classList.remove('player-special');
        }, 1000);
        
        // æ— æ•ˆåŒ–æ•Œäººçš„æ™®é€šæ”»å‡»
        if (enemyAction === 'light-attack' || enemyAction === 'heavy-attack') {
            addLog(`${enemy.name}çš„æ”»å‡»è¢«${player.name}çš„ç»æ‹›æ— æ•ˆåŒ–äº†ï¼`);
            // æ•Œäººæ¶ˆè€—çš„èƒ½é‡ä¸è¿”è¿˜
            if (enemyAction === 'light-attack') enemy.energy -= 1;
            if (enemyAction === 'heavy-attack') enemy.energy -= 2;
        }
    }
    
    if (enemyAction === 'special') {
        // æ— è®ºç»æ‹›æ˜¯å¦è¢«å˜´ç‚®æ— æ•ˆåŒ–ï¼Œéƒ½æ¶ˆè€—èƒ½é‡
        enemy.energy -= 5;
        enemyCharacter.classList.add('enemy-special');
        
        if (!playerTauntSuccess) {
            playerCharacter.classList.add('player-hit');
            // æ˜¾ç¤ºç©å®¶è¢«æ”»å‡»ç‰¹æ•ˆ
            showBattleEffect('player-hit-effect', 1200);
            
            setTimeout(() => {
                playerCharacter.classList.remove('player-hit');
            }, 1000);
            
            const damage = Math.round(enemy.basicDamage * 3 * fieldDamageMultiplier / defenseMultiplier);
            player.currentHealth -= damage;
            enemyTotalDamageDealt += damage;  // è¿½è¸ªä¼¤å®³ç”¨äºæ€æ„è‡ªä¼¤
            addLog(`${enemy.name}ä½¿ç”¨ç»æ‹›ï¼Œå¯¹${player.name}é€ æˆ${damage}ç‚¹ä¼¤å®³ï¼`);
            playerWasHit = true;
            enemyDealtDamage = true;           // æ•Œäººé€ æˆä¼¤å®³
            enemyDamageAction = 'special';     // è®°å½•æ”»å‡»ç±»å‹
            if (playerDefending) {
                playerHitBySpecial = true;     // ç©å®¶é˜²å¾¡è¢«ç»æ‹›æ— è§†
            }
        } else {
            addLog(`${enemy.name}ä½¿ç”¨ç»æ‹›ï¼Œä½†ä¼¤å®³è¢«${player.name}çš„å˜´ç‚®æ— æ•ˆåŒ–äº†ï¼`);
        }
        
        setTimeout(() => {
            enemyCharacter.classList.remove('enemy-special');
        }, 1000);
        
        // æ— æ•ˆåŒ–ç©å®¶çš„æ™®é€šæ”»å‡»
        if (playerAction === 'light-attack' || playerAction === 'heavy-attack') {
            addLog(`${player.name}çš„æ”»å‡»è¢«${enemy.name}çš„ç»æ‹›æ— æ•ˆåŒ–äº†ï¼`);
            // ç©å®¶æ¶ˆè€—çš„èƒ½é‡ä¸è¿”è¿˜
            if (playerAction === 'light-attack') player.energy -= 1;
            if (playerAction === 'heavy-attack') player.energy -= 2;
        }
    }
    
    // å¦‚æœæ²¡æœ‰è¢«ç»æ‹›æ— æ•ˆï¼Œå¤„ç†é‡æ”»å‡»
    if (playerAction === 'heavy-attack' &&
        enemyAction !== 'special' &&
        playerAction !== 'special') {
        player.energy -= 2;
        
        // æ£€æŸ¥æ˜¯å¦è¢«é˜²å¾¡æˆ–æ˜¯å¦æ— æ•ˆå¯¹æ–¹è½»æ”»å‡»
        if (enemyDefending) {
            playerCharacter.classList.add('player-attack');
            // enemyCharacter.classList.add('enemy-hit');
            
            setTimeout(() => {
                playerCharacter.classList.remove('player-attack');
                // enemyCharacter.classList.remove('enemy-hit');
            }, 600);
            
            // é˜²å¾¡é‡æ”»å‡»å—åˆ°25%ä¼¤å®³ï¼ˆå›ºå®ˆæ•ˆæœä¸‹å®Œå…¨å…ä¼¤ï¼‰
            const reducedDamage = fieldFullDefense ? 0 : Math.round(player.basicDamage * 1.5 * 0.25 * damageMultiplier * fieldDamageMultiplier);
            enemy.currentHealth -= reducedDamage;
            playerTotalDamageDealt += reducedDamage;
            // æ˜¾ç¤ºæ•Œäººè¢«æ”»å‡»ç‰¹æ•ˆ
            showBattleEffect('enemy-hit-effect', 1000);
            if (fieldFullDefense) {
                addLog(`${player.name}çš„é‡æ”»å‡»è¢«${enemy.name}å®Œå…¨é˜²å¾¡äº†ï¼`);
            } else {
                addLog(`${player.name}çš„é‡æ”»å‡»è¢«${enemy.name}é˜²å¾¡äº†ï¼Œä½†ä»é€ æˆ${reducedDamage}ç‚¹ä¼¤å®³ï¼`);
            }
            enemyWasHit = true;
            playerDealtDamage = true;
            playerDamageAction = 'heavy-attack';
        } else if (enemyAction === 'light-attack') {
            // é‡æ”»å‡»å…‹åˆ¶è½»æ”»å‡»
            playerCharacter.classList.add('player-attack');
            enemyCharacter.classList.add('enemy-hit');
            // æ˜¾ç¤ºæ•Œäººè¢«æ”»å‡»ç‰¹æ•ˆ
            showBattleEffect('enemy-hit-effect', 1000);
            
            setTimeout(() => {
                playerCharacter.classList.remove('player-attack');
                enemyCharacter.classList.remove('enemy-hit');
            }, 600);
            
            const damage = Math.round(player.basicDamage * 1.5 * damageMultiplier * fieldDamageMultiplier);
            enemy.currentHealth -= damage;
            playerTotalDamageDealt += damage;
            enemy.energy -= 1; // æ¶ˆè€—æ•Œäººçš„èƒ½é‡
            addLog(`${player.name}çš„é‡æ”»å‡»æ— æ•ˆåŒ–äº†${enemy.name}çš„è½»æ”»å‡»ï¼Œå¹¶é€ æˆ${damage}ç‚¹ä¼¤å®³ï¼`);
            enemyWasHit = true;
            playerDealtDamage = true;
            playerDamageAction = 'heavy-attack';
        } else {
            playerCharacter.classList.add('player-attack');
            enemyCharacter.classList.add('enemy-hit');
            // æ˜¾ç¤ºæ•Œäººè¢«æ”»å‡»ç‰¹æ•ˆ
            showBattleEffect('enemy-hit-effect', 1000);
            
            setTimeout(() => {
                playerCharacter.classList.remove('player-attack');
                enemyCharacter.classList.remove('enemy-hit');
            }, 600);
            
            const damage = Math.round(player.basicDamage * 1.5 * damageMultiplier * fieldDamageMultiplier);
            enemy.currentHealth -= damage;
            playerTotalDamageDealt += damage;
            addLog(`${player.name}çš„é‡æ”»å‡»å¯¹${enemy.name}é€ æˆ${damage}ç‚¹ä¼¤å®³ï¼`);
            enemyWasHit = true;
            playerDealtDamage = true;
            playerDamageAction = 'heavy-attack';
        }
    }
    
    if (enemyAction === 'heavy-attack' &&
        playerAction !== 'special' &&
        enemyAction !== 'special') {
        enemy.energy -= 2;
        
        // æ£€æŸ¥æ˜¯å¦è¢«é˜²å¾¡æˆ–æ˜¯å¦æ— æ•ˆå¯¹æ–¹è½»æ”»å‡»
        if (playerDefending) {
            enemyCharacter.classList.add('enemy-attack');
            // playerCharacter.classList.add('player-hit');
            // æ˜¾ç¤ºç©å®¶è¢«æ”»å‡»ç‰¹æ•ˆï¼ˆé˜²å¾¡æ—¶ä¹Ÿæ˜¾ç¤ºï¼‰
            showBattleEffect('player-hit-effect', 1000);
            
            setTimeout(() => {
                enemyCharacter.classList.remove('enemy-attack');
                // playerCharacter.classList.remove('player-hit');
            }, 600);
            
            // é˜²å¾¡é‡æ”»å‡»å—åˆ°20%ä¼¤å®³ï¼ˆå›ºå®ˆæ•ˆæœä¸‹å®Œå…¨å…ä¼¤ï¼‰
            const reducedDamage = fieldFullDefense ? 0 : Math.round(enemy.basicDamage * 1.5 * 0.2 * fieldDamageMultiplier / defenseMultiplier);
            player.currentHealth -= reducedDamage;
            enemyTotalDamageDealt += reducedDamage;
            if (fieldFullDefense) {
                addLog(`${enemy.name}çš„é‡æ”»å‡»è¢«${player.name}å®Œå…¨é˜²å¾¡äº†ï¼`);
            } else {
                addLog(`${enemy.name}çš„é‡æ”»å‡»è¢«${player.name}é˜²å¾¡äº†ï¼Œä½†ä»é€ æˆ${reducedDamage}ç‚¹ä¼¤å®³ï¼`);
            }
            playerWasHit = true;
            enemyDealtDamage = true;
            enemyDamageAction = 'heavy-attack';
        } else if (playerAction === 'light-attack') {
            // é‡æ”»å‡»å…‹åˆ¶è½»æ”»å‡»
            enemyCharacter.classList.add('enemy-attack');
            playerCharacter.classList.add('player-hit');
            // æ˜¾ç¤ºç©å®¶è¢«æ”»å‡»ç‰¹æ•ˆ
            showBattleEffect('player-hit-effect', 1000);
            
            setTimeout(() => {
                enemyCharacter.classList.remove('enemy-attack');
                playerCharacter.classList.remove('player-hit');
            }, 600);
            
            const damage = Math.round(enemy.basicDamage * 1.5 * fieldDamageMultiplier / defenseMultiplier);
            player.currentHealth -= damage;
            enemyTotalDamageDealt += damage;
            player.energy -= 1; // æ¶ˆè€—ç©å®¶çš„èƒ½é‡
            addLog(`${enemy.name}çš„é‡æ”»å‡»æ— æ•ˆåŒ–äº†${player.name}çš„è½»æ”»å‡»ï¼Œå¹¶é€ æˆ${damage}ç‚¹ä¼¤å®³ï¼`);
            playerWasHit = true;
            enemyDealtDamage = true;
            enemyDamageAction = 'heavy-attack';
        } else {
            enemyCharacter.classList.add('enemy-attack');
            playerCharacter.classList.add('player-hit');
            // æ˜¾ç¤ºç©å®¶è¢«æ”»å‡»ç‰¹æ•ˆ
            showBattleEffect('player-hit-effect', 1000);
            
            setTimeout(() => {
                enemyCharacter.classList.remove('enemy-attack');
                playerCharacter.classList.remove('player-hit');
            }, 600);
            
            const damage = Math.round(enemy.basicDamage * 1.5 * fieldDamageMultiplier / defenseMultiplier);
            player.currentHealth -= damage;
            enemyTotalDamageDealt += damage;
            addLog(`${enemy.name}çš„é‡æ”»å‡»å¯¹${player.name}é€ æˆ${damage}ç‚¹ä¼¤å®³ï¼`);
            playerWasHit = true;
            enemyDealtDamage = true;
            enemyDamageAction = 'heavy-attack';
        }
    }
    
    // å¦‚æœæ²¡æœ‰è¢«é‡æ”»å‡»æˆ–ç»æ‹›æ— æ•ˆï¼Œå¤„ç†è½»æ”»å‡»
    if (playerAction === 'light-attack' && 
        enemyAction !== 'heavy-attack' && 
        enemyAction !== 'special') {
        player.energy -= 1;
        
        // æ£€æŸ¥æ˜¯å¦è¢«é˜²å¾¡
        if (enemyDefending) {
            playerCharacter.classList.add('player-attack');
            // enemyCharacter.classList.add('enemy-hit');
            // æ˜¾ç¤ºæ•Œäººè¢«æ”»å‡»ç‰¹æ•ˆï¼ˆé˜²å¾¡æ—¶ä¹Ÿæ˜¾ç¤ºï¼‰
            showBattleEffect('enemy-hit-effect', 1000);
            
            setTimeout(() => {
                playerCharacter.classList.remove('player-attack');
                // enemyCharacter.classList.remove('enemy-hit');
            }, 600);
            
            // é˜²å¾¡è½»æ”»å‡»å—åˆ°15%ä¼¤å®³ï¼ˆå›ºå®ˆæ•ˆæœä¸‹å®Œå…¨å…ä¼¤ï¼‰
            const reducedDamage = fieldFullDefense ? 0 : Math.round(player.basicDamage * 0.15 * damageMultiplier * fieldDamageMultiplier);
            enemy.currentHealth -= reducedDamage;
            playerTotalDamageDealt += reducedDamage;
            if (fieldFullDefense) {
                addLog(`${player.name}çš„è½»æ”»å‡»è¢«${enemy.name}å®Œå…¨é˜²å¾¡äº†ï¼`);
            } else {
                addLog(`${player.name}çš„è½»æ”»å‡»è¢«${enemy.name}é˜²å¾¡äº†ï¼Œä½†ä»é€ æˆ${reducedDamage}ç‚¹ä¼¤å®³ï¼`);
            }
            enemyWasHit = true;
            playerDealtDamage = true;
            playerDamageAction = 'light-attack';
        } else {
            playerCharacter.classList.add('player-attack');
            enemyCharacter.classList.add('enemy-hit');
            // æ˜¾ç¤ºæ•Œäººè¢«æ”»å‡»ç‰¹æ•ˆ
            showBattleEffect('enemy-hit-effect', 1000);
            
            setTimeout(() => {
                playerCharacter.classList.remove('player-attack');
                enemyCharacter.classList.remove('enemy-hit');
            }, 600);
            
            const damage = Math.round(player.basicDamage * damageMultiplier * fieldDamageMultiplier);
            enemy.currentHealth -= damage;
            playerTotalDamageDealt += damage;
            addLog(`${player.name}çš„è½»æ”»å‡»å¯¹${enemy.name}é€ æˆ${damage}ç‚¹ä¼¤å®³ï¼`);
            enemyWasHit = true;
            playerDealtDamage = true;
            playerDamageAction = 'light-attack';
        }
    }
    
    if (enemyAction === 'light-attack' && 
        playerAction !== 'heavy-attack' && 
        playerAction !== 'special') {
        enemy.energy -= 1;
        
        // æ£€æŸ¥æ˜¯å¦è¢«é˜²å¾¡
        if (playerDefending) {
            enemyCharacter.classList.add('enemy-attack');
            // playerCharacter.classList.add('player-hit');
            // æ˜¾ç¤ºç©å®¶è¢«æ”»å‡»ç‰¹æ•ˆï¼ˆé˜²å¾¡æ—¶ä¹Ÿæ˜¾ç¤ºï¼‰
            showBattleEffect('player-hit-effect', 1000);
            
            setTimeout(() => {
                enemyCharacter.classList.remove('enemy-attack');
                // playerCharacter.classList.remove('player-hit');
            }, 600);
            
            // é˜²å¾¡è½»æ”»å‡»å—åˆ°15%ä¼¤å®³ï¼ˆå›ºå®ˆæ•ˆæœä¸‹å®Œå…¨å…ä¼¤ï¼‰
            const reducedDamage = fieldFullDefense ? 0 : Math.round(enemy.basicDamage * 0.15 * fieldDamageMultiplier / defenseMultiplier);
            player.currentHealth -= reducedDamage;
            enemyTotalDamageDealt += reducedDamage;
            if (fieldFullDefense) {
                addLog(`${enemy.name}çš„è½»æ”»å‡»è¢«${player.name}å®Œå…¨é˜²å¾¡äº†ï¼`);
            } else {
                addLog(`${enemy.name}çš„è½»æ”»å‡»è¢«${player.name}é˜²å¾¡äº†ï¼Œä½†ä»é€ æˆ${reducedDamage}ç‚¹ä¼¤å®³ï¼`);
            }
            playerWasHit = true;
            enemyDealtDamage = true;
            enemyDamageAction = 'light-attack';
        } else {
            enemyCharacter.classList.add('enemy-attack');
            playerCharacter.classList.add('player-hit');
            // æ˜¾ç¤ºç©å®¶è¢«æ”»å‡»ç‰¹æ•ˆ
            showBattleEffect('player-hit-effect', 1000);
            
            setTimeout(() => {
                enemyCharacter.classList.remove('enemy-attack');
                playerCharacter.classList.remove('player-hit');
            }, 600);
            
            const damage = Math.round(enemy.basicDamage * fieldDamageMultiplier / defenseMultiplier);
            player.currentHealth -= damage;
            enemyTotalDamageDealt += damage;
            addLog(`${enemy.name}çš„è½»æ”»å‡»å¯¹${player.name}é€ æˆ${damage}ç‚¹ä¼¤å®³ï¼`);
            playerWasHit = true;
            enemyDealtDamage = true;
            enemyDamageAction = 'light-attack';
        }
    }
    
    // ç¡®ä¿ç”Ÿå‘½å€¼ä¸ä¸ºè´Ÿæ•°
    if (player.currentHealth < 0) player.currentHealth = 0;
    if (enemy.currentHealth < 0) enemy.currentHealth = 0;
    
    // åœºåœ°æ•ˆæœï¼šæ€æ„è‡ªä¼¤ï¼ˆæ”»å‡»è€…æ‰¿å—é€ æˆä¼¤å®³çš„25%ï¼‰
    const selfDamageRatio = getFieldSelfDamageRatio();
    if (selfDamageRatio > 0) {
        if (playerTotalDamageDealt > 0) {
            const playerSelfDamage = Math.round(playerTotalDamageDealt * selfDamageRatio);
            player.currentHealth -= playerSelfDamage;
            if (player.currentHealth < 0) player.currentHealth = 0;
            addLog(`ã€æ€æ„åå™¬ã€‘${player.name}å—åˆ°${playerSelfDamage}ç‚¹åä¼¤ï¼`);
        }
        if (enemyTotalDamageDealt > 0) {
            const enemySelfDamage = Math.round(enemyTotalDamageDealt * selfDamageRatio);
            enemy.currentHealth -= enemySelfDamage;
            if (enemy.currentHealth < 0) enemy.currentHealth = 0;
            addLog(`ã€æ€æ„åå™¬ã€‘${enemy.name}å—åˆ°${enemySelfDamage}ç‚¹åä¼¤ï¼`);
        }
    }
    
    // å—å‡»åé¦ˆåŠ¨ç”»ï¼ˆä¸ç«‹ç»˜å—å‡»çŠ¶æ€åˆ¤æ–­ä¸€è‡´ï¼‰
    // ç©å®¶çœŸæ­£å—å‡»çš„æƒ…å†µï¼šç»æ‹›è¢«ç ´ã€è¢«å˜´ç‚®ç ´é˜²ã€è¢«ç»æ‹›æ— è§†é˜²å¾¡ã€éé˜²å¾¡çŠ¶æ€è¢«æ‰“
    const playerTrueHit = playerSpecialBroken || playerBrokenByTaunt || playerHitBySpecial || (playerWasHit && !playerDefending);
    // æ•ŒäººçœŸæ­£å—å‡»çš„æƒ…å†µï¼šç»æ‹›è¢«ç ´ã€è¢«å˜´ç‚®ç ´é˜²ã€è¢«ç»æ‹›æ— è§†é˜²å¾¡ã€éé˜²å¾¡çŠ¶æ€è¢«æ‰“
    const enemyTrueHit = enemySpecialBroken || enemyBrokenByTaunt || enemyHitBySpecial || (enemyWasHit && !enemyDefending);
    
    if (playerTrueHit) {
        gameContainer.classList.add('shake');
        screenFlash.classList.add('active');
        playerPortraitLayer.classList.add('shake');
        setTimeout(() => {
            gameContainer.classList.remove('shake');
            screenFlash.classList.remove('active');
            playerPortraitLayer.classList.remove('shake');
        }, 400);
    }
    if (enemyTrueHit) {
        npcPortraitLayer.classList.add('shake');
        setTimeout(() => {
            npcPortraitLayer.classList.remove('shake');
        }, 400);
    }
    
    // ========== ç«‹ç»˜åŠ¨ç”»é€»è¾‘ ==========
    // ç¡®å®šç©å®¶ç«‹ç»˜çŠ¶æ€
    let playerPortraitState = 'å¾…æœº';
    let playerGlowClass = null;
    
    if (playerSpecialBroken) {
        // ç»æ‹›è¢«å˜´ç‚®ç ´ï¼Œæ˜¾ç¤ºå—å‡»
        playerPortraitState = 'å—å‡»';
    } else if (playerDealtDamage) {
        // é€ æˆä¼¤å®³ä¼˜å…ˆæ˜¾ç¤ºæ”»å‡»
        playerPortraitState = 'æ”»å‡»';
        playerGlowClass = getGlowClass(playerDamageAction, true);
    } else if (playerBrokenByTaunt || playerHitBySpecial) {
        // è¢«å˜´ç‚®ç ´é˜²æˆ–è¢«ç»æ‹›æ— è§†é˜²å¾¡ï¼Œæ˜¾ç¤ºå—å‡»
        playerPortraitState = 'å—å‡»';
    } else if (playerDefending) {
        // é˜²å¾¡çŠ¶æ€ï¼ˆæ­£å¸¸é˜²å¾¡è½»/é‡æ”»å‡»ï¼‰
        playerPortraitState = 'é˜²å¾¡';
    } else if (playerWasHit) {
        // åªå—ä¼¤æ˜¾ç¤ºå—å‡»ï¼ˆéé˜²å¾¡æƒ…å†µä¸‹è¢«æ‰“ï¼‰
        playerPortraitState = 'å—å‡»';
    }
    
    // ç¡®å®šæ•Œäººç«‹ç»˜çŠ¶æ€
    let enemyPortraitState = 'å¾…æœº';
    let enemyGlowClass = null;
    
    if (enemySpecialBroken) {
        // ç»æ‹›è¢«å˜´ç‚®ç ´ï¼Œæ˜¾ç¤ºå—å‡»
        enemyPortraitState = 'å—å‡»';
    } else if (enemyDealtDamage) {
        // é€ æˆä¼¤å®³ä¼˜å…ˆæ˜¾ç¤ºæ”»å‡»
        enemyPortraitState = 'æ”»å‡»';
        enemyGlowClass = getGlowClass(enemyDamageAction, true);
    } else if (enemyBrokenByTaunt || enemyHitBySpecial) {
        // è¢«å˜´ç‚®ç ´é˜²æˆ–è¢«ç»æ‹›æ— è§†é˜²å¾¡ï¼Œæ˜¾ç¤ºå—å‡»
        enemyPortraitState = 'å—å‡»';
    } else if (enemyDefending) {
        // é˜²å¾¡çŠ¶æ€ï¼ˆæ­£å¸¸é˜²å¾¡è½»/é‡æ”»å‡»ï¼‰
        enemyPortraitState = 'é˜²å¾¡';
    } else if (enemyWasHit) {
        // åªå—ä¼¤æ˜¾ç¤ºå—å‡»ï¼ˆéé˜²å¾¡æƒ…å†µä¸‹è¢«æ‰“ï¼‰
        enemyPortraitState = 'å—å‡»';
    }
    
    // åº”ç”¨ç«‹ç»˜çŠ¶æ€
    setPortraitState(true, playerPortraitState, playerGlowClass);
    setPortraitState(false, enemyPortraitState, enemyGlowClass);
    
    // 1.0ç§’åæ¢å¤å¾…æœºçŠ¶æ€
    setTimeout(() => {
        resetPortraitsToIdle();
    }, 1000);
    
    // æ›´æ–°æ˜¾ç¤º
    updateDisplay();
}

// ç»§ç»­æ¸¸æˆ
function continueGame() {
    // é‡ç½®é€‰æ‹©çŠ¶æ€
    gameState.player.selectedAction = null;
    gameState.enemy.selectedAction = null;
    gameState.waitingForConfirmation = false;
    selectedActionText.textContent = 'æ— ';
    
    // é€’å‡æŒ‘è¡…çŠ¶æ€è®¡æ•°
    if (gameState.player.tauntedTurns > 0) {
        gameState.player.tauntedTurns--;
        if (gameState.player.tauntedTurns === 0) {
            addLog(`${gameState.player.name}çš„æŒ‘è¡…çŠ¶æ€ç»“æŸäº†ã€‚`);
        }
    }
    if (gameState.enemy.tauntedTurns > 0) {
        gameState.enemy.tauntedTurns--;
        if (gameState.enemy.tauntedTurns === 0) {
            addLog(`${gameState.enemy.name}çš„æŒ‘è¡…çŠ¶æ€ç»“æŸäº†ã€‚`);
        }
    }
    
    // å¤„ç†åœºåœ°æ•ˆæœå›åˆç»“æŸ
    processFieldEffectTurnEnd();
    
    // å¢åŠ å›åˆæ•°
    gameState.turnNumber++;
    
    // æ£€æŸ¥å¹¶è§¦å‘æ–°çš„åœºåœ°æ•ˆæœ
    checkFieldEffectTrigger();
    
    // åº”ç”¨åœºåœ°æ•ˆæœçš„å›åˆå¼€å§‹æ•ˆæœ
    setTimeout(() => {
        applyFieldEffectOnTurnStart();
        
        // æ£€æŸ¥æ˜¯å¦å› åœºåœ°æ•ˆæœå¯¼è‡´æˆ˜æ–—ç»“æŸ
        if (checkGameOver()) {
            return;
        }
        
        // æ›´æ–°æ˜¾ç¤º
        updateDisplay();
        
        // ç»§ç»­æ¸¸æˆ
        addLog('å‡†å¤‡ä¸‹ä¸€å›åˆ...');
        
        // æ›´æ–°å›åˆæŒ‡ç¤º
        setTimeout(() => {
            addLog('è¯·é€‰æ‹©ä½ çš„è¡ŒåŠ¨...');
        }, 500);
    }, activeFieldEffect ? 500 : 0);  // å¦‚æœæœ‰åœºåœ°æ•ˆæœï¼Œç¨å¾®å»¶è¿Ÿè®©ç©å®¶çœ‹æ¸…
}

// æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
function checkGameOver() {
    if (gameState.player.currentHealth <= 0) {
        addLog(`${gameState.player.name}è¢«å‡»è´¥äº†ï¼æ¸¸æˆç»“æŸã€‚`);
        gameEnd(false);
        return true;
    } else if (gameState.enemy.currentHealth <= 0) {
        addLog(`${gameState.enemy.name}è¢«å‡»è´¥äº†ï¼èƒœåˆ©ï¼`);
        gameEnd(true);
        return true;
    }
    return false;
}

// //å›åˆåˆ¶ç³»ç»Ÿé›†æˆæ›´æ–° - æ¸¸æˆç»“æŸ
function gameEnd(isVictory) {
    // ç¦ç”¨æ‰€æœ‰æŒ‰é’®
    commandButtons.forEach(btn => {
        btn.classList.add('disabled');
    });
    
    // è·å–è§’è‰²åå­—
    const playerName = gameState.player.name;
    const enemyName = gameState.enemy.name;
    
    // è®¾ç½®å¼¹çª—å†…å®¹
    if (isVictory) {
        gameOverTitle.textContent = 'æˆ˜æ–—èƒœåˆ©';
        gameOverMessage.textContent = `${playerName}æˆ˜èƒœäº†${enemyName}ï¼`;
        addLog('æ­å–œä½ å–å¾—èƒœåˆ©ï¼');
    } else {
        gameOverTitle.textContent = 'æˆ˜æ–—å¤±è´¥';
        gameOverMessage.textContent = `${playerName}è´¥ç»™äº†${enemyName}ï¼`;
        addLog('æ¸¸æˆç»“æŸï¼Œå†æ¥å†å‰ï¼');
    }
    
    // æ£€æŸ¥æ˜¯å¦åœ¨iframeä¸­è¿è¡Œ
    const isInIframe = window.parent !== window;
    
    if (isInIframe) {
        // åœ¨iframeä¸­ï¼Œéšè—é‡æ–°å¼€å§‹æŒ‰é’®å’Œæ•´ä¸ªfooter
        document.getElementById('game-over-footer').style.display = 'none';
        
        // æ˜¾ç¤ºæ¸¸æˆç»“æŸå¼¹çª—
        gameOverModal.style.display = 'flex';
        
        // 3ç§’åè‡ªåŠ¨é€€å‡ºï¼ˆç¨å¾®å»¶é•¿ä¸€ç‚¹æ—¶é—´è®©ç©å®¶çœ‹åˆ°ç»“æœï¼‰
        setTimeout(() => {
            exitBattle(isVictory ? 'victory' : 'defeat');
        }, 3000);
    } else {
        // ä¸åœ¨iframeä¸­ï¼Œæ˜¾ç¤ºé‡æ–°å¼€å§‹æŒ‰é’®
        document.getElementById('game-over-footer').style.display = 'flex';
        
        // æ˜¾ç¤ºæ¸¸æˆç»“æŸå¼¹çª—
        gameOverModal.style.display = 'flex';
    }
}


// é”®ç›˜äº‹ä»¶å¤„ç†
function handleKeyPress(event) {
    // å¦‚æœé“å…·å¼¹çª—æ˜¾ç¤ºä¸­ï¼ŒæŒ‰ESCå…³é—­
    const itemModal = document.getElementById('item-modal');
    if (itemModal && itemModal.style.display === 'flex' && event.key === 'Escape') {
        closeItemModal();
        return;
    }
    
    // å¦‚æœå¼¹çª—æ˜¾ç¤ºä¸­ï¼ŒæŒ‰ESCå…³é—­
    if (confirmModal.style.display === 'flex' && event.key === 'Escape') {
        confirmModal.style.display = 'none'; gameState.player.selectedAction = null;
        updateDisplay(); return;
    }


    // å¦‚æœå¼¹çª—æ˜¾ç¤ºä¸­ï¼ŒæŒ‰Enterç¡®è®¤
    if (confirmModal.style.display === 'flex' && event.key === 'Enter') {
        confirmModal.style.display = 'none';
        confirmAction();
        return;
    }

    // å¦‚æœä¸æ˜¯ç©å®¶å›åˆæˆ–æ­£åœ¨ç­‰å¾…ç¡®è®¤ï¼Œè¿”å›
    if (gameState.currentTurn !== 'player' || gameState.waitingForConfirmation) return;

    const key = event.key.toUpperCase();

    switch (key) {
        case 'Q':
            selectAction('gather');
            break;
        case 'W':
            selectAction('defend');
            break;
        case 'E':
            selectAction('light-attack');
            break;
        case 'R':
            selectAction('heavy-attack');
            break;
        case 'T':
            selectAction('special');
            break;
        case 'Y':
            selectAction('taunt');
            break;
        case 'U':
            openItemModal();
            break;
    }
}

// åˆå§‹åŒ–æ¸¸æˆ 
// åŠ¨æ€è®¾ç½®1.46æ¯”ä¾‹çš„å‡½æ•° 
function setAspectRatio() { 
    const gameContainer = document.querySelector('.game-container'); 
    if (!gameContainer) return;

    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;

    // è®¡ç®—1.46æ¯”ä¾‹çš„å°ºå¯¸ï¼ˆä¸ä¸»ç•Œé¢viewportä¸€è‡´ï¼‰
    const aspectRatio = 1.46;
    let gameWidth, gameHeight;

    // ä¼˜å…ˆåŸºäºå®½åº¦è®¡ç®—ï¼ˆé«˜åº¦ä¸ºå®½åº¦çš„ 1/1.46 â‰ˆ 0.685ï¼‰
    gameWidth = viewportWidth;
    gameHeight = viewportWidth / aspectRatio;

    // å¦‚æœè®¡ç®—å‡ºçš„é«˜åº¦è¶…è¿‡è§†å£é«˜åº¦ï¼Œåˆ™æ ¹æ®é«˜åº¦åæ¨å®½åº¦
    if (gameHeight > viewportHeight) {
        gameHeight = viewportHeight;
        gameWidth = viewportHeight * aspectRatio;
    }

    // ç¡®ä¿ä¸ä¼šè¶…å‡ºè¾¹ç•Œ
    gameWidth = Math.min(gameWidth, viewportWidth);
    gameHeight = Math.min(gameHeight, viewportHeight);

    // åº”ç”¨å°ºå¯¸
    gameContainer.style.width = `${gameWidth}px`;
    gameContainer.style.height = `${gameHeight}px`;
    
    // ç¡®ä¿å®¹å™¨ç´§è´´é¡¶éƒ¨
    gameContainer.style.marginTop = '0';
    
    // æ°´å¹³å±…ä¸­ï¼ˆå¦‚æœå®½åº¦å°äºè§†å£å®½åº¦ï¼‰
    if (gameWidth < viewportWidth) {
        gameContainer.style.marginLeft = `${(viewportWidth - gameWidth) / 2}px`;
        gameContainer.style.marginRight = 'auto';
    } else {
        gameContainer.style.marginLeft = '0';
        gameContainer.style.marginRight = '0';
    }

    console.log(`æ¸¸æˆå®¹å™¨å°ºå¯¸: ${gameWidth}x${gameHeight}, è§†å£: ${viewportWidth}x${viewportHeight}, æ¯”ä¾‹: ${(gameWidth/gameHeight).toFixed(2)}`);
}

// çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è®¾ç½®æ¯”ä¾‹ 
function handleResize() { 
    setAspectRatio(); 
}

// åˆå§‹åŒ–å°ºå¯¸è®¾ç½® 
function initAspectRatio() { 
    setAspectRatio();

    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
    window.addEventListener('resize', handleResize);
    window.addEventListener('orientationchange', () => {
        // å»¶è¿Ÿæ‰§è¡Œï¼Œç­‰å¾…æ–¹å‘å˜åŒ–å®Œæˆ
        setTimeout(setAspectRatio, 100);
    });
}

// ä¿®æ”¹åŸæœ‰çš„DOMContentLoadedäº‹ä»¶ç›‘å¬ 
document.addEventListener('DOMContentLoaded', () => { 
    // é¦–å…ˆè®¾ç½®4:3æ¯”ä¾‹ 
    initAspectRatio();

    // è®¾ç½®ä¸»èƒŒæ™¯
    const gameContainer = document.querySelector('.game-container');
    if (gameContainer) {
        gameContainer.style.backgroundImage = `url('${GAME_BG_URL}')`;
    }

    // è®¾ç½®å¼¹çª—èƒŒæ™¯ - æ’é™¤é“å…·å¼¹çª—
    const modalContents = document.querySelectorAll('.modal-content');
    modalContents.forEach(modal => {
        modal.style.background = `url('${MODAL_BG_URL}') center center / cover`;
    });
    
    // é“å…·å¼¹çª—ä½¿ç”¨ä¸é€æ˜çº¯è‰²èƒŒæ™¯
    const itemModalContent = document.querySelector('.item-modal-content');
    if (itemModalContent) {
        itemModalContent.style.background = 'linear-gradient(135deg, #1a1410 0%, #2a2018 50%, #1a1410 100%)';
    }

    // åˆå§‹åŒ–æ¸¸æˆ
    initGame();
});

    </script> 
</body> 
</html>
